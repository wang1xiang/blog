import{f as l,g as i,J as t}from"./common-03e46d7f.js";const e='{"title":"文档离线编辑实现","frontmatter":{"date":"2024-03-01","title":"文档离线编辑实现","tags":["tiptap"],"describe":null},"headers":[{"level":2,"title":"服务端：word 多人协作 socket 服务流程图","slug":"服务端：word-多人协作-socket-服务流程图"},{"level":2,"title":"前端","slug":"前端"},{"level":2,"title":"实现","slug":"实现"}],"relativePath":"docs/tiptap/tiptap-tutorial9.md","lastUpdated":1742290670619.4688}';var o={};const r=[t('<h2 id="服务端：word-多人协作-socket-服务流程图"><a class="header-anchor" href="#服务端：word-多人协作-socket-服务流程图" aria-hidden="true">#</a> 服务端：word 多人协作 socket 服务流程图</h2><p>html 使用接口判断权限相关，以跳转页面 socket 数据读取、保存、缓存 接口：由 socket 调用以保存数据并生成历史记录</p><p><img src="/blog/_assets/word-yjs-socket.802eda0a.png" alt="word-yjs-socket"></p><h2 id="前端"><a class="header-anchor" href="#前端" aria-hidden="true">#</a> 前端</h2><p>word 使用 tipap 框架（一个基于 ProseMirror 的在线编辑器框架） 多人协作使用 yjs</p><ol><li>访问 api/doc/info 接口以校验权限</li><li>权限校验完成后，创建 tiptap 实例 <ol><li>本地创建 YDoc</li><li>生成 title 和 prosemirror 子节点（title 不属于 tiptap，所以需要单独处理，prosemirror 用于存放 tiptap 内容）</li><li>绑定 prosemirror 与 tiptap 变更同步</li><li>创建 socket 连接（携带 token 及 uid）</li><li>监听 ydoc 变更及光标位置</li></ol></li><li>socket 服务 <ol><li>校验 token</li><li>校验服务器文档状态： <strong>正在恢复历史断开连接</strong></li><li>校验客户断文档版本号：<strong>重连才会携带，不一致通知</strong>、客户断刷新页面</li><li>下发服务器文档版本号</li><li>下发服务器文档内容</li></ol></li><li>记录版本号，掉线重连时携带（掉线后版本号有变化刷新页面，版本号 = 恢复的历史 ID || 文档 ID）</li><li>使用服务器下发内容渲染文档内容</li><li>tiptap 实例 initSuccess<strong>编辑按钮可点击、或自动进入编辑态</strong></li><li>编辑内容或标题 <strong>ydoc 发现变更并发送</strong></li><li>服务端：收到 ydoc 变更下发给其它端</li><li>客户端：收到服务器变更，yjs 合并内容</li><li>掉线，打开断网遮罩 <ol><li>携带 服务器文档版本号 重连</li><li>恢复同步后</li></ol></li></ol><h2 id="实现"><a class="header-anchor" href="#实现" aria-hidden="true">#</a> 实现</h2><p>基于 y-indexeddb 将文档内容存入本地 indexeddb</p><ul><li>首次渲染 <ul><li>从服务器下载内容，存入本地</li><li>每次变更，向服务器同步、存本地同时触发</li></ul></li><li>后续渲染 <ul><li>先从本地获取数据渲染页面</li><li>与服务器同步差异</li></ul></li><li>离线 <ul><li>变更存入本地</li><li>重连后与服务器进行全量对比，同步差异</li></ul></li><li>恢复历史记录 <ul><li>恢复进行中，所有客户端会被踢下线，恢复完成后才能连的上</li><li>每次连接会判断客户端 doc version 与服务器是否一致，不一致以 4301 连接失败，客户端收到 4301 删除本地 indexeddb，重新连接</li></ul></li></ul>',9)];o.render=function(t,e,o,s,a,d){return l(),i("div",null,r)};export{e as __pageData,o as default};
