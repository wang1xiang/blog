import{f as n,g as e,J as s}from"./common-03e46d7f.js";import{_ as a}from"./common-af9dd5a8.js";const t='{"title":"èµ·é£äº†ï¼GitLab CI + Docker é¡¹ç›®éƒ¨ç½²å®æˆ˜","frontmatter":{"date":"2024-04-07","title":"èµ·é£äº†ï¼GitLab CI + Docker é¡¹ç›®éƒ¨ç½²å®æˆ˜","tags":["git"],"describe":null},"headers":[{"level":2,"title":"é¡¹ç›® CI/CD é…ç½®","slug":"é¡¹ç›®-ci-cd-é…ç½®"},{"level":3,"title":"é˜¶æ®µ","slug":"é˜¶æ®µ"},{"level":3,"title":"ä½œä¸š","slug":"ä½œä¸š"},{"level":3,"title":"æµæ°´çº¿æ‰§è¡Œ","slug":"æµæ°´çº¿æ‰§è¡Œ"},{"level":3,"title":"Gitlab Runner","slug":"gitlab-runner"},{"level":3,"title":"å†æ¬¡æµ‹è¯•æµæ°´çº¿","slug":"å†æ¬¡æµ‹è¯•æµæ°´çº¿"},{"level":3,"title":"é‡åˆ°çš„é—®é¢˜","slug":"é‡åˆ°çš„é—®é¢˜"},{"level":2,"title":"Docker","slug":"docker"},{"level":3,"title":"é‡è¦æ¦‚å¿µ","slug":"é‡è¦æ¦‚å¿µ"},{"level":3,"title":"å¦‚ä½•ç”Ÿæˆ Docker é•œåƒ","slug":"å¦‚ä½•ç”Ÿæˆ-docker-é•œåƒ"},{"level":2,"title":".gitlab-ci.yml æ–‡ä»¶ç¼–å†™","slug":"gitlab-ci-yml-æ–‡ä»¶ç¼–å†™"}],"relativePath":"docs/git/gitlab-ci-start.md","lastUpdated":1743046188616.0437}';var o={};const c=[s('<p>ä¹‹å‰æœ‰ä¸€ç¯‡<a href="https://juejin.cn/post/7349561234931515433" target="_blank" rel="noopener noreferrer">é˜Ÿå‹å‡èŒï¼Œè¢«è¿«è§£é” Jenkinsï¼ˆæ‰€ä»¥ï¼Œå‰ç«¯éœ€è¦å­¦ä¹  Jenkins å—ï¼ŸğŸ¤”ï¼‰</a>å¦‚ä½•ä½¿ç”¨ Jenkins æ¥éƒ¨ç½²é¡¹ç›®ï¼Œçœ‹è¯„è®ºæœ‰å¥½å‡ ä¸ªäººéƒ½è¯´æ€ä¹ˆä¸ç”¨ GitLab CIï¼Œåˆšå¥½æœ‰ä¸€ä¸ªæ–°çš„ Node é¡¹ç›®å®Œæˆéœ€è¦éƒ¨ç½²ï¼Œå°è¯•ç”¨ GitLab CI + docker çš„æ–¹å¼å»éƒ¨ç½²ï¼Œå†™äº†è¿™ç¯‡æ–‡ç« ï¼Œå¸Œæœ›å¯¹å¤§å®¶æœ‰å¸®åŠ©ã€‚</p><h2 id="é¡¹ç›®-ci-cd-é…ç½®"><a class="header-anchor" href="#é¡¹ç›®-ci-cd-é…ç½®" aria-hidden="true">#</a> é¡¹ç›® CI/CD é…ç½®</h2><p>é¦–å…ˆç‚¹å‡» CI/CDï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„ GitLab CI</p><p><img src="/blog/_assets/gitlab-ci-create.7de798d0.png" alt="gitlab-ci-create"></p><p>GitLab CI æ˜¯é€šè¿‡åä¸º <code>.gitlab-ci.yml</code> çš„æ–‡ä»¶è¿›è¡Œé…ç½®ï¼Œè¯¥æ–‡ä»¶ä½äºä»“åº“çš„æ ¹ç›®å½•ä¸‹ã€‚</p><p><img src="/blog/_assets/gitlab-ci-create-more.24981d81.png" alt="gitlab-ci-create-more"></p><p>æ–°å»ºçš„ GitLab CI é…ç½®æ–‡ä»¶å¦‚ä¸‹ï¼š</p><div class="language-yml"><pre><code><span class="token comment"># è¿™æ˜¯ä¸€ä¸ªç¤ºä¾‹çš„ GitLab CI/CD é…ç½®æ–‡ä»¶ï¼Œåº”è¯¥å¯ä»¥ç›´æ¥è¿è¡Œè€Œæ— éœ€ä»»ä½•ä¿®æ”¹ã€‚</span>\n<span class="token comment"># å®ƒå±•ç¤ºäº†ä¸€ä¸ªåŸºæœ¬çš„ 3 ä¸ªé˜¶æ®µçš„ CI/CD æµæ°´çº¿ã€‚åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬ä½¿ç”¨ echo å‘½ä»¤æ¥æ¨¡æ‹Ÿæµæ°´çº¿çš„æ‰§è¡Œï¼Œè€Œä¸æ˜¯çœŸæ­£çš„æµ‹è¯•æˆ–è„šæœ¬ã€‚</span>\n<span class="token comment">#</span>\n<span class="token comment"># æµæ°´çº¿ç”±ç‹¬ç«‹çš„ä½œä¸šç»„æˆï¼Œè¿™äº›ä½œä¸šè¿è¡Œè„šæœ¬ï¼Œå¹¶è¢«åˆ†ç»„åˆ°é˜¶æ®µä¸­ã€‚</span>\n<span class="token comment"># é˜¶æ®µæŒ‰é¡ºåºè¿è¡Œï¼Œä½†é˜¶æ®µå†…çš„ä½œä¸šå¹¶è¡Œè¿è¡Œã€‚</span>\n<span class="token comment">#</span>\n<span class="token comment"># æ¬²äº†è§£æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚é˜…ï¼šhttps://docs.gitlab.com/ee/ci/yaml/index.html#stages</span>\n<span class="token comment">#</span>\n<span class="token comment"># ä½ å¯ä»¥å°†è¿™ä¸ªæ¨¡æ¿å¤åˆ¶ç²˜è´´åˆ°ä¸€ä¸ªæ–°çš„ `.gitlab-ci.yml` æ–‡ä»¶ä¸­ã€‚</span>\n<span class="token comment"># è¯·ä¸è¦ä½¿ç”¨ `include:` å…³é”®å­—å°†æ­¤æ¨¡æ¿æ·»åŠ åˆ°ç°æœ‰çš„ `.gitlab-ci.yml` æ–‡ä»¶ä¸­ã€‚</span>\n<span class="token comment">#</span>\n<span class="token comment"># è¦è´¡çŒ® CI/CD æ¨¡æ¿çš„æ”¹è¿›ï¼Œè¯·éµå¾ªå¼€å‘æŒ‡å—ï¼š</span>\n<span class="token comment"># https://docs.gitlab.com/ee/development/cicd/templates.html</span>\n<span class="token comment"># æ­¤ç‰¹å®šæ¨¡æ¿ä½äºï¼š</span>\n<span class="token comment"># https://gitlab.com/gitlab-org/gitlab/-/blob/master/lib/gitlab/ci/templates/Getting-Started.gitlab-ci.yml</span>\n\n<span class="token key atrule">stages</span><span class="token punctuation">:</span> <span class="token comment"># ä½œä¸šçš„é˜¶æ®µåˆ—è¡¨ï¼Œä»¥åŠå®ƒä»¬çš„æ‰§è¡Œé¡ºåº</span>\n  <span class="token punctuation">-</span> build\n  <span class="token punctuation">-</span> test\n  <span class="token punctuation">-</span> deploy\n\n<span class="token key atrule">build-job</span><span class="token punctuation">:</span> <span class="token comment"># æ­¤ä½œä¸šè¿è¡Œåœ¨æ„å»ºé˜¶æ®µï¼Œè¯¥é˜¶æ®µé¦–å…ˆè¿è¡Œã€‚</span>\n  <span class="token key atrule">stage</span><span class="token punctuation">:</span> build\n  <span class="token key atrule">script</span><span class="token punctuation">:</span>\n    <span class="token punctuation">-</span> echo &quot;Compiling the code<span class="token punctuation">...</span>&quot;\n    <span class="token punctuation">-</span> echo &quot;Compile complete.&quot;\n\n<span class="token key atrule">unit-test-job</span><span class="token punctuation">:</span> <span class="token comment"># æ­¤ä½œä¸šè¿è¡Œåœ¨æµ‹è¯•é˜¶æ®µã€‚</span>\n  <span class="token key atrule">stage</span><span class="token punctuation">:</span> test <span class="token comment"># ä»…å½“æ„å»ºé˜¶æ®µçš„ä½œä¸šæˆåŠŸå®Œæˆæ—¶ï¼Œå®ƒæ‰ä¼šå¼€å§‹è¿è¡Œã€‚</span>\n  <span class="token key atrule">script</span><span class="token punctuation">:</span>\n    <span class="token punctuation">-</span> echo &quot;Running unit tests<span class="token punctuation">...</span> This will take about 60 seconds.&quot;\n    <span class="token punctuation">-</span> sleep 60\n    <span class="token punctuation">-</span> echo &quot;Code coverage is 90%&quot;\n\n<span class="token key atrule">lint-test-job</span><span class="token punctuation">:</span> <span class="token comment"># æ­¤ä½œä¸šä¹Ÿåœ¨æµ‹è¯•é˜¶æ®µè¿è¡Œã€‚</span>\n  <span class="token key atrule">stage</span><span class="token punctuation">:</span> test <span class="token comment"># å®ƒå¯ä»¥ä¸ unit-test-job åŒæ—¶è¿è¡Œï¼ˆå¹¶è¡Œï¼‰ã€‚</span>\n  <span class="token key atrule">script</span><span class="token punctuation">:</span>\n    <span class="token punctuation">-</span> echo &quot;Linting code<span class="token punctuation">...</span> This will take about 10 seconds.&quot;\n    <span class="token punctuation">-</span> sleep 10\n    <span class="token punctuation">-</span> echo &quot;No lint issues found.&quot;\n\n<span class="token key atrule">deploy-job</span><span class="token punctuation">:</span> <span class="token comment"># æ­¤ä½œä¸šåœ¨éƒ¨ç½²é˜¶æ®µè¿è¡Œã€‚</span>\n  <span class="token key atrule">stage</span><span class="token punctuation">:</span> deploy <span class="token comment"># ä»…å½“æµ‹è¯•é˜¶æ®µä¸­çš„ *æ‰€æœ‰* ä½œä¸šæˆåŠŸå®Œæˆæ—¶ï¼Œå®ƒæ‰ä¼šè¿è¡Œã€‚</span>\n  <span class="token key atrule">script</span><span class="token punctuation">:</span>\n    <span class="token punctuation">-</span> echo &quot;Deploying application<span class="token punctuation">...</span>&quot;\n    <span class="token punctuation">-</span> echo &quot;Application successfully deployed.&quot;\n</code></pre></div><h3 id="é˜¶æ®µ"><a class="header-anchor" href="#é˜¶æ®µ" aria-hidden="true">#</a> é˜¶æ®µ</h3><p>è„šæœ¬ä¸­ä½¿ç”¨ <code>stages</code> å­—æ®µå®šä¹‰äº†ä¸‰ä¸ªé˜¶æ®µï¼šbuildã€test å’Œ deployï¼ŒæŒ‰ç…§ç”±ä¸Šåˆ°ä¸‹çš„é¡ºåºæ‰§è¡Œï¼Œå’Œ Jenkins ä¸­çš„ stages ä¸€æ ·ã€‚</p><h3 id="ä½œä¸š"><a class="header-anchor" href="#ä½œä¸š" aria-hidden="true">#</a> ä½œä¸š</h3><p>è„šæœ¬åŒ…å«å››ä¸ªä½œä¸šï¼šbuild-jobã€unit-test-jobã€lint-test-job å’Œ deploy-jobï¼Œä½œä¸šä¸­é€šè¿‡ <code>stage</code> å­—æ®µæ¥å®šä¹‰å½“å‰ä½œä¸šå±äºå“ªä¸ªé˜¶æ®µï¼Œç±»ä¼¼äº Jenkins ä¸­çš„ stepsã€‚</p><p>å…¶ä¸­ unit-test-jobã€lint-test-job å±äºåŒä¸€ä¸ªé˜¶æ®µ testã€‚</p><p>ä½œä¸šä¸­é€šè¿‡ <code>script</code> å®šä¹‰æ‰§è¡Œè„šæœ¬ã€‚</p><h3 id="æµæ°´çº¿æ‰§è¡Œ"><a class="header-anchor" href="#æµæ°´çº¿æ‰§è¡Œ" aria-hidden="true">#</a> æµæ°´çº¿æ‰§è¡Œ</h3><p>æäº¤ <code>.gitlab-ci.yml</code> çš„ä¿®æ”¹å³å¯è§¦å‘ CI æµç¨‹ï¼Œæ­¤æ—¶è¿˜æœªå¯åŠ¨ä»»ä½• Runnerï¼Œæ‰€æœ‰çš„ä½œä¸šéƒ½ä¼šè¢«æ ‡è®°ä¸ºç­‰å¾…çŠ¶æ€ã€‚</p><p><img src="/blog/_assets/gitlab-ci-runner-not.5e4de8f9.png" alt="gitlab-ci-runner-not"></p><p>é‚£ä¹ˆ Gitlab Runner åˆæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ</p><h3 id="gitlab-runner"><a class="header-anchor" href="#gitlab-runner" aria-hidden="true">#</a> Gitlab Runner</h3><p>æˆ‘ä»¬å¯ä»¥ç®€å•çš„æŠŠ Gitlab Runner ç†è§£ä¸º Gitlab çš„ä¸€ä¸ªæ’ä»¶ï¼Œå®ƒè´Ÿè´£æ‰§è¡Œ CI æµç¨‹ï¼Œæ‰€ä»¥éœ€è¦çº¿å®‰è£…å®ƒã€‚</p><p>Gitlab Runner å¯ä»¥éƒ¨ç½²åœ¨ä»»ä½•çš„æœåŠ¡å™¨ä¸Šï¼Œç±»ä¼¼äº Jenkins master æ˜¯ä»¥å®¹å™¨æ–¹å¼è¿è¡Œï¼Œè€Œ agent æ˜¯å¯ä»¥ç›´æ¥è·‘åœ¨å®¿ä¸»æœºä¸Šçš„ã€‚</p><p><img src="'+a+'" alt="jenkins-agent-master"></p><h4 id="å®‰è£…-gitlab-runner"><a class="header-anchor" href="#å®‰è£…-gitlab-runner" aria-hidden="true">#</a> å®‰è£… Gitlab Runner</h4><p>è¿™é‡Œæˆ‘ä»¬ç›´æ¥ä½¿ç”¨ docker å®‰è£…ã€‚</p><div class="language-bash"><pre><code><span class="token comment"># åˆ›å»ºä¸€ä¸ªæ–‡ä»¶å¤¹ç”¨äºåç»­æŒ‚è½½ runner çš„é…ç½®æ–‡ä»¶</span>\n<span class="token function">mkdir</span> -p /home/gitlab-runner/config\n<span class="token comment"># æ‹‰å– gitlab-runner é•œåƒï¼Œå°½é‡ä¸ gitlab ç‰ˆæœ¬ä¿æŒä¸€è‡´</span>\n<span class="token function">docker</span> pull gitlab/gitlab-runner:v16.8.0\n<span class="token comment"># æŸ¥çœ‹ docker é•œåƒåˆ—è¡¨</span>\n<span class="token function">docker</span> images\n<span class="token comment"># è¿è¡Œ gitlab-runner é•œåƒ</span>\n<span class="token function">docker</span> run -itd --restart always --name gitlab-runner <span class="token punctuation">\\</span>\n-v /home/gitlab-runner/config:/etc/gitlab-runner <span class="token punctuation">\\</span>\n-v /var/run/docker.sock:/var/run/docker.sock <span class="token punctuation">\\</span>\ngitlab/gitlab-runner:v16.8.0\n<span class="token comment"># æŸ¥çœ‹è¿è¡Œçš„é•œåƒ</span>\n<span class="token function">docker</span> <span class="token function">ps</span> <span class="token operator">|</span> <span class="token function">grep</span> gitlab\n</code></pre></div><p>æŸ¥çœ‹ docker é•œåƒï¼Œå‡ºç°ä»¥ä¸‹åˆ™è¯´æ˜ gitlab-runner é•œåƒè¿è¡ŒæˆåŠŸã€‚</p><p><img src="/blog/_assets/gitlab-runner-installed.7428e597.png" alt="gitlab-runner-installed"></p><h4 id="æ³¨å†Œ-gitlab-runner"><a class="header-anchor" href="#æ³¨å†Œ-gitlab-runner" aria-hidden="true">#</a> æ³¨å†Œ Gitlab Runner</h4><p>gitlab-runner å®¹å™¨å¯åŠ¨å®Œæˆåï¼Œè¿˜éœ€è¦æ³¨å†Œ gitlab-runner æ‰å¯ä½¿ç”¨ã€‚</p><div class="language-bash"><pre><code><span class="token comment"># è¿›å…¥å®¹å™¨</span>\n<span class="token function">docker</span> <span class="token builtin class-name">exec</span> -it gitlab-runner-docker <span class="token function">sh</span>\n<span class="token comment"># æŸ¥çœ‹ä¿¡æ¯</span>\ngitlab-runner -v\n</code></pre></div><p><img src="/blog/_assets/gitlab-runner-installed-v.42931c06.png" alt="gitlab-runner-installed-v"></p><p>å¼€å§‹æ³¨å†Œï¼š</p><div class="language-bash"><pre><code>gitlab-runner register\n</code></pre></div><p><img src="/blog/_assets/gitlab-runner-register.ab63e212.png" alt="gitlab-runner-register"></p><p>æˆ‘ä»¬æŒ‰ç…§æ­¥éª¤ï¼š</p><ol><li><p>è¾“å…¥ GitLab åœ°å€å’Œ token</p><p>ç›´æ¥ä» CI/CD é¡µé¢ï¼Œç›´æ¥å¤åˆ¶å³å¯</p><p><img src="/blog/_assets/gitlab-runner-register-gitlab.956d7deb.png" alt="gitlab-runner-register-gitlab"></p></li><li><p>è¾“å…¥ Runner çš„æè¿°ä¿¡æ¯</p><p>æè¿°ä¿¡æ¯ï¼Œä¹Ÿæ˜¯ runner çš„åç§°ï¼Œæ­¤å¤„å¡« <code>build</code>ï¼Œä¹Ÿå¯ä¸å¡«ï¼Œå¯ä»¥åœ¨ Gitlab ç•Œé¢æ˜¾ç¤ºè¿›è¡Œä¿®æ”¹</p></li><li><p>è¾“å…¥ Tag</p><p>å¯ä¸å¡«ï¼Œç›´æ¥åœ¨ Gitlab ç•Œé¢ä¿®æ”¹ï¼Œå¯ä»¥ç”¨äºæŒ‡å®šåœ¨æ„å»ºè§„å®šçš„ tag æ—¶è§¦å‘ CIï¼Œå»ºè®®<strong>ä¸è¦ä¸ºçº¯æ•°å­—ï¼Œå¦åˆ™æ„å»ºä¼šæŠ¥é”™</strong></p></li><li><p>è¾“å…¥ç”¨æˆ·æƒé™å¤‡æ³¨</p><p>å¯ä¸å¡«</p></li><li><p>é€‰æ‹© Runner-Executorï¼Œå»ºè®® <code>docker</code></p></li><li><p>é€‰æ‹© Runner-Executor-Versionï¼Œå»ºè®® <code>docker:latest</code></p><p><code>node:16.19-slim</code>ï¼Œå°ç‰ˆæœ¬ï¼Œèƒ½çœå¾ˆå¤šå†…å­˜ æ ¹æ®æç¤ºå¡«å†™ docker æ‰§è¡Œå™¨ç‰ˆæœ¬ï¼Œåç»­ä½œä¸šä»¥å“ªä¸ªé•œåƒç‰ˆæœ¬æ¥è¿è¡Œ jobï¼ˆå¯åœ¨.gitlab-ci.yml ä¸­ä¿®æ”¹éœ€è¦çš„ imageï¼‰</p></li></ol><p>æ‰€æœ‰æ­¥éª¤æ‰§è¡Œå®Œä¼šç”Ÿæˆä¸€ä¸ª Runner çš„é…ç½®æ–‡ä»¶ï¼Œé»˜è®¤ä½ç½®æ˜¯ <code>/etc/gitlab-runner/config.toml</code>ï¼Œç”±äºæˆ‘ä»¬åˆ›å»º Runner å®¹å™¨æ—¶æŒ‚è½½äº†ç›®å½•ï¼Œè¯¥æ–‡ä»¶ä¼šåŒæ­¥å‡ºç°åœ¨æˆ‘ä»¬åˆ›å»ºçš„æœ¬åœ°æŒ‚è½½ç›®å½• <code>/home/gitlab-runner/config/config.toml</code> ä¸­ã€‚</p><h4 id="æ‰§è¡Œå™¨è¿è¡Œç»“æœ"><a class="header-anchor" href="#æ‰§è¡Œå™¨è¿è¡Œç»“æœ" aria-hidden="true">#</a> æ‰§è¡Œå™¨è¿è¡Œç»“æœ</h4><div class="language-bash"><pre><code>gitlab-runner list\n</code></pre></div><p><img src="/blog/_assets/gitlab-ci-runner-list.f594fbe6.png" alt="gitlab-ci-runner-list"></p><p>Runner æ›´å¤šå‘½ä»¤ï¼š</p><div class="language-bash"><pre><code>gitlab-runner register   <span class="token comment"># äº¤äº’å¼æ³¨å†Œ Runner</span>\ngitlab-runner list       <span class="token comment"># æ‰€æœ‰çš„ Runner åˆ—è¡¨</span>\ngitlab-runner verify     <span class="token comment"># æ£€æŸ¥æ³¨å†Œçš„ Runner æ˜¯å¦å¯ä»¥è¿æ¥</span>\ngitlab-runner unregister <span class="token comment"># å–æ¶ˆæ³¨å†Œ Runner</span>\ngitlab-runner unregister --name test-runner\n</code></pre></div><p>æ­¤æ—¶å¯ä»¥è¿”å›ä»“åº“æŸ¥çœ‹</p><p><img src="/blog/_assets/gitlab-ci-setting-success.f892163d.png" alt="gitlab-ci-setting-success"></p><ul><li>é¡µé¢æ–°å¢ä¸€æ¡å¯ç”¨çš„æŒ‡å®š Runner</li><li>å¦‚æœæŒ‡ç¤ºç¯æ˜¯ç»¿è‰²åˆ™è¡¨ç¤ºæ­£å¸¸</li></ul><h3 id="å†æ¬¡æµ‹è¯•æµæ°´çº¿"><a class="header-anchor" href="#å†æ¬¡æµ‹è¯•æµæ°´çº¿" aria-hidden="true">#</a> å†æ¬¡æµ‹è¯•æµæ°´çº¿</h3><p><img src="/blog/_assets/gitlab-ci-run-pipeline.6a68c2ea.png" alt="gitlab-ci-run-pipeline"></p><p>ç‚¹å‡» <code>Run pipeline</code> å¼€å¯ä¸€ä¸ªæ–°çš„æµæ°´çº¿ä»»åŠ¡ï¼š</p><p>ç­‰å¾…æ‰§è¡Œå®Œæˆåï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><p><img src="/blog/_assets/gitlab-ci-success.964c1d43.png" alt="gitlab-ci-success"></p><p>ä¹Ÿå¯ä»¥ç‚¹å‡»è¿›å»æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯ï¼Œå¦‚æˆ‘ä»¬çš„è¾“å‡ºä¿¡æ¯ï¼š</p><p><img src="/blog/_assets/gitlab-ci-success-info.19e84b16.png" alt="gitlab-ci-success-info"></p><h3 id="é‡åˆ°çš„é—®é¢˜"><a class="header-anchor" href="#é‡åˆ°çš„é—®é¢˜" aria-hidden="true">#</a> é‡åˆ°çš„é—®é¢˜</h3><ol><li><p>ä½¿ç”¨ docker æ‹‰å–é•œåƒçš„æ—¶å€™ï¼ŒæŠ¥é”™ <code>missing signature key</code></p><div class="language-bash"><pre><code>yum <span class="token function">install</span> docker-ce -y\n<span class="token comment"># é‡å¯docker</span>\nsystemctl restart <span class="token function">docker</span>\n</code></pre></div></li><li><p>gitlab-runner è¿æ¥æˆåŠŸï¼Œä½†ä½œä¸šä¸€ç›´æ˜¯ <code>pending</code> çŠ¶æ€</p><p><img src="/blog/_assets/gitlab-ci-untagged-jobs.3af2edad.png" alt="gitlab-ci-untagged-jobs"></p><p><code>Run untagged jobs</code> é¡¹æœªå‹¾é€‰ï¼Œè¡¨ç¤ºæ­¤ runner ä¸èƒ½æ‰§è¡Œæ²¡æœ‰æŒ‡å®š tag çš„ pipelineï¼Œå‹¾é€‰ä¸Šå³å¯</p></li><li><p>å®‰è£…äº†ä½ç‰ˆæœ¬çš„ gitlab-runner</p><div class="language-bash"><pre><code><span class="token comment"># åˆ é™¤å®¹å™¨</span>\n<span class="token function">docker</span> stop <span class="token operator">&lt;</span>container_id_or_name<span class="token operator">&gt;</span>\n<span class="token function">docker</span> <span class="token function">rm</span> <span class="token operator">&lt;</span>container_id_or_name<span class="token operator">&gt;</span>\n<span class="token comment"># åˆ é™¤é•œåƒ</span>\n<span class="token function">docker</span> rmi <span class="token operator">&lt;</span>image_id_or_repository:tag<span class="token operator">&gt;</span>\n<span class="token comment"># é‡æ–°å®‰è£…</span>\n</code></pre></div></li></ol><h2 id="docker"><a class="header-anchor" href="#docker" aria-hidden="true">#</a> Docker</h2><p>å…„å¼Ÿä»¬ï¼Œæˆ‘ç»ˆäºå¼„æ‡‚ Docker äº† ğŸ‰ï¼Œç®€ç›´å¤ªå¥½ç”¨äº†ï¼Œå¯¹é€ å‡º Docker çš„å¤§ç¥ç®€ç›´ä½©æœçš„äº”ä½“æŠ•åœ°ã€‚</p><p>ä¸€ç›´å¬åˆ«äººè¯´â€œDocker å¥½ç”¨â€ï¼Œâ€œDocker å°±æ˜¯ä¸ªè™šæ‹Ÿæœºâ€ï¼Œæ¯”å¦‚ï¼šåç«¯é¡¹ç›®éƒ¨ç½²æ—¶ä¸ä»…åŒ…å«è‡ªå·±çš„ä»£ç ï¼Œè¿˜éœ€è¦ mysqlã€redisã€nginx ç­‰æœåŠ¡ï¼Œè¿˜æœ‰åŸºç¡€çš„ JDK ç­‰ç­‰ï¼Œè¿™äº›ä¸œè¥¿è¿˜éœ€è¦å®‰è£…æ­¥éª¤ã€ç¯å¢ƒå˜é‡çš„è®¾ç½®ç­‰ã€‚</p><p>å¦‚æœéœ€è¦éƒ¨ç½²å¤šå°æœºå™¨æ—¶ï¼Œå…¨éƒ½æ˜¯é‡å¤å·¥ä½œï¼Œå¢åŠ å·¥ä½œé‡çš„åŒæ—¶ä¹Ÿå¢åŠ äº†é£é™©ï¼Œä¸‡ä¸€å“ªä¸€æ­¥æ¼æ‰äº†ï¼ŒæœåŠ¡å°±è·‘ä¸èµ·æ¥äº†ã€‚</p><p>è€Œ Docker çš„å‡ºç°å°±æ˜¯ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œé¦–å…ˆæŠŠä¸Šè¿°è¯´çš„ä¸€ç³»åˆ—æœåŠ¡å°è£…æˆæˆä¸€ä¸ªé•œåƒï¼Œé•œåƒè¿è¡Œèµ·æ¥å°±æ˜¯ä¸€ä¸ªå®¹å™¨ï¼ˆå®¹å™¨ç›¸å½“äºä¸€ä¸ªè™šæ‹Ÿæœºï¼Œå¹¶ä¸”å¸®ä½ å®‰è£…å¥½äº†ä¸Šè¿°çš„åŸºç¡€æœåŠ¡ï¼‰ï¼Œå¯ä»¥ä¸€æ¬¡è¿è¡Œå¤šä¸ªå®¹å™¨ï¼Œæ‰€ä»¥å®ƒçš„ logo æ˜¯è¿™æ ·å¼çš„ã€‚</p><p><img src="/blog/_assets/docker-logo.3a1da4b9.png" alt="docker-logo.png"></p><p>å¹¶ä¸” Docker æä¾›äº†ç«¯å£å’Œæ–‡ä»¶æ˜ å°„ï¼Œæˆ‘ä»¬åªéœ€è¦æŠŠå®¹å™¨çš„ç«¯å£æ˜ å°„åˆ°å®¿ä¸»æœºï¼Œå°±å¯ä»¥è®¿é—®åˆ°å®¹å™¨å†…çš„æœåŠ¡äº†ã€‚</p><p><img src="/blog/_assets/docker-images-containers.a985dee4.png" alt="docker-images-containers"></p><p>æ²¡ä¸Šæ‰‹å‰æ„Ÿè§‰ Docker ç¦»æˆ‘å¥½è¿œï¼Œâ€œè¿™æ˜¯ä¸ªå•¥å‘€ï¼Œæˆ‘ä¸ä¼šæ‰€ä»¥æˆ‘ä¸ç”¨â€ï¼›ç”¨äº†ä¸€æ¬¡ï¼Œå‘€ï¼çœŸé¦™ï¼</p><p>å®‰è£… Docker ç¯å¢ƒå°±ä¸è¯´äº†ï¼Œç½‘ä¸Šä¸€æœä¸€å¤§æŠŠï¼Œ<strong>å¼ºçƒˆæ¨èï¼šå®‰è£…æ¡Œé¢ç«¯ Docker</strong>ã€‚</p><p><a href="https://www.docker.com/products/docker-desktop/" target="_blank" rel="noopener noreferrer">ğŸ‘‡ ä¸‹è½½åœ°å€</a></p><h3 id="é‡è¦æ¦‚å¿µ"><a class="header-anchor" href="#é‡è¦æ¦‚å¿µ" aria-hidden="true">#</a> é‡è¦æ¦‚å¿µ</h3><p>å¦‚æœå·²ç»å®‰è£…å®Œ Dockerï¼Œé¦–å…ˆæ‹‰å–ä¸€ä¸ªé•œåƒã€‚</p><div class="language-bash"><pre><code><span class="token function">docker</span> pull nginx\n</code></pre></div><p><img src="/blog/_assets/docker-pull-code.4fd1b533.png" alt="docker-pull-code"></p><p>æˆ–è€…ç›´æ¥åœ¨æ¡Œé¢ç«¯ Docker ä¸­æœç´¢ï¼Œå¹¶æ‹‰å–ï¼š</p><p><img src="/blog/_assets/docker-pull-desktop.6dae5aa1.png" alt="docker-pull-desktop"></p><p>æ¥ç€çœ‹å‡ ä¸ª Docker ä¸­ç»å¸¸ä¼šæåˆ°çš„åè¯ï¼Œäº†è§£è¿™å‡ ä¸ªåè¯çš„å…³ç³»ï¼Œæœ‰åŠ©äºæˆ‘ä»¬æ›´å¥½çš„æŒæ¡ Dockerã€‚</p><p>å“¦ï¼Œä½ è¿˜ä¸æ‡‚ Docker å‘½ä»¤ï¼Œæ²¡äº‹ï¼Œç›´æ¥åœ¨ç»ˆç«¯è¾“å…¥ dockerï¼Œæç¤ºå°±å‡ºæ¥äº†ã€‚</p><p><img src="/blog/_assets/docker-bash-code.c6df448a.png" alt="docker-bash-code"></p><h4 id="images-é•œåƒ"><a class="header-anchor" href="#images-é•œåƒ" aria-hidden="true">#</a> images é•œåƒ</h4><p>images å°±æ˜¯æ‰€æœ‰é•œåƒçš„åˆ—è¡¨ï¼Œå¯ä»¥é€šè¿‡ pull æ‹‰å–æ›´å¤šé•œåƒï¼Œå¯ä»¥é€šè¿‡ <code>docker images</code> å‘½ä»¤æŸ¥çœ‹ï¼š</p><p><img src="/blog/_assets/docker-images-code.13c8552b.png" alt="docker-images-code"></p><p>æˆ–è€…ç›´æ¥åœ¨æ¡Œé¢ç«¯çœ‹ï¼š</p><p><img src="/blog/_assets/docker-images-desktop.867e9cb5.png" alt="docker-images-desktop"></p><h4 id="containers-å®¹å™¨"><a class="header-anchor" href="#containers-å®¹å™¨" aria-hidden="true">#</a> containers å®¹å™¨</h4><p>containers å°±æ˜¯é•œåƒè·‘èµ·æ¥çš„å®¹å™¨ï¼Œ<strong>å®¹å™¨æ˜¯é•œåƒçš„ä¸€ä¸ªå®ä¾‹ï¼Œä¸€ä¸ªé•œåƒå¯ä»¥è·‘å¤šä¸ªå®¹å™¨</strong></p><p><img src="/blog/_assets/docker-containers-runs.b02c9279.png" alt="docker-containers-runs"></p><p>ç‚¹å‡» <code>Run</code> å°±å¼¹å‡ºä¸€ä¸ªè¡¨å•ï¼Œå¡«å†™å¦‚ä¸‹å†…å®¹ï¼š</p><ul><li>å®¹å™¨åç§°ï¼šä¸å¡«å†™ï¼Œéšæœºç”Ÿæˆåå­—</li><li>ç«¯å£æ˜ å°„ï¼šå°±æ˜¯æŠŠå®¹å™¨çš„ç«¯å£æ˜ å°„åˆ°å®¿ä¸»æœºçš„ç«¯å£ä¸Šï¼Œæ¯”å¦‚å®¹å™¨å†… nginx æœåŠ¡æ˜¯ 80 ç«¯å£ï¼Œéœ€è¦æŠŠå®¿ä¸»æœºçš„ç«¯å£æ˜ å°„åˆ°è¿™ä¸ªç«¯å£ï¼Œåœ¨å®¿ä¸»æœºä¸Šæ‰å¯ä»¥è®¿é—® nginx æœåŠ¡</li><li>æ•°æ®å·ï¼šå°±æ˜¯æŠŠå®¿ä¸»æœºæŸä¸ªç›®å½•æŒ‚è½½åˆ°å®¹å™¨å†…ï¼Œå¯ä»¥è®¾ç½®å¤šä¸ªï¼Œå¦‚ä¿å­˜æ—¥å¿—çš„ã€é…ç½®æ–‡ä»¶ã€nginx çš„ html ç›®å½•ç­‰ï¼Œè¿™æ ·å®¹å™¨å†…çš„æ•°æ®å°±ä¼šä¸å®¿ä¸»æœºåŒæ­¥ï¼Œç›¸å½“äºå°†å®¹å™¨å†…çš„æ•°æ®ä¿å­˜åˆ°å®¿ä¸»æœºäº†</li><li>ç¯å¢ƒå˜é‡ï¼šå°±æ˜¯å®¹å™¨çš„ç¯å¢ƒå˜é‡ï¼Œå¯ä»¥è®¾ç½®å¤šä¸ªï¼Œå¦‚æ•°æ®åº“è¿æ¥ä¿¡æ¯ã€ç¯å¢ƒå˜é‡ç­‰</li></ul><p>åœ¨æ¡Œé¢ç«¯ Docker ä¸­ï¼Œå¯ä»¥çœ‹åˆ°å½“å‰è¿è¡Œçš„å®¹å™¨åˆ—è¡¨ï¼š</p><p><img src="/blog/_assets/docker-containers-list.a1f94d1c.png" alt="docker-containers-list"></p><p>é€šè¿‡ <code>docker ps</code> ä¹Ÿå¯ä»¥æŸ¥çœ‹å½“å‰å¯åŠ¨çš„å®¹å™¨åˆ—è¡¨ï¼š</p><p><img src="/blog/_assets/docker-containers-list1.2539c3aa.png" alt="docker-containers-list1"></p><p>è¿™é‡Œæˆ‘å¯åŠ¨ 4 ä¸ªå®¹å™¨ï¼š</p><ol><li>ç›´æ¥ <code>Run</code>ï¼Œæ²¡æœ‰ä»»ä½•é…ç½®</li><li>é…ç½®äº†åç§°</li><li>é…ç½®åç§°å’Œç«¯å£</li><li>é…ç½®åç§°ã€ç«¯å£å’Œæ–‡ä»¶æŒ‚è½½è·¯å¾„</li></ol><p><img src="/blog/_assets/docker-containers-mount.9c54a9aa.png" alt="docker-containers-mount"></p><p>æµè§ˆå™¨æ‰“å¼€ <a href="http://localhost:8091/" target="_blank" rel="noopener noreferrer">http://localhost:8091/</a>ï¼Œæ˜¾ç¤ºæˆ‘ä»¬æœ¬åœ°çš„ html æ–‡ä»¶å†…å®¹</p><p><img src="/blog/_assets/docker-containers-mount1.c74e345c.png" alt="docker-containers-mount1"></p><p>ä¸Šè¿°å››ä¸ªå®¹å™¨ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ <code>docker run</code> å‘½ä»¤è¡Œå¯åŠ¨ï¼Œæ ¼å¼ä¸ºï¼š</p><div class="language-bash"><pre><code><span class="token comment"># --name è®¾ç½®å®¹å™¨åç§°</span>\n<span class="token comment"># -p ç«¯å£æ˜ å°„</span>\n<span class="token comment"># -v æŒ‡å®šæ•°æ®å·æŒ‚è½½ç›®å½•ï¼Œå¯å¤šæ¬¡è®¾ç½®</span>\n<span class="token comment"># -e æŒ‡å®šç¯å¢ƒå˜é‡ï¼ŒKey=Value</span>\n<span class="token comment"># -d åå°è¿è¡Œ</span>\n<span class="token function">docker</span> run --name xxx -p xx:xx -v xx:xx -e <span class="token assign-left variable">xx</span><span class="token operator">=</span>xx -d nginx:latest\n</code></pre></div><p>é‚£ä¹ˆï¼Œæˆ‘ä»¬åˆšåˆšå¯åŠ¨çš„ 4 ä¸ªå®¹å™¨ï¼Œåˆ†åˆ«å¯¹åº”çš„å‘½ä»¤å°±æ˜¯ï¼š</p><ol><li><code>docker run nginx:latest</code></li><li><code>docker run --name nginx1 nginx:latest</code></li><li><code>docker run --name nginx2 -p 8090:80 nginx:latest</code></li><li><code>docker run --name nginx3 -p 8091:80 -v /Users/Desktop/html:/usr/share/nginx/html nginx:latest</code></li></ol><h4 id="volumes"><a class="header-anchor" href="#volumes" aria-hidden="true">#</a> volumes</h4><p>ä¸Šé¢å·²ç»æåˆ°äº†ï¼Œæ•°æ®å· volumeï¼Œç”¨æ¥æŠŠå®¿ä¸»æœºæŸä¸ªç›®å½•æŒ‚è½½åˆ°å®¹å™¨å†…ã€‚</p><p>ç†è§£äº†ä»¥ä¸Šå‡ ä¸ªæ¦‚å¿µï¼ŒDocker ä¹Ÿå°±ç®—å…¥é—¨äº†ã€‚æˆ‘ä»¬æ¥æ¢³ç†ä¸€ä¸‹æµç¨‹ï¼šé¦–å…ˆéœ€è¦æ‹‰å–ä¸€ä¸ªé•œåƒï¼Œç„¶åé€šè¿‡é•œåƒè¿è¡Œå®¹å™¨ï¼Œå°†å®¹å™¨å†…æœåŠ¡çš„ç«¯å£æ˜ å°„åˆ°å®¿ä¸»æœºï¼Œå°±å¯ä»¥è®¿é—®å®¹å™¨å†…çš„æœåŠ¡äº†ï¼Œå†å°†å¯¹åº”çš„ç›®å½•æŒ‚è½½åˆ°å®¿ä¸»æœºï¼Œè¿™æ ·å®¹å™¨å†…çš„æ•°æ®å°±ä¼šä¸å®¿ä¸»æœºåŒæ­¥ï¼Œç›¸å½“äºå°†å®¹å™¨å†…çš„æ•°æ®ä¿å­˜åˆ°å®¿ä¸»æœºã€‚</p><p>ä¸Šé¢æˆ‘ä»¬è®²äº†å¦‚ä½•ä½¿ç”¨é•œåƒã€å®¹å™¨çš„è¿‡ç¨‹ï¼Œåœ¨é¡¹ç›®é‡Œæˆ‘ä»¬ä¸ä»…ä»…æ˜¯ä½¿ç”¨å®ƒï¼Œè€Œä¸”è¿˜éœ€è¦ç”¨å®ƒæ¥å¸®æˆ‘ä»¬éƒ¨ç½²å¤šå¥—ç¯å¢ƒï¼Œæ¯”å¦‚å°†æˆ‘ä»¬çš„æœåŠ¡ç”Ÿæˆ Docker é•œåƒã€‚é‚£ä¹ˆï¼Œå¦‚ä½•ç”Ÿæˆ Docker é•œåƒå‘¢ï¼Ÿ</p><h3 id="å¦‚ä½•ç”Ÿæˆ-docker-é•œåƒ"><a class="header-anchor" href="#å¦‚ä½•ç”Ÿæˆ-docker-é•œåƒ" aria-hidden="true">#</a> å¦‚ä½•ç”Ÿæˆ Docker é•œåƒ</h3><p><code>Dockerfile</code> æ˜¯ç”Ÿæˆ Docker é•œåƒçš„æ–‡ä»¶ï¼Œåœ¨ <code>docker run</code> çš„æ—¶å€™æ‰§è¡Œã€‚</p><p>ä»¥æˆ‘ä»¬çš„çœŸå®é¡¹ç›®ä¸ºä¾‹ï¼Œé¦–å…ˆåœ¨é¡¹ç›®æ ¹ç›®å½•åˆ›å»ºä¸€ä¸ª <code>Dockerfile</code> å’Œ <code>.dockerignore</code> æ–‡ä»¶ï¼Œ</p><p><img src="/blog/_assets/qtable-coll-excel.8190ba50.png" alt="qtable-coll-excel"></p><p><code>Dockerfile</code> å†…å®¹å¦‚ä¸‹ï¼š</p><div class="language-bash"><pre><code>FROM node:16\nWORKDIR /usr/src\nCOPY <span class="token builtin class-name">.</span> ./\nRUN <span class="token function">npm</span> <span class="token function">install</span> --registry<span class="token operator">=</span>https://registry.npmmirror.com --ignore-scripts\nCMD <span class="token builtin class-name">export</span> <span class="token assign-left variable">PRODUCTION</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span> <span class="token function">node</span> bin/server.js\n</code></pre></div><p>è¿™äº›æŒ‡ä»¤çš„å«ä¹‰å¦‚ä¸‹ï¼š</p><ul><li><p>FROMï¼šåŸºäºä¸€ä¸ªåŸºç¡€é•œåƒæ¥ä¿®æ”¹ï¼Œæˆ‘ä»¬é¡¹ç›®æ˜¯ä¸€ä¸ª node é¡¹ç›®ï¼Œæ‰€ä»¥éœ€è¦åŸºäº node16 æ¥åˆ›å»ºé•œåƒ</p></li><li><p>WORKDIRï¼šæŒ‡å®šå½“å‰å·¥ä½œç›®å½•</p></li><li><p>COPYï¼šæŠŠå®¹å™¨å¤–çš„å†…å®¹å¤åˆ¶åˆ°å®¹å™¨å†…</p><p>é€šè¿‡ <code>WORKDIR</code> æŒ‡å®šå½“å‰å·¥ä½œç›®å½•ä¸º <code>/usr/src</code>ï¼Œæ¥ç€é€šè¿‡ <code>COPY</code> æŠŠ Dockerfile åŒçº§ç›®å½•ä¸‹çš„å†…å®¹å¤åˆ¶åˆ°å®¹å™¨å†…çš„ <code>/usr/src</code> ç›®å½•ä¸‹</p></li><li><p>RUNï¼šåœ¨å®¹å™¨å†…æ‰§è¡Œå‘½ä»¤ï¼Œå®‰è£…ä¾èµ–</p></li><li><p>CMDï¼šå¯åŠ¨å®¹å™¨æ‰§è¡Œçš„å‘½ä»¤</p></li></ul><p>.dockerignore ç±»ä¼¼äº .gitignoreï¼Œåœ¨ docker build æ—¶ï¼Œ.gitignore ä¸‹çš„æ–‡ä»¶ä¼šè¢«å¿½ç•¥ï¼Œä¸ä¼šè¢«æ‰“åŒ…åˆ° Docker é•œåƒä¸­ã€‚</p><p>æ¥ç€æˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨ docker build æ¥åˆ¶ä½œé•œåƒäº†ï¼Œè¯­æ³•å¦‚ä¸‹ï¼š</p><div class="language-bash"><pre><code><span class="token comment"># docker build -t é•œåƒå:æ ‡ç­¾å Dockerfileè·¯å¾„</span>\n<span class="token function">docker</span> build -t doc-socket-excel:0.0.3 <span class="token builtin class-name">.</span>\n<span class="token comment"># ä¹Ÿå¯ä»¥ä¸éœ€è¦æ ‡ç­¾å</span>\n<span class="token comment"># docker build -t doc-socket-excel .</span>\n</code></pre></div><p>é€šè¿‡è¾“å‡ºå¯ä»¥çœ‹åˆ°ï¼Œé¦–å…ˆæ‹‰å–äº† node16 é•œåƒï¼Œæ¥ç€æ‹‰å–æˆ‘ä»¬çš„ä»£ç å¹¶æ‰§è¡Œå‘½ä»¤ã€‚</p><p><img src="/blog/_assets/docker-make-image.a850512d.png" alt="docker-make-image"></p><p>é€šè¿‡ docker images çœ‹åˆ°æˆ‘ä»¬çš„ docker é•œåƒï¼Œé€šè¿‡ docker run è¿è¡Œå®¹å™¨ï¼Œé€šè¿‡ docker ps æŸ¥çœ‹å½“å‰è¿è¡Œçš„å®¹å™¨</p><p><img src="/blog/_assets/docker-run-image.b8a5004d.png" alt="docker-run-image"></p><p>æ¥ç€å¯ä»¥ä½¿ç”¨ <code>docker exec -it doc-socket-excel sh</code> è¿›å…¥åˆ°å®¹å™¨å†…éƒ¨ï¼Œåœ¨å¯¹åº”çš„ç›®å½•ä¸‹ï¼ˆä¹‹å‰æ‰§è¡Œçš„<code>WORKDIR</code>ï¼‰å°±èƒ½çœ‹åˆ°æˆ‘ä»¬çš„é¡¹ç›®ä»£ç ã€‚</p><p>æœ€åé€šè¿‡æŒ‚è½½çš„ logs ç›®å½•å°±èƒ½çœ‹åˆ°æˆ‘ä»¬çš„é¡¹ç›®æ—¥å¿—ã€‚</p><p><img src="/blog/_assets/docker-image-logs.55cc14cf.png" alt="docker-image-logs"></p><h2 id="gitlab-ci-yml-æ–‡ä»¶ç¼–å†™"><a class="header-anchor" href="#gitlab-ci-yml-æ–‡ä»¶ç¼–å†™" aria-hidden="true">#</a> .gitlab-ci.yml æ–‡ä»¶ç¼–å†™</h2><p><a href="https://git.qmpoa.com/help/ci/yaml/index" target="_blank" rel="noopener noreferrer">è¯­æ³•</a></p><div class="language-yml"><pre><code><span class="token key atrule">variables</span><span class="token punctuation">:</span> <span class="token comment"># å®šä¹‰å…¨å±€å˜é‡ </span>\n    PROJECT_IMAGES<span class="token punctuation">:</span> <span class="token string">&quot;irweb:$CI_COMMIT_TAG&quot;</span> <span class="token comment"># gitlabç³»ç»Ÿå˜é‡ï¼Œè·å–æäº¤tagçš„ä¿¡æ¯</span>\n</code></pre></div>',122)];o.render=function(s,a,t,o,p,l){return n(),e("div",null,c)};export{t as __pageData,o as default};
