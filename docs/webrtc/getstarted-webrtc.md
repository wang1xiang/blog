---
date: 2023-7-3
title: å®æ—¶é€šè®¯WebRTCæ‰«ç›²â€”â€”å¿«é€Ÿæ­å»º1å¯¹1éŸ³è§†é¢‘é€šè¯
tags:
  - javascript
  - WebRTC
describe: å°ç™½å¿«é€Ÿä¸Šæ‰‹WebRTC
---

## ä»€ä¹ˆæ˜¯ WebRTC

WebRTCï¼ˆWeb Real-Time Communicationsï¼‰æ˜¯ä¸€é¡¹å®æ—¶é€šè®¯æŠ€æœ¯ï¼Œå®ƒå…è®¸ç½‘ç»œåº”ç”¨æˆ–è€…ç«™ç‚¹ï¼Œåœ¨ä¸å€ŸåŠ©ä¸­é—´åª’ä»‹çš„æƒ…å†µä¸‹ï¼Œå»ºç«‹æµè§ˆå™¨ä¹‹é—´ç‚¹å¯¹ç‚¹ï¼ˆPeer-to-Peerï¼‰çš„è¿æ¥ï¼Œå®ç°è§†é¢‘æµå’Œï¼ˆæˆ–ï¼‰éŸ³é¢‘æµæˆ–è€…å…¶ä»–ä»»æ„æ•°æ®çš„ä¼ è¾“ã€‚WebRTC åŒ…å«çš„è¿™äº›æ ‡å‡†ä½¿ç”¨æˆ·åœ¨æ— éœ€å®‰è£…ä»»ä½•æ’ä»¶æˆ–è€…ç¬¬ä¸‰æ–¹çš„è½¯ä»¶çš„æƒ…å†µä¸‹ï¼Œåˆ›å»ºç‚¹å¯¹ç‚¹ï¼ˆPeer-to-Peerï¼‰çš„æ•°æ®åˆ†äº«å’Œç”µè¯ä¼šè®®æˆä¸ºå¯èƒ½ã€‚

[WebRTC](https://developer.mozilla.org/zh-CN/docs/Web/API/WebRTC_API)

## WebRTC å‘å±•å²

2011 å¹´å¼€å§‹ï¼Œ Google å…ˆåæ”¶è´­ GIPS å’Œ On2ï¼Œç»„æˆ GIPS éŸ³è§†é¢‘å¼•æ“ + VPx ç³»åˆ—è§†é¢‘ç¼–è§£ç å™¨ï¼Œå¹¶å°†å…¶ä»£ç å¼€æºï¼ŒWebRTC é¡¹ç›®åº”è¿è€Œç”Ÿã€‚
2012 å¹´ï¼ŒGoogle å°† WebRTC é›†æˆåˆ° Chrome æµè§ˆå™¨ä¸­ã€‚å¯ä»¥åœ¨æµè§ˆå™¨ä¹‹é—´å¿«é€Ÿåœ°å®ç°éŸ³è§†é¢‘é€šä¿¡ã€‚

![can-i-use-webrtc.png](./images/can-i-use-webrtc.png)

## WebRTC é€šä¿¡è¿‡ç¨‹

å¦‚æœæƒ³å®ç°ä¸€å¯¹ä¸€éŸ³è§†é¢‘é€šä¿¡ï¼Œéœ€è¦ä»¥ä¸‹ 4 éƒ¨åˆ†ï¼š

- WebRTC ç»ˆç«¯ï¼ˆä¸¤ä¸ªï¼‰ï¼šè´Ÿè´£éŸ³è§†é¢‘é‡‡é›†ã€ç¼–è§£ç ã€NAT ç©¿è¶Šä»¥åŠéŸ³è§†é¢‘æ•°æ®ä¼ è¾“ç­‰ã€‚

- Signal ä¿¡ä»¤æœåŠ¡å™¨ï¼šè´Ÿè´£ä¿¡ä»¤å¤„ç†ï¼Œå¦‚åŠ å…¥æˆ¿é—´ã€ç¦»å¼€æˆ¿é—´ã€åª’ä½“åå•†æ¶ˆæ¯çš„ä¼ é€’ç­‰ã€‚

- STUN/TURN æœåŠ¡å™¨ï¼šè´Ÿè´£è·å– WebRTC ç»ˆç«¯åœ¨å…¬ç½‘çš„ IP åœ°å€ï¼Œä»¥åŠ NAT ç©¿è¶Šå¤±è´¥åçš„æ•°æ®ä¸­è½¬æœåŠ¡ã€‚

é€šä¿¡è¿‡ç¨‹å¦‚ä¸‹ï¼š

1. æœ¬åœ°ï¼ˆWebRTC ç»ˆç«¯ï¼‰å¯åŠ¨åï¼Œæ£€æµ‹è®¾å¤‡å¯ç”¨æ€§ï¼Œå¦‚æœå¯ç”¨åå¼€å§‹éŸ³è§†é¢‘é‡‡é›†ï¼›
2. æœ¬åœ°å°±ç»ªåï¼Œå‘é€â€œåŠ å…¥â€ä¿¡ä»¤åˆ° Signal æœåŠ¡å™¨ï¼›
3. Signal æœåŠ¡å™¨åˆ›å»ºæˆ¿é—´ï¼Œç­‰å¾…åŠ å…¥ï¼›
4. å¯¹ç«¯ï¼ˆWebRTC ç»ˆç«¯ï¼‰åŒæ ·æ“ä½œï¼ŒåŠ å…¥æˆ¿é—´ï¼Œå¹¶é€šçŸ¥å¦ä¸€ç«¯ï¼›
5. åŒç«¯åˆ›å»ºåª’ä½“è¿æ¥å¯¹è±¡ [RTCPeerConnection](https://developer.mozilla.org/zh-CN/docs/Web/API/RTCPeerConnection)ï¼Œå¼€å§‹åª’ä½“åå•†ï¼›
6. åŒç«¯è¿›è¡Œè¿é€šæ€§æµ‹è¯•ï¼Œæœ€ç»ˆå»ºç«‹è¿æ¥ï¼›
7. å°†é‡‡é›†åˆ°çš„éŸ³è§†é¢‘æ•°æ®é€šè¿‡ RTCPeerConnection å¯¹è±¡è¿›è¡Œç¼–ç ï¼Œæœ€ç»ˆé€šè¿‡ P2P ä¼ é€ç»™å¯¹ç«¯/æœ¬åœ°ï¼Œå†è¿›è¡Œè§£ç ã€å±•ç¤ºã€‚

> ç¬¬ 6 æ­¥åœ¨è¿›è¡Œ P2P ç©¿è¶Šæ—¶å¾ˆæœ‰å¯èƒ½å¤±è´¥ã€‚æ‰€ä»¥ï¼Œå½“ P2P ç©¿è¶Šå¤±è´¥æ—¶ï¼Œä¸ºäº†ä¿éšœéŸ³è§†é¢‘æ•°æ®ä»ç„¶å¯ä»¥äº’é€šï¼Œåˆ™éœ€è¦é€šè¿‡ TURN æœåŠ¡å™¨è¿›è¡ŒéŸ³è§†é¢‘æ•°æ®ä¸­è½¬ã€‚åé¢ä¼šè®²åˆ° TURN æœåŠ¡æ˜¯ä»€ä¹ˆï¼Œä»¥åŠå¦‚ä½•æ­å»º TURN æœåŠ¡ã€‚

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æŒ‰ç…§é€šä¿¡è¿‡ç¨‹ï¼Œæ¥ä¸€ä¸€è®²è§£æ¯ä¸€æ­¥è¦åšçš„äº‹æƒ…ã€‚

### ç¬¬ä¸€æ­¥ï¼šéŸ³è§†é¢‘é‡‡é›†

è¿™ä¸€æ­¥ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨æµè§ˆå™¨æä¾›çš„ API è¿›è¡ŒéŸ³è§†é¢‘é‡‡é›†ï¼š[getUserMedia](https://developer.mozilla.org/zh-CN/docs/Web/API/MediaDevices/getUserMedia)

è¯­æ³•

```js
const localStream = navigator.mediaDevices.getUserMedia(constraints)
```

ä¼ é€’å‚æ•°[constraints](https://developer.mozilla.org/zh-CN/docs/Web/API/MediaDevices/getUserMedia#%E5%8F%82%E6%95%B0)ç”¨äºæŒ‡å®š MediaStream ä¸­åŒ…å«å“ªäº›ç±»å‹çš„åª’ä½“è½¨ï¼ˆéŸ³é¢‘è½¨ã€è§†é¢‘è½¨ï¼‰ï¼Œå¹¶å¯¹åª’ä½“è½¨åšè®¾ç½®ã€‚

è¿”å›ä¸€ä¸ª promise å¯¹è±¡ï¼ŒæˆåŠŸåä¼šè·å¾— MediaStream å¯¹è±¡ï¼ˆåŒ…å«ä»éŸ³è§†é¢‘è®¾å¤‡ä¸­è·å–çš„éŸ³è§†é¢‘æ•°æ®ï¼‰ï¼›å¦‚æœç”¨æˆ·æ‹’ç»æˆ–æ— æƒé™æ—¶ï¼Œåˆ™è¿”å› errorã€‚

#### Demo

é€šè¿‡`getUserMedia`æˆåŠŸå›è°ƒæ‹¿åˆ°åª’ä½“æµä¹‹åï¼Œé€šè¿‡å°†åª’ä½“æµæŒ‚è½½åˆ°`videoDOM.srcObject`å³å¯æ˜¾ç¤ºåœ¨é¡µé¢ä¸Šã€‚

æ•ˆæœå¦‚ä¸‹ï¼š

![video-demo.png](./images/video-demo.png)

åœ¨çº¿é¢„è§ˆåœ°å€ï¼š[codepen.io](https://codepen.io/wang1xiang/pen/jOQdZJz)

#### å…¶ä»–ç›¸å…³ API

##### [MediaDeviceInfo](https://developer.mozilla.org/en-US/docs/Web/API/MediaDeviceInfo)

ç”¨äºè¡¨ç¤ºæ¯ä¸ªåª’ä½“è¾“å…¥/è¾“å‡ºè®¾å¤‡çš„ä¿¡æ¯ï¼ŒåŒ…å«ä»¥ä¸‹ 4 ä¸ªå±æ€§ï¼š

- deviceId: è®¾å¤‡çš„å”¯ä¸€æ ‡è¯†ï¼›
- groupId: å¦‚æœä¸¤ä¸ªè®¾å¤‡å±äºåŒä¸€ç‰©ç†è®¾å¤‡ï¼Œåˆ™å®ƒä»¬å…·æœ‰ç›¸åŒçš„ç»„æ ‡è¯†ç¬¦ - ä¾‹å¦‚åŒæ—¶å…·æœ‰å†…ç½®æ‘„åƒå¤´å’Œéº¦å…‹é£çš„æ˜¾ç¤ºå™¨ã€‚
- label: è¿”å›æè¿°è¯¥è®¾å¤‡çš„å­—ç¬¦ä¸²ï¼Œå³è®¾å¤‡åç§°ï¼ˆä¾‹å¦‚â€œå¤–éƒ¨ USB ç½‘ç»œæ‘„åƒå¤´â€ï¼‰ï¼›
- kind: è®¾å¤‡ç§ç±»ï¼Œå¯ç”¨äºè¯†åˆ«å‡ºæ˜¯éŸ³é¢‘è®¾å¤‡è¿˜æ˜¯è§†é¢‘è®¾å¤‡ï¼Œæ˜¯è¾“å…¥è®¾å¤‡è¿˜æ˜¯è¾“å‡ºè®¾å¤‡ï¼šaudioinput/audiooutput/videoinput

é€šè¿‡`navigator.mediaDevices.enumerateDevices()`æŸ¥çœ‹å¦‚ä¸‹æ‰€ç¤ºï¼š
![enumerateDevices-demo.png](./images/enumerateDevices-demo.png)

##### [MediaDevices](https://developer.mozilla.org/zh-CN/docs/Web/API/MediaDevices)

è¯¥æ¥å£æä¾›è®¿é—®è¿æ¥åª’ä½“è¾“å…¥çš„è®¾å¤‡ï¼ˆå¦‚æ‘„åƒå¤´ã€éº¦å…‹é£ï¼‰ä»¥åŠè·å–å±å¹•å…±äº«ç­‰æ–¹æ³•ã€‚è€Œæˆ‘ä»¬éœ€è¦è·å–å¯ç”¨çš„éŸ³è§†é¢‘è®¾å¤‡åˆ—è¡¨ï¼Œå°±æ˜¯é€šè¿‡è¯¥æ¥å£ä¸­çš„æ–¹æ³•æ¥å®ç°çš„ï¼Œå¦‚å‰é¢æåˆ°çš„`getUserMedia`æ–¹æ³•ã€‚

æ–¹æ³•ï¼š

- MediaDevices.enumerateDevices()

  è·å–å¯ç”¨çš„åª’ä½“è¾“å…¥å’Œè¾“å‡ºè®¾å¤‡çš„åˆ—è¡¨ï¼Œä¾‹å¦‚ï¼šéº¦å…‹é£ã€ç›¸æœºã€è€³æœºç­‰

  ```js
  var enumeratorPromise = navigator.mediaDevices.enumerateDevices()
  ```

  è¿”å›çš„ promise å¯¹è±¡ï¼ŒæˆåŠŸå›è°ƒæ—¶ä¼šæ‹¿åˆ°æè¿°è®¾å¤‡çš„ MediaDeviceInfo åˆ—è¡¨ï¼Œç”¨æ¥å­˜æ”¾ WebRTC è·å–åˆ°çš„æ¯ä¸€ä¸ªéŸ³è§†é¢‘è®¾å¤‡ä¿¡æ¯ã€‚

- MediaDevices.getDisplayMedia()

  æç¤ºç”¨æˆ·å»é€‰æ‹©å’Œæˆæƒæ•è·å±•ç¤ºçš„å†…å®¹æˆ–éƒ¨åˆ†å†…å®¹ï¼ˆå¦‚ä¸€ä¸ªçª—å£ï¼‰åœ¨ä¸€ä¸ª MediaStream é‡Œã€‚ç„¶åï¼Œè¿™ä¸ªåª’ä½“æµå¯ä»¥é€šè¿‡ä½¿ç”¨ MediaStream Recording API è¢«è®°å½•æˆ–è€…ä½œä¸º WebRTC ä¼šè¯çš„ä¸€éƒ¨åˆ†è¢«ä¼ è¾“ã€‚ç”¨äºå…±äº«å±å¹•æ—¶ä¼ é€’ã€‚

  ```js
  var promise = navigator.mediaDevices.getDisplayMedia(constraints)
  ```

  æ¥å—å¯é€‰å‚æ•° constraints åŒ`getUserMedia`æ–¹æ³•ï¼Œä¸ä¼ æ—¶ä¹Ÿä¼šå¼€å¯è§†é¢‘è½¨é“ã€‚

  ![mediaDevices-getDisplayMedia.png](./images/mediaDevices-getDisplayMedia.png)

- MediaDevices.getUserMedia()

**éœ€è¦ Https ç¯å¢ƒæ”¯æŒï¼Œå› ä¸ºåœ¨æµè§ˆå™¨ä¸Šé€šè¿‡ HTTP è¯·æ±‚ä¸‹æ¥çš„ JavaScript è„šæœ¬æ˜¯ä¸å…è¯è®¿é—®éŸ³è§†é¢‘è®¾å¤‡çš„ï¼Œåªæœ‰é€šè¿‡ HTTPS è¯·æ±‚çš„è„šæœ¬æ‰èƒ½è®¿é—®éŸ³è§†é¢‘è®¾å¤‡ã€‚**

### ç¬¬äºŒ/ä¸‰/å››æ­¥ï¼šåŒæ–¹å‘é€ä¿¡ä»¤

#### ä»€ä¹ˆæ˜¯ä¿¡ä»¤æœåŠ¡å™¨

ä¿¡ä»¤å¯ä»¥ç®€å•ç†è§£ä¸ºæ¶ˆæ¯ï¼Œåœ¨åè°ƒé€šè®¯çš„è¿‡ç¨‹ä¸­ï¼Œä¸ºäº†å»ºç«‹ä¸€ä¸ª webRTC çš„é€šè®¯è¿‡ç¨‹ï¼Œ**åœ¨é€šä¿¡åŒæ–¹å½¼æ­¤è¿æ¥ã€ä¼ è¾“åª’ä½“æ•°æ®ä¹‹å‰ï¼Œå®ƒä»¬è¦é€šè¿‡ä¿¡ä»¤æœåŠ¡å™¨äº¤æ¢ä¸€äº›ä¿¡æ¯ï¼Œå¦‚åŠ å…¥æˆ¿é—´ã€ç¦»å¼€æˆ¿é—´åŠåª’ä½“åå•†**ç­‰ï¼Œè€Œè¿™ä¸ªè¿‡ç¨‹åœ¨ webRTC é‡Œé¢æ˜¯æ²¡æœ‰å®ç°çš„ï¼Œéœ€è¦è‡ªå·±æ­å»ºä¿¡ä»¤æœåŠ¡ã€‚

#### ä½¿ç”¨ Node æ­å»ºä¿¡ä»¤æœåŠ¡å™¨

å¯ä»¥ä½¿ç”¨ [Socket.io](https://socket.io/zh-CN/) æ¥å®ç° WebRTC ä¿¡ä»¤æœåŠ¡å™¨ï¼ŒSocket.io å·²ç»å†…ç½®äº†æˆ¿é—´çš„æ¦‚å¿µï¼Œæ‰€ä»¥éå¸¸é€‚åˆç”¨äºä¿¡ä»¤æœåŠ¡å™¨çš„åˆ›å»ºã€‚

Socket.io å‘é€æ¶ˆæ¯å’Œæ¥å—æ¶ˆæ¯ï¼Œæœ‰ä»¥ä¸‹å‡ ç§ç±»å‹ï¼š

- ç»™æœ¬æ¬¡è¿æ¥å‘æ¶ˆæ¯

  ```js
  socket.emit()
  // å¦‚ å‘é€messageæ¶ˆæ¯
  const username = 'xx'
  const message = 'hello'
  // å‘é€æ¶ˆæ¯
  socket.emit('message', username, message)
  // æ¥å—æ¶ˆæ¯
  socket.on('message', (username, message) => {
    console.log(`${username}: ${message}`)
  })
  ```

- ç»™æŸä¸ªæˆ¿é—´å†…æ‰€æœ‰äººå‘æ¶ˆæ¯(é™¤æœ¬è¿æ¥å¤–)

  ```js
  socket.to(room).emit()
  ```

- ç»™æ‰€æœ‰äººå‘æ¶ˆæ¯(é™¤æœ¬è¿æ¥å¤–)

  ```js
  socket.broadcast.emit()
  ```

æ­å»ºä¿¡ä»¤æœåŠ¡å™¨è¿‡ç¨‹å¦‚ä¸‹ï¼š

1. Socket.io åˆ†ä¸ºæœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯ä¸¤éƒ¨åˆ†ã€‚æœåŠ¡ç«¯ç”± Node.js åŠ è½½åä¾¦å¬æŸä¸ªæœåŠ¡ç«¯å£ã€‚

   ```js
   let app = express()
   let http_server = http.createServer(app)
   http_server.listen(80)

   let io = new IO(http_server, {
     path: '/',
     cors: {
       origin: '*',
     },
   })
   http_server.on('listening')
   ```

2. å®¢æˆ·ç«¯è¦æƒ³ä¸æœåŠ¡ç«¯ç›¸è¿ï¼Œé¦–å…ˆè¦åŠ è½½ Socket.io çš„å®¢æˆ·ç«¯åº“ï¼Œç„¶åè°ƒç”¨ io.connect();

   ```js
   socket = io('http://localhost:80', {
     query: { username, room },
   }).connect()
   ```

3. æ­¤æ—¶ï¼ŒæœåŠ¡ç«¯ä¼šæ¥æ”¶åˆ°`connection`æ¶ˆæ¯ï¼Œåœ¨æ­¤æ¶ˆæ¯ä¸­æ³¨å†Œæ¥å—/å‘é€æ¶ˆæ¯çš„äº‹ä»¶ï¼›

   ```js
   // ç›‘å¬è¿æ¥
   io.on(SOCKET_ON_SYS.CONNECTION, (socket) => {
   const { query } = socket.handshake
   // è·å–socketè¿æ¥å‚æ•° usernameå’Œroom
   const { username, room } = query
   ...
   })
   ```

4. å®¢æˆ·ç«¯åŒæ ·æ³¨å†Œæ¥å—/å‘é€æ¶ˆæ¯çš„äº‹ä»¶ï¼ŒåŒæ–¹å¼€å§‹é€šä¿¡ã€‚

   ```js
   socket.on(SOCKET_EMIT.MESSAGE, (room, data) => {
     logger.debug(`æ”¶åˆ°æ¶ˆæ¯: ${data}, æ¥è‡ªäºæˆ¿é—´: ${room}`)
     socket.to(room).emit(SOCKET_EMIT.MESSAGE, room, data)
   })

   socket.on(SOCKET_EMIT.LEAVE, (room, username) => {
     socket.leave(room)
     logger.debug(`ç¦»å¼€æˆ¿é—´: ${username}, æ¥è‡ªäºæˆ¿é—´: ${room}`)

     socket.emit(SOCKET_EMIT.LEAVE, room, socket.id)
   })
   ```

æœ€åï¼Œçœ‹ä¸€ä¸‹æ•ˆæœå¦‚ä¸‹ï¼š
![socketIO-demo.png](./images/socketIO-demo.png)

é¡ºä¾¿çœ‹ä¸€ä¸‹æ—¥å¿—ä¿¡æ¯ï¼š
![socketIO-demo-log](./images/socketIO-demo-log.png)

å®Œæˆä»£ç è¯·å‚è€ƒï¼š

### ç¬¬äº”æ­¥ï¼šåˆ›å»º RTCPeerConnection å¯¹è±¡ åª’ä½“åå•†

[RTCPeerConnection](https://developer.mozilla.org/zh-CN/docs/Web/API/RTCPeerConnection)ï¼šä»£è¡¨ä¸€ä¸ªç”±æœ¬åœ°è®¡ç®—æœºåˆ°è¿œç«¯çš„ WebRTC è¿æ¥ï¼Œè¯¥æ¥å£æä¾›äº†åˆ›å»ºï¼Œä¿æŒï¼Œç›‘æ§ï¼Œå…³é—­è¿æ¥çš„æ–¹æ³•çš„å®ç°ã€‚

é€šè¿‡`new RTCPeerConnection`å³å¯åˆ›å»ºä¸€ä¸ª RTCPeerConnection å¯¹è±¡ï¼Œæ­¤å¯¹è±¡ä¸»è¦è´Ÿè´£ä¸**å„ç«¯å»ºç«‹è¿æ¥ï¼ˆNAT ç©¿è¶Šï¼‰ï¼Œæ¥æ”¶ã€å‘é€éŸ³è§†é¢‘æ•°æ®**ï¼Œå¹¶ä¿éšœéŸ³è§†é¢‘çš„æœåŠ¡è´¨é‡ï¼Œæ¥ä¸‹æ¥è¦è¯´çš„ç«¯åˆ°ç«¯ä¹‹é—´çš„åª’ä½“åå•†ï¼Œä¹Ÿæ˜¯åŸºäº RTCPeerConnection å¯¹è±¡æ¥å®ç°çš„ã€‚

ç®€å•ç‚¹æ¥è¯´ï¼šâ€œRTCPeerConnection å°±æ˜¯åŠŸèƒ½å¼ºå¤§çš„ socketã€‚â€

è‡³äºå®ƒæ˜¯å¦‚ä½•ä¿éšœç«¯ä¸ç«¯ä¹‹é—´çš„è¿é€šæ€§ï¼Œå¦‚ä½•ä¿è¯éŸ³è§†é¢‘çš„æœåŠ¡è´¨é‡ï¼Œåˆå¦‚ä½•ç¡®å®šä½¿ç”¨çš„æ˜¯å“ªä¸ªç¼–è§£ç å™¨ç­‰é—®é¢˜ï¼Œä½œä¸ºåº”ç”¨è€…æˆ‘ä»¬å¤§å¯ä¸å¿…å…³å¿ƒï¼Œå› ä¸ºæ‰€æœ‰çš„è¿™äº›é—®é¢˜éƒ½å·²ç»åœ¨ RTCPeerConnection å¯¹è±¡çš„åº•å±‚å®ç°å¥½äº†ã€‚

```js
const localPc = new RTCPeerConnection(rtcConfig)
// å°†éŸ³è§†é¢‘æµæ·»åŠ åˆ° RTCPeerConnection å¯¹è±¡ä¸­
localStream.getTracks().forEach((track) => {
  localPc.addTrack(track, localStream)
})
```

æˆ‘ä»¬åœ¨ç¬¬ä¸€æ­¥è·å–éŸ³è§†é¢‘æµåï¼Œéœ€è¦å°†æµæ·»åŠ åˆ°åˆ›å»ºçš„ RTCPeerConnection å¯¹è±¡ä¸­ï¼Œå½“ RTCPeerConnection å¯¹è±¡è·å¾—éŸ³è§†é¢‘æµåï¼Œå°±å¯ä»¥å¼€å§‹ä¸å¯¹ç«¯è¿›è¡Œåª’åä½“åå•†ã€‚

#### ä»€ä¹ˆæ˜¯åª’ä½“åå•†

åª’ä½“åå•†çš„ä½œç”¨æ˜¯æ‰¾åˆ°åŒæ–¹å…±åŒæ”¯æŒçš„åª’ä½“èƒ½åŠ›ï¼Œå¦‚åŒæ–¹å„è‡ªæ”¯æŒçš„ç¼–è§£ç å™¨ï¼ŒéŸ³é¢‘çš„å‚æ•°é‡‡æ ·ç‡ï¼Œé‡‡æ ·å¤§å°ï¼Œå£°é“æ•°ã€è§†é¢‘çš„å‚æ•°åˆ†è¾¨ç‡ï¼Œå¸§ç‡ç­‰ç­‰ã€‚ç±»ä¼¼äºç”·å¥³ç›¸äº²çš„ä¸­é—´äººï¼Œé€šè¿‡ä¸­é—´äººç”·çš„çŸ¥é“äº†å¥³çš„èº«é«˜ã€é¢œå€¼ã€èº«æï¼Œå¥³çš„ç†è§£äº†ç”·çš„å®¶åº­ã€è´¢å¯Œã€åœ°ä½ï¼Œä½ ä¿©è§‰å¾—â€œå“‡è¿™ä¹ˆåˆé€‚â€ï¼Œèµ¶ç´§è§é¢æ·±å…¥äº¤æµä¸€ä¸‹ ğŸ’“ã€‚

ä¸Šè¿°è¯´åˆ°çš„è¿™äº›éŸ³é¢‘/è§†é¢‘çš„ä¿¡æ¯éƒ½ä¼šåœ¨ SDPï¼ˆSession Description Protocalï¼šå³ä½¿ç”¨æ–‡æœ¬æè¿°å„ç«¯çš„â€œèƒ½åŠ›â€ï¼‰ä¸­è¿›è¡Œæè¿°ã€‚

> ä¸€å¯¹ä¸€çš„åª’ä½“åå•†å¤§è‡´å¦‚ä¸‹ï¼šé¦–å…ˆè‡ªå·±åœ¨ SDP ä¸­è®°å½•è‡ªå·±æ”¯æŒçš„éŸ³é¢‘/è§†é¢‘å‚æ•°å’Œä¼ è¾“åè®®ï¼Œç„¶åè¿›è¡Œä¿¡ä»¤äº¤äº’ï¼Œäº¤äº’çš„è¿‡ç¨‹ä¼šåŒæ—¶ä¼ é€’ SDP ä¿¡æ¯ï¼Œå¦ä¸€æ–¹æ¥æ”¶åä¸è‡ªå·±çš„ SDP ä¿¡æ¯æ¯”å¯¹ï¼Œå¹¶å–å‡ºå®ƒä»¬ä¹‹é—´çš„äº¤é›†ï¼Œè¿™ä¸ªäº¤é›†å°±æ˜¯å®ƒä»¬åå•†çš„ç»“æœï¼Œä¹Ÿå°±æ˜¯å®ƒä»¬æœ€ç»ˆä½¿ç”¨çš„éŸ³è§†é¢‘å‚æ•°åŠä¼ è¾“åè®®ã€‚

#### åª’ä½“åå•†è¿‡ç¨‹

ä¸€å¯¹ä¸€é€šä¿¡ä¸­ï¼Œå‘èµ·æ–¹å‘é€çš„ SDP ç§°ä¸ºæè®®(Offer)ï¼Œæ¥æ”¶æ–¹å‘é€çš„ SDP ç§°ä¸ºåº”ç­”(Answer)ã€‚æ¯ç«¯ä¿æŒä¸¤ä¸ªæè¿°ï¼šæè¿°æœ¬èº«çš„**æœ¬åœ°æè¿° LocalDescription**å’Œæè¿°å‘¼å«çš„è¿œç«¯çš„**è¿œç¨‹æè¿° RemoteDescription**ã€‚å½“é€šä¿¡åŒæ–¹ RTCPeerConnection å¯¹è±¡åˆ›å»ºå®Œæˆåï¼Œå°±å¯ä»¥è¿›è¡Œåª’ä½“åå•†äº†ï¼Œå¤§è‡´è¿‡ç¨‹å¦‚ä¸‹ï¼š

1. å‘èµ·æ–¹åˆ›å»º Offer ç±»å‹çš„ SDPï¼Œä¿å­˜ä¸ºæœ¬åœ°æè¿°åå†é€šè¿‡ä¿¡ä»¤æœåŠ¡å™¨å‘é€åˆ°å¯¹ç«¯ï¼›
2. æ¥æ”¶æ–¹æ¥æ”¶åˆ° Offer ç±»å‹çš„ SDPï¼Œå°† Offer ä¿å­˜ä¸ºè¿œç¨‹æè¿°ï¼›
3. æ¥æ”¶æ–¹åˆ›å»º Answer ç±»å‹çš„ SDPï¼Œä¿å­˜ä¸ºæœ¬åœ°æè¿°ï¼Œå†é€šè¿‡ä¿¡ä»¤æœåŠ¡å™¨å‘é€åˆ°å‘èµ·æ–¹ï¼Œæ­¤æ—¶æ¥æ”¶æ–¹å·²çŸ¥é“è¿æ¥åŒæ–¹çš„é…ç½®ï¼›
4. å‘èµ·æ–¹æ¥æ”¶åˆ° Answer ç±»å‹çš„ SDP åä¿å­˜åˆ°è¿œç¨‹æè¿°ï¼Œæ­¤æ—¶å‘èµ·æ–¹ä¹Ÿå·²çŸ¥é“è¿æ¥åŒæ–¹çš„é…ç½®ï¼›
5. æ•´ä¸ªåª’ä½“åå•†è¿‡ç¨‹å¤„ç†å®Œæ¯•ã€‚

æ›´è¯¦ç»†çš„æ­¥éª¤è¯·å‚è€ƒ MDN ä¸­å¯¹[ä¼šè¯æè¿°](https://developer.mozilla.org/zh-CN/docs/Web/API/WebRTC_API/Connectivity#%E4%BC%9A%E8%AF%9D%E6%8F%8F%E8%BF%B0)è®²è§£ã€‚

#### ä»£ç å®ç°åª’ä½“åå•†è¿‡ç¨‹

é€šè¿‡ MDN å…ˆäº†è§£ä¸‹æˆ‘ä»¬å¯èƒ½ç”¨åˆ°çš„ APIï¼š

- [createOffer](https://developer.mozilla.org/zh-CN/docs/Web/API/RTCPeerConnection/createOffer)ç”¨äºåˆ›å»º Offerï¼›
- [createAnswer](https://developer.mozilla.org/en-US/docs/Web/API/RTCPeerConnection/createAnswer)ç”¨äºåˆ›å»º Answerï¼›
- [setLocalDescription](https://developer.mozilla.org/en-US/docs/Web/API/RTCPeerConnection/setLocalDescription)ç”¨äºè®¾ç½®æœ¬åœ° SDP ä¿¡æ¯ï¼›
- [setRemoteDescription](https://developer.mozilla.org/zh-CN/docs/Web/API/RTCPeerConnection/setRemoteDescription)ç”¨äºè®¾ç½®è¿œç«¯çš„ SDP ä¿¡æ¯ã€‚

##### å‘èµ·æ–¹åˆ›å»º RTCPeerConnection

```js
// é…ç½®
export const rtcConfig = null
const localPc = new RTCPeerConnection(rtcConfig)
```

##### å‘èµ·æ–¹/æ¥æ”¶æ–¹åˆ›å»º Offer ä¿å­˜ä¸ºæœ¬åœ°æè¿°

å‘èµ·æ–¹æˆ–æ¥æ”¶æ–¹ä½•æ—¶åˆ›å»º Offer å‘¢ï¼Ÿ

å½“æˆ¿é—´å†…æœ‰ä¸¤ä¸ªäººæ—¶ï¼Œå‘èµ·æ–¹/æ¥æ”¶æ–¹å¼€å§‹åˆ›å»º offerï¼Œå¹¶é€šè¿‡ä¹‹å‰çš„ä¿¡ä»¤æœåŠ¡å™¨å‘é€ Offerï¼Œä»£ç å¦‚ä¸‹ï¼š

```js
let offer = await localPc.createOffer()
// ä¿å­˜ä¸ºæœ¬åœ°æè¿°
await localPc.setLocalDescription(offer)
// é€šè¿‡ä¿¡ä»¤æœåŠ¡å™¨å‘é€åˆ°å¯¹ç«¯
socket.emit('offer', offer)
```

##### æ¥å— Offer å åˆ›å»º Answer å¹¶å‘é€

```js
socket.on('offer', offer) => {
  // å°† Offer ä¿å­˜ä¸ºè¿œç¨‹æè¿°ï¼›
  await remotePc.setRemoteDescription(remoteDesc);
  remotePc = new RTCPeerConnection(rtcConfig)
   await remotePc.setRemoteDescription(remoteDesc)
   let remoteAnswer = await remotePc.createAnswer()
   await remotePc.setLocalDescription(remoteAnswer)
   socket.emit('answer', remoteAnswer)
});
```

##### æ¥å— Answer å­˜å‚¨ä¸ºè¿œç¨‹æè¿°

```js
// 4. å‘èµ·æ–¹æ¥æ”¶åˆ° Answer ç±»å‹çš„ SDP åä¿å­˜åˆ°è¿œç¨‹æè¿°ï¼Œæ­¤æ—¶å‘èµ·æ–¹ä¹Ÿå·²çŸ¥é“è¿æ¥åŒæ–¹çš„é…ç½®ï¼›
socket.on('answer', answer) => {
  // å°† Answer ä¿å­˜ä¸ºè¿œç¨‹æè¿°ï¼›
  await localPc.setRemoteDescription(answer);
});
```

è‡³æ­¤ï¼Œåª’ä½“åå•†ç»“æŸï¼Œç´§æ¥ç€åœ¨ WebRTC åº•å±‚ä¼šæ”¶é›† Candidateï¼Œå¹¶è¿›è¡Œè¿é€šæ€§æ£€æµ‹ï¼Œæœ€ç»ˆåœ¨é€šè¯åŒæ–¹ä¹‹é—´å»ºç«‹èµ·ä¸€æ¡é“¾è·¯æ¥ã€‚

### ç¬¬å…­æ­¥ï¼šç«¯ä¸ç«¯å»ºç«‹è¿æ¥

åª’ä½“åå•†ç»“æŸåï¼ŒåŒç«¯ç»Ÿä¸€äº†ä¼ è¾“åè®®ã€ç¼–è§£ç å™¨ç­‰ï¼Œæ­¤æ—¶å°±éœ€è¦å»ºç«‹è¿æ¥å¼€å§‹éŸ³è§†é¢‘é€šä¿¡äº†ã€‚

ä½† WebRTC æ—¢è¦ä¿æŒéŸ³è§†é¢‘é€šä¿¡çš„**è´¨é‡**ï¼Œåˆè¦ä¿è¯**è”é€š**ã€‚æ‰€æœ‰ï¼Œå½“åŒæ—¶å­˜åœ¨å¤šä¸ªæœ‰æ•ˆè¿æ¥æ—¶ï¼Œå®ƒé¦–å…ˆé€‰æ‹©ä¼ è¾“è´¨é‡æœ€å¥½çš„çº¿è·¯ï¼Œå¦‚èƒ½ç”¨å†…ç½‘è¿é€šå°±ä¸ç”¨å…¬ç½‘ï¼Œä¼˜å…ˆ P2P ä¼ è¾“ï¼Œå¦‚æœ P2P ä¸é€šæ‰ä¼šé€‰æ‹©ä¸­ç»§æœåŠ¡å™¨ï¼ˆrelay æœåŠ¡å™¨æˆ– TURN æœåŠ¡å™¨ï¼‰ï¼Œå› ä¸ºä¸­ç»§æ–¹å¼ä¼šå¢åŠ åŒç«¯ä¼ è¾“çš„æ—¶é•¿ã€‚

#### ä»€ä¹ˆæ˜¯ Candidate

ç¬¬äº”æ­¥æœ€åï¼Œæˆ‘ä»¬æåˆ°äº†åª’ä½“åå•†ç»“æŸåï¼Œå¼€å§‹æ”¶é›† Candidateï¼Œé‚£ä¹ˆæˆ‘ä»¬æ¥äº†è§£ä¸‹ä»€ä¹ˆæ˜¯ Candidateã€ä»¥åŠå®ƒçš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿ

[ICE Candidate](https://developer.mozilla.org/zh-CN/docs/Web/API/RTCPeerConnection/icecandidate_event)ï¼ˆICE å€™é€‰è€…ï¼‰ï¼šè¡¨ç¤º WebRTC ä¸è¿œç«¯é€šä¿¡æ—¶ä½¿ç”¨çš„åè®®ã€IP åœ°å€å’Œç«¯å£ï¼Œç»“æ„å¦‚ä¸‹ï¼š

```js
{
  address: xxx.xxx.xxx.xxx, // æœ¬åœ°IPåœ°å€
  port: number, // æœ¬åœ°ç«¯å£å·
  type: 'host/srflx/relay', // å€™é€‰è€…ç±»å‹
  priority: number, // ä¼˜å…ˆçº§
  protocol: 'udp/tcp', // ä¼ è¾“åè®®
  usernameFragment: string // è®¿é—®æœåŠ¡çš„ç”¨æˆ·å
  ...
}
```

![ice-candidate-demo.png](./images/ice-candidate-demo.png)

WebRTC åœ¨è¿›è¡Œè¿æ¥æµ‹è¯•åæ—¶ï¼Œé€šä¿¡åŒç«¯ä¼šæä¾›ä¼—å¤šå€™é€‰è€…ï¼Œç„¶åæŒ‰ç…§ä¼˜å…ˆçº§è¿›è¡Œè¿é€šæ€§æµ‹è¯•ï¼Œæµ‹è¯•æˆåŠŸå°±ä¼šå»ºç«‹è¿æ¥ã€‚

å€™é€‰è€… Candidate ç±»å‹ï¼Œå³ type åˆ†ä¸ºä¸‰ç§ç±»å‹ï¼š

- hostï¼šæœ¬æœºå€™é€‰è€…

  ä¼˜å…ˆçº§æœ€é«˜ï¼Œhost ç±»å‹ä¹‹é—´çš„è¿é€šæ€§æµ‹è¯•å°±æ˜¯å†…ç½‘ä¹‹é—´çš„è¿é€šæ€§æµ‹è¯•ï¼ŒP2P

- srflxï¼šå†…ç½‘ä¸»æœºæ˜ å°„çš„å¤–ç½‘åœ°å€å’Œç«¯å£

  å¦‚æœ host æ— æ³•å»ºç«‹è¿æ¥ï¼Œåˆ™é€‰æ‹© srflx è¿æ¥ï¼Œå³ P2P è¿æ¥

- relayï¼šä¸­ç»§å€™é€‰è€…

  ä¼˜å…ˆçº§æœ€ä½ï¼Œåªæœ‰ä¸Šè¿°ä¸¤ç§ä¸å­˜åœ¨æ—¶ï¼Œæ‰ä¼šèµ°ä¸­ç»§æœåŠ¡å™¨çš„æ¨¡å¼ï¼Œå› ä¸ºä¼šå¢åŠ ä¼ è¾“æ—¶é—´ï¼Œä¼˜å…ˆçº§æœ€ä½

#### å¦‚ä½•æ”¶é›† Candidate

æˆ‘ä»¬å·²ç»äº†è§£äº† Candidate çš„ä¸‰ç§ç±»å‹ä»¥åŠå„è‡ªçš„ä¼˜å…ˆçº§ï¼Œé‚£ä¹ˆæˆ‘ä»¬çœ‹ä¸‹åŒç«¯æ˜¯å¦‚ä½•æ”¶é›† Candidate çš„ã€‚

##### host ç±»å‹

host ç±»å‹çš„ Candidate æ˜¯æœ€å¥½æ”¶é›†çš„ï¼Œå°±æ˜¯æœ¬æœºçš„ ip åœ°å€ å’Œç«¯å£

##### srflx å’Œ relay ç±»å‹

srflx ç±»å‹çš„ Candidate å°±æ˜¯å†…ç½‘é€šè¿‡ NATï¼ˆNet Address Translationï¼Œä½œç”¨æ˜¯è¿›è¡Œå†…å¤–ç½‘çš„åœ°å€è½¬æ¢ï¼Œä½äºå†…ç½‘çš„ç½‘å…³ä¸Šï¼‰æ˜ å°„åçš„å¤–ç½‘åœ°å€ã€‚å¦‚ï¼šè®¿é—®ç™¾åº¦æ—¶ NAT ä¼šå°†ä¸»æœºå†…ç½‘åœ°å€è½¬æ¢ä¸ºå¤–ç½‘åœ°å€ï¼Œå‘é€è¯·æ±‚åˆ°ç™¾åº¦çš„æœåŠ¡å™¨ï¼ŒæœåŠ¡å™¨è¿”å›åˆ°å…¬ç½‘åœ°å€å’Œç«¯å£ï¼Œåœ¨é€šè¿‡ NAT è½¬åˆ°å†…ç½‘çš„ä¸»æœºä¸Šã€‚

WebRTC ä¼šæ€ä¹ˆå¤„ç† NAT å‘¢ï¼Ÿ

æ²¡é”™ï¼Œå°±æ˜¯æˆ‘ä»¬ä¹‹å‰æåˆ°çš„ **STUN** å’Œ **TURN**

##### STUN åè®®

å…¨ç§° Session Traversal Utilities for NATï¼ˆNAT ä¼šè¯ç©¿è¶Šåº”ç”¨ç¨‹åºï¼‰ï¼Œæ˜¯ä¸€ç§ç½‘ç»œåè®®ï¼Œå®ƒå…è®¸ä½äº NAT åçš„å®¢æˆ·ç«¯æ‰¾å‡ºè‡ªå·±çš„å…¬ç½‘åœ°å€ï¼Œä¹Ÿå°±æ˜¯**éµå®ˆè¿™ä¸ªåè®®å°±å¯ä»¥æ‹¿åˆ°è‡ªå·±çš„å…¬ç½‘ IP**ã€‚

STUN æœåŠ¡å™¨å¯ä»¥ç›´æ¥ä½¿ç”¨ google æä¾›çš„å…è´¹æœåŠ¡ `stun.l.google.com:19302`ï¼Œæˆ–è€…è‡ªå·±æ­å»ºã€‚

##### TURN åè®®

å…¨ç§° Traversal Using Relays around NATï¼ˆä½¿ç”¨ä¸­ç»§ç©¿é€ NATï¼‰ï¼ŒSTUN çš„ä¸­ç»§æ‰©å±•ã€‚ç®€å•çš„è¯´ï¼ŒTURN ä¸ STUN çš„å…±åŒç‚¹éƒ½æ˜¯é€šè¿‡ä¿®æ”¹åº”ç”¨å±‚ä¸­çš„ç§ç½‘åœ°å€è¾¾åˆ° NAT ç©¿é€çš„æ•ˆæœï¼Œå¼‚åŒç‚¹æ˜¯ TURN æ˜¯é€šè¿‡ä¸¤æ–¹é€šè®¯çš„â€œä¸­é—´äººâ€æ–¹å¼å®ç°ç©¿é€ã€‚

> ä¸Šé¢æåˆ°çš„ relay æœåŠ¡å°±æ˜¯é€šè¿‡ TURN åè®®å®ç°çš„ï¼Œæ‰€ä»¥ relay æœåŠ¡å™¨å’Œ TURN æœåŠ¡å™¨æ˜¯åŒä¸€ä¸ªæ„æ€ï¼Œéƒ½æ˜¯ä¸­ç»§æœåŠ¡å™¨ã€‚

relay ç±»å‹çš„ Candidate è·å–æ˜¯é€šè¿‡ TURN åè®®å®Œæˆï¼Œå®ƒçš„**è¿é€šç‡æ˜¯æ‰€æœ‰å€™é€‰è€…ä¸­è¿é€šç‡æœ€é«˜çš„**ï¼Œä¼˜å…ˆçº§ä¹Ÿæ˜¯æœ€ä½çš„ã€‚

WebRTC é¦–ä¼šå…ˆä½¿ç”¨ STUN æœåŠ¡å™¨å»æ‰¾å‡ºè‡ªå·±çš„ NAT ç¯å¢ƒï¼Œç„¶åè¯•å›¾æ‰¾å‡ºæ‰“â€œæ´â€çš„æ–¹å¼ï¼Œæœ€åè¯•å›¾åˆ›å»ºç‚¹å¯¹ç‚¹è¿æ¥ã€‚
å½“å®ƒå°è¯•è¿‡ä¸åŒçš„ç©¿é€æ–¹å¼éƒ½å¤±è´¥ä¹‹åï¼Œä¸ºä¿è¯é€šä¿¡æˆåŠŸç‡ä¼šå¯ç”¨ TURN æœåŠ¡å™¨è¿›è¡Œä¸­è½¬ï¼Œæ­¤æ—¶æ‰€æœ‰çš„æµé‡éƒ½ä¼šé€šè¿‡ TURN æœåŠ¡å™¨ã€‚è¿™æ—¶å¦‚æœ TURN æœåŠ¡å™¨é…ç½®ä¸å¥½æˆ–å¸¦å®½ä¸å¤Ÿæ—¶ï¼Œé€šä¿¡è´¨é‡å°±ä¼šå˜å·®ã€‚

**STUN æœåŠ¡å™¨æ˜¯ç”¨æ¥è·å–å¤–ç½‘åœ°å€è¿›è¡Œ P2Pï¼›è€Œ TURN æœåŠ¡å™¨æ˜¯åœ¨ P2P å¤±è´¥æ—¶è¿›è¡Œè½¬å‘çš„**

##### NAT æ‰“æ´/P2P ç©¿è¶Š

NAT è§£å†³äº† IPv4 åœ°å€ä¸å¤Ÿç”¨çš„æƒ…å†µï¼Œä½†å› ä¸ºæœ‰äº† NATï¼Œç«¯ä¸ç«¯ä¹‹é—´çš„ç½‘ç»œè¿æ¥å˜å¾—å¤æ‚ï¼Œä¹Ÿå°±éœ€è¦ NAT ç©¿è¶Šç­‰æŠ€æœ¯ã€‚

æ”¶é›†å®Œ Candidate åï¼ŒWebRTC å°±æŒ‰ç…§ä¼˜å…ˆçº§é¡ºåºè¿›è¡Œè¿é€šæ€§æ£€æµ‹ã€‚å¦‚æœåŒæ–¹ä½äºåŒä¸€ä¸ªå±€åŸŸç½‘ï¼Œå°±ä¼šç›´æ¥å»ºç«‹è¿æ¥ï¼Œå¦‚æœä¸åœ¨åŒä¸€ä¸ªå±€åŸŸç½‘å†…ï¼ŒWebRTC å°±ä¼šå°è¯• NAT æ‰“æ´ï¼Œå³ P2P ç©¿è¶Šäº†ã€‚

##### ICE

å…¨ç§° Interactive Connectivity Establishmentï¼ˆäº¤äº’å¼è¿é€šå»ºç«‹æ–¹å¼ï¼‰ï¼ŒICE åè®®é€šè¿‡ä¸€ç³»åˆ—çš„æŠ€æœ¯ï¼ˆå¦‚ STUNã€TURN æœåŠ¡å™¨ï¼‰å¸®åŠ©é€šä¿¡åŒæ–¹å‘ç°å’Œåå•†å¯ç”¨çš„å…¬å…±ç½‘ç»œåœ°å€ï¼Œä»è€Œå®ç° NAT ç©¿è¶Šï¼Œä¹Ÿå°±æ˜¯ä¸Šé¢è¯´çš„è·å–æ‰€æœ‰å€™é€‰è€…ç±»å‹çš„è¿‡ç¨‹ï¼Œå³ï¼šåœ¨æœ¬æœºæ”¶é›†æ‰€æœ‰çš„ host ç±»å‹çš„ Candidateï¼Œé€šè¿‡ STUN åè®®æ”¶é›† srflx ç±»å‹çš„ Candidateï¼Œä½¿ç”¨ TURN åè®®æ”¶é›† relay ç±»å‹çš„ Candidateã€‚

#### ä»£ç å®ç°æ”¶é›† Candidate

å½“ Candidate è¢«æ”¶é›†ä¹‹åï¼Œä¼šè§¦å‘`icecandidate`äº‹ä»¶ï¼Œæ‰€ä»¥éœ€è¦åœ¨ä»£ç ä¸­ç›‘å¬æ­¤äº‹ä»¶ï¼Œä»¥å¯¹æ”¶é›†åˆ°çš„ Candidate åšå¤„ç†ã€‚

```js
localPc.onicecandidate = function (event) {
  console.log('localPc:', event.candidate, event)
  // å›è°ƒæ—¶ï¼Œå°†è‡ªå·±candidateå‘ç»™å¯¹æ–¹ï¼Œå¯¹æ–¹å¯ä»¥ç›´æ¥addIceCandidate(candidate)æ·»åŠ å¯ä»¥è·å–æµ
  if (event.candidate) socket.emit('candidate', event.candidate)
}
```

æ‰“å°å‡ºçš„ Candidate å¦‚ä¸‹æ‰€ç¤ºï¼š
![on-icecandidate.png](./images/on-icecandidate.png)

ä¸æˆ‘ä»¬ä¸Šé¢æåˆ°çš„ Candidate ç»“æ„ä¸€è‡´ï¼Œå…¶ä¸­`type`å­—æ®µä¸º`host`ï¼Œå³æœ¬æœºå€™é€‰è€…ã€‚

å¯¹ç«¯æ¥æ”¶åˆ°å‘é€çš„ candidate åï¼Œå†è°ƒç”¨ RTCPeerConnection å¯¹è±¡çš„ addIceCandidate() æ–¹æ³•å°†æ”¶åˆ°çš„ Candidate ä¿å­˜èµ·
æ¥ï¼Œç„¶åæŒ‰ç…§ Candidate çš„ä¼˜å…ˆçº§è¿›è¡Œè¿é€šæ€§æ£€æµ‹ã€‚

```js
await remotePc.addIceCandidate(candidate)
```

å¦‚æœ Candidate è¿é€šæ€§æ£€æµ‹å®Œæˆï¼Œé‚£ä¹ˆç«¯ä¸ç«¯ä¹‹é—´å°±å»ºç«‹äº†ç‰©ç†è¿æ¥ï¼Œè¿™æ—¶åª’ä½“æ•°æ®å°±å¯èƒ½é€šè¿™ä¸ªç‰©ç†è¿æ¥æºæºä¸æ–­åœ°ä¼ è¾“äº†ã€‚

### ç¬¬ä¸ƒæ­¥ï¼šæ˜¾ç¤ºè¿œç«¯æµ

é€šä¿¡åŒæ–¹é€šè¿‡ RTCPeerConnection å»ºç«‹è¿æ¥åï¼Œæœ¬åœ°çš„éŸ³è§†é¢‘æ•°æ®æºæºä¸æ–­çš„ä¼ è¾“ï¼Œè¦æƒ³åœ¨è¿œç«¯å±•ç¤ºå‡ºæ¥ï¼Œå°±éœ€è¦å°† RTCPeerConnection å¯¹è±¡ä¸`<video>`æˆ–`<audio>`è¿›è¡Œç»‘å®šã€‚

å½“è¿œç«¯åˆ›å»ºå¥½ RTCPeerConnection å¯¹è±¡åï¼Œä¼šä¸º RTCPeerConnection ç»‘å®š`ontrack`äº‹ä»¶ï¼Œå½“æœ‰éŸ³è§†é¢‘æ•°æ®æµåˆ°æ¥æ—¶ï¼Œè¾“å…¥å‚æ•° event ä¸­åŒ…å«äº†è¿œç«¯çš„éŸ³è§†é¢‘æµï¼Œå³ MediaStream å¯¹è±¡ï¼Œæ­¤æ—¶å°†æ­¤å¯¹è±¡èµ‹å€¼ç»™`<video>`æˆ–`<audio>`çš„`srcObject`å­—æ®µï¼Œè¿™æ · RTCPeerConnection å¯¹è±¡å°±ä¸`<video>`æˆ–`<audio>`è¿›è¡Œäº†ç»‘å®šï¼ŒéŸ³é¢‘æˆ–è§†é¢‘å°±èƒ½å±•ç¤ºå‡ºæ¥ã€‚

```js
remotePc.ontrack = (e) => {
  video.srcObject = e.streams[0]
  video.oncanplay = () => video.play()
}
```

æ”¯æŒï¼Œä¸€ä¸ªå®Œæ•´çš„ WebRTC é€šä¿¡è¿‡ç¨‹å°±ç»“æŸäº† ğŸ‰ğŸ‰ğŸ‰ã€‚

## æ­å»º 1 å¯¹ 1 éŸ³è§†é¢‘èŠå¤©

åŸºäºä»¥ä¸Š WebRTC é€šä¿¡è¿‡ç¨‹çš„æè¿°ï¼Œæˆ‘ä»¬æ¥åŠ¨æ‰‹å®è·µä¸€å¯¹ä¸€éŸ³è§†é¢‘èŠå¤©ã€‚

## TURN æœåŠ¡å™¨çš„æ­å»º

TURN æœåŠ¡æœ‰ä¸¤ä¸ªä½œç”¨ï¼šä¸€æ˜¯æä¾› STUN æœåŠ¡ï¼Œå®¢æˆ·ç«¯é€šè¿‡ STUN æœåŠ¡è·å–è‡ªå·±çš„å…¬ç½‘åœ°å€ï¼›è€Œæ˜¯æä¾›æ•°æ®ä¸­ç»§æœåŠ¡ï¼ˆå½“æ•°æ®é€šä¿¡åŒæ–¹æ— æ³•é€šè¿‡ P2P ä¼ è¾“æ—¶ï¼Œå°±éœ€è¦é€šè¿‡ä¸­ç»§çš„æ–¹å¼è®©é€šä¿¡åŒæ–¹çš„æ•°æ®å¯ä»¥äº’é€šï¼‰ã€‚

1. ä¸‹è½½æºç 

   ç›®å‰æœ€è‘—åçš„ TURN æœåŠ¡å™¨æ˜¯ç”± Google å‘èµ·çš„å¼€æºé¡¹ç›® [coturn](https://github.com/coturn/coturn),coturn æœåŠ¡å™¨å®Œæ•´çš„å®ç°äº† STUN/TURN/ICE åè®®ï¼Œæ”¯æŒ P2P ç©¿é€é˜²ç«å¢™ã€‚

   ```bash
   git clone https://github.com/coturn/coturn
   ```

2. ç”Ÿæˆ Markfile

   ```bash
   cd coturn
   ./configure --prefix=/usr/local/coturn
   ```

   éœ€è¦å®‰è£… libevent åº“ï¼Œä¸ç„¶ä¼šæŠ¥é”™

   ![coturn-make-error.png](./images/coturn-make-error.png)

3. å®‰è£… libevent

   å¦‚æœå·²ç»å®‰è£…è¿‡ï¼Œåˆ™å¿½ç•¥è¿™ä¸€æ­¥

   é¦–å…ˆå®‰è£…è¿è¡Œ coturn éœ€è¦ä¾èµ–çš„ç¯å¢ƒ

   ```bash
   yum install openssl openssl-libs libevent2 libevent-devel
   ```

   å¦‚æœ libevent2 å®‰è£…å¤±è´¥ï¼Œæ‰‹åŠ¨å®‰è£…
   ä¸‹è½½åœ°å€ï¼šhttp://libevent.org/

   ```bash
   # è§£å‹
   tar -xf libevent-2.0.22-stable.tar.gz
   cd ibevent-2.0.22-stable
   # ç”ŸæˆMarkfile
    ./configure --prefix=/usr
   # æ‰§è¡Œmakeç¼–è¯‘libevent
   make
   # å®‰è£…
   make install
   ```

   å®Œæˆåï¼Œæµ‹è¯•æ˜¯å¦å®‰è£…æˆåŠŸ

   ```bash
   ls -a /usr/lib |grep libevent
   ```

   ![libevent-success.png](./images/libevent-success.png)

4. ç»§ç»­å®‰è£… coturn

   ```bash
   ./configure
   make
   make install
   ```

5. éªŒè¯ coturn æœåŠ¡æ˜¯å¦å®‰è£…æˆåŠŸ

   ```bash
   which turnserver
   # /usr/local/bin/turnserver
   ```

6. ç”Ÿæˆç­¾å

   ```bash
   cd /usr/local/etc/

   openssl req -x509 -newkey rsa:2048 -keyout /usr/local/etc/turn_server_pkey.pem -out /usr/local/etc/turn_server_cert.pem -days 99999 -nodes
   ```

   ä¸€è·¯å›è½¦å³å¯ï¼Œå®Œæˆååœ¨/use/local/etc ç›®å½•ä¸‹å°±æœ‰äº†`turn_server_pkey.pem`å’Œ`turn_server_cert.pem`ä¸¤ä¸ªæ–‡ä»¶ã€‚

7. ä¿®æ”¹é…ç½®æ–‡ä»¶

   ```bash
   cp turnserver.conf.default turnserver.conf
   vim turnserver.conf
   ```

   ```bash
   # ç½‘å¡
   listening-device=eth0
   # ç›‘å¬çš„ç«¯å£
   listening-port=3478
   # ç»‘å®šçš„å…¬ç½‘åœ°å€
   external-ip=43.140.xxx.xx
   # ç”¨æˆ·åå’Œå¯†ç 
   user=admin:123456
   # åç§°
   realm=admin
   ```

8. å¯åŠ¨ turnserver

   ```bash
   ./turnserver ../etc/turnserver.conf
   ```

   æŸ¥çœ‹æ˜¯å¦å¯åŠ¨æˆåŠŸ

   ```bash
   ps -ef|grep turnserver
   ```

9. æ£€æµ‹

   åœ¨çº¿æ£€æµ‹ ICE ç©¿é€çš„åœ°å€ï¼š[https://webrtc.github.io...](https://webrtc.github.io/samples/src/content/peerconnection/trickle-ice/)

   ä¸Šé¢è¿™ä¸ªåœ°å€ç”¨äºæ£€æµ‹ turn æœåŠ¡æ˜¯å¦å¯ç”¨ï¼Œæ³¨æ„`æŸ¥çœ‹æœåŠ¡å™¨ç«¯å£æ˜¯å¦å·²å¼€å¯`3478`

   ![coturn-server-success.png](./images/coturn-server-success.png)

   å¦‚æœä½ æµ‹è¯•ä¸€ä¸ª STUN æœåŠ¡å™¨ï¼Œä½ èƒ½æ”¶é›†åˆ°ä¸€ä¸ªç±»å‹ä¸ºâ€œsrflxâ€çš„å€™é€‰è€…ï¼Œå®ƒå°±å¯ä»¥å·¥ä½œã€‚å¦‚æœä½ æµ‹è¯•ä¸€ä¸ª TURN æœåŠ¡å™¨ï¼Œä½ èƒ½æ”¶é›†åˆ°ä¸€ä¸ªç±»å‹ä¸ºâ€œrelayâ€çš„å€™é€‰äººï¼Œå®ƒå°±ä¼šå·¥ä½œã€‚

10.
