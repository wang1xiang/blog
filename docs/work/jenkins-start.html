<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>
      队友升职加薪来不及羡慕，被迫解锁 Jenkins 技能（小小玩意，拿捏 🫴） | 学习笔记
    </title>
    <meta name="description" content="A VitePress site">
    <link rel="stylesheet" href="/blog/_assets/style.85766dd9.css">
    <link rel="modulepreload" href="/blog/_assets/common-03e46d7f.js">
    <link rel="modulepreload" href="/blog/_assets/common-af9dd5a8.js">
    <link rel="modulepreload" href="/blog/_assets/docs_work_jenkins-start.md.38f362c4.lean.js">
    <link rel="modulepreload" href="/blog/_assets/app.41c738e0.js">
    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no">
    <meta name="keywords" content="翔子Blog">
    <link rel="icon" href="/blog/favicon.ico">
    <link rel="stylesheet" href="https://lib.baomitu.com/gitalk/1.7.0/gitalk.min.css">
    <script src="https://lib.baomitu.com/gitalk/1.7.0/gitalk.min.js"></script>
    <script src="https://lib.baomitu.com/axios/0.21.1/axios.js"></script>
    
  </head>
  <body>
    <div id="app"><!--[--><div id="containerColor" class="no-sidebar theme" data-v-afcf09d4><header class="navbar" data-v-afcf09d4><!--[--><a class="title" aria-label="学习笔记, back to home" href="/blog/"><img class="logo" src="/blog/favicon.ico" alt="logo"><span>学习笔记</span></a><div class="flex-grow"></div><nav class="nav-links hide-mobile"><!--[--><!--[--><div class="nav-item"><a class="nav-link" href="/blog/index.html" target="" rel="">🏠 首页 <!----></a></div><!--]--><!--[--><div class="nav-item"><a class="nav-link" href="/blog/more/docs.html" target="" rel="">📅 归档 <!----></a></div><!--]--><!--[--><div class="nav-item"><a class="nav-link" href="/blog/more/tags.html" target="" rel="">📂 分类 <!----></a></div><!--]--><!--]--><div id="docsearch"></div><!----><!----></nav><!--[--><!--]--><!--]--><div class="sidebar-button" data-v-afcf09d4><svg class="icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z" class></path></svg></div></header><aside class="" data-v-afcf09d4><!--[--><nav class="nav-links show-mobile"><!--[--><!--[--><div class="nav-item"><a class="nav-link" href="/blog/index.html" target="" rel="">🏠 首页 <!----></a></div><!--]--><!--[--><div class="nav-item"><a class="nav-link" href="/blog/more/docs.html" target="" rel="">📅 归档 <!----></a></div><!--]--><!--[--><div class="nav-item"><a class="nav-link" href="/blog/more/tags.html" target="" rel="">📂 分类 <!----></a></div><!--]--><!--]--><div id="docsearch"></div><!----><!----></nav><!--[--><!--]--><ul class="sidebar"><!--[--><!--]--></ul><!--[--><!--]--><!--]--></aside><!----><!-- TODO: make this button accessible --><div class="sidebar-mask" data-v-afcf09d4></div><main data-v-afcf09d4><!--[--><div class="content"><!--[--><!--]--><div class="md-header"><div class="md-title">队友升职加薪来不及羡慕，被迫解锁 Jenkins 技能（小小玩意，拿捏 🫴）</div><span id="jinrishici-sentence">正在加载今日诗词....</span><div class="md-date">2024-03-11</div></div><ul class="catalog"><!--[--><li class="catalog-item"><a class="level level-2" href="#入坑-jenkins">入坑 Jenkins</a><!----></li><li class="catalog-item"><a class="level level-2" href="#说说我经历过的前端部署流程">说说我经历过的前端部署流程</a><!----></li><li class="catalog-item"><!----><a class="level level-3" href="#原始时代">原始时代</a></li><li class="catalog-item"><!----><a class="level level-3" href="#脚本化时代">脚本化时代</a></li><li class="catalog-item"><!----><a class="level level-3" href="#ci-cd-时代">CI/CD 时代</a></li><li class="catalog-item"><a class="level level-2" href="#jenkins-解决了什么问题">Jenkins 解决了什么问题</a><!----></li><li class="catalog-item"><a class="level level-2" href="#jenkins-部署">Jenkins 部署</a><!----></li><li class="catalog-item"><!----><a class="level level-3" href="#安装过程">安装过程</a></li><li class="catalog-item"><!----><a class="level level-3" href="#jenkins-配置">Jenkins 配置</a></li><li class="catalog-item"><!----><a class="level level-3" href="#安装过程遇到的问题">安装过程遇到的问题</a></li><li class="catalog-item"><!----><a class="level level-3" href="#如何卸载-jenkins">如何卸载 Jenkins</a></li><li class="catalog-item"><!----><a class="level level-3" href="#jenkins-版本更新">Jenkins 版本更新</a></li><li class="catalog-item"><a class="level level-2" href="#项目创建">项目创建</a><!----></li><li class="catalog-item"><!----><a class="level level-3" href="#freestyle-project">Freestyle project</a></li><li class="catalog-item"><!----><a class="level level-3" href="#build-steps">Build Steps</a></li><li class="catalog-item"><!----><a class="level level-3" href="#构建后操作">构建后操作</a></li><li class="catalog-item"><a class="level level-2" href="#构建">构建</a><!----></li><li class="catalog-item"><!----><a class="level level-3" href="#pipeline">Pipeline</a></li><li class="catalog-item"><!----><a class="level level-3" href="#生成方式">生成方式</a></li><li class="catalog-item"><!----><a class="level level-3" href="#重要概念">重要概念</a></li><li class="catalog-item"><!----><a class="level level-3" href="#语法">语法</a></li><li class="catalog-item"><!----><a class="level level-3" href="#构建看看效果">构建看看效果</a></li><li class="catalog-item"><!----><a class="level level-3" href="#通过项目中的-jenkinsfile-构建">通过项目中的 Jenkinsfile 构建</a></li><li class="catalog-item"><!----><a class="level level-3" href="#片段生成器">片段生成器</a></li><li class="catalog-item"><!----><a class="level level-3" href="#配置构建过程遇到的问题">配置构建过程遇到的问题</a></li><li class="catalog-item"><a class="level level-2" href="#总结">总结</a><!----></li><!--]--></ul><div><p><img src="/blog/_assets/jenkins-learn.6cc4796a.png" alt="jenkins-learn"></p><h2 id="入坑-jenkins"><a class="header-anchor" href="#入坑-jenkins" aria-hidden="true">#</a> 入坑 Jenkins</h2><p>作为一个前端，想必大家都会有这个想法：“<strong>Jenkins 会用就行了，有啥好学的</strong>”。</p><p>我一直都是这么想的，不就会点个<code>开始构建</code>就行了嘛！</p><p>可是碰巧我们之前负责 Jenkins 的前端同事升了职，碰巧这个项目组就剩了两个人，碰巧我比较闲，于是这个“活”就落在我的头上了。</p><p><img src="/blog/_assets/yali.d5778777.jpeg" alt="yali"></p><p>压力一下就上来了，一点不懂 Jenkins 可咋整？</p><p>然而现实是没有一点儿压力。</p><p>刚开始的时候挺轻松，也就是要发版的流程到我这了，我直接在对应项目上点击<code>开始构建</code>，so easy！可是某一天，突然遇到一个 bug：我们每次 web 端项目发完后，桌面端的 hybrid 包需要我手动改 OSS 上配置文件的版本号，正巧那天忘记更新版本号了，导致桌面端应用本地的 hybrid 没有更新。。。</p><p>领导：你要不就别手动更新了，弄成自动化的 我：😨 啊！什么，我我我不会，是不可能的</p><p>小弟我之前没有接触过 Jenkins，看着那一堆配置着实有点费脑，于是就只能边百度学习边输出，从 Jenkins 安装开始到配置不同类型的构建流程，踩过不少坑，最后形成这篇万字长文。如果有能帮到大家的点，我就很开心了，毕竟我也是刚接触的！</p><h2 id="说说我经历过的前端部署流程"><a class="header-anchor" href="#说说我经历过的前端部署流程" aria-hidden="true">#</a> 说说我经历过的前端部署流程</h2><p>按照我的经历，我把前端部署流程分为了以下几个阶段：即原始时代 -&gt; 脚本化时代 -&gt; CI/CD 时代。</p><p><img src="/blog/_assets/jenkins-history.6bf79e01.png" alt="jenkins-history"></p><h3 id="原始时代"><a class="header-anchor" href="#原始时代" aria-hidden="true">#</a> 原始时代</h3><p>最开始的公司运维是一个小老头，他只负责管理服务器资源，不管各种项目打包之类的。我们就只能自己打包，再手动把构建的文件丢到服务器上。</p><p>整体流程就是：本地合并代码 --&gt; 本地打包 --&gt; 上传服务器；</p><p>上传服务器可以分为这几个小步骤：打开 xshell --&gt; 连接服务器 --&gt; 进入 tomcat 目录 --&gt; 通过 ftp 上传本地文件。</p><p>可能全套下来需要 5 分钟左右。</p><h3 id="脚本化时代"><a class="header-anchor" href="#脚本化时代" aria-hidden="true">#</a> 脚本化时代</h3><p>为了简化，我写了一个 node 脚本，通过<code>ssh2-sftp-client</code>将<code>上传服务器</code>这一步骤脚本化：</p><div class="language-js"><pre><code><span class="token keyword">const</span> chalk <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;chalk&#39;</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;path&#39;</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;fs&#39;</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> Client <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;ssh2-sftp-client&#39;</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> sftp <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Client</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> envConfig <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;./env.config&#39;</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> defalutConfig <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">port</span><span class="token operator">:</span> <span class="token string">&#39;22&#39;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">username</span><span class="token operator">:</span> <span class="token string">&#39;root&#39;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">password</span><span class="token operator">:</span> <span class="token string">&#39;123&#39;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">localStatic</span><span class="token operator">:</span> <span class="token string">&#39;./dist.tar.gz&#39;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token operator">...</span>defalutConfig<span class="token punctuation">,</span>
  <span class="token literal-property property">host</span><span class="token operator">:</span> envConfig<span class="token punctuation">.</span>host<span class="token punctuation">,</span>
  <span class="token literal-property property">remoteStatic</span><span class="token operator">:</span> envConfig<span class="token punctuation">.</span>remoteStatic<span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> error <span class="token operator">=</span> chalk<span class="token punctuation">.</span>bold<span class="token punctuation">.</span>red
<span class="token keyword">const</span> success <span class="token operator">=</span> chalk<span class="token punctuation">.</span>bold<span class="token punctuation">.</span>green
<span class="token keyword">function</span> <span class="token function">upload</span><span class="token punctuation">(</span><span class="token parameter">config<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fs<span class="token punctuation">.</span><span class="token function">existsSync</span><span class="token punctuation">(</span><span class="token string">&#39;./dist&#39;</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>fs<span class="token punctuation">.</span><span class="token function">existsSync</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>localStatic<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 标志上传dist目录</span>
  <span class="token keyword">let</span> isDist <span class="token operator">=</span> <span class="token boolean">false</span>
  sftp
    <span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// 判断gz文件存在时 上传gz 不存在时上传dist</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>fs<span class="token punctuation">.</span><span class="token function">existsSync</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>localStatic<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> sftp<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>localStatic<span class="token punctuation">,</span> options<span class="token punctuation">.</span>remoteStatic<span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>fs<span class="token punctuation">.</span><span class="token function">existsSync</span><span class="token punctuation">(</span><span class="token string">&#39;./dist&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        isDist <span class="token operator">=</span> <span class="token boolean">true</span>
        <span class="token keyword">return</span> sftp<span class="token punctuation">.</span><span class="token function">uploadDir</span><span class="token punctuation">(</span><span class="token string">&#39;./dist&#39;</span><span class="token punctuation">,</span> options<span class="token punctuation">.</span>remoteStatic<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      sftp<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isDist<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> <span class="token punctuation">{</span> Client <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;ssh2&#39;</span><span class="token punctuation">)</span>
        <span class="token keyword">const</span> conn <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Client</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        conn
          <span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;ready&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token comment">// 远程解压</span>
            <span class="token keyword">const</span> remoteModule <span class="token operator">=</span> options<span class="token punctuation">.</span>remoteStatic<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">&#39;dist.tar.gz&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">)</span>
            conn<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span>
              <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">cd </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>remoteModule<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">;tar xvf dist.tar.gz</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
              <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> stream</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">throw</span> err
                stream
                  <span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;close&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">code</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                    code <span class="token operator">===</span> <span class="token number">0</span>
                    conn<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token comment">// 解压完成 删除本地文件</span>
                    fs<span class="token punctuation">.</span><span class="token function">unlink</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>localStatic<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                      <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">throw</span> err
                    <span class="token punctuation">}</span><span class="token punctuation">)</span>
                  <span class="token punctuation">}</span><span class="token punctuation">)</span>
                  <span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;data&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
              <span class="token punctuation">}</span>
            <span class="token punctuation">)</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      sftp<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 上传文件</span>
<span class="token function">upload</span><span class="token punctuation">(</span>config<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">localStatic</span><span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> config<span class="token punctuation">.</span>localStatic<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 本地文件夹路径</span>
  <span class="token literal-property property">remoteStatic</span><span class="token operator">:</span> config<span class="token punctuation">.</span>remoteStatic<span class="token punctuation">,</span> <span class="token comment">// 服务器文件夹路径器</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p><img src="/blog/_assets/upload-dist.a021593f.png" alt="upload-dist"></p><p>最后只要通过执行<code>yarn deploy</code>即可实现打包并上传，用了一段时间，队友也都觉得挺好用的，毕竟少了很多手动操作，效率大大提升。</p><h3 id="ci-cd-时代"><a class="header-anchor" href="#ci-cd-时代" aria-hidden="true">#</a> CI/CD 时代</h3><p>不过用了没多久后，来了个新的运维小年轻，一上来就整了个 Jenkins ，取代了我们手动打包的过程，只要我们点击部署就可以了，当时就感觉 Jenkins 挺方便的，但又觉得和前端没多大关系，也就没学习。</p><p>不过也挺<code>烦</code> Jenkins 的，为啥呢？</p><blockquote><p>当时和测试说的最多的就是“我在我这试试.....我这没问题啊，你刷新一下”，趁这个时候，赶紧打包重新部署下。有了 Jenkins 后，打包都有记录了，测试一看就知道我在哄她了 🙄</p></blockquote><h2 id="jenkins-解决了什么问题"><a class="header-anchor" href="#jenkins-解决了什么问题" aria-hidden="true">#</a> Jenkins 解决了什么问题</h2><p>我觉得在了解一个新事物前，应该先了解下它的出现解决了什么问题。</p><p>以我的亲身经历来看，Jenkins 的出现使得 <code>拉取代码 -&gt; 打包 -&gt; 部署 -&gt; 完成后工作（通知、归档、上传CDN等）</code>这一繁琐的流程不需要人为再去干预，一键触发 🛫。</p><p><img src="/blog/_assets/jenkins-vs-old.7fc3d2be.png" alt="jenkins-vs-old"></p><p>只需要点击开始构建即可，如何你觉得还得每次打开 jenkins 页面去点击构建，可以通过设置代码提交到 master 或合并代码时触发构建，这样就不用每次手动去点击构建了，省时更省力 🚴🏻‍♂️。</p><h2 id="jenkins-部署"><a class="header-anchor" href="#jenkins-部署" aria-hidden="true">#</a> Jenkins 部署</h2><p><a href="https://www.jenkins.io/zh/doc/" target="_blank" rel="noopener noreferrer">Jenkins 中文帮助文档</a></p><p>Jenkins 提供了多种<a href="https://www.jenkins.io/zh/download/" target="_blank" rel="noopener noreferrer">安装</a>方式，我的服务器是 Centos，按照<a href="https://mirrors.jenkins-ci.org/redhat/" target="_blank" rel="noopener noreferrer">官方教程</a>进行部署即可。</p><p>官方提供两种方式进行安装：</p><p>方式一：</p><div class="language-bash"><pre><code><span class="token function">sudo</span> <span class="token function">wget</span> -O /etc/yum.repos.d/jenkins.repo https://pkg.jenkins.io/redhat-stable/jenkins.repo
<span class="token function">sudo</span> <span class="token function">rpm</span> --import https://pkg.jenkins.io/redhat-stable/jenkins.io.key

yum <span class="token function">install</span> jenkins
</code></pre></div><p>方式二：</p><p>直接下载 rpm 包进行安装，地址：<a href="https://mirrors.jenkins-ci.org/redhat/" target="_blank" rel="noopener noreferrer">https://mirrors.jenkins-ci.org/redhat/</a></p><div class="language-bash"><pre><code><span class="token function">wget</span> https://pkg.jenkins.io/redhat/jenkins-2.449-1.1.noarch.rpm
<span class="token function">rpm</span> -ivh jenkins-2.449-1.1.noarch.rpm
</code></pre></div><h3 id="安装过程"><a class="header-anchor" href="#安装过程" aria-hidden="true">#</a> 安装过程</h3><p>我是使用方式二进行安装的，来看下具体过程。</p><p>首先需要<strong>安装 jdk17 以上的版本</strong></p><ol><li><p>下载对应的 jdk</p><div class="language-bash"><pre><code><span class="token function">wget</span> https://download.oracle.com/java/17/latest/jdk-17_linux-x64_bin.tar.gz
</code></pre></div></li><li><p>解压并放到合适位置</p><div class="language-bash"><pre><code><span class="token function">tar</span> xf jdk-17_linux-x64_bin.tar.gz
<span class="token function">mv</span> jdk-17.0.8/ /usr/lib/jvm
</code></pre></div></li><li><p>配置 Java 环境变量</p><div class="language-bash"><pre><code><span class="token function">vim</span> /etc/profile
<span class="token builtin class-name">export</span> <span class="token assign-left variable">JAVA_HOME</span><span class="token operator">=</span>/usr/lib/jvm/jdk-17.0.8
<span class="token builtin class-name">export</span> <span class="token assign-left variable">CLASSPATH</span><span class="token operator">=</span><span class="token variable">$JAVA_HOME</span>/lib:<span class="token variable">$JRE_HOME</span>/lib:<span class="token variable">$CLASSPATH</span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable"><span class="token environment constant">PATH</span></span><span class="token operator">=</span><span class="token variable">$JAVA_HOME</span>/bin:<span class="token variable">$JRE_HOME</span>/bin:<span class="token environment constant">$PATH</span>
</code></pre></div></li><li><p>验证</p><div class="language-bash"><pre><code>java -version
</code></pre></div><p><img src="/blog/_assets/jenkins-java-version.0e96ee21.png" alt="jenkins-java-version"></p></li></ol><p>接着安装 Jenkins，需要注意：<strong>Jenkins 一定要安装最新版本，因为插件要求最新版本</strong>，最新的 2.449。</p><ol><li><p>下载 rpm 包</p><div class="language-bash"><pre><code><span class="token builtin class-name">cd</span> /usr/local/jenkins
<span class="token function">wget</span> https://mirrors.jenkins-ci.org/redhat/jenkins-2.449-1.1.noarch.rpm
</code></pre></div></li><li><p>安装 Jenkins</p><div class="language-bash"><pre><code><span class="token function">rpm</span> -ivh jenkins-2.449-1.1.noarch.rpm
</code></pre></div><p><img src="/blog/_assets/jenkins-install-2.449.88b5b58c.png" alt="jenkins-install-2.449"></p></li><li><p>启动 Jenkins</p><div class="language-bash"><pre><code>systemctl start jenkins
</code></pre></div><p><img src="/blog/_assets/jenkins-install-error.6ef0890b.png" alt="jenkins-install-error"></p></li></ol><p>你以为就这么简单？肯定会报错的，通过百度报错信息，报错原因是：<strong>Java 环境不对</strong>，百度到的解决方法：</p><p>修改<code>/etc/init.d/jenkins</code>文件，添加 JDK，但是目录下并没有这个文件，继续百度得知：</p><p><strong>使用 <code>systemctl</code> 启动 jenkins 时，不会使用 <code>etc/init.d/jenkins</code> 配置文件，而是使用 <code>/usr/lib/systemd/system/jenkins.service</code>文件</strong>。</p><p>于是修改：</p><div class="language-bash"><pre><code><span class="token function">vim</span> /usr/lib/systemd/system/jenkins.service
</code></pre></div><p><img src="/blog/_assets/jenkins-service-java.2c14c3ee.png" alt="jenkins-service-java"> 搜索 Java，找到上面这一行，打开注释，修改为对应的 JDK 位置：</p><div class="language-bash"><pre><code><span class="token assign-left variable">Environment</span><span class="token operator">=</span><span class="token string">&quot;JAVA_HOME=/usr/lib/jvm/jdk-17.0.10&quot;</span>
</code></pre></div><p>重新启动 Jenkins：</p><div class="language-bash"><pre><code>systemctl restart jenkins
</code></pre></div><p>查看启动状态，出现如下则说明 Jenkins 启动完成：</p><p><img src="/blog/_assets/jenkins-install-success.ef6059ec.png" alt="jenkins-install-success"></p><p>接着在浏览器通过 <code>ip:8090</code> 访问，出现如下页面，说明安装成功。</p><p><img src="/blog/_assets/jenkins-install-success-ip.8627075a.png" alt="jenkins-install-success-ip"></p><p>此时需要填写管理员密码，通过 <code>cat /var/lib/jenkins/secrets/initialAdminPassword</code> 即可获取。</p><h3 id="jenkins-配置"><a class="header-anchor" href="#jenkins-配置" aria-hidden="true">#</a> Jenkins 配置</h3><p>出现上述界面，填写密码成功后等待数秒，即可出现如下界面：</p><p><img src="/blog/_assets/jenkins-install-plugins.44936023.png" alt="jenkins-install-plugins"></p><p>选择 <code>安装推荐的插件</code></p><p><img src="/blog/_assets/jenkins-install-plugins-wait.72e54108.png" alt="jenkins-install-plugins-wait"></p><p>这个过程稍微有点慢，可以整理整理文档，等待安装完成。</p><p>安装完成后，会出现此页面，需要创建一个管理员用户。</p><p><img src="/blog/_assets/jenkins-install-ok.b4698e0e.png" alt="jenkins-install-ok"></p><p>点击开始使用 Jenkins，即可进入 Jenkins 首页。</p><p><img src="/blog/_assets/jenkins-home.adce1a29.png" alt="jenkins-home"></p><p>至此，Jenkins 安装完成 🎉🎉🎉。</p><h3 id="安装过程遇到的问题"><a class="header-anchor" href="#安装过程遇到的问题" aria-hidden="true">#</a> 安装过程遇到的问题</h3><ol><li><p>没有经验第一次安装，参考网上文档推荐的是 JDK8，结果安装的 Jenkins 至少需要 JDK 11，导致安装失败；</p></li><li><p>第二次安装，按照网上的文档安装，不是最新版本，导致部分插件安装失败；</p><p><a href="https://github.com/jenkinsci/jenkins/releases" target="_blank" rel="noopener noreferrer">release</a><a href="https://mirrors.jenkins-ci.org/redhat/" target="_blank" rel="noopener noreferrer">版本</a></p></li><li><p>配置修改问题</p><ul><li>Jenkins 默认的配置文件位于 <code>/usr/lib/systemd/system/jenkins.service</code></li><li>默认目录安装在 <code>/var/lib/jenkins/</code></li><li>默认工作空间在 <code>/var/lib/jenkins/workspace</code></li></ul></li><li><p>修改端口号为 <code>8090</code></p><div class="language-bash"><pre><code><span class="token function">vim</span> /usr/lib/systemd/system/jenkins.service
</code></pre></div><p>修改 <code>Environment=&quot;JENKINS_PORT=8090&quot;</code>，修改完后执行：</p><div class="language-bash"><pre><code>systemctl daemon-reload
systemctl restart jenkins
</code></pre></div></li></ol><h3 id="如何卸载-jenkins"><a class="header-anchor" href="#如何卸载-jenkins" aria-hidden="true">#</a> 如何卸载 Jenkins</h3><p>安装过程遇到了不少坑，基本都是卸载了重新安装，于是就总结了以下卸载的命令。</p><div class="language-bash"><pre><code><span class="token comment"># 查找是否存在 Jenkins 安装包</span>
<span class="token function">rpm</span> -ql jenkins
<span class="token comment"># 卸载 Jenkins</span>
<span class="token function">rpm</span> -e jenkins
<span class="token comment"># 再次查看 此时会提示：未安装软件包 jenkins</span>
<span class="token function">rpm</span> -ql jenkins
<span class="token comment"># 删除所有 Jenkins 相关目录</span>
<span class="token function">find</span> / -iname jenkins <span class="token operator">|</span> <span class="token function">xargs</span> -n <span class="token number">1000</span> <span class="token function">rm</span> -rf
</code></pre></div><h3 id="jenkins-版本更新"><a class="header-anchor" href="#jenkins-版本更新" aria-hidden="true">#</a> Jenkins 版本更新</h3><p>Jenkins 发布版本很频繁，基本为一周一次，参考 <a href="https://segmentfault.com/a/1190000022109648#item-2" target="_blank" rel="noopener noreferrer">Jenkins 更新</a></p><h2 id="项目创建"><a class="header-anchor" href="#项目创建" aria-hidden="true">#</a> 项目创建</h2><p>点击 <code>+ 新建Item</code>，输入名称，选择类型：</p><p><img src="/blog/_assets/jenkins-create-project.6323a31a.png" alt="jenkins-create-project"></p><p>有多种类型可供选择，这里我们主要讲这两种：Freestyle project 和 Pipeline。</p><h3 id="freestyle-project"><a class="header-anchor" href="#freestyle-project" aria-hidden="true">#</a> Freestyle project</h3><p><img src="/blog/_assets/jenkins-create-freestyle.6c52e3d9.jpeg" alt="jenkins-create-freestyle"></p><p>选择这种类型后，就可以通过各种 web 表单（基础信息、源码、构建步骤等），配置完整的构建步骤，对于新手来说，易上手且容易理解，如果第一次接触，创建项目就选择 Freestyle project 即可。</p><p>总共有以下几个环节需要配置：</p><ul><li>General</li><li>源码管理</li><li>构建触发器</li><li>构建环境</li><li>Build Steps</li><li>构建后操作</li></ul><p>此时我们点击 OK，创建完如下所示都是空白的，也可以通过创建时的<code>复制</code>选项，复制之前项目的配置：</p><p><img src="/blog/_assets/jenkins-create-configure.f757836b.png" alt="jenkins-create-configure"></p><p>接着就如同填写表单信息，一步步完成构建工作。</p><h4 id="general"><a class="header-anchor" href="#general" aria-hidden="true">#</a> General</h4><p>项目基本信息也就是对所打包项目的描述信息：</p><p><img src="/blog/_assets/jenkins-configure-general.6dd56687.png" alt="jenkins-configure-general"></p><p>比如描述这里，可以写项目名称、描述、输出环境等等。</p><h5 id="discard-old-builds-丢弃旧的构建"><a class="header-anchor" href="#discard-old-builds-丢弃旧的构建" aria-hidden="true">#</a> Discard old builds 丢弃旧的构建</h5><p>可以理解为<strong>清初构建历史</strong>，Jenkins 每打包一次就会产生一个构建历史记录，在<code>构建历史</code>中可以看到从第一次到最新的构建信息，这会导致磁盘空间消耗。</p><p>点击配置名称或勾选，会自动展开配置项。这里我们可以设置<code>保持构建的最大个数</code>为<code>5</code>，则当前项目的构建历史记录只会保留最新的 5 个，并自动删除掉最老的构建。</p><p><img src="/blog/_assets/jenkins-configure-discard.f3cd708d.png" alt="jenkins-configure-discard"></p><p>这个可以按照自己的需求来设置，比如保留 7 天的构建记录或保留最多 100 个构建记录。</p><p>Jenkins 的大多数配置都有 <code>高级</code> 选项，在高级选项中可以做更详细的配置。</p><h5 id="this-project-is-parameterized"><a class="header-anchor" href="#this-project-is-parameterized" aria-hidden="true">#</a> This project is parameterized</h5><p>可以理解为<strong>此构建后续过程可能用到的参数</strong>，可以是手动输入或选项等，如：git 分支、构建环境、特定的配置等等。通过这种方式，项目可以更加灵活和可配置，以适应不同的构建需求和环境。</p><p>默认有 8 种参数类型：</p><ol><li>Boolean Parameter: checkbox 选择，如果需要设置 true/false 值时，可以添加此参数类型</li><li>Choice Parameter：选择，多个选项</li><li>Credentials Parameter：账号证书等参数</li><li>File Parameter：文件上传</li><li>Multi-line String parameters：多行文本参数</li><li>Password Parameter：密码参数</li><li>Run Parameter：用于选择执行的 job</li><li>String Parameter：单行文本参数</li></ol><p><code>Git Parameter</code> 需要在 <code>系统管理 -&gt; 插件管理</code> 搜索 <code>Git Parameter</code> 插件进行安装，安装完成后重启才会有这个参数。</p><p>通过 <code>添加参数</code> 来设置后续会用到的参数，比如设置名称为 <code>delopyTag</code> 的 <code>Git Parameter</code> 参数来指定要构建的分支，设置名称为 <code>DEPLOYPATH</code> 的 <code>Choice Parameter</code> 参数来指定部署环境等等。</p><p><img src="/blog/_assets/jenkins-configure-parameter.22985ad1.png" alt="jenkins-configure-parameter"></p><h4 id="源码管理"><a class="header-anchor" href="#源码管理" aria-hidden="true">#</a> 源码管理</h4><h5 id="repositories"><a class="header-anchor" href="#repositories" aria-hidden="true">#</a> Repositories</h5><p>一般公司项目都是从 gitlab 上拉代码，首先设置 <code>Repository URL</code>，填写 git 仓库地址，比如：<code>https://gitlab.com/xxx/xxx.git</code></p><p>填写完后会报错如下：</p><p><img src="/blog/_assets/jenkins-configure-git-error.694ed24a.png" alt="jenkins-configure-git-error"></p><p>可以通过添加 Credentials 凭证解决，在 Jenkins 中，Git 的 Credentials 是用于访问 Git 仓库的认证信息，这些凭据可以是用户名和密码、SSH 密钥或其他认证机制，以确保 Jenkins 能够安全的与 Git 仓库进行交互，即构建过程中<strong>自动拉取代码、执行构建任务等</strong>。</p><h6 id="方式一：在当前页面填写帐号、密码"><a class="header-anchor" href="#方式一：在当前页面填写帐号、密码" aria-hidden="true">#</a> 方式一：在当前页面填写帐号、密码</h6><p>选择<code>添加 -&gt; Jenkins -&gt; 填写 git 用户名、密码</code>等信息生成一个新的 Credentials，然后重新选择我们刚刚添加的 Credentials，报错信息自动消失</p><p><img src="/blog/_assets/jenkins-configure-git.015381c4.png" alt="jenkins-configure-git"></p><p>这样添加会有一个问题，就是如果有多个项目时，每次都需要手动填写 Git 账户和密码信息。</p><h6 id="方式二：jenkins-全局凭证设置"><a class="header-anchor" href="#方式二：jenkins-全局凭证设置" aria-hidden="true">#</a> 方式二：Jenkins 全局凭证设置</h6><p>在 <a href="https://jk.qmpoa.com/manage/credentials/store/system/domain/_/" target="_blank" rel="noopener noreferrer">Global Credentials</a> 中设置全局的凭证。</p><p><img src="/blog/_assets/jenkins-configure-git-credentials.2e3d5b1a.png" alt="jenkins-configure-git-credentials"></p><p>然后在项目中配置时可以直接选择我们刚刚添加的 Credentials，报错信息自动消失。</p><h5 id="branches-to-build"><a class="header-anchor" href="#branches-to-build" aria-hidden="true">#</a> Branches to build</h5><p>这里构建的分支，可以设置为我们上面设置的 <code>delopyTag</code> 参数，即用户自己选择的分支进行构建。</p><h4 id="构建触发器"><a class="header-anchor" href="#构建触发器" aria-hidden="true">#</a> 构建触发器</h4><p>特定情况下出发构建，如<strong>定时触发、代码提交或合并时触发、其他任务完成时触发</strong>等。</p><p>如果没有特殊的要求时，这一步完全可以不用设置，在需要构建时我们只需要手动点击开始构建即可。</p><h4 id="构建环境"><a class="header-anchor" href="#构建环境" aria-hidden="true">#</a> 构建环境</h4><p>构建环境是在构建开始之前的准备工作，如<strong>清除上次构建、指定构建工具、设置 JDK 、Node 版本、生成版本号</strong>等。</p><h5 id="provide-node-npm-bin-folder-to-path"><a class="header-anchor" href="#provide-node-npm-bin-folder-to-path" aria-hidden="true">#</a> Provide Node &amp; npm bin/folder to PATH</h5><p>默认是没有这一项的，但前端部署需要 Node 环境支持，所以需要在 <code>系统管理 -&gt; 插件管理</code> 搜索 <code>nodejs</code> 插件进行安装，安装完成后重启才会展示这项配置。</p><p>但此时还是不能选择的，需要在 <code>系统管理 -&gt; 全局工具配置</code> 中先安装 NodeJs，根据不同环境配置，<strong>可同时安装多个 NodeJs 版本</strong>。</p><p><img src="/blog/_assets/jenkins-configure-nodeJs.578c2be1.png" alt="jenkins-configure-nodeJs"></p><p>之后在 <code>Provide Node</code> 处才有可供选择的 Node 环境。</p><p><img src="/blog/_assets/jenkins-configure-provide-node.fce9818f.png" alt="jenkins-configure-provide-node"></p><h5 id="create-a-formatted-version-number"><a class="header-anchor" href="#create-a-formatted-version-number" aria-hidden="true">#</a> Create a formatted version number</h5><p>这个就是我用来解决了一开始问题的配置项，也就是把每次打包的结果上传到 OSS 服务器上时生成一个新的版本号，在 Electron 项目中通过对比版本号，自动更新对应的 hybrid 包，领导都爱上我了 😜。</p><p>首先需要安装插件 <code>Version Number Plugin</code>，在 <code>系统管理 -&gt; 插件管理</code> 中搜索安装，然后重启 Jenkins 即可</p><p><img src="/blog/_assets/jenkins-configure-version.e4e73e7b.png" alt="jenkins-configure-version"></p><ol><li><p>Environment Variable Name</p><p>类似于第一步的构建参数，可以在其他地方使用。</p></li><li><p>Version Number Format String</p><p>用于设置版本号的格式，如<code>1.x.x</code>，Jenkins 提供了许多内置的环境变量：</p><ul><li><p>BUILD_DAY：生成的日期</p></li><li><p>BUILD_WEEK：生成年份中的一周</p></li><li><p>BUILD_MONTH：生成的月份</p></li><li><p>BUILD_YEAR：生成的年份</p></li><li><p>BUILDS_TAY：在此日历日期完成的生成数</p></li><li><p>BUILDS_THIS_WEEK：此日历周内完成的生成数</p></li><li><p>BUILDS_THIS_MONTH：此日历月内完成的生成数</p></li><li><p>BUILDS_THIS_YEAR：此日历年中完成的生成数</p></li><li><p>BUILDS_ALL_TIME：自项目开始以来完成的生成数</p></li></ul></li><li><p>勾选 Build Display Name Use the formatted version number for build display name 后</p><p>此时每次构建后就会生成一个个版本号：</p><p><img src="/blog/_assets/jenkins-configure-version-result.0d2c8af5.png" alt="jenkins-configure-version-result"></p></li><li><p>把这个参数传递到后续的 OSS 上传的 Shell 脚本中即可。</p></li></ol><p>如果想要重置版本号，只要设置<code>Number of builds since the start of the project</code>为 0 即可，此时就会从 <code>1.7.0</code> 重新开始。</p><h3 id="build-steps"><a class="header-anchor" href="#build-steps" aria-hidden="true">#</a> Build Steps</h3><p>这是最为重要的环节，主要用于定义整个构建过程的具体任务和操作，包括<strong>执行脚本、编译代码、打包应用</strong>等。</p><p>我们可以通过 Shell 脚本来完成前端项目常见的操作：安装依赖、打包、压缩、上传到 OSS 等。</p><p>点击 <code>增加构建步骤 -&gt; Execute shell</code>，在上方输入 shell 脚本，常见的如下：</p><div class="language-bash"><pre><code><span class="token comment">#环境变量</span>
<span class="token builtin class-name">echo</span> <span class="token environment constant">$PATH</span>
<span class="token comment">#node版本号</span>
<span class="token function">node</span> -v
<span class="token comment">#npm版本号</span>
<span class="token function">npm</span> -v


<span class="token comment">#进入jenkins workspace的项目目录</span>
<span class="token builtin class-name">echo</span> <span class="token variable">${WORKSPACE}</span>
<span class="token builtin class-name">cd</span> <span class="token variable">${WORKSPACE}</span>

<span class="token comment">#下载依赖包</span>
<span class="token function">yarn</span>
<span class="token comment">#开始打包</span>
<span class="token function">yarn</span> run build

<span class="token comment">#进入到打包目录</span>
<span class="token builtin class-name">cd</span> dist
<span class="token comment">#删除上次打包生成的压缩文件</span>
<span class="token function">rm</span> -rf *.tar.gz

<span class="token comment">#上传oss，如果没有需要可删除此段代码</span>
<span class="token assign-left variable">ossurl</span><span class="token operator">=</span><span class="token string">&quot;xxx&quot;</span>
<span class="token function">curl</span> <span class="token string">&quot;xxx&quot;</span> <span class="token operator">&gt;</span> RELEASES.json
<span class="token function">node</span> deploy-oss.cjs -- <span class="token assign-left variable">accessKeyId</span><span class="token operator">=</span><span class="token variable">$OSS_KEY</span> <span class="token assign-left variable">accessKeySecret</span><span class="token operator">=</span><span class="token variable">$OSS_SECRET</span> <span class="token assign-left variable">zipDir</span><span class="token operator">=</span>tmp.zip <span class="token assign-left variable">ossUrl</span><span class="token operator">=</span>xxx/v<span class="token variable">${BUILD_VERSION}</span>.zip
<span class="token function">node</span> deploy-oss.cjs -- <span class="token assign-left variable">accessKeyId</span><span class="token operator">=</span><span class="token variable">$OSS_KEY</span> <span class="token assign-left variable">accessKeySecret</span><span class="token operator">=</span><span class="token variable">$OSS_SECRET</span> <span class="token assign-left variable">zipDir</span><span class="token operator">=</span>RELEASES.json <span class="token assign-left variable">ossUrl</span><span class="token operator">=</span>xxx/RELEASES.json

<span class="token comment">#把生成的项目打包成压缩包方便传输到远程服务器</span>
<span class="token function">tar</span> -zcvf <span class="token variable"><span class="token variable">`</span><span class="token function">date</span> +%Y%m%d%H%M%S<span class="token variable">`</span></span>.tar.gz *
<span class="token comment">#回到上层工作目录</span>
<span class="token builtin class-name">cd</span> <span class="token punctuation">..</span>/
</code></pre></div><h3 id="构建后操作"><a class="header-anchor" href="#构建后操作" aria-hidden="true">#</a> 构建后操作</h3><p>通过上面的构建步骤，我们已经完成了项目的打包，此时我们需要执行一些后续操作，如<strong>部署应用、发送通知、触发其他 Job</strong>等操作。</p><h4 id="send-build-artifacts-over-ssh"><a class="header-anchor" href="#send-build-artifacts-over-ssh" aria-hidden="true">#</a> Send build artifacts over SSH</h4><p>通过 Send build artifacts over SSH，我们可以将构建好的产物（<strong>一般是压缩后的文件</strong>）通过 ssh 发送到指定的服务器上用于部署，比如 Jenkins 服务器是 10.10，需要将压缩文件发送到 10.11 服务器进行部署，需要以下步骤：</p><ol><li><p>安装插件</p><p>在 <code>系统管理 -&gt; 插件管理</code> 中搜索插件 <code>Publish over SSH</code> 安装，用于处理文件上传工作；</p></li><li><p>配置服务器信息</p><p>在 <code>系统管理 -&gt; System</code> 中搜索 <code>Publish over SSH</code> 进行配置。</p><p><img src="/blog/_assets/jenkins-publish-over-SSH.54300329.png" alt="jenkins-publish-over-SSH"></p><p>需要填写用户名、密码、服务器地址等信息，完成后点击 <code>Test Configuration</code>，如果配置正确，会显示 <code>Success</code>，否则会出现报错信息。</p><p>这里有两种方式连接远程服务器，第一种是<strong>密码方式</strong>，输入服务器账户密码等信息即可；</p><p>第二种是<strong>秘钥方式</strong>，在服务器生成密钥文件，并且将私钥<strong>全部拷贝</strong>，记住是全部，要携带<strong>起止标志-----BEGIN RSA PRIVATE KEY-----或-----END RSA PRIVATE KEY----</strong>，粘贴在 <code>高级 -&gt; key</code> 即可。</p><p>此处的 <code>Remote Directory</code> 是远程服务器接收 Jenkins 打包产物的目录，<strong>必须在对应的服务器手动创建目录</strong>，如 <code>/home/jenkins</code>。</p></li><li><p>项目配置</p><p>选择需要上传的服务器，接着设置需要传输的文件，执行脚本，移动文件到对应的目录。</p><p><img src="/blog/_assets/jenkins-configure-ssh.ec4aa3ed.png" alt="jenkins-configure-ssh"></p></li></ol><h5 id="transfer-set-参数配置"><a class="header-anchor" href="#transfer-set-参数配置" aria-hidden="true">#</a> Transfer Set 参数配置</h5><ul><li><p><code>Source files</code>：需要传输的文件，也就是通过上一步 Build Steps 后生成的压缩文件，这个路径是相对于“工作空间”的路径，即只需要输入 <code>dist/*.tar.gz</code> 即可</p></li><li><p><code>Remove prefix</code>：删除传输文件指定的前缀，如 <code>Source files</code> 设置为<code>dist/*.tar.gz</code> ，此时设置 <code>Remove prefix</code> 为<code>/dist</code>，移除前缀，只传输 <code>*.tar.gz</code> 文件；如果不设置酒会传输 <code>dist/*.tar.gz</code> 包含了 dist 整个目录，并且会自动在上传后的服务器中创建 <code>/dist</code> 这个路径。如果只需要传输压缩包，则移除前缀即可</p></li><li><p><code>Remote directory</code>：文件传输到远程服务器上的具体目录，会与 Publish over SSH 插件系统配置中的 <code>Remote directory</code> 进行拼接，如我们之前设置的目录是 <code>/home/jenkins</code>，此处在写入 <code>qmp_pc_ddm</code>，那么最终上传的路径为 <code>/home/jenkins/qmp_pc_ddm</code>，与之前不同的是，如果此路径不存在时会自动创建，这样设置后，Jenkins 服务器构建后的产物会通过 ssh 上传到此目录，供下一步使用。</p></li><li><p><code>Exec command</code></p><p>文件传输完成后执行自定义 Shell 脚本，比如移动文件到指定目录、解压文件、启动服务等。</p><div class="language-bash"><pre><code><span class="token shebang important">#!/bin/bash</span>

<span class="token comment">#进入远程服务器的目录</span>
<span class="token assign-left variable">project_dir</span><span class="token operator">=</span>/usr/local/nginx/qmp_pc_ddm/<span class="token variable">${DEPLOYPATH}</span>
<span class="token builtin class-name">cd</span> <span class="token variable">$project_dir</span>

<span class="token comment">#移动压缩包</span>
<span class="token function">sudo</span> <span class="token function">mv</span> /home/jenkins/qmp_pc_ddm/*.tar.gz  <span class="token builtin class-name">.</span>

<span class="token comment">#找到新的压缩包</span>
<span class="token assign-left variable">new_dist</span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span><span class="token function">ls</span> -ltr *.tar.gz <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">&#39;{print $NF}&#39;</span> <span class="token operator">|</span><span class="token function">tail</span> -1<span class="token variable">`</span></span>
<span class="token builtin class-name">echo</span> <span class="token variable">$new_dist</span>

<span class="token comment">#解压缩</span>
<span class="token function">sudo</span> <span class="token function">tar</span> -zxvf <span class="token variable">$new_dist</span>

<span class="token comment">#删除压缩包</span>
<span class="token function">sudo</span> <span class="token function">rm</span> *.tar.gz
</code></pre></div><p>这一步可以使用之前定义的参数，如 <code>${DEPLOYPATH}</code>，以及 Jenkins 提供的变量：如 <code>${WORKSPACE}</code> 来引用 Jenkins 的工作空间路径等。</p></li></ul><h4 id="build-other-projects"><a class="header-anchor" href="#build-other-projects" aria-hidden="true">#</a> Build other projects</h4><p>添加 Build other projects，在项目构建成功后，触发相关联的应用开始打包。</p><p><img src="/blog/_assets/jenkins-configure-other.a2614ac8.png" alt="jenkins-configure-other"></p><p>另外还可以配置企业微信通知、生成构建报告等工作。</p><p>此时，所有的配置都设置完成，我们点击<code>保存</code>配置，返回到构建页。</p><h2 id="构建"><a class="header-anchor" href="#构建" aria-hidden="true">#</a> 构建</h2><p><img src="/blog/_assets/jenkins-start-build.ee9694e5.png" alt="jenkins-start-build"></p><p>点击 <code>Build with parameters</code> 选择对应的分支和部署环境，点击<code>开始构建</code></p><p>在控制台输出中，可以看到打包的详细过程，</p><p>可以看到我们在<code>Build Steps</code>中执行的 Shell 脚本的输出如下：</p><p><img src="/blog/_assets/jenkins-result-build.bc3fdcc5.png" alt="jenkins-result-build"></p><p>以及我们通过 Publish Over SSH 插件将构建产物传输的指定服务器的输出：</p><p><img src="/blog/_assets/jenkins-result-ssh.363bb7b1.png" alt="jenkins-result-ssh"></p><p>最终需要部署的服务器就有了以下文件：</p><p><img src="/blog/_assets/jenkins-remote-directory.4f2b93d9.png" alt="jenkins-remote-directory"></p><h3 id="pipeline"><a class="header-anchor" href="#pipeline" aria-hidden="true">#</a> Pipeline</h3><p>对于简单的构建需求或新手用户来说，我们可以直接选择 FreeStyle project。而对于复杂的构建流程或需要更高灵活性和扩展性的场景来说，Pipeline 则更具优势。</p><p>通过 <code>新建任务 -&gt; 流水线</code> 创建一个流水线项目。</p><p><img src="/blog/_assets/jenkins-pipeline-white.5f8d32b8.png" alt="jenkins-pipeline-white"></p><p>开始配置前请先阅读下<a href="https://www.jenkins.io/zh/doc/book/pipeline/" target="_blank" rel="noopener noreferrer">流水线</a>章节。</p><h3 id="生成方式"><a class="header-anchor" href="#生成方式" aria-hidden="true">#</a> 生成方式</h3><p>首先，Jenkins 流水线是一套插件，在最开始的插件推荐安装时会自动安装，如果选择自定义安装时，需要手动安装这一套插件。</p><p>Jenkins 流水线的定义有两种方式：<code>Pipeline script</code> 和 <code>Pipeline script from SCM</code>。 <img src="/blog/_assets/jenkins-pipeline-type.12077a7d.png" alt="jenkins-pipeline-type"></p><h4 id="pipeline-script"><a class="header-anchor" href="#pipeline-script" aria-hidden="true">#</a> Pipeline script</h4><p>Pipeline script 是直接在 Jenkins 页面的配置中写脚本，<strong>可直接定义和执行</strong>，比较直观。</p><p><img src="/blog/_assets/jenkins-pipeline-page.0f4696d2.png" alt="jenkins-pipeline-page"></p><h4 id="pipeline-script-from-scm"><a class="header-anchor" href="#pipeline-script-from-scm" aria-hidden="true">#</a> Pipeline script from SCM</h4><p>Pipeline script from SCM 是将脚本文件和项目代码放在一起，即 <code>Jenkinsfile</code>，也可自定义名称。</p><p><img src="/blog/_assets/jenkins-pipeline-code.6ec3c322.png" alt="jenkins-pipeline-code"></p><p>当 Jenkins 执行构建任务时，会从 git 中拉取该仓库到本地，然后读取 <code>Jenkinsfile</code> 的内容执行相应步骤，通常<strong>认为在 <code>Jenkinsfile</code> 中定义并检查源代码控制是最佳实践</strong>。</p><p>当选择 <code>Pipeline script from SCM</code> 后，需要设置 SCM 为 <code>git</code>，告诉 Jenkins 从指定的 Git 仓库中拉取包含 Pipeline 脚本的文件。</p><p><img src="/blog/_assets/jenkins-pipeline-code-scm.2a18d75a.png" alt="jenkins-pipeline-code-scm"></p><p>如果没有对应的文件时，任务会失败并发出报错信息。</p><p><img src="/blog/_assets/jenkins-pipeline-code-error.4832540a.png" alt="jenkins-pipeline-code-error"></p><h3 id="重要概念"><a class="header-anchor" href="#重要概念" aria-hidden="true">#</a> 重要概念</h3><p>了解完上面的基础配置，我们先找一段示例代码，粘贴在项目的配置中：</p><div class="language-bash"><pre><code>pipeline <span class="token punctuation">{</span>
  agent any
    stages <span class="token punctuation">{</span>
      stage<span class="token punctuation">(</span><span class="token string">&#39;Build&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        steps <span class="token punctuation">{</span>
          <span class="token builtin class-name">echo</span> <span class="token string">&#39;Build&#39;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      stage<span class="token punctuation">(</span><span class="token string">&#39;Test&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        steps <span class="token punctuation">{</span>
          <span class="token builtin class-name">echo</span> <span class="token string">&#39;Test&#39;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      stage<span class="token punctuation">(</span><span class="token string">&#39;Deploy&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        steps <span class="token punctuation">{</span>
          <span class="token builtin class-name">echo</span> <span class="token string">&#39;Deploy&#39;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>看下它的输出结果：</p><p><img src="/blog/_assets/jenkins-pipeline-result.937afc3d.png" alt="jenkins-pipeline-result"></p><p>接着看一下上面语法中几个重要的概念。</p><h4 id="流水线-pipline"><a class="header-anchor" href="#流水线-pipline" aria-hidden="true">#</a> 流水线 pipline</h4><p>定义了整个项目的构建过程, 包括：构建、测试和交付应用程序的阶段。</p><p><strong>流水线顶层必须是一个 block，pipeline{}</strong>，作为整个流水线的根节点，如下：</p><div class="language-js"><pre><code>pipeline <span class="token punctuation">{</span>
  <span class="token comment">/* insert Declarative Pipeline here */</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="节点-agent"><a class="header-anchor" href="#节点-agent" aria-hidden="true">#</a> 节点 agent</h4><p>agent 用来指定在哪个代理节点上执行构建，即执行流水线，可以设置为 <code>any</code>，表示 Jenkins 可以在任何可用的代理节点上执行构建任务。</p><p>但一般在实际项目中，为了满足更复杂的构建需求，提高构建效率和资源利用率，以及确保构建环境的一致性，会根据项目的具体需求和资源情况，设置不同的代理节点来执行流水线。</p><p>如：</p><div class="language-js"><pre><code>pipeline <span class="token punctuation">{</span>
  agent <span class="token punctuation">{</span>
        node <span class="token punctuation">{</span>
            label <span class="token string">&#39;slave_2_34&#39;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre></div><p>可以通过 <code>系统管理 -&gt; 节点列表</code> 增加节点，可以看到默认有一个 master 节点，主要负责协调和管理整个 Jenkins 系统的运行，包括任务的调度、代理节点的管理、插件的安装和配置等。</p><p><img src="/blog/_assets/jenkins-agent-master.813e56fd.png" alt="jenkins-agent-master"></p><h4 id="阶段-stage"><a class="header-anchor" href="#阶段-stage" aria-hidden="true">#</a> 阶段 stage</h4><p>定义流水线的执行过程，如：Build、Test 和 Deploy，可以在可视化的查看目前的状态/进展。</p><p>注意：<strong>参数可以传入任何内容</strong>。不一定非得 <code>Build</code>、<code>Test</code>，也可以传入 <code>打包</code>、<code>测试</code>，与红框内的几个阶段名对应。</p><p><img src="/blog/_assets/jenkins-pipeline-console.f56b208d.png" alt="jenkins-pipeline-console"></p><h4 id="步骤-steps"><a class="header-anchor" href="#步骤-steps" aria-hidden="true">#</a> 步骤 steps</h4><p>执行某阶段具体的步骤。</p><h3 id="语法"><a class="header-anchor" href="#语法" aria-hidden="true">#</a> 语法</h3><p>了解上述概念后，我们仅仅只能看懂一个 Pipeline script 脚本，但距离真正的动手写还有点距离，此时就需要来了解下<a href="https://www.jenkins.io/zh/doc/book/pipeline/syntax/" target="_blank" rel="noopener noreferrer">流水线语法</a>。</p><p>我将上面通过 Freestyle project 的脚本翻译成 Pipeline script 的语法：</p><div class="language-groovy"><pre><code>pipeline <span class="token punctuation">{</span>
    agent any
    triggers <span class="token punctuation">{</span>
        <span class="token function">gitlab</span><span class="token punctuation">(</span>triggerOnPush<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> triggerOnMergeRequest<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> branchFilterType<span class="token punctuation">:</span> <span class="token string">&#39;All&#39;</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    parameters <span class="token punctuation">{</span>
     gitParameter branchFilter<span class="token punctuation">:</span> <span class="token string">&#39;origin/(.*)&#39;</span><span class="token punctuation">,</span> defaultValue<span class="token punctuation">:</span> <span class="token string">&#39;master&#39;</span><span class="token punctuation">,</span> name<span class="token punctuation">:</span> <span class="token string">&#39;delopyTag&#39;</span><span class="token punctuation">,</span> type<span class="token punctuation">:</span> <span class="token string">&#39;PT_BRANCH&#39;</span>
    <span class="token punctuation">}</span>
    stages <span class="token punctuation">{</span>
        <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">&#39;拉取代码&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          steps <span class="token punctuation">{</span>
            git branch<span class="token punctuation">:</span> <span class="token interpolation-string"><span class="token string">&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token expression">params<span class="token punctuation">.</span>delopyTag</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">,</span> credentialsId<span class="token punctuation">:</span> <span class="token string">&#39;xxx&#39;</span><span class="token punctuation">,</span> url<span class="token punctuation">:</span> <span class="token string">&#39;https://xxx/fe/qmp_doc_hy.git&#39;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">&#39;安装依赖&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          steps <span class="token punctuation">{</span>
            <span class="token function">nodejs</span><span class="token punctuation">(</span><span class="token string">&#39;node-v16.20.2&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              sh <span class="token string">&#39;&#39;&#39;
                #!/bin/bash
                source /etc/profile
                echo &quot;下载安装包&quot;
                yarn config set registry https://registry.npmmirror.com
                yarn
              &#39;&#39;&#39;</span>
            <span class="token punctuation">}</span>
            sleep <span class="token number">5</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">&#39;编译&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          steps <span class="token punctuation">{</span>
            sh <span class="token string">&#39;&#39;&#39;
              #!/bin/bash
              source /etc/profile
              yarn run build
              sleep 5
              if [ -d dist ];then
                cd dist
                rm -rf *.tar.gz

                tar -zcvf `date +%Y%m%d%H%M%S`.tar.gz *
              fi
            &#39;&#39;&#39;</span>
            sleep <span class="token number">5</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">&#39;解压&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          steps <span class="token punctuation">{</span>
            echo <span class="token string">&#39;解压&#39;</span>
            <span class="token function">sshPublisher</span><span class="token punctuation">(</span>
                publishers<span class="token punctuation">:</span> <span class="token punctuation">[</span>
                    <span class="token function">sshPublisherDesc</span><span class="token punctuation">(</span>
                        configName<span class="token punctuation">:</span> <span class="token string">&#39;server(101.201.181.27)&#39;</span><span class="token punctuation">,</span><span class="token punctuation">,</span>
                        transfers<span class="token punctuation">:</span> <span class="token punctuation">[</span>
                            <span class="token function">sshTransfer</span><span class="token punctuation">(</span>
                                cleanRemote<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
                                excludes<span class="token punctuation">:</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">,</span>
                                execCommand<span class="token punctuation">:</span> <span class="token string">&#39;&#39;&#39;#!/bin/bash
                                  #进入远程服务器的目录
                                  project_dir=/usr/local/nginx/qmp_pc_ddm_${DEPLOYPATH}/${DEPLOYPATH}
                                  if [ ${DEPLOYPATH} == &quot;ddm&quot;  ]; then
                                     project_dir=/usr/local/nginx/qmp_pc_ddm/dist
                                  fi
                                  cd $project_dir

                                  sudo mv /home/jenkins/qmp_pc_ddm/*.tar.gz  .

                                  #找到新的压缩包
                                  new_dist=`ls -ltr *.tar.gz | awk \&#39;{print $NF}\&#39; |tail -1`

                                  #解压缩
                                  sudo tar -zxvf $new_dist

                                  #删除压缩包
                                  sudo rm *.tar.gz

                                  #发布完成
                                  echo &quot;环境发布完成&quot;
                                &#39;&#39;&#39;</span><span class="token punctuation">,</span>
                                execTimeout<span class="token punctuation">:</span> <span class="token number">120000</span><span class="token punctuation">,</span>
                                flatten<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
                                makeEmptyDirs<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
                                noDefaultExcludes<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
                                patternSeparator<span class="token punctuation">:</span> <span class="token string">&#39;[, ]+&#39;</span><span class="token punctuation">,</span>
                                remoteDirectory<span class="token punctuation">:</span> <span class="token string">&#39;qmp_pc_ddm&#39;</span><span class="token punctuation">,</span>
                                remoteDirectorySDF<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
                                removePrefix<span class="token punctuation">:</span> <span class="token string">&#39;dist/&#39;</span><span class="token punctuation">,</span>
                                sourceFiles<span class="token punctuation">:</span> <span class="token string">&#39;dist/*.tar.gz&#39;</span>
                            <span class="token punctuation">)</span>
                        <span class="token punctuation">]</span><span class="token punctuation">,</span>
                        usePromotionTimestamp<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
                        useWorkspaceInPromotion<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
                        verbose<span class="token punctuation">:</span> <span class="token boolean">false</span>
                    <span class="token punctuation">)</span>
                <span class="token punctuation">]</span>
            <span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    post <span class="token punctuation">{</span>
        success  <span class="token punctuation">{</span>
          echo <span class="token string">&#39;success.&#39;</span>
          <span class="token function">deleteDir</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>接下来，我们一起来解读下这个文件。</p><p>首先，所有的指令都是包裹在 <code>pipeline{}</code> 块中，</p><h4 id="agent"><a class="header-anchor" href="#agent" aria-hidden="true">#</a> agent</h4><p>enkins 可以在任何可用的代理节点上执行构建任务。</p><h4 id="environment"><a class="header-anchor" href="#environment" aria-hidden="true">#</a> <a href="https://www.jenkins.io/zh/doc/book/pipeline/syntax/#environment" target="_blank" rel="noopener noreferrer">environment</a></h4><p>用于定义环境变量，它们会保存为 Groovy 变量和 Shell 环境变量：定义流水线中的所有步骤可用的环境变量 <code>temPath</code>，在后续可通过 <code>$tmpPath</code> 来使用；</p><p>环境变量可以在全局定义，也可在 stage 里单独定义，全局定义的在整个生命周期里可以使用，在 stage 里定义的环境变量只能在当前步骤使用。</p><p>Jenkins 有一些内置变量也可以通过 env 获取（env 也可以读取用户自己定义的环境变量）。</p><div class="language-js"><pre><code>steps <span class="token punctuation">{</span>
    echo <span class="token string">&quot;Running ${env.BUILD_ID} on ${env.JENKINS_URL}&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这些变量都是 String 类型，常见的内置变量有：</p><ul><li>BUILD_NUMBER：Jenkins 构建序号；</li><li>BUILD_TAG：比如 jenkins-${JOB_NAME}-${BUILD_NUMBER}；</li><li>BUILD_URL：Jenkins 某次构建的链接；</li><li>NODE_NAME：当前构建使用的机器</li></ul><h4 id="parameters"><a class="header-anchor" href="#parameters" aria-hidden="true">#</a> <a href="https://www.jenkins.io/zh/doc/book/pipeline/syntax/#%E5%8F%82%E6%95%B0" target="_blank" rel="noopener noreferrer">parameters</a></h4><p>定义流水线中可以接收的参数，如上面脚本中的 gitParameter，只有安装了 Git Parameters 插件后才能使用，name 设置为<code>delopyTag</code>，在后续可通过 <code>${params.delopyTag}</code> 来使用；</p><p>还有以下参数类型可供添加：</p><div class="language-js"><pre><code>parameters <span class="token punctuation">{</span>
  <span class="token function">booleanParam</span><span class="token punctuation">(</span>name<span class="token operator">:</span> <span class="token string">&#39;isOSS&#39;</span><span class="token punctuation">,</span> <span class="token literal-property property">defaultValue</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token literal-property property">description</span><span class="token operator">:</span> <span class="token string">&#39;是否上传OSS&#39;</span><span class="token punctuation">)</span>
  <span class="token function">choice</span><span class="token punctuation">(</span>name<span class="token operator">:</span> <span class="token string">&#39;select&#39;</span><span class="token punctuation">,</span> <span class="token literal-property property">choices</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&#39;A&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;B&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;C&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token literal-property property">description</span><span class="token operator">:</span> <span class="token string">&#39;选择&#39;</span><span class="token punctuation">)</span>
  <span class="token function">string</span><span class="token punctuation">(</span>name<span class="token operator">:</span> <span class="token string">&#39;temp&#39;</span><span class="token punctuation">,</span> <span class="token literal-property property">defaultValue</span><span class="token operator">:</span> <span class="token string">&#39;/temp&#39;</span><span class="token punctuation">,</span> <span class="token literal-property property">description</span><span class="token operator">:</span> <span class="token string">&#39;默认路径&#39;</span><span class="token punctuation">)</span>
  <span class="token function">text</span><span class="token punctuation">(</span>name<span class="token operator">:</span> <span class="token string">&#39;showText&#39;</span><span class="token punctuation">,</span> <span class="token literal-property property">defaultValue</span><span class="token operator">:</span> <span class="token string">&#39;Hello\nWorld&#39;</span><span class="token punctuation">,</span> <span class="token literal-property property">description</span><span class="token operator">:</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">)</span>
  <span class="token function">password</span><span class="token punctuation">(</span>name<span class="token operator">:</span> <span class="token string">&#39;Password&#39;</span><span class="token punctuation">,</span> <span class="token literal-property property">defaultValue</span><span class="token operator">:</span> <span class="token string">&#39;123&#39;</span><span class="token punctuation">,</span> <span class="token literal-property property">description</span><span class="token operator">:</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="triggers"><a class="header-anchor" href="#triggers" aria-hidden="true">#</a> <a href="https://www.jenkins.io/zh/doc/book/pipeline/syntax/#%E8%A7%A6%E5%8F%91%E5%99%A8" target="_blank" rel="noopener noreferrer">triggers</a></h4><p>定义了流水线被重新触发的自动化方法，上面的配置是：当 Git 仓库有新的 push 操作时触发构建</p><h4 id="stages-阶段"><a class="header-anchor" href="#stages-阶段" aria-hidden="true">#</a> stages 阶段</h4><ul><li><p>阶段一：拉取代码</p><p>git：拉取代码，参数 <code>branch</code> 为分支名，我们使用上面定义的 <code>${params.delopyTag}</code>，<code>credentialsId</code> 以及 <code>url</code>，如果不知道怎么填，可以在 <code>流水线语法 -&gt; 片段生成器</code> 中填写对应信息后，自动生成，如下：</p><p><img src="/blog/_assets/jenkins-stage-git.86a6be47.png" alt="jenkins-stage-git"></p><p>再复制到此处即可。</p></li><li><p>阶段二：安装依赖</p><p>在 <code>steps</code> 中，<code>sh</code> 是 Jenkins pipeline 的语法，通过它来执行 shell 脚本。</p><p><code>#!/bin/bash</code>表示使用 bash 脚本； <code>source /etc/profile</code> 用于将指定文件中的环境变量和函数导入当前 shell。</p><p>执行 <code>yarn</code> 安装依赖。</p></li><li><p>阶段三：编译</p><p>执行 <code>yarn build</code> 打包，</p><p><code>if [ -d dist ];</code> 是 shell 脚本中的语法，用于测试 <code>dist</code> 目录是否存在，通过脚本将打包产物打成一个压缩包。</p></li><li><p>阶段四：解压</p><p>将上步骤生成的压缩包，通过 <code>Publish over SSH</code> 发送到指定服务器的指定位置，执行 Shell 命令解压。</p><p>不会写 <code>Publish over SSH</code> 怎么办？同样，可以在 <code>流水线语法 -&gt; 片段生成器</code> 中填写对应信息后，自动生成，如下：</p><p><img src="/blog/_assets/jenkins-generate-publish.872a08c3.png" alt="jenkins-generate-publish"></p></li></ul><h4 id="post"><a class="header-anchor" href="#post" aria-hidden="true">#</a> <a href="https://www.jenkins.io/zh/doc/book/pipeline/syntax/#post" target="_blank" rel="noopener noreferrer">post</a></h4><p>当流水线的完成状态为 <code>success</code>，输出 success。</p><p>deleteDir() 函数用于删除当前工作目录中的所有文件和子目录。这通常用于清理工作区，确保在下一次构建之前工作区是干净的，以避免由于残留文件或目录引起的潜在问题。</p><h3 id="构建看看效果"><a class="header-anchor" href="#构建看看效果" aria-hidden="true">#</a> 构建看看效果</h3><p>可以直接通过 <code>Console Output</code> 查看控制台输出，当然在流水线项目中自然要通过流水线去查看了。</p><p><img src="/blog/_assets/jenkins-pipeline-result-in.de7b7c1f.png" alt="jenkins-pipeline-result-in"></p><ol><li><p>效果一</p><p><img src="/blog/_assets/jenkins-pipeline-result1.2d48ed21.png" alt="jenkins-pipeline-result1"></p><p>Pipeline Overview 中记录了每个步骤的执行情况、开始时间和耗时等信息，但是没有详细信息，详细信息就要在 Pipeline Console 中进行查看。</p></li><li><p>效果二</p><p>安装插件 <code>Blue Ocean</code>，相当于同时结合了 Pipeline Overview 和 Pipeline Console，可以同时看到每个步骤的执行情况等基本信息，以及构建过程中的详细信息。</p><p><img src="/blog/_assets/jenkins-pipeline-result2.6e3a631a.png" alt="jenkins-pipeline-result2"></p><p>通过 Blue Ocean 也可以直接创建流水线，选择代码仓库，然后填写对应的字段，即可快速创建流水线项目，如创建 gitlab 仓库：</p><p><img src="/blog/_assets/jenkins-blue-create.de5965d6.png" alt="jenkins-blue-create"></p><p>或者直接连接 github 仓库，需要 token，直接点击红框去创建即可：</p><p><img src="/blog/_assets/jenkins-blue-create1.1d625fb6.png" alt="jenkins-blue-create1"></p></li></ol><h3 id="通过项目中的-jenkinsfile-构建"><a class="header-anchor" href="#通过项目中的-jenkinsfile-构建" aria-hidden="true">#</a> 通过项目中的 Jenkinsfile 构建</h3><p>再把对应的 Pipeline script 代码复制到对应代码仓库的 <code>Jenkinsfile</code> 文件，设置为 Pipeline script from SCM，填写 git 信息。</p><p><img src="/blog/_assets/jenkins-pipeline-config-scm.0838cb45.png" alt="jenkins-pipeline-config-scm"></p><p>正常情况下，Jenkins 会自动检测代码仓库的 <code>Jenkinsfile</code> 文件，如果选择的文件没有 Jenkinsfile 文件时就会报错，如下：</p><p><img src="/blog/_assets/jenkins-pipeline-scm-error.914a8959.png" alt="jenkins-pipeline-scm-error"></p><p>正常按照流水线的执行流程，打开 Blue Ocean，查看构建结果，如下：</p><p><img src="/blog/_assets/jenkins-pipeline-scm-result.e0f72ce2.png" alt="jenkins-pipeline-scm-result"></p><h3 id="片段生成器"><a class="header-anchor" href="#片段生成器" aria-hidden="true">#</a> 片段生成器</h3><p>如果你觉得上述代码手写麻烦，刚开始时又不会写，那么就可以使用片段代码生成器来帮助我们生成流水线语法。</p><p>进入任务构建页面，点击 <code>流水线语法</code> 进入：</p><h3 id="配置构建过程遇到的问题"><a class="header-anchor" href="#配置构建过程遇到的问题" aria-hidden="true">#</a> 配置构建过程遇到的问题</h3><ol><li><p>Jenkins 工作空间权限问题</p><p><img src="/blog/_assets/jenkins-pipeline-error.229cec12.png" alt="jenkins-pipeline-error"></p><p>修复：</p><div class="language-bash"><pre><code><span class="token function">chown</span> -R jenkins:jenkins /var/lib/jenkins/workspace
</code></pre></div></li><li><p>Git Parameters 不显示问题</p><p>当配置完 Git Parameters 第一次点击构建时，会报如下错误，找了很久也没有找到解决方法，于是就先使用 master 分支构建了一次，构建完成之后再次点击构建这里就正常显示了，猜测是没构建前没有 git 仓库的信息，构建完一次后就有了构建信息，于是就正常显示了。</p><p><img src="/blog/_assets/jenkins-pipeline-error1.50e8bd4b.png" alt="jenkins-pipeline-error1"></p></li></ol><h2 id="总结"><a class="header-anchor" href="#总结" aria-hidden="true">#</a> 总结</h2><p>本文对 Jenkins 的基本教程就到此为止了，主要讲了 Jenkins 的安装部署，FreeStyle project 和 Pipeline 的使用，以及插件安装、配置等。如果想要学，跟着我这个教程实操一遍，Jenkins 就基本掌握了，基本工作中遇到的问题都能解决，剩下的就只能在实际工作中慢慢摸索了。</p><p>再说回最初的话题，前端需不需要学习 Jenkins。我认为接触新的东西，然后学习并掌握，拓宽了技术面，虽然是一种压力，也是得到了成长的机会，在这个前端技术日新月异的时代，前端们不仅要熟练掌握前端技术，还需要具备一定的后端知识和自动化构建能力，才能不那么容易被大环境淘汰。</p></div><div class="links-wrapper"><div class="prev-link"><!----></div><div class="next-link"><!----></div></div><div><footer class="page-edit"><!-- <a v-for="(item,index) in data.platform" :key="index" :href="item.href">
        <img class="imgIcon" :src="item.icon" />
      </a> --></footer><!-- <p class="platform">
      以上皆为
      <a href="javascript:;">纪年</a> 文章发布平台
    </p> --><p class="platform"><a href="https://beian.miit.gov.cn/" target="_blank">京ICP备2022027737号</a><br> Copyright © 2022 - present <a href="https://github.com/wang1xiang">@wangxiang</a></p></div><!--[--><!--]--></div><!-- 只想点击背景才关闭 请使用 .self 修饰符 --><div style="display:none;" class="imgBox"><img src=""></div><!--]--></main><div class="theme-select" data-v-afcf09d4><ul data-v-afcf09d4><li class="active" data-v-afcf09d4>☀️</li><li class="" data-v-afcf09d4>🌑</li></ul></div></div><!----><!--]--></div>
    <script>__VP_HASH_MAP__ = JSON.parse("{\"README.md\":\"5249837d\",\"index.md\":\"1a88f2f0\",\"more_docs.md\":\"56afc234\",\"more_index.md\":\"7d2a75aa\",\"more_tags.md\":\"971f9648\",\"docs_css_grid.md\":\"819b30c7\",\"docs_css_placeholder.md\":\"31806d9d\",\"docs_css_tailWindcss-start.md\":\"23d03cb4\",\"docs_docker_docker-start.md\":\"b24ca2b3\",\"docs_electron_electron-bug.md\":\"f1d66f17\",\"docs_electron_electron-check-update.md\":\"89cb8f5e\",\"docs_electron_electron-diaoyan.md\":\"bc05f4f2\",\"docs_electron_electron-object-destroyed.md\":\"d8a551b0\",\"docs_electron_electron-og.md\":\"b9e213a6\",\"docs_electron_electron-open-other.md\":\"185ce0f8\",\"docs_electron_electron-protocol.md\":\"45a1a312\",\"docs_electron_electron-sentry.md\":\"7ff7df74\",\"docs_electron_electron-sign-windows.md\":\"1313b519\",\"docs_electron_electron-sign.md\":\"ac9a3b61\",\"docs_electron_electron-sqlite3-bug.md\":\"1aa0abec\",\"docs_electron_electron-sqlite3-start.md\":\"6cce6f55\",\"docs_electron_electron-sqlite3.md\":\"99f5b749\",\"docs_electron_electron-start.md\":\"766eb49a\",\"docs_electron_electron-update.md\":\"9760af84\",\"docs_electron_electron-webview-zoom.md\":\"b72d634f\",\"docs_electron_hybrid-electron.md\":\"4807e192\",\"docs_electron_sentry-electron.md\":\"3f4d4b65\",\"docs_flutter_flutter-dart.md\":\"732ec407\",\"docs_flutter_flutter-other.md\":\"ac371147\",\"docs_flutter_flutter-route-manage.md\":\"9a25e74d\",\"docs_flutter_flutter-start.md\":\"38381fcb\",\"docs_flutter_flutter-state-manage.md\":\"1b5342ac\",\"docs_flutter_flutter-wechat-pay.md\":\"f2d70382\",\"docs_git_git-autocrlf.md\":\"0546ba4c\",\"docs_git_git-ignorecase.md\":\"1eeb9be7\",\"docs_git_git-notes.md\":\"0d9446e6\",\"docs_git_git-rebase.md\":\"682b7a39\",\"docs_git_git-username.md\":\"6843cec1\",\"docs_git_gitflow.md\":\"f932cb90\",\"docs_git_gitlab-ci-start.md\":\"0796bac0\",\"docs_http_http.md\":\"da15fe30\",\"docs_javascript_async-await.md\":\"f9e3f078\",\"docs_javascript_createEvent.md\":\"c0adf681\",\"docs_javascript_html2docs.md\":\"3bbc21fb\",\"docs_javascript_http-cache.md\":\"2d8b830a\",\"docs_javascript_image-load.md\":\"052641dd\",\"docs_javascript_indexDB-dexie.md\":\"013bd221\",\"docs_javascript_javascript-utils.md\":\"5ca937ae\",\"docs_javascript_memory-leak.md\":\"e9b175fa\",\"docs_javascript_office-preview-type.md\":\"2aadc329\",\"docs_javascript_page-alive.md\":\"563b7275\",\"docs_javascript_performance-optimization.md\":\"9c550aaf\",\"docs_javascript_preload-prefetch.md\":\"e253f4a9\",\"docs_javascript_scrollend.md\":\"b27077cb\",\"docs_javascript_storage-change.md\":\"1bd2ec55\",\"docs_javascript_turborepo-start.md\":\"ffd235b8\",\"docs_javascript_webworker.md\":\"9c4934f2\",\"docs_javascript_zero-width-space.md\":\"c57ba9a7\",\"docs_leetcode_array-code.md\":\"4a3b8c40\",\"docs_leetcode_array-code1.md\":\"e537f1b4\",\"docs_leetcode_back-tracking-code.md\":\"6ecb6695\",\"docs_leetcode_back-tracking-code1.md\":\"4700727a\",\"docs_leetcode_back-tracking-code2.md\":\"15acf5d5\",\"docs_leetcode_back-tracking-code3.md\":\"51bdfa84\",\"docs_leetcode_binary-tree-code.md\":\"be171c27\",\"docs_leetcode_binary-tree-code1.md\":\"5691c57a\",\"docs_leetcode_binary-tree-code2.md\":\"096a9ced\",\"docs_leetcode_binary-tree-code3.md\":\"c118aa8a\",\"docs_leetcode_binary-tree-code4.md\":\"0a936a78\",\"docs_leetcode_binary-tree-code5.md\":\"aa3cf6c1\",\"docs_leetcode_binary-tree-code6.md\":\"e4f46b82\",\"docs_leetcode_binary-tree-code7.md\":\"1292d82d\",\"docs_leetcode_dynamic-programming-code.md\":\"08d6469b\",\"docs_leetcode_dynamic-programming-code2.md\":\"9ac0135c\",\"docs_leetcode_greedy-algorithmc-code.md\":\"b9e1256c\",\"docs_leetcode_greedy-algorithmc-code2.md\":\"b175cec2\",\"docs_leetcode_greedy-algorithmc-code3.md\":\"3a30b884\",\"docs_leetcode_greedy-algorithmc-code4.md\":\"08c0ded4\",\"docs_leetcode_greedy-algorithmc-code5.md\":\"2c59f1eb\",\"docs_leetcode_hash-code.md\":\"de5843b9\",\"docs_leetcode_hash-code1.md\":\"e1f2a84c\",\"docs_leetcode_linked-list-code.md\":\"dda892c3\",\"docs_leetcode_linked-list-code1.md\":\"a013b96a\",\"docs_leetcode_stack-code.md\":\"5a305115\",\"docs_leetcode_stack-code1.md\":\"df25cf2f\",\"docs_leetcode_string-code.md\":\"1551c770\",\"docs_leetcode_string-code1.md\":\"5a97476b\",\"docs_linux_centos-docker.md\":\"6bd1950c\",\"docs_linux_linux-no-possword.md\":\"bfd5c815\",\"docs_mobile_mobileDebugging.md\":\"eb01b512\",\"docs_nest_mysql-satart.md\":\"76f52256\",\"docs_nest_nest-bff.md\":\"1eca8332\",\"docs_nest_nest-start.md\":\"4252dc3b\",\"docs_node_bff-express-esm.md\":\"c6226aee\",\"docs_node_bff-express.md\":\"edc18afd\",\"docs_node_bff.md\":\"641e27cc\",\"docs_node_deploy-server.md\":\"db321263\",\"docs_node_express-mysql2.md\":\"d75f7b59\",\"docs_node_express-swigger.md\":\"037abe91\",\"docs_node_socketIO-start.md\":\"ad317b90\",\"docs_photography_nd.md\":\"a863d711\",\"docs_pnpm_pnpm-monorepo.md\":\"0261d6ed\",\"docs_prosemirror_html2docs-pdf.md\":\"7c710c2e\",\"docs_react_create-react-app.md\":\"c8cf1591\",\"docs_react_dompurify.md\":\"1407499a\",\"docs_react_eslint-react.md\":\"2762b0fc\",\"docs_react_react-classnames.md\":\"dabc5f7a\",\"docs_react_react-grid-layout.md\":\"c48591ef\",\"docs_react_react-intl.md\":\"b4c59820\",\"docs_react_react-philosophies.md\":\"c7e344a0\",\"docs_react_react-query.md\":\"69334fa7\",\"docs_react_react-router-change.md\":\"059fc679\",\"docs_react_react-vs-vue3.md\":\"b4198b25\",\"docs_react_redux-audition.md\":\"cc7e4899\",\"docs_react_tomcat-404.md\":\"6a557377\",\"docs_reactNative_react-native-errors.md\":\"52f8ded9\",\"docs_taro_taro-get-started.md\":\"4bcf9c4f\",\"docs_taro_taro-start.md\":\"56273c9b\",\"docs_tiptap_tiptap-tutorial.md\":\"283dc1b9\",\"docs_tiptap_tiptap-tutorial10.md\":\"eb3805c6\",\"docs_tiptap_tiptap-tutorial2.md\":\"70b47a25\",\"docs_tiptap_tiptap-tutorial3.md\":\"3e1738c7\",\"docs_tiptap_tiptap-tutorial4.md\":\"44a26566\",\"docs_tiptap_tiptap-tutorial5.md\":\"f8e623cc\",\"docs_tiptap_tiptap-tutorial6.md\":\"3b2a1158\",\"docs_tiptap_tiptap-tutorial7.md\":\"00d888b7\",\"docs_tiptap_tiptap-tutorial8.md\":\"53ff156f\",\"docs_tiptap_tiptap-tutorial9.md\":\"f74a35ee\",\"docs_tool_2023-summary.md\":\"0ed2cb41\",\"docs_tool_2024-summary.md\":\"c75ea118\",\"docs_tool_blog.md\":\"2aae3cbb\",\"docs_tool_chatgpt.md\":\"764288d9\",\"docs_tool_chrome-extension.md\":\"8a69651a\",\"docs_tool_chrome-override.md\":\"96233581\",\"docs_tool_debugging.md\":\"be8a5e6f\",\"docs_tool_mac.md\":\"71e15080\",\"docs_tool_mock.md\":\"2f27b416\",\"docs_tool_moment-api.md\":\"c52c80e6\",\"docs_tool_mvp.md\":\"612e166c\",\"docs_tool_np.md\":\"4734f1ad\",\"docs_tool_prosemirror-tables.md\":\"31f3bf99\",\"docs_tool_vitepress-error.md\":\"25998e7d\",\"docs_tool_vscode-web-error.md\":\"f531af1d\",\"docs_tool_whistle.md\":\"2fe60924\",\"docs_tool_yarn-certificate.md\":\"2ad606e6\",\"docs_vite_componentLibrary.md\":\"a6d95e48\",\"docs_vite_create-vite.md\":\"d386a322\",\"docs_vite_vite-env.md\":\"4f479c1c\",\"docs_vite_vite-mulit-import.md\":\"d12d3fdb\",\"docs_vite_vite-react-cli.md\":\"9ed902a2\",\"docs_vite_vite-react.md\":\"f8a831ef\",\"docs_vite_vite.md\":\"20048ded\",\"docs_vite_vite3.0.md\":\"d6f6b8ad\",\"docs_vscode_vscode-markdown.md\":\"3de99e9f\",\"docs_vscode_vscode-todo.md\":\"9f2b627c\",\"docs_vue_antd-form.md\":\"2bc3333f\",\"docs_vue_antd-vue.md\":\"ef70c9a4\",\"docs_vue_axios-token.md\":\"d531fca7\",\"docs_vue_history-mode.md\":\"2b5901e5\",\"docs_vue_keepAlive.md\":\"95b1acdd\",\"docs_vue_tjTodo.md\":\"ae62ff71\",\"docs_vue_unplugin-auto-import.md\":\"5dd732e7\",\"docs_vue_vue-scoped-issue.md\":\"86213b20\",\"docs_vue_vue3-jsx.md\":\"05937363\",\"docs_vue_vue3-lint-staged.md\":\"602fd060\",\"docs_vue_vue3-unexpected-token.md\":\"65582750\",\"docs_webrtc_getstarted-webrtc.md\":\"595c0da1\",\"docs_webrtc_livekit-start.md\":\"b898eaee\",\"docs_webrtc_webrtc-one.md\":\"0eaddb96\",\"docs_wechat_uniapp-start.md\":\"803311b6\",\"docs_wechat_wechat-app.md\":\"039baf94\",\"docs_work_360-develop.md\":\"ccbad4ab\",\"docs_work_babel.md\":\"f91c1586\",\"docs_work_click-event.md\":\"568a49e9\",\"docs_work_contentEdit-div-insert.md\":\"4aae094a\",\"docs_work_developer.md\":\"dddb12b1\",\"docs_work_echarts.md\":\"064baad2\",\"docs_work_email-font.md\":\"3b8737a3\",\"docs_work_excalidraw-use.md\":\"66a5c580\",\"docs_work_excalidraw.md\":\"62019d0d\",\"docs_work_font-loading-speed.md\":\"2c76c436\",\"docs_work_g2-vs-echarts.md\":\"329bdf44\",\"docs_work_h5-app.md\":\"958acddd\",\"docs_work_html2canvas-bug.md\":\"6b4807a0\",\"docs_work_i18n.md\":\"b187a026\",\"docs_work_image-type.md\":\"039f024b\",\"docs_work_jenkins-start.md\":\"38f362c4\",\"docs_work_js-long.md\":\"0f97b11f\",\"docs_work_malformed.md\":\"2ff3bd53\",\"docs_work_mutationObserver.md\":\"3dabe5b9\",\"docs_work_node16-docker.md\":\"b746c6ae\",\"docs_work_one-react-screenshots.md\":\"61c19689\",\"docs_work_plop-express.md\":\"90172eb0\",\"docs_work_puppeteer.md\":\"3d994735\",\"docs_work_react-ref.md\":\"dfe3b3d7\",\"docs_work_report-2023.md\":\"770e2a76\",\"docs_work_report-regular.md\":\"3cc165b1\",\"docs_work_richeditor.md\":\"a7ad7d98\",\"docs_work_sentry-cli-error.md\":\"9a5e8f08\",\"docs_work_sentry-error.md\":\"3de049b0\",\"docs_work_sentry.md\":\"0bbf39d6\",\"docs_work_server-deploy.md\":\"282cbaa2\",\"docs_work_sse.md\":\"74abf2af\",\"docs_work_text-decoration.md\":\"e906a8fb\",\"docs_work_unocss.md\":\"0b42b112\",\"docs_work_white-board.md\":\"8e6f7cfe\",\"docs_work_word-cpu.md\":\"3efd452d\",\"docs_work_zero-width-spaces.md\":\"9f6ac888\"}")</script>
    <script type="module" async src="/blog/_assets/app.41c738e0.js"></script>
  </body>
</html>