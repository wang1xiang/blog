---
date: 2023-4-16
title: ä¸æ˜¯å§ï¼Ÿ2023äº†ç«Ÿç„¶è¿˜æœ‰äººç”¨Try-Catchæ¥å¤„ç†async...awaitå¼‚å¸¸
tags:
  - javascript
  - work
describe: async/await æ˜¯åœ¨ ES2017 ä¸­å¼•å…¥çš„ï¼Œç›®çš„æ˜¯ä¸ºäº†è®©å¼‚æ­¥æ“ä½œæ›´åŠ ç›´è§‚ã€æ–¹ä¾¿ï¼ŒåŒæ—¶ä¹Ÿè§£å†³äº† Promise çš„å›è°ƒåœ°ç‹±é—®é¢˜ã€‚é‚£ä¹ˆæˆ‘ä»¬è¯¥ä»€ä¹ˆæ—¶å€™å»æ•è· async/await çš„å¼‚å¸¸å‘¢ï¼Ÿ
---

## å†™åœ¨å‰é¢

ä¸çŸ¥é“å¤§å®¶é¡¹ç›®é‡Œé¢æ˜¯æ€ä¹ˆå¤„ç† async/await çš„å¼‚å¸¸ï¼Œæˆ‘æ–—èƒ†åœ¨æˆ‘ä»¬é¡¹ç›®é‡Œç¿»äº†ä¸€ä¸‹ï¼Œå‘ç°å¤§é‡ä½¿ç”¨ try-catch æ¥å¤„ç† async/await å¼‚å¸¸ã€‚

![try-await-catch.png](./images/try-awati-catch.png)

é¦–å…ˆè¯´æ˜ä¸€ä¸‹ï¼Œ try-catch å¤„ç†å¹¶æ²¡æœ‰ä»€ä¹ˆé—®é¢˜ï¼Œæˆ‘åªæ˜¯è§‰å¾—è¿™ä¹ˆå†™ä»£ç ä¼šæœ‰ç‚¹ä¹±ï¼Œæ„Ÿè§‰ä»£ç é€»è¾‘åƒæ˜¯æ–­å±‚äº†ä¸€æ ·ï¼Œä¸æ˜“ç†è§£ï¼›
å…¶æ¬¡æ˜¯ä»£ç å†—ä½™é—®é¢˜ï¼Œå•ä¸ª try-catch å°±å äº†å¥½å‡ è¡Œä»£ç ï¼Œå¦‚æœæ¯ä¸ªè¯·æ±‚çš„åœ°æ–¹éƒ½æ·»åŠ  try-catchï¼Œå°±ä¼šæ˜¾å¾—ä»£ç å¾ˆè‡ƒè‚¿ã€‚
è€Œå¯¹äºè¿™ç§å¤§é‡ç›¸åŒçš„å†—ä½™ä»£ç ï¼Œå®Œå…¨å¯ä»¥ç”¨ä¸€ç§é€šç”¨çš„å‡½æ•°æ¥æ›¿ä»£ã€‚

async/await æ˜¯åœ¨ ES2017 ä¸­å¼•å…¥çš„ï¼Œç›®çš„æ˜¯ä¸ºäº†è®©å¼‚æ­¥æ“ä½œæ›´åŠ ç›´è§‚ã€æ–¹ä¾¿ï¼ŒåŒæ—¶ä¹Ÿè§£å†³äº† Promise çš„å›è°ƒåœ°ç‹±é—®é¢˜ã€‚æƒ³å¿…è¿™äº›æ¦‚å¿µå¤§å®¶éƒ½å·²ç»äº†è§£äº†ï¼Œ**é‚£ä¹ˆæˆ‘ä»¬ä¸ºä»€ä¹ˆè¦æ•è· async/await çš„å¼‚å¸¸å‘¢ï¼Ÿå®ƒä»¬æ˜¯åœ¨ä»€ä¹ˆæ—¶å€™å‘ç”Ÿå¼‚å¸¸å‘¢ï¼Ÿ** å¸¦ç€é—®é¢˜æˆ‘ä»¬ä¸€èµ·çœ‹ä¸€ä¸‹æœ¬æ–‡ã€‚

## ä»€ä¹ˆæ—¶å€™ä¼šè¯·æ±‚å¼‚å¸¸

æˆ‘ä»¬éƒ½çŸ¥é“ await åé¢ä¸€èˆ¬éƒ½æ˜¯å¼‚æ­¥è¯·æ±‚ï¼Œå¼‚æ­¥è¯·æ±‚å‘ç”Ÿå¼‚å¸¸çš„åŸå› å¤§è‡´æœ‰ä»¥ä¸‹å‡ ç§ï¼š

1. ç½‘ç»œé—®é¢˜å¯¼è‡´ï¼Œç½‘ç»œæ–­å¼€è¿æ¥ï¼Œè¯·æ±‚ä¸åˆ°ï¼›
2. ç½‘ç»œæ…¢å¯¼è‡´å¼‚æ­¥è¯·æ±‚è¶…æ—¶ã€‚

## ä»€ä¹ˆæƒ…å†µä¸‹éœ€è¦å¤„ç†è¯·æ±‚å¼‚å¸¸

ä¸€æ—¦æœ‰ä»¥ä¸Šæƒ…å†µå‡ºç°ï¼Œè¿™ä¸ªå¼‚æ­¥è¯·æ±‚å°±ä¼šäº§ç”Ÿå¼‚å¸¸ï¼Œè€Œ JavaScript åˆæ˜¯ä¸€ä¸ªå•çº¿ç¨‹è¯­è¨€ï¼Œä»£ç æŠ¥é”™åå°±ä¼šå¯¼è‡´åé¢çš„ä»£ç æ— æ³•ç»§ç»­æ‰§è¡Œï¼Œæ‰€ä»¥æ­¤æ—¶å°±éœ€è¦æ·»åŠ  try-catch æ¥æ•è·å¼‚æ­¥è¯·æ±‚çš„å¼‚å¸¸ï¼Œä½¿å¾—ä»£ç å¯ä»¥ç»§ç»­å‘åæ‰§è¡Œã€‚

**ä½†æœ‰å¿…è¦ä¸ºæ‰€æœ‰çš„å¼‚æ­¥è¯·æ±‚éƒ½åŠ  try-catch å—ï¼Ÿ**

æˆ‘ç ”ç©¶äº†ä¸‹æˆ‘ä»¬é¡¹ç›®çš„ä»£ç ï¼Œå¼‚æ­¥è¯·æ±‚åŠ äº† try-catch å¤„ç†çš„ï¼Œæœ‰ä»¥ä¸‹å‡ ç§æƒ…å†µï¼š

### å¤šä¸ªå¼‚æ­¥è¯·æ±‚ä¸²è¡Œ

```js
try {
  // è·å–åˆ—è¡¨list
  const list = await getList(params)
  // è·å–å•ä¸ªè¯¦æƒ…
  const info = await getListById(list[0]?.id)
} catch {}
```

å‰ä¸€ä¸ªå¼‚æ­¥è¯·æ±‚çš„è¿”å›ç»“æœï¼Œä¼šä½œä¸ºåä¸€ä¸ªå¼‚æ­¥è¯·æ±‚çš„è¯·æ±‚å‚æ•°ä½¿ç”¨ï¼Œæ‰€ä»¥ä¸€æ—¦å‰ä¸€ä¸ªè¯·æ±‚å¼‚å¸¸ï¼Œåé¢çš„è¯·æ±‚è‚¯å®šä¼šå¼‚å¸¸ï¼Œæ‰€ä»¥éœ€è¦æ·»åŠ  try-catch å¤„ç†ã€‚

### å¤„ç†å¼‚æ­¥è¯·æ±‚çš„ loading çŠ¶æ€

```js
loading.value = true
try {
  // è·å–åˆ—è¡¨list
  const list = await getList(params)
} finally {
  loading.value = false
}
```

ä¸€èˆ¬æˆ‘ä»¬å¤„ç†å¼‚æ­¥è¯·æ±‚å‰ï¼Œä¼šä¸ºå…¶æ·»åŠ  loading çŠ¶æ€ï¼Œè€Œä¸€æ—¦è¯·æ±‚å¼‚å¸¸å‡ºç°æ—¶ï¼Œå¦‚æœä¸åŠ  try-catch æ—¶å°±ä¼šå¯¼è‡´é¡µé¢ä¸€ç›´å¤„äº loading çŠ¶æ€ã€‚æ‰€ä»¥éœ€è¦åœ¨`finally`ä¸­å°† loading çŠ¶æ€ç½®ä¸º falseï¼Œ`catchä¸­å¤„ç†æ—¶éœ€è¦å¤–éƒ¨å†å¤„ç†ä¸€æ¬¡`ã€‚

é‚£ä¹ˆï¼Œæˆ‘ä»¬å¦‚ä½•ä¼˜é›…çš„å¤„ç†å¼‚æ­¥è¯·æ±‚ä¸­çš„ try-catch å‘¢ï¼Ÿ

## å¤„ç†æ–¹æ³•

### ä½¿ç”¨ Promise å¤„ç†

é¦–å…ˆéœ€è¦æ˜ç¡®ä¸€ç‚¹ï¼š[æ­£å¸¸æƒ…å†µä¸‹ï¼Œawait å‘½ä»¤åé¢æ˜¯ä¸€ä¸ª Promise å¯¹è±¡](https://es6.ruanyifeng.com/#docs/async#await-%E5%91%BD%E4%BB%A4)ã€‚æ‰€ä»¥å®ƒæœ¬èº«å°±å¯ä»¥ä½¿ç”¨`.catch`æ¥æ•è·å¼‚å¸¸ï¼Œé‚£ä¹ˆåƒä¸Šé¢ç¬¬äºŒç§åªæ˜¯å¤„ç† loading çŠ¶æ€çš„æ“ä½œï¼Œå®Œå…¨å¯ä»¥åœ¨`.catch`è¿›è¡Œå¤„ç†ï¼Œç„¶åç”¨`if`åˆ¤æ–­æ¥æ§åˆ¶æå‰é€€å‡ºï¼Œæ²¡å¿…è¦å†™ try-catch è¿™ç§å†—ä½™ä»£ç ã€‚

```js
loading.value = true
let res = await getList().catch(() => (loading.value = false))
if (!res) return
// è¯·æ±‚æˆåŠŸåæ­£å¸¸æ“ä½œ
```

### await-to-js å¤„ç†å‡½æ•°

ç®€å•çš„å¼‚æ­¥è¯·æ±‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸Šé¢è¿™ç§æ–¹æ³•ï¼Œä½†é‡åˆ°å¤šä¸ªå¼‚æ­¥æ“ä½œæ—¶ï¼Œå°±éœ€è¦å€ŸåŠ©æˆ‘ä»¬ä»Šå¤©è¦è¯´çš„[await-to-js](https://github.com/scopsy/await-to-js)è¿™ä¸ªåº“ï¼Œå®ƒçš„ä»‹ç»å¾ˆç®€å•ï¼š**æ— éœ€ try-catch å³å¯è½»æ¾å¤„ç†é”™è¯¯**ã€‚

è€Œä¸”[æºç ](https://github.com/scopsy/await-to-js/blob/master/src/await-to-js.ts)è´¼ç®€å•ï¼Œå°± 23 è¡Œä»£ç ï¼Œæˆ‘ä»¬ä¸€èµ·æ¥çœ‹çœ‹ã€‚

```ts
/**
 * @param { Promise } promise
 * @param { Object= } errorExt - Additional Information you can pass to the err object
 * @return { Promise }
 */
export function to<T, U = Error>(
  promise: Promise<T>,
  errorExt?: object
): Promise<[U, undefined] | [null, T]> {
  return promise
    .then<[null, T]>((data: T) => [null, data])
    .catch<[U, undefined]>((err: U) => {
      if (errorExt) {
        const parsedError = Object.assign({}, err, errorExt)
        return [parsedError, undefined]
      }

      return [err, undefined]
    })
}

export default to
```

å¤§è‡´æµç¨‹å¦‚ä¸‹ï¼š
å‡½æ•°`to`æ¥å—å‚æ•°`Promise`å’Œ`errorExt`ï¼Œå¦‚æœè¿™ä¸ª Promise æˆåŠŸæ—¶è¿”å›`[null, data]`ï¼Œå¦‚æœå¼‚å¸¸æ—¶ä¼šåˆ¤æ–­æ˜¯å¦å¸¦æœ‰`errorExt`å‚æ•°ï¼ˆä»£è¡¨ä¼ é€’ç»™ err å¯¹è±¡çš„é™„åŠ ä¿¡æ¯ï¼‰ï¼Œå¦‚æœæœ‰æ—¶ä¼šä¸ catch æ•è·çš„ err åˆå¹¶è¿”å›ï¼Œå¦‚æœæ²¡æœ‰æ—¶è¿”å›`[err, undefined]`ã€‚

å¾ˆç®€å•çš„é€»è¾‘æ˜¯ä¸æ˜¯ï¼Œæ¥ç€æˆ‘ä»¬çœ‹ä¸‹å®ƒçš„ç”¨æ³•ï¼š

- å®‰è£…

  ```bash
  # use npm
  npm i await-to-js --save
  # use yarn
  yarn add await-to-js
  ```

- ä½¿ç”¨

  é¦–å…ˆå¼•å…¥`to`å‡½æ•°ï¼Œå¯ä»¥çœ‹åˆ°åŒ…å¾ˆå°ï¼Œåªæœ‰ 370bï¼Œgzip å‹ç¼©ååªæœ‰ 242bï¼Œæ‰€ä»¥æ”¾å¿ƒå¼•å…¥ï¼Œåˆ«æ‹…å¿ƒä»€ä¹ˆåŒ…å¤§å°é—®é¢˜ã€‚

  ![await-to-js-size.png](./images/await-to-js-size.png)

  æˆ‘ä»¬é€šè¿‡`to`æ¥æ”¹å†™ä¸€ä¸‹ä¸Šé¢ç¬¬ä¸€ç§é—®é¢˜ï¼š

  ```js
  import to from 'await-to-js'

  // è·å–åˆ—è¡¨list
  const [err, data] = await to(getList(params))
  if (err) return
  // è·å–å•ä¸ªè¯¦æƒ…
  const info = await to(getListById(list[0]?.id))
  ```

  é€šè¿‡`to`å‡½æ•°æ”¹é€ åï¼Œå¦‚æœè¿”å›ç¬¬ä¸€ä¸ªå‚æ•°ä¸ä¸ºç©ºæ—¶ï¼Œè¯´æ˜è¯¥è¯·æ±‚æŠ¥é”™ï¼Œå°±å¯ä»¥æå‰ return å‡ºå»ï¼Œå¦‚æœä¸å­˜åœ¨ç¬¬ä¸€ä¸ªå‚æ•°æ—¶ï¼Œåˆ™å¼‚æ­¥è¯·æ±‚æˆåŠŸã€‚

## æ€»ç»“

æœ¬æ–‡é€šè¿‡ç ”ç©¶ async/await çš„å¼‚å¸¸æ•è·ï¼Œå‘ç°äº†ä¸¤ç§å¸¸è§çš„å¼‚æ­¥è¯·æ±‚å¼‚å¸¸æ•è·ï¼Œå¹¶æå‡ºäº†ä¸¤ç§ç®€å•çš„è§£å†³æ–¹æ³•ã€‚é€šè¿‡è¿™ä¸¤ç§æ–¹æ³•ï¼Œå°±å¯ä»¥ä¸¢æ‰å†—ä½™çš„ try-catchï¼Œç„¶åä½ å°±ä¼šå‘ç°æ²¡äº† try-catch çš„ä»£ç çœ‹èµ·æ¥éƒ½æ˜¯é¡ºçœ¼çš„ã€‚

å¾ˆå¤šå°ä¼™ä¼´å¯èƒ½ä¹Ÿä¼šé‡åˆ°è¿™ä¸ªé—®é¢˜ï¼šå°½ç®¡ä½ æå‡ºäº†è§£å†³æ–¹æ¡ˆï¼Œä½†ä¾æ—§ä¼šæœ‰é¡¹ç›®ç»„æˆå‘˜ä¸ç”¨ã€‚ä½ è¦è¿™ä¹ˆæƒ³å°±é”™äº†ï¼Œè‡ªå·±é€šè¿‡ç ”ç©¶ã€æŸ¥èµ„æ–™ï¼Œæœ€ç»ˆå­¦åˆ°äº†ä¸œè¥¿å°±è¶³å¤Ÿäº†ï¼Œç®¡åˆ«äººå¹²å˜›ï¼æ²¡å¿…è¦å•Šã€‚

ä»¥ä¸Šå°±æ˜¯æœ¬æ–‡çš„å…¨éƒ¨å†…å®¹ï¼Œå¸Œæœ›è¿™ç¯‡æ–‡ç« å¯¹ä½ æœ‰æ‰€å¸®åŠ©ï¼Œæ¬¢è¿ç‚¹èµå’Œæ”¶è— ğŸ™ï¼Œå¦‚æœå‘ç°æœ‰ä»€ä¹ˆé”™è¯¯æˆ–è€…æ›´å¥½çš„è§£å†³æ–¹æ¡ˆåŠå»ºè®®ï¼Œæ¬¢è¿éšæ—¶è”ç³»ã€‚
