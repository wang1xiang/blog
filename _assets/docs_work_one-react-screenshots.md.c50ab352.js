import{f as e,g as s,J as t}from"./common-03e46d7f.js";const l='{"title":"记录一次One系统截图bug的定位与处理","frontmatter":{"date":"2024-04-23","title":"记录一次One系统截图bug的定位与处理","tags":["work"],"describe":"记录一次One系统截图bug的定位与处理"},"headers":[{"level":3,"title":"现象","slug":"现象"},{"level":3,"title":"问题分析","slug":"问题分析"},{"level":3,"title":"问题定位","slug":"问题定位"},{"level":3,"title":"总结","slug":"总结"}],"relativePath":"docs/work/one-react-screenshots.md","lastUpdated":1743400723447.4116}';var r={};const i=[t('<h3 id="现象"><a class="header-anchor" href="#现象" aria-hidden="true">#</a> 现象</h3><p>如图所示，当用快捷键或小剪刀进行截图时，聊天框内会出现多张相同的截图</p><p><img src="/blog/_assets/screenshot-bug.7cf4e589.png" alt="screenshot-bug"></p><h3 id="问题分析"><a class="header-anchor" href="#问题分析" aria-hidden="true">#</a> 问题分析</h3><p>根据现象，分析出现此问题有 2 种可能</p><ul><li>渲染进程监听了多次截图事件，导致截图事件触发时，多次绘图到页面</li><li>主进程本身截图有问题，触发了多次截图事件，导致渲染进程绘图多次</li></ul><h3 id="问题定位"><a class="header-anchor" href="#问题定位" aria-hidden="true">#</a> 问题定位</h3><p><img src="/blog/_assets/screenshot-bug-1.5e155d45.png" alt="screenshot-bug"></p><ol><li><p>针对第一个问题，找一些关键字，定位到具体文件，具体代码的位置（screenshotsOk 为事件绑定函数，返回值为“N”, 通过执行 N(),可进行解除绑定。在 onMounted 中进行事件绑定，onBeforeUnmount 中进行解除绑定。）</p></li><li><p>在触发的绘图函数内进行 debug，点击截图，观察函数执行次数。</p></li><li><p>发现这里只执行一次，可知渲染进程监听的截图事件没有问题，没有监听多次。</p></li><li><p>考虑主进程是否有问题，因为主进程无法在打包后的程序里 debug，只能通过日志来定位问题</p></li><li><p>日志位置</p><p><img src="/blog/_assets/screenshot-bug-2.8f4396d4.png" alt="screenshot-bug"></p></li><li><p>正常情况下一次截图会打印 startCapture-&gt;screenshots:ok-&gt;endCapture 3 个 log。如图所示，下面的日志，一次截图会触法 3 次相同的事件</p><p><img src="/blog/_assets/screenshot-bug-3.02147f02.png" alt="screenshot-bug"></p></li><li><p>根据日志，判断问题出在主进程，寻找主进程相关代码，应该是 initScreenshots 执行了多次，导致该函数中的事件注册了多次。</p><p><img src="/blog/_assets/screenshot-bug-4.db26bcbe.png" alt="screenshot-bug"></p></li><li><p>问题找到，决定把该部分代码改成单例模式，避免多次初始化</p><p><img src="/blog/_assets/screenshot-bug-5.309723e7.png" alt="screenshot-bug"></p></li><li><p>深度思考，之所以这里之前没有使用单例模式，是考虑到这块的代码只会执行一次，并不会多次执行。<strong>经过进一步的定位，发现是体验版和私有云进行切换时，主窗口会关闭，重新创建。主窗口重新创建时，会再次触发 ready-to-show 事件，也就再次触发了 initScreenshots 初始化截图。</strong></p><p><img src="/blog/_assets/screenshot-bug-6.25ce5b84.png" alt="screenshot-bug"></p></li><li><p>切换体验版和私有云后，该 bug 果然复现了，改成单例模式后，该 bug 没有出现，问题解决。</p></li></ol><h3 id="总结"><a class="header-anchor" href="#总结" aria-hidden="true">#</a> 总结</h3><ol><li><p>根据现象，分析可能出现问题的各种情况，逐一排查</p></li><li><p>主进程的开发过程中，可以在关键流程进行日志记录，有利于问题的发现。</p></li><li><p>主窗口并不是只有打开应该时创建一次，在切换私有云和体验版是会再次创建，后续的开发中应该注意</p></li></ol>',11)];r.render=function(t,l,r,a,o,n){return e(),s("div",null,i)};export{l as __pageData,r as default};
