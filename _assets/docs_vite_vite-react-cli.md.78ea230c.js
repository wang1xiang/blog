import{f as n,g as s,J as a}from"./common-03e46d7f.js";const t='{"title":"「记录篇」我是如何一步步为公司搭建react项目脚手架的","frontmatter":{"date":"2023-05-13","title":"「记录篇」我是如何一步步为公司搭建react项目脚手架的","tags":["vite"],"describe":"集成React-Router、Antd、Redux-Toolkit和React-Query，并封装ESLint+Prettier+Husky的React项目脚手架，快来试试吧！"},"headers":[{"level":2,"title":"🔥 运行流程","slug":"🔥-运行流程"},{"level":2,"title":"🎁 安装 & 使用","slug":"🎁-安装-使用"},{"level":2,"title":"起因","slug":"起因"},{"level":2,"title":"针对 create-vite 的修改","slug":"针对-create-vite-的修改"},{"level":3,"title":"删除不需要的模块","slug":"删除不需要的模块"},{"level":3,"title":"修改模板 vite.config.ts 代码","slug":"修改模板-vite-config-ts-代码"},{"level":3,"title":"使用 sass 作为 css 预处理器","slug":"使用-sass-作为-css-预处理器"},{"level":3,"title":"将 classnames 引入项目","slug":"将-classnames-引入项目"},{"level":2,"title":"统一代码 & git 规范","slug":"统一代码-git-规范"},{"level":3,"title":"使用 EditorConfig 统一 IDE 编码风格","slug":"使用-editorconfig-统一-ide-编码风格"},{"level":3,"title":"添加 eslint & prettier 用于代码规范","slug":"添加-eslint-prettier-用于代码规范"},{"level":3,"title":"添加 pre-commit 和 commit-msg 钩子","slug":"添加-pre-commit-和-commit-msg-钩子"},{"level":2,"title":"集成 ant design 作为 UI 库","slug":"集成-ant-design-作为-ui-库"},{"level":2,"title":"集成 react-router 作为路由","slug":"集成-react-router-作为路由"},{"level":3,"title":"react-router v6 说明","slug":"react-router-v6-说明"},{"level":3,"title":"react-router v6 使用教程","slug":"react-router-v6-使用教程"},{"level":2,"title":"集成 Redux toolkit 作为状态管理","slug":"集成-redux-toolkit-作为状态管理"},{"level":3,"title":"为什么是 Redux toolkit","slug":"为什么是-redux-toolkit"},{"level":3,"title":"Redux Toolkit 使用教程","slug":"redux-toolkit-使用教程"},{"level":3,"title":"Redux Toolkit 异步操作","slug":"redux-toolkit-异步操作"},{"level":2,"title":"集成 react-query 作为请求库","slug":"集成-react-query-作为请求库"},{"level":3,"title":"为什么是 react query","slug":"为什么是-react-query"},{"level":3,"title":"react query 使用教程","slug":"react-query-使用教程"},{"level":2,"title":"发布 npm","slug":"发布-npm"},{"level":2,"title":"如何使用","slug":"如何使用"},{"level":2,"title":"总结","slug":"总结"}],"relativePath":"docs/vite/vite-react-cli.md","lastUpdated":1743134641219.317}';var p={};const o=[a('<h1 id="create-vct"><a class="header-anchor" href="#create-vct" aria-hidden="true">#</a> <img src="/blog/_assets/create-vct.3c13469e.svg" alt="create-vct"> create-vct</h1><p>这是一个用于初始化 vite + React 企业级项目的脚手架工具。</p><h2 id="🔥-运行流程"><a class="header-anchor" href="#🔥-运行流程" aria-hidden="true">#</a> 🔥 运行流程</h2><p><img src="/blog/_assets/create-vct-flow.31105c05.gif" alt="create-vct-flow.gif"></p><h2 id="🎁-安装-使用"><a class="header-anchor" href="#🎁-安装-使用" aria-hidden="true">#</a> 🎁 安装 &amp; 使用</h2><div class="language-bash"><pre><code>npx create-vct\n\n<span class="token comment"># or</span>\n<span class="token function">npm</span> i create-vct -g\ncreate-vct\n</code></pre></div><h2 id="起因"><a class="header-anchor" href="#起因" aria-hidden="true">#</a> 起因</h2><p>我们公司前端统一用 vue3，但最近有个白板项目<a href="https://juejin.cn/post/7232947178691444794" target="_blank" rel="noopener noreferrer">产品经理：客户想要个画板，你们前端能不能做？</a>，只有 react 的框架可以做。领导说让我来弄这个项目，顺便完了之后搭一个 react 脚手架工具用于以后快速开发 react 应用。ok，接受挑战 😜。</p><p>create-vct 脚手架工具是在 create-vite 的基础上修改，封装了 react 中常用到的各种包：<a href="https://reactrouter.com/en/mRin" target="_blank" rel="noopener noreferrer">react-router</a>、<a href="https://redux-toolkit.js.org/" target="_blank" rel="noopener noreferrer">redux-toolkit</a>、<a href="https://cangsdarm.github.io/react-query-web-i18n/react/" target="_blank" rel="noopener noreferrer">react-query</a>、<a href="https://ant.design/index-cn" target="_blank" rel="noopener noreferrer">antd</a> 等等，包含 ts 和 js 版本，同时也封装了 eslint + prettier + husky + commitlint 用于团队规范。</p><p>下面让我们来看看整个过程，篇幅较长，请耐心观看。</p><h2 id="针对-create-vite-的修改"><a class="header-anchor" href="#针对-create-vite-的修改" aria-hidden="true">#</a> 针对 create-vite 的修改</h2><p><img src="/blog/_assets/create-vite-load.dec459a4.png" alt="create-vite-load.png"></p><p><strong>&quot;工欲善其事，必先利其器&quot;</strong>，开始之前，如果不熟悉 create-vite 源码的小伙伴，欢迎阅读这篇文章<a href="https://juejin.cn/post/7217750296171118651" target="_blank" rel="noopener noreferrer">站在巨人的肩膀上：你还不懂 create-vite 原理吗？来一起康康</a>，顺便动动你的小手手点个赞 👍。</p><h3 id="删除不需要的模块"><a class="header-anchor" href="#删除不需要的模块" aria-hidden="true">#</a> 删除不需要的模块</h3><p>因为我们只需要 react 的模板，所以把其他不需要的一并删除掉，最后只留下这些文件。 <img src="/blog/_assets/create-vite-delete.ea9e65d5.png" alt="create-vite-delete.png"></p><h3 id="修改模板-vite-config-ts-代码"><a class="header-anchor" href="#修改模板-vite-config-ts-代码" aria-hidden="true">#</a> 修改模板 vite.config.ts 代码</h3><ol><li><p>配置 alias 添加别名设置</p></li><li><p>配置 server 代理服务器</p><div class="language-ts"><pre><code> <span class="token comment">// vite.config.ts</span>\n <span class="token operator">...</span>\n <span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">defineConfig</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n   plugins<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token function">react</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n   resolve<span class="token operator">:</span> <span class="token punctuation">{</span>\n     alias<span class="token operator">:</span> <span class="token punctuation">{</span>\n       <span class="token string-property property">&#39;@&#39;</span><span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">&#39;src&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// src 路径</span>\n     <span class="token punctuation">}</span>\n   <span class="token punctuation">}</span><span class="token punctuation">,</span>\n   server<span class="token operator">:</span> <span class="token punctuation">{</span>\n     port<span class="token operator">:</span> <span class="token number">5173</span><span class="token punctuation">,</span> <span class="token comment">// 开发环境启动的端口</span>\n     proxy<span class="token operator">:</span> <span class="token punctuation">{</span>\n       <span class="token string-property property">&#39;/api&#39;</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n         <span class="token comment">// 当遇到 /api 路径时，将其转换成 target 的值</span>\n         target<span class="token operator">:</span> <span class="token string">&#39;http://xx.xx.xx.xx:8080/api&#39;</span><span class="token punctuation">,</span>\n         changeOrigin<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n         <span class="token function-variable function">rewrite</span><span class="token operator">:</span> <span class="token punctuation">(</span>path<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> path<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^\\/api</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 将 /api 重写为空</span>\n       <span class="token punctuation">}</span><span class="token punctuation">,</span>\n     <span class="token punctuation">}</span><span class="token punctuation">,</span>\n   <span class="token punctuation">}</span><span class="token punctuation">,</span>\n <span class="token punctuation">}</span><span class="token punctuation">)</span>\n</code></pre></div></li><li><p>路径别名同时需要配置 tsconfig.json，不然直接使用 ts 会报错</p><div class="language-json"><pre><code><span class="token comment">// tsconfig.json</span>\n<span class="token punctuation">{</span>\n  <span class="token property">&quot;compilerOptions&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n    <span class="token property">&quot;paths&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n      <span class="token property">&quot;@/*&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;./src/*&quot;</span><span class="token punctuation">]</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n</code></pre></div></li></ol><h3 id="使用-sass-作为-css-预处理器"><a class="header-anchor" href="#使用-sass-作为-css-预处理器" aria-hidden="true">#</a> 使用 sass 作为 css 预处理器</h3><p>公司项目都是使用 sass，所以这个脚手架自然使用 sass 来处理 css。</p><ol><li><p>在 package.json 中依赖中添加<code>&quot;sass&quot;: &quot;^1.62.1&quot;</code>；</p></li><li><p>将.css 后缀文件修改为.scss 后缀文件；</p></li><li><p>创建 src/styles/variables.scss，设置全局 sass 变量；</p></li><li><p>在 vite.config.js 中配置全局 sass 变量：</p><div class="language-js"><pre><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">defineConfig</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n  <span class="token operator">...</span>\n  <span class="token literal-property property">css</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n    <span class="token literal-property property">preprocessorOptions</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n      <span class="token literal-property property">scss</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n        <span class="token literal-property property">additionalData</span><span class="token operator">:</span> <span class="token string">&#39;@import &quot;@/styles/variables.scss&quot;;&#39;</span><span class="token punctuation">,</span>\n      <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token punctuation">}</span>\n  <span class="token operator">...</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span>\n</code></pre></div><p><strong>注意：vite 对.sass 已经提供了内置支持，所以不再需要安装 loader 了，<a href="https://cn.vitejs.dev/guide/features.html#css-pre-processors" target="_blank" rel="noopener noreferrer">官方解释</a></strong></p></li></ol><h3 id="将-classnames-引入项目"><a class="header-anchor" href="#将-classnames-引入项目" aria-hidden="true">#</a> 将 classnames 引入项目</h3><p>个人感觉 CSS Modules 比 CSS In JS 用起来更舒服，所以该脚手架使用 CSS Modules 的方式来处理 css，当然你也可以用 CSS In JS 的方式处理，项目模板没有太多 css 代码，不会影响到你的选择。</p><p>在 package.json 中依赖中添加<code>&quot;classnames&quot;: &quot;^2.3.2&quot;</code>即可。</p><p>使用也很简单：</p><div class="language-js"><pre><code><span class="token keyword">import</span> classNames <span class="token keyword">from</span> <span class="token string">&#39;classnames/bind&#39;</span>\n<span class="token keyword">import</span> styles <span class="token keyword">from</span> <span class="token string">&#39;./index.module.scss&#39;</span>\n<span class="token keyword">const</span> cx <span class="token operator">=</span> <span class="token function">classNames</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>styles<span class="token punctuation">)</span>\n\n<span class="token keyword">const</span> <span class="token function-variable function">App</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>\n  <span class="token keyword">return</span> <span class="token operator">&lt;</span>div className<span class="token operator">=</span><span class="token punctuation">{</span><span class="token function">cx</span><span class="token punctuation">(</span><span class="token string">&#39;btn&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;btn-primary&#39;</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>\n<span class="token punctuation">}</span>\n</code></pre></div><h2 id="统一代码-git-规范"><a class="header-anchor" href="#统一代码-git-规范" aria-hidden="true">#</a> 统一代码 &amp; git 规范</h2><p><img src="/blog/_assets/eslint-logo.7cebb5dd.png" alt="eslint-logo.png"></p><h3 id="使用-editorconfig-统一-ide-编码风格"><a class="header-anchor" href="#使用-editorconfig-统一-ide-编码风格" aria-hidden="true">#</a> 使用 EditorConfig 统一 IDE 编码风格</h3><p>.editorconfig 文件创建在项目根目录下：</p><div class="language-bash"><pre><code><span class="token punctuation">[</span>*<span class="token punctuation">]</span>\nindent_style <span class="token operator">=</span> space\nindent_size <span class="token operator">=</span> <span class="token number">2</span>\nend_of_line <span class="token operator">=</span> lf\ncharset <span class="token operator">=</span> utf-8\ntrim_trailing_whitespace <span class="token operator">=</span> <span class="token boolean">false</span>\ninsert_final_newline <span class="token operator">=</span> <span class="token boolean">false</span>\n</code></pre></div><h3 id="添加-eslint-prettier-用于代码规范"><a class="header-anchor" href="#添加-eslint-prettier-用于代码规范" aria-hidden="true">#</a> 添加 eslint &amp; prettier 用于代码规范</h3><p>eslint 和 prettier 的安装参考的是<a href="https://github.com/tzsk/vite-pretty-lint" target="_blank" rel="noopener noreferrer">vite-pretty-lint</a>，将项目源码克隆到本地，只需要创建文件的那部分代码，其余的可删除。</p><h3 id="添加-pre-commit-和-commit-msg-钩子"><a class="header-anchor" href="#添加-pre-commit-和-commit-msg-钩子" aria-hidden="true">#</a> 添加 pre-commit 和 commit-msg 钩子</h3><p>添加 githooks，在提交前对代码进行校验和格式化处理，并规范提交信息，可以参考我之前的文章：<a href="https://juejin.cn/post/7215454235046445112" target="_blank" rel="noopener noreferrer">vue3 项目添加 husky+lint-staged 配置</a>。</p><p>我们看看在一个项目中配置 git hooks 都需要哪些步骤。</p><ol><li><p>添加 husky 和 lint-staged 依赖</p><div class="language-bash"><pre><code><span class="token function">yarn</span> <span class="token function">add</span> lint-staged husky\n</code></pre></div></li><li><p>初始化 husky，生成.husky 文件</p><div class="language-bash"><pre><code><span class="token function">yarn</span> husky <span class="token function">install</span>\n</code></pre></div></li><li><p>在 package.json 的 scripts 中添加 prepare 个钩子</p><div class="language-json"><pre><code> <span class="token property">&quot;scripts&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n   <span class="token property">&quot;dev&quot;</span><span class="token operator">:</span> <span class="token string">&quot;vite&quot;</span><span class="token punctuation">,</span>\n   <span class="token property">&quot;build&quot;</span><span class="token operator">:</span> <span class="token string">&quot;tsc &amp;&amp; vite build&quot;</span><span class="token punctuation">,</span>\n   <span class="token property">&quot;preview&quot;</span><span class="token operator">:</span> <span class="token string">&quot;vite preview&quot;</span><span class="token punctuation">,</span>\n   <span class="token property">&quot;lint&quot;</span><span class="token operator">:</span> <span class="token string">&quot;eslint --ext .ts --ext .tsx src --fix&quot;</span><span class="token punctuation">,</span>\n   <span class="token property">&quot;prepare&quot;</span><span class="token operator">:</span> <span class="token string">&quot;npx husky install&quot;</span>\n <span class="token punctuation">}</span><span class="token punctuation">,</span>\n</code></pre></div></li><li><p>在 package.json 中配置 lint-staged</p><div class="language-json"><pre><code> <span class="token property">&quot;lint-staged&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n   <span class="token property">&quot;src/**/*.{js,jsx,ts,tsx,json,md}&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>\n     <span class="token string">&quot;eslint --fix --max-warnings=0&quot;</span><span class="token punctuation">,</span>\n     <span class="token string">&quot;prettier --write&quot;</span>\n   <span class="token punctuation">]</span><span class="token punctuation">,</span>\n   <span class="token property">&quot;src/**/*.{scss,less,css}&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>\n     <span class="token string">&quot;prettier --write&quot;</span>\n   <span class="token punctuation">]</span><span class="token punctuation">,</span>\n <span class="token punctuation">}</span>\n</code></pre></div></li><li><p>添加 pre-commit 钩子，会在.husky 目录下生成 pre-commit 文件</p><div class="language-bash"><pre><code>npx husky <span class="token function">add</span> .husky/pre-commit <span class="token string">&quot;npx lint-staged&quot;</span>\n</code></pre></div><p>这一步完成后，在提交代码的时候就会有对暂存区的代码做 ESLint 代码校验和 Prettier 格式化处理。</p></li><li><p>接着是 commitlint 规范提交信息，安装依赖</p><div class="language-bash"><pre><code><span class="token function">yarn</span> <span class="token function">add</span> @commitlint/cli @commitlint/config-conventional -D\n</code></pre></div></li><li><p>创建 commitlint.config.js 配置文件</p><div class="language-js"><pre><code>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>\n  <span class="token keyword">extends</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&#39;@commitlint/config-conventional&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span>\n</code></pre></div></li><li><p>生成 pre-commit hook</p><div class="language-bash"><pre><code>npx husky <span class="token function">add</span> .husky/commit-msg <span class="token string">&#39;npx commitlint --edit&#39;</span>\n</code></pre></div></li><li><p>到这里，husky + lint-staged + commitlint 都配置完成了。</p><p><img src="/blog/_assets/husky-error.be7e10b3.png" alt="husky-error.png"></p></li></ol><p>这一步完成后，我们同时配置了代码规范和 git 规范，添加了 husky，所以需要在项目创建完成后，首先<strong>执行一下 git init 初始化 git 仓库，然后 husky 才能正常运行</strong>，于是就把提示信息多加了一项 🤔，如下：</p><p><img src="/blog/_assets/create-vct-init.a6fdd41c.png" alt="create-vct-init.png"></p><p>基于以上，我们修改 create-vite 的代码，添加如下：</p><div class="language-js"><pre><code><span class="token keyword">if</span> <span class="token punctuation">(</span>isEslint<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> eslintTemplate <span class="token operator">=</span> <span class="token string">&#39;../eslint-templates&#39;</span>\n  <span class="token keyword">const</span> eslintFile <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>targetPath<span class="token punctuation">,</span> <span class="token string">&#39;.eslintrc.json&#39;</span><span class="token punctuation">)</span>\n  <span class="token keyword">const</span> prettierFile <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>targetPath<span class="token punctuation">,</span> <span class="token string">&#39;.prettierrc.json&#39;</span><span class="token punctuation">)</span>\n  <span class="token keyword">const</span> eslintIgnoreFile <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>targetPath<span class="token punctuation">,</span> <span class="token string">&#39;.eslintignore&#39;</span><span class="token punctuation">)</span>\n  <span class="token keyword">const</span> <span class="token punctuation">{</span> packages<span class="token punctuation">,</span> eslintOverrides <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">import</span><span class="token punctuation">(</span>\n    <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>eslintTemplate<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>template<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.js</span><span class="token template-punctuation string">`</span></span>\n  <span class="token punctuation">)</span>\n\n  <span class="token keyword">const</span> packageList <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token operator">...</span>commonPackages<span class="token punctuation">,</span> <span class="token operator">...</span>packages <span class="token punctuation">}</span>\n  <span class="token keyword">const</span> eslintConfigOverrides <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">...</span>eslintConfig<span class="token punctuation">.</span>overrides<span class="token punctuation">,</span> <span class="token operator">...</span>eslintOverrides<span class="token punctuation">]</span>\n  <span class="token keyword">const</span> eslint <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token operator">...</span>eslintConfig<span class="token punctuation">,</span> <span class="token literal-property property">overrides</span><span class="token operator">:</span> eslintConfigOverrides <span class="token punctuation">}</span>\n\n  <span class="token keyword">const</span> viteConfigFiles <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">&#39;vite.config.js&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;vite.config.ts&#39;</span><span class="token punctuation">]</span>\n  <span class="token keyword">const</span> <span class="token punctuation">[</span>viteFile<span class="token punctuation">]</span> <span class="token operator">=</span> viteConfigFiles\n    <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">file</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>targetPath<span class="token punctuation">,</span> file<span class="token punctuation">)</span><span class="token punctuation">)</span>\n    <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">file</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> fs<span class="token punctuation">.</span><span class="token function">existsSync</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n  <span class="token keyword">const</span> viteConfig <span class="token operator">=</span> <span class="token function">viteEslint</span><span class="token punctuation">(</span>fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>viteFile<span class="token punctuation">,</span> <span class="token string">&#39;utf8&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n  fs<span class="token punctuation">.</span><span class="token function">writeFileSync</span><span class="token punctuation">(</span>eslintFile<span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>eslint<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n  fs<span class="token punctuation">.</span><span class="token function">writeFileSync</span><span class="token punctuation">(</span>prettierFile<span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>prettierConfig<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n  fs<span class="token punctuation">.</span><span class="token function">writeFileSync</span><span class="token punctuation">(</span>eslintIgnoreFile<span class="token punctuation">,</span> eslintIgnore<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">&#39;\\n&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n  fs<span class="token punctuation">.</span><span class="token function">writeFileSync</span><span class="token punctuation">(</span>viteFile<span class="token punctuation">,</span> viteConfig<span class="token punctuation">)</span>\n  <span class="token keyword">const</span> files <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readdirSync</span><span class="token punctuation">(</span>eslintTemplate<span class="token punctuation">)</span>\n  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> file <span class="token keyword">of</span> files<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">f</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token operator">!</span>f<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">&#39;react&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token function">write</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> eslintTemplate<span class="token punctuation">)</span>\n  <span class="token punctuation">}</span>\n  pkg<span class="token punctuation">.</span>devDependencies <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token operator">...</span>pkg<span class="token punctuation">.</span>devDependencies<span class="token punctuation">,</span> <span class="token operator">...</span>packageList <span class="token punctuation">}</span>\n  pkg<span class="token punctuation">.</span>scripts <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token operator">...</span>pkg<span class="token punctuation">.</span>scripts<span class="token punctuation">,</span> <span class="token operator">...</span>packageScripts <span class="token punctuation">}</span>\n  pkg<span class="token punctuation">[</span><span class="token string">&#39;lint-staged&#39;</span><span class="token punctuation">]</span> <span class="token operator">=</span> packageMore\n\n  <span class="token function">write</span><span class="token punctuation">(</span><span class="token string">&#39;package.json&#39;</span><span class="token punctuation">,</span> templateDir<span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>pkg<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&#39;\\n&#39;</span><span class="token punctuation">)</span>\n<span class="token punctuation">}</span>\n</code></pre></div><p>这一步会将<code>.husky</code>、<code>.editorconfig</code>、<code>commitlint.config.js</code>、<code>.eslintrc.json</code>、<code>.prettierrc.json</code>和<code>.eslintignore</code>配置添加到所创建的项目中，并修改 package.json 文件，添加 ESLint 的依赖项。</p><h2 id="集成-ant-design-作为-ui-库"><a class="header-anchor" href="#集成-ant-design-作为-ui-库" aria-hidden="true">#</a> 集成 ant design 作为 UI 库</h2><p><img src="/blog/_assets/antd-logo.d12a9b34.png" alt="antd-logo.png"></p><p>我们先来梳理下，如果往项目中添加 Antd 需要做哪些事：</p><ol><li><p>添加 Antd 依赖；</p><p>ant-design@v5 版本支持 tree-shaking，就不用配置按需加载了。那么就很简单，我们只需要在 package.json 的<code>dependencies</code>字段中添加 Antd 的库。</p></li><li><p>全局引入 reset.css 文件；</p></li><li><p>设置 ConfigProvider 全局化配置；</p><div class="language-jsx"><pre><code><span class="token keyword">import</span> <span class="token string">&#39;antd/dist/reset.css&#39;</span>\n<span class="token keyword">import</span> zhCN <span class="token keyword">from</span> <span class="token string">&#39;antd/locale/zh_CN&#39;</span>\n<span class="token keyword">import</span> dayjs <span class="token keyword">from</span> <span class="token string">&#39;dayjs&#39;</span>\n<span class="token keyword">import</span> <span class="token string">&#39;dayjs/locale/zh-cn&#39;</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> ConfigProvider <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;antd&#39;</span>\n\ndayjs<span class="token punctuation">.</span><span class="token function">locale</span><span class="token punctuation">(</span><span class="token string">&#39;zh-cn&#39;</span><span class="token punctuation">)</span>\n\nReactDOM<span class="token punctuation">.</span><span class="token function">createRoot</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&#39;root&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>\n  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">React.StrictMode</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">\n    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">ConfigProvider</span></span> <span class="token attr-name">locale</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>zhCN<span class="token punctuation">}</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">\n      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">App</span></span> <span class="token punctuation">/&gt;</span></span><span class="token plain-text">\n    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">ConfigProvider</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">\n  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">React.StrictMode</span></span><span class="token punctuation">&gt;</span></span>\n<span class="token punctuation">)</span>\n</code></pre></div></li><li><p>修改 App 组件，添加一个 antd 的组件，这样启动项目就可以看到 Antd 的组件使用方法。</p></li></ol><p>基于以上的步骤，我们可以仿照 ESLint 那块的代码来修改，最终实现如下：</p><div class="language-js"><pre><code><span class="token comment">// antd配置</span>\n<span class="token keyword">const</span> fileSuffix <span class="token operator">=</span> template<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">&#39;-ts&#39;</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string">&#39;.tsx&#39;</span> <span class="token operator">:</span> <span class="token string">&#39;.jsx&#39;</span>\n<span class="token keyword">if</span> <span class="token punctuation">(</span>isAntd<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> AppComponent <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>targetPath<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">/src/App</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>fileSuffix<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>\n  <span class="token keyword">const</span> MainComponent <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>targetPath<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">/src/main</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>fileSuffix<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>\n  <span class="token comment">// @ts-ignore</span>\n  <span class="token keyword">const</span> <span class="token punctuation">{</span> packages<span class="token punctuation">,</span> App<span class="token punctuation">,</span> Main <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">&#39;../antd-templates/index.js&#39;</span><span class="token punctuation">)</span>\n  fs<span class="token punctuation">.</span><span class="token function">writeFileSync</span><span class="token punctuation">(</span>AppComponent<span class="token punctuation">,</span> App<span class="token punctuation">)</span>\n  fs<span class="token punctuation">.</span><span class="token function">writeFileSync</span><span class="token punctuation">(</span>MainComponent<span class="token punctuation">,</span> Main<span class="token punctuation">)</span>\n\n  pkg<span class="token punctuation">.</span>dependencies <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token operator">...</span>pkg<span class="token punctuation">.</span>dependencies<span class="token punctuation">,</span> <span class="token operator">...</span>packages <span class="token punctuation">}</span>\n  <span class="token function">write</span><span class="token punctuation">(</span><span class="token string">&#39;package.json&#39;</span><span class="token punctuation">,</span> templateDir<span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>pkg<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&#39;\\n&#39;</span><span class="token punctuation">)</span>\n<span class="token punctuation">}</span>\n</code></pre></div><h2 id="集成-react-router-作为路由"><a class="header-anchor" href="#集成-react-router-作为路由" aria-hidden="true">#</a> 集成 react-router 作为路由</h2><p><img src="/blog/_assets/react-router-logo.6efcd422.png" alt="react-router-logo"></p><p>这里我们使用<a href="https://reactrouter.com/zh/main" target="_blank" rel="noopener noreferrer">react-router@v6</a>版本，v6 版本之前如果使用 typescript 时，需要同时安装<code>@types/react-router</code>、<code>@types/react-router-dom</code>、<code>react-router</code>和<code>react-router-dom</code>。</p><blockquote><p>react-router 和 react-router-dom 的关系类似于 react 和 react-dom。dom 及浏览器环境，react-router-dom 通过添加用于 DOM 的组件，可以让 react-router 运行在浏览器环境，同时还有 react-router-native，用于 native 环境。</p></blockquote><p>使用 v6 后不需要再引入额外的类型，只需要安装<code>react-router</code>和<code>react-router-dom</code>即可。</p><h3 id="react-router-v6-说明"><a class="header-anchor" href="#react-router-v6-说明" aria-hidden="true">#</a> react-router v6 说明</h3><ul><li><code>&lt;Routes /&gt;</code>: 新增组件，移除 v5 的<code>&lt;Switch /&gt;</code>组件，用<code>&lt;Routes /&gt;</code>组件代替，用法相同；</li><li><code>&lt;Router /&gt;</code>: 基础路由组件，v5 的 component={Home}改写为 element={Home}；</li><li><code>&lt;Link /&gt;</code>: 导航组件；</li><li><code>&lt;Outlet /&gt;</code>: 新增组件，自适应渲染组件；</li><li>useParams: 新增 Hook，获取当前路由携带参数；</li><li>useNavigate: 新增 Hook，类似 v5 的 useHistory，获取当前路由；</li><li>useOutlet: 新增 Hook，获取根据路由生成的 element；</li><li>useLocation: 获取当前 location 对象；</li><li>useRoutes: 同<code>&lt;Routes&gt;</code>组件，在 js 中使用；</li><li>useSearchParams: 获取 URL 中 search 参数。</li></ul><h3 id="react-router-v6-使用教程"><a class="header-anchor" href="#react-router-v6-使用教程" aria-hidden="true">#</a> react-router v6 使用教程</h3><p>同 Antd，首先我们先梳理一下将 react-router 添加到项目中的步骤。</p><ol><li><p>添加 react-router 和 react-router-dom 依赖；</p><div class="language-bash"><pre><code><span class="token function">yarn</span> <span class="token function">add</span> react-router-dom react-router\n</code></pre></div></li><li><p>添加 src/routes/routerConfig.ts 文件，配置路由表；</p><div class="language-js"><pre><code><span class="token keyword">import</span> ErrorPage <span class="token keyword">from</span> <span class="token string">&#39;@/pages/ErrorPage&#39;</span>\n<span class="token keyword">import</span> AppLayout <span class="token keyword">from</span> <span class="token string">&#39;@/layout/AppLayout&#39;</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> lazy <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;react&#39;</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> MetaMenu<span class="token punctuation">,</span> AuthRouteObject <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;./interface&#39;</span>\n\n<span class="token comment">// 快速导入工具函数</span>\n<span class="token keyword">const</span> <span class="token function-variable function">lazyLoad</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">moduleName</span><span class="token operator">:</span> string</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>\n  <span class="token function">lazy</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">@/pages/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>moduleName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/index.tsx</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token keyword">const</span> Home <span class="token operator">=</span> <span class="token function">lazyLoad</span><span class="token punctuation">(</span><span class="token string">&#39;Home&#39;</span><span class="token punctuation">)</span>\n<span class="token keyword">const</span> ReduxToolkitDemo <span class="token operator">=</span> <span class="token function">lazyLoad</span><span class="token punctuation">(</span><span class="token string">&#39;ReduxToolkitDemo&#39;</span><span class="token punctuation">)</span>\n<span class="token keyword">const</span> ReactQueryDemo <span class="token operator">=</span> <span class="token function">lazyLoad</span><span class="token punctuation">(</span><span class="token string">&#39;ReactQueryDemo&#39;</span><span class="token punctuation">)</span>\n\n<span class="token keyword">const</span> <span class="token literal-property property">routers</span><span class="token operator">:</span> AuthRouteObject<span class="token operator">&lt;</span>MetaMenu<span class="token operator">&gt;</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>\n  <span class="token punctuation">{</span>\n    <span class="token literal-property property">path</span><span class="token operator">:</span> <span class="token string">&#39;/&#39;</span><span class="token punctuation">,</span>\n    <span class="token literal-property property">element</span><span class="token operator">:</span> <span class="token operator">&lt;</span>AppLayout <span class="token operator">/</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>\n    <span class="token literal-property property">errorElement</span><span class="token operator">:</span> <span class="token operator">&lt;</span>ErrorPage <span class="token operator">/</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>\n    <span class="token literal-property property">meta</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n      <span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">,</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token literal-property property">children</span><span class="token operator">:</span> <span class="token punctuation">[</span>\n      <span class="token punctuation">{</span>\n        <span class="token literal-property property">path</span><span class="token operator">:</span> <span class="token string">&#39;home&#39;</span><span class="token punctuation">,</span>\n        <span class="token literal-property property">element</span><span class="token operator">:</span> <span class="token operator">&lt;</span>Home <span class="token operator">/</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>\n        <span class="token literal-property property">meta</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n          <span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token string">&#39;Home&#39;</span><span class="token punctuation">,</span>\n        <span class="token punctuation">}</span><span class="token punctuation">,</span>\n      <span class="token punctuation">}</span><span class="token punctuation">,</span>\n      <span class="token punctuation">{</span>\n        <span class="token literal-property property">path</span><span class="token operator">:</span> <span class="token string">&#39;toolkit&#39;</span><span class="token punctuation">,</span>\n        <span class="token literal-property property">element</span><span class="token operator">:</span> <span class="token operator">&lt;</span>ReduxToolkitDemo <span class="token operator">/</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>\n        <span class="token literal-property property">meta</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n          <span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token string">&#39;React Toolkit&#39;</span><span class="token punctuation">,</span>\n        <span class="token punctuation">}</span><span class="token punctuation">,</span>\n      <span class="token punctuation">}</span><span class="token punctuation">,</span>\n      <span class="token punctuation">{</span>\n        <span class="token literal-property property">path</span><span class="token operator">:</span> <span class="token string">&#39;query&#39;</span><span class="token punctuation">,</span>\n        <span class="token literal-property property">element</span><span class="token operator">:</span> <span class="token operator">&lt;</span>ReactQueryDemo <span class="token operator">/</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>\n        <span class="token literal-property property">meta</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n          <span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token string">&#39;React Query&#39;</span><span class="token punctuation">,</span>\n        <span class="token punctuation">}</span><span class="token punctuation">,</span>\n      <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token punctuation">]</span><span class="token punctuation">,</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n<span class="token punctuation">]</span>\n\n<span class="token keyword">export</span> <span class="token keyword">default</span> routers\n</code></pre></div></li><li><p>创建 src/layout 文件夹，添加 AppLayout 组件；</p></li><li><p>创建 src/pages 文件夹，添加 Home 和 ReactQueryDemo 组件；</p></li><li><p>通过 <a href="https://reactrouter.com/en/main/hooks/use-routes" target="_blank" rel="noopener noreferrer">useRoutes</a> 钩子将上面的路由表一一映射为路由对象</p><p>useRoutes 也就是<code>&lt;Routes /&gt;</code>组件的 js 实现，在路由跳转时需要增加 loading 转场，我们可以使用<code>&lt;Suspense /&gt;</code>组件传入一个 loading 组件来实现。</p><blockquote><p>此处的 Loading 组件可根据项目需求来修改转场动画</p></blockquote><div class="language-tsx"><pre><code><span class="token keyword">import</span> <span class="token string">&#39;./App.scss&#39;</span>\n<span class="token keyword">import</span> routers <span class="token keyword">from</span> <span class="token string">&#39;./routes/routerConfig&#39;</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> useRoutes <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;react-router-dom&#39;</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> Suspense <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;react&#39;</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> Spin <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;antd&#39;</span>\n\n<span class="token keyword">function</span> <span class="token function">App</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> elements <span class="token operator">=</span> <span class="token function">useRoutes</span><span class="token punctuation">(</span>routers<span class="token punctuation">)</span>\n  <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Suspense</span></span> <span class="token attr-name">fallback</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Spin</span></span> <span class="token punctuation">/&gt;</span></span><span class="token punctuation">}</span></span><span class="token punctuation">&gt;</span></span><span class="token punctuation">{</span>elements<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">Suspense</span></span><span class="token punctuation">&gt;</span></span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">export</span> <span class="token keyword">default</span> App\n</code></pre></div></li><li><p>在 main.tsx 中配置<code>&lt;BrowserRouter /&gt;</code>包裹 App 组件</p><div class="language-tsx"><pre><code><span class="token keyword">import</span> <span class="token punctuation">{</span> BrowserRouter <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;react-router-dom&#39;</span>\n\nReactDOM<span class="token punctuation">.</span><span class="token function">createRoot</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&#39;root&#39;</span><span class="token punctuation">)</span> <span class="token keyword">as</span> HTMLElement<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>\n  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">React.StrictMode</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">\n    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">BrowserRouter</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">\n      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">App</span></span> <span class="token punctuation">/&gt;</span></span><span class="token plain-text">\n    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">BrowserRouter</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">\n  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">React.StrictMode</span></span><span class="token punctuation">&gt;</span></span>\n<span class="token punctuation">)</span>\n</code></pre></div></li></ol><p>基于以上步骤，我们实现的代码如下：</p><p>首先询问是否需要安装 react-router，并返回 isRouter 是否为 true，如果为 true 时，将 react-router 的模板文件添加到输出目录中，同时修改 App.tsx 和 main.tsx 的代码：</p><div class="language-ts"><pre><code><span class="token keyword">if</span> <span class="token punctuation">(</span>isRouter<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token function">copyTemplateFile</span><span class="token punctuation">(</span><span class="token string">&#39;router&#39;</span><span class="token punctuation">)</span>\n  <span class="token comment">// @ts-ignore</span>\n  <span class="token keyword">let</span> <span class="token punctuation">{</span> packages<span class="token punctuation">,</span> App<span class="token punctuation">,</span> Main<span class="token punctuation">,</span> Antd_App<span class="token punctuation">,</span> Antd_Main <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">import</span><span class="token punctuation">(</span>\n    <span class="token string">&#39;../router-templates/index.js&#39;</span>\n  <span class="token punctuation">)</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>isAntd<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    App <span class="token operator">=</span> Antd_App\n    Main <span class="token operator">=</span> Antd_Main\n  <span class="token punctuation">}</span>\n  fs<span class="token punctuation">.</span><span class="token function">writeFileSync</span><span class="token punctuation">(</span>AppComponent<span class="token punctuation">,</span> App<span class="token punctuation">)</span>\n  fs<span class="token punctuation">.</span><span class="token function">writeFileSync</span><span class="token punctuation">(</span>MainComponent<span class="token punctuation">,</span> Main<span class="token punctuation">)</span>\n\n  pkg<span class="token punctuation">.</span>dependencies <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token operator">...</span>pkg<span class="token punctuation">.</span>dependencies<span class="token punctuation">,</span> <span class="token operator">...</span>packages <span class="token punctuation">}</span>\n  <span class="token function">write</span><span class="token punctuation">(</span><span class="token string">&#39;package.json&#39;</span><span class="token punctuation">,</span> templateDir<span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>pkg<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&#39;\\n&#39;</span><span class="token punctuation">)</span>\n<span class="token punctuation">}</span>\n</code></pre></div><h2 id="集成-redux-toolkit-作为状态管理"><a class="header-anchor" href="#集成-redux-toolkit-作为状态管理" aria-hidden="true">#</a> 集成 Redux toolkit 作为状态管理</h2><p><img src="/blog/_assets/redux-toolkit-logo.287a2c4c.png" alt="redux-toolkit-logo.png"></p><h3 id="为什么是-redux-toolkit"><a class="header-anchor" href="#为什么是-redux-toolkit" aria-hidden="true">#</a> 为什么是 Redux toolkit</h3><p><a href="https://cn.redux.js.org/redux-toolkit/overview/" target="_blank" rel="noopener noreferrer">Redux Toolkit</a> 是 Redux 官方强烈推荐，开箱即用的一个高效的 Redux 开发工具集。它旨在成为标准的 Redux 逻辑开发模式，强烈建议你使用它。</p><p>优点如下：</p><ul><li>优化 Redux 中间件、各种配置以及书写目录规范等，简化操作，例如取代 Redux 中很恶心的 types、actions、reducers；</li><li>React-Redux Hook API 取代麻烦的<code>connect</code>和<code>mapState</code>；</li><li>Reducer 中默认使用 Immer 来更新 Immutable 数据，不用再返回 state，简单、省事；</li><li>封装好了 redux-devtools-extension，可直接使用；</li><li>已经集成 redux-thunk，不需要再次安装；</li><li>按 feature 组织 Redux 逻辑，更加清晰。</li></ul><p>总体来说，Redux Toolkit 的出现让之前想尝试 Redux，但又被 Redux 各种繁琐的配置劝退的人重新归位 😄。</p><h3 id="redux-toolkit-使用教程"><a class="header-anchor" href="#redux-toolkit-使用教程" aria-hidden="true">#</a> Redux Toolkit 使用教程</h3><p>参考：<a href="https://redux.js.org/usage/usage-with-typescript#define-typed-hooks" target="_blank" rel="noopener noreferrer">https://redux.js.org/usage/usage-with-typescript#define-typed-hooks</a></p><ol><li><p>添加 Redux Toolkit 相关依赖；</p><div class="language-bash"><pre><code><span class="token function">yarn</span> <span class="token function">add</span> @reduxjs/toolkit react-redux\n</code></pre></div></li><li><p>创建 store 文件夹；</p><p>store 中包含 feature（包含所有的 Slice）、hooks（封装 useSelector 和 useDispatch）、index（主入口文件）</p><div class="language-bash"><pre><code>store\n│   ├── feature\n│   │   └── appSlice.ts\n│   ├── hooks.ts\n│   └── index.ts\n</code></pre></div></li><li><p>index.ts 入口；</p><div class="language-ts"><pre><code><span class="token keyword">import</span> <span class="token punctuation">{</span> configureStore<span class="token punctuation">,</span> ThunkAction<span class="token punctuation">,</span> Action <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;@reduxjs/toolkit&#39;</span>\n<span class="token keyword">import</span> appReducer <span class="token keyword">from</span> <span class="token string">&#39;./feature/appSlice&#39;</span>\n<span class="token comment">// 创建store</span>\n<span class="token keyword">export</span> <span class="token keyword">const</span> store <span class="token operator">=</span> <span class="token function">configureStore</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n  <span class="token comment">// feature中创建多个子reducer 最终在这里进行合并</span>\n  reducer<span class="token operator">:</span> <span class="token punctuation">{</span>\n    app<span class="token operator">:</span> appReducer<span class="token punctuation">,</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token comment">// 中间件</span>\n  <span class="token function-variable function">middleware</span><span class="token operator">:</span> <span class="token punctuation">(</span>getDefaultMiddleware<span class="token punctuation">)</span> <span class="token operator">=&gt;</span>\n    <span class="token function">getDefaultMiddleware</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n      serializableCheck<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n  <span class="token comment">// redux-devtools-extension何时开启</span>\n  devTools<span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">&#39;production&#39;</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span>\n\n<span class="token keyword">export</span> <span class="token keyword">type</span> <span class="token class-name">AppDispatch</span> <span class="token operator">=</span> <span class="token keyword">typeof</span> store<span class="token punctuation">.</span>dispatch\n<span class="token keyword">export</span> <span class="token keyword">type</span> <span class="token class-name">RootState</span> <span class="token operator">=</span> ReturnType<span class="token operator">&lt;</span><span class="token keyword">typeof</span> store<span class="token punctuation">.</span>getState<span class="token operator">&gt;</span>\n<span class="token keyword">export</span> <span class="token keyword">type</span> <span class="token class-name">AppThunk<span class="token operator">&lt;</span>ReturnType <span class="token operator">=</span> <span class="token keyword">void</span><span class="token operator">&gt;</span></span> <span class="token operator">=</span> ThunkAction<span class="token operator">&lt;</span>\n  ReturnType<span class="token punctuation">,</span>\n  RootState<span class="token punctuation">,</span>\n  <span class="token builtin">unknown</span><span class="token punctuation">,</span>\n  Action<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token operator">&gt;</span>\n<span class="token operator">&gt;</span>\n</code></pre></div><blockquote><p>serializableCheck: false 关闭 serializableCheck 检查，当数据较复杂时，开启时会报错； @reduxjs/toolkit 已经封装好了 redux-devtools-extension，通过 devTools: true 开启。</p></blockquote></li><li><p>hooks.ts 钩子</p><p>官方推荐使用 useAppSelector 来操作 store 数据，使用 useAppDispatch 触发子 store 中的 action。</p><div class="language-ts"><pre><code><span class="token keyword">import</span> <span class="token punctuation">{</span> TypedUseSelectorHook<span class="token punctuation">,</span> useDispatch<span class="token punctuation">,</span> useSelector <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;react-redux&#39;</span>\n<span class="token keyword">import</span> <span class="token keyword">type</span> <span class="token punctuation">{</span> RootState<span class="token punctuation">,</span> AppDispatch <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;.&#39;</span>\n\n<span class="token comment">// Use throughout your app instead of plain `useDispatch` and `useSelector`</span>\n<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">useAppDispatch</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token generic-function"><span class="token function">useDispatch</span><span class="token generic class-name"><span class="token operator">&lt;</span>AppDispatch<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n\n<span class="token keyword">export</span> <span class="token keyword">const</span> useAppSelector<span class="token operator">:</span> TypedUseSelectorHook<span class="token operator">&lt;</span>RootState<span class="token operator">&gt;</span> <span class="token operator">=</span> useSelector\n</code></pre></div></li><li><p>将 Redux 连接到 React</p><p>在 main.tsx 中，使用 react-redux 的 Provider 组件将 store 注入到上下文中，和之前没有变化</p><div class="language-tsx"><pre><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Provider <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;react-redux&#39;</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> store <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;./store&#39;</span><span class="token punctuation">;</span>\n<span class="token operator">...</span>\n<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Provider</span></span> <span class="token attr-name">store</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>store<span class="token punctuation">}</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">\n...\n</span></code></pre></div></li><li><p>组件中如何使用</p><p>在组件文件中，使用官方推荐的 useAppDispatch 和 useAppSelector，从每个子 slice 中获取 action。</p><div class="language-tsx"><pre><code><span class="token keyword">import</span> <span class="token punctuation">{</span> useAppDispatch<span class="token punctuation">,</span> useAppSelector <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;./store/hooks&#39;</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span>\n  selectCount<span class="token punctuation">,</span>\n  decremented<span class="token punctuation">,</span>\n  incremented<span class="token punctuation">,</span>\n<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;./store/feature/appSlice&#39;</span>\n\n<span class="token keyword">function</span> <span class="token function">App</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> elements <span class="token operator">=</span> <span class="token function">useRoutes</span><span class="token punctuation">(</span>routers<span class="token punctuation">)</span>\n  <span class="token keyword">const</span> count <span class="token operator">=</span> <span class="token function">useAppSelector</span><span class="token punctuation">(</span>selectCount<span class="token punctuation">)</span>\n\n  <span class="token keyword">const</span> dispatch <span class="token operator">=</span> <span class="token function">useAppDispatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n  <span class="token keyword">return</span> <span class="token punctuation">(</span>\n    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">\n      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">\n        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Button</span></span>\n          <span class="token attr-name">style</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span> marginRight<span class="token operator">:</span> <span class="token string">&#39;8px&#39;</span> <span class="token punctuation">}</span><span class="token punctuation">}</span></span>\n          <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>primary<span class="token punctuation">&quot;</span></span>\n          <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token function">incremented</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span>\n        <span class="token punctuation">&gt;</span></span><span class="token plain-text">\n          +\n        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">Button</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">\n        ...\n      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">\n    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span></span><span class="token punctuation">&gt;</span></span>\n  <span class="token punctuation">)</span>\n<span class="token punctuation">}</span>\n<span class="token keyword">export</span> <span class="token keyword">default</span> App\n</code></pre></div></li></ol><h3 id="redux-toolkit-异步操作"><a class="header-anchor" href="#redux-toolkit-异步操作" aria-hidden="true">#</a> Redux Toolkit 异步操作</h3><p>在 Redux 中，如果需要异步操作则需要安装 Redux-Thunk，而 Redux Toolkit 已经内置了 Redux-Thunk，不需要另外安装和配置。</p><p>我们只需要使用 createAsyncThunk 就能完成异步 action 的创建。</p><p>下面以一个获取 github 用户列表为例：</p><h4 id="创建-userslice"><a class="header-anchor" href="#创建-userslice" aria-hidden="true">#</a> 创建 userSlice</h4><div class="language-ts"><pre><code><span class="token keyword">import</span> <span class="token punctuation">{</span> createSlice<span class="token punctuation">,</span> createAsyncThunk <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;@reduxjs/toolkit&#39;</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> RootState <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;..&#39;</span>\n\n<span class="token keyword">type</span> <span class="token class-name">UserType</span> <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token punctuation">[</span>props<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">|</span> <span class="token builtin">number</span> <span class="token operator">|</span> <span class="token builtin">boolean</span> <span class="token punctuation">}</span>\n<span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">UserState</span> <span class="token punctuation">{</span>\n  users<span class="token operator">:</span> UserType<span class="token punctuation">[</span><span class="token punctuation">]</span>\n  total<span class="token operator">:</span> <span class="token builtin">number</span>\n<span class="token punctuation">}</span>\n<span class="token keyword">const</span> initialState<span class="token operator">:</span> UserState <span class="token operator">=</span> <span class="token punctuation">{</span>\n  users<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n  total<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span>\n\n<span class="token comment">// createAsyncThunk创建一个异步action，return出去的值，会在extraReducers中接收，有三种状态：</span>\n<span class="token comment">// pending（进行中）、fulfilled（成功）、rejected（失败）</span>\n<span class="token keyword">export</span> <span class="token keyword">const</span> getUserData <span class="token operator">=</span> <span class="token function">createAsyncThunk</span><span class="token punctuation">(</span><span class="token string">&#39;user/getList&#39;</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">&#39;https://api.github.com/search/users?q=wang&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>\n    <span class="token punctuation">(</span>res<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n  <span class="token punctuation">)</span>\n  <span class="token keyword">return</span> res\n<span class="token punctuation">}</span><span class="token punctuation">)</span>\n\n<span class="token comment">// 创建一个 Slice</span>\n<span class="token keyword">export</span> <span class="token keyword">const</span> userSlice <span class="token operator">=</span> <span class="token function">createSlice</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n  name<span class="token operator">:</span> <span class="token string">&#39;user&#39;</span><span class="token punctuation">,</span>\n  initialState<span class="token punctuation">,</span>\n  reducers<span class="token operator">:</span> <span class="token punctuation">{</span>\n    <span class="token comment">// Reducer 中默认使用 Immer 来更新 Immutable 数据，不用再返回 state</span>\n    <span class="token function-variable function">deleteUser</span><span class="token operator">:</span> <span class="token punctuation">(</span>state<span class="token punctuation">,</span> <span class="token punctuation">{</span> payload <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>\n      state<span class="token punctuation">.</span>users <span class="token operator">=</span> state<span class="token punctuation">.</span>users<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> user<span class="token punctuation">.</span>id <span class="token operator">!==</span> payload<span class="token punctuation">)</span>\n      state<span class="token punctuation">.</span>total <span class="token operator">-=</span> <span class="token number">1</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token comment">// extraReducers 接受 createAsyncThunk的状态</span>\n  <span class="token function">extraReducers</span><span class="token punctuation">(</span>builder<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    builder\n      <span class="token punctuation">.</span><span class="token function">addCase</span><span class="token punctuation">(</span>getUserData<span class="token punctuation">.</span>pending<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;loading...&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n      <span class="token comment">// 通常只需要接受fulfilled即可 接收到返回值在同步到state状态中即可</span>\n      <span class="token punctuation">.</span><span class="token function">addCase</span><span class="token punctuation">(</span>getUserData<span class="token punctuation">.</span>fulfilled<span class="token punctuation">,</span> <span class="token punctuation">(</span>state<span class="token punctuation">,</span> <span class="token punctuation">{</span> payload <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>\n        state<span class="token punctuation">.</span>users <span class="token operator">=</span> payload<span class="token punctuation">.</span>items\n        state<span class="token punctuation">.</span>total <span class="token operator">=</span> payload<span class="token punctuation">.</span>total_count\n      <span class="token punctuation">}</span><span class="token punctuation">)</span>\n      <span class="token punctuation">.</span><span class="token function">addCase</span><span class="token punctuation">(</span>getUserData<span class="token punctuation">.</span>rejected<span class="token punctuation">,</span> <span class="token punctuation">(</span>_<span class="token punctuation">,</span> err<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;error&#39;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">)</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span>\n\n<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token punctuation">{</span> deleteUser <span class="token punctuation">}</span> <span class="token operator">=</span> userSlice<span class="token punctuation">.</span>actions\n<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">selectUser</span> <span class="token operator">=</span> <span class="token punctuation">(</span>state<span class="token operator">:</span> RootState<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> state<span class="token punctuation">.</span>user<span class="token punctuation">.</span>users\n<span class="token keyword">export</span> <span class="token keyword">default</span> userSlice<span class="token punctuation">.</span>reducer\n</code></pre></div><p>在 userSlice 中我们主要做了这几件事：</p><ol><li><p>使用 createAsyncThunk 创建一个异步 action</p><p>通过 createAsyncThunk return 出去的值，会在 extraReducers 中接收，有三种状态：</p><ul><li>pending（进行中）</li><li>fulfilled（成功）</li><li>ejected（失败）</li></ul></li><li><p>通过 extraReducers 来接受 createAsyncThunk 的结果</p><p>在<code>addCase(getUserData.fulfilled..</code>中获取异步结果成功后的返回值，直接更新在 state 中。</p></li><li><p>创建一个 deleteUser action，用来删除用户</p><p>这一步主要是为了<strong>演示 immer 的作用</strong>，如果对 immer 不太熟悉的同学，可以看看这篇文章：<a href="https://juejin.cn/post/7047450607984541710#heading-18" target="_blank" rel="noopener noreferrer">不可变数据实现-Immer.js</a>。</p><p>要是以前在 Redux 中，我们需要这样操作：</p><div class="language-ts"><pre><code><span class="token function-variable function">deleteUser</span><span class="token operator">:</span> <span class="token punctuation">(</span>state<span class="token punctuation">,</span> <span class="token punctuation">{</span> payload <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>\n <span class="token keyword">return</span> <span class="token punctuation">{</span>\n   <span class="token operator">...</span>state<span class="token punctuation">,</span>\n   users<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token operator">...</span>state<span class="token punctuation">.</span>users<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> user<span class="token punctuation">.</span>id <span class="token operator">!==</span> payload<span class="token punctuation">)</span><span class="token punctuation">,</span>\n   count<span class="token operator">:</span> state<span class="token punctuation">.</span>total <span class="token operator">-</span> <span class="token number">1</span>\n <span class="token punctuation">}</span>\n</code></pre></div><p>而使用 Redux Toolkit 之后，只需要这样操作：</p><div class="language-ts"><pre><code><span class="token function-variable function">deleteUser</span><span class="token operator">:</span> <span class="token punctuation">(</span>state<span class="token punctuation">,</span> <span class="token punctuation">{</span> payload <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>\n   state<span class="token punctuation">.</span>users <span class="token operator">=</span> state<span class="token punctuation">.</span>users<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> user<span class="token punctuation">.</span>id <span class="token operator">!==</span> payload<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   state<span class="token punctuation">.</span>total <span class="token operator">-=</span> <span class="token number">1</span><span class="token punctuation">;</span>\n <span class="token punctuation">}</span><span class="token punctuation">,</span>\n</code></pre></div></li><li><p>在主入口合并到 reducer 中，和 appSlice 一样操作；</p></li><li><p>使用，同同步操作</p></li></ol><p>基于以上步骤，我们实现的代码如下：</p><p>首先询问是否需要安装 Redux Toolkit，并返回 isRedux 是否为 true，如果为 true 时，将 Redux Toolkit 的模板文件添加到输出目录中，同时修改 main.tsx 的代码：</p><div class="language-ts"><pre><code><span class="token keyword">if</span> <span class="token punctuation">(</span>isRedux<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token function">copyTemplateFile</span><span class="token punctuation">(</span><span class="token string">&#39;redux&#39;</span><span class="token punctuation">)</span>\n  <span class="token comment">// @ts-ignore</span>\n  <span class="token keyword">let</span> <span class="token punctuation">{</span> packages<span class="token punctuation">,</span> Main<span class="token punctuation">,</span> Router_Main<span class="token punctuation">,</span> Antd_Main<span class="token punctuation">,</span> Antd_Router_Main <span class="token punctuation">}</span> <span class="token operator">=</span>\n    <span class="token keyword">await</span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">&#39;../redux-templates/index.js&#39;</span><span class="token punctuation">)</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>isAntd<span class="token punctuation">)</span> Main <span class="token operator">=</span> Antd_Main\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>isRouter<span class="token punctuation">)</span> Main <span class="token operator">=</span> Router_Main\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>isAntd <span class="token operator">&amp;&amp;</span> isRouter<span class="token punctuation">)</span> Main <span class="token operator">=</span> Antd_Router_Main\n  fs<span class="token punctuation">.</span><span class="token function">writeFileSync</span><span class="token punctuation">(</span>MainComponent<span class="token punctuation">,</span> Main<span class="token punctuation">)</span>\n\n  pkg<span class="token punctuation">.</span>dependencies <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token operator">...</span>pkg<span class="token punctuation">.</span>dependencies<span class="token punctuation">,</span> <span class="token operator">...</span>packages <span class="token punctuation">}</span>\n  <span class="token function">write</span><span class="token punctuation">(</span><span class="token string">&#39;package.json&#39;</span><span class="token punctuation">,</span> templateDir<span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>pkg<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&#39;\\n&#39;</span><span class="token punctuation">)</span>\n<span class="token punctuation">}</span>\n</code></pre></div><h2 id="集成-react-query-作为请求库"><a class="header-anchor" href="#集成-react-query-作为请求库" aria-hidden="true">#</a> 集成 react-query 作为请求库</h2><p><img src="/blog/_assets/react-query-logo.581d8b5c.png" alt="react-query-logo"></p><h3 id="为什么是-react-query"><a class="header-anchor" href="#为什么是-react-query" aria-hidden="true">#</a> 为什么是 react query</h3><p>用官方的来说：React Query 通常被描述为 React 缺少的数据获取(data-fetching)库，但是从更广泛的角度来看，它<strong>使 React 程序中的获取，缓存，同步和更新服务器状态变得轻而易举</strong>。</p><p>接下来，跟着我的流程看一下，你就会发现 react query 太香了。</p><p><img src="/blog/_assets/zhenxiang.e9d079b9.jpg" alt="zhenxiang.jpg"></p><h3 id="react-query-使用教程"><a class="header-anchor" href="#react-query-使用教程" aria-hidden="true">#</a> react query 使用教程</h3><p><a href="https://cangsdarm.github.io/react-query-web-i18n/react/" target="_blank" rel="noopener noreferrer">官方教程</a> 也可以看我之前写的一个教程：<a href="https://juejin.cn/post/7162005581224968205" target="_blank" rel="noopener noreferrer">react-query 系列一——基础及 useQuery 使用</a></p><ol><li><p>添加 react query 和 axios 依赖</p><div class="language-bash"><pre><code><span class="token function">yarn</span> <span class="token function">add</span> react-query axios\n</code></pre></div></li><li><p>创建 api 文件夹</p><p>api 中包含 feature（包含所有的请求接口）、interface(类型统一管理)、query（react query 相关配置）、request（封装 axios）。</p><div class="language-bash"><pre><code>├── api\n│   ├── feature\n│   │   └── app.ts\n│   ├── interface.ts\n│   ├── query\n│   │   ├── query.client.ts\n│   │   └── query.constant.ts\n│   └── request.ts\n</code></pre></div><p>对于 axios，网上有大把过渡封装的案例 🤮，我只是简单的添加了请求拦截和相应拦截，感觉就已经够用了。</p><div class="language-ts"><pre><code><span class="token keyword">import</span> <span class="token punctuation">{</span> message <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;antd&#39;</span>\n<span class="token keyword">import</span> Axios<span class="token punctuation">,</span> <span class="token punctuation">{</span> AxiosRequestConfig <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;axios&#39;</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> resData <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;./interface&#39;</span>\n\n<span class="token comment">// 统一配置</span>\n<span class="token keyword">const</span> baseURL <span class="token operator">=</span> <span class="token string">&#39;&#39;</span>\n<span class="token keyword">export</span> <span class="token keyword">const</span> service <span class="token operator">=</span> Axios<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n  baseURL<span class="token punctuation">,</span>\n  responseType<span class="token operator">:</span> <span class="token string">&#39;json&#39;</span><span class="token punctuation">,</span>\n  timeout<span class="token operator">:</span> <span class="token number">600000</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span>\n\n<span class="token comment">// 请求拦截</span>\nservice<span class="token punctuation">.</span>interceptors<span class="token punctuation">.</span>request<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span>res<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>\n  res<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>token <span class="token operator">=</span> <span class="token string">&#39;token&#39;</span>\n  <span class="token keyword">return</span> res\n<span class="token punctuation">}</span><span class="token punctuation">)</span>\n\n<span class="token comment">// 拦截响应</span>\nservice<span class="token punctuation">.</span>interceptors<span class="token punctuation">.</span>response<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>\n  <span class="token punctuation">(</span>response<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> res <span class="token operator">=</span> response<span class="token punctuation">.</span>data\n    <span class="token comment">// 这块需要修改 根据请求返回成功标志</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>res <span class="token operator">||</span> res<span class="token punctuation">.</span>success<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span>message<span class="token punctuation">)</span> message<span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>message<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>\n      <span class="token keyword">return</span> response\n    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span>message<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        message<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>message<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>\n        <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span>code <span class="token operator">===</span> <span class="token number">401</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n          window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>href <span class="token operator">=</span> <span class="token string">&#39;/login&#39;</span>\n        <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span>\n      <span class="token keyword">return</span> <span class="token builtin">Promise</span><span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>\n    message<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>err<span class="token punctuation">.</span>message<span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span>\n    <span class="token keyword">return</span> <span class="token builtin">Promise</span><span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">)</span>\n\n<span class="token comment">// 设置返回值和请求值范型</span>\n<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token generic-function"><span class="token function">request</span><span class="token generic class-name"><span class="token operator">&lt;</span>Res <span class="token operator">=</span> <span class="token builtin">any</span><span class="token punctuation">,</span> <span class="token constant">Q</span> <span class="token operator">=</span> <span class="token builtin">any</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>\n  req<span class="token operator">:</span> AxiosRequestConfig <span class="token operator">&amp;</span> <span class="token punctuation">{</span>\n    data<span class="token operator">?</span><span class="token operator">:</span> <span class="token constant">Q</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">return</span> <span class="token function">service</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>\n    <span class="token punctuation">(</span>res<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>\n      <span class="token keyword">return</span> res<span class="token punctuation">.</span>data <span class="token keyword">as</span> resData<span class="token operator">&lt;</span>Res<span class="token operator">&gt;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token punctuation">(</span>res<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>\n      <span class="token keyword">return</span> <span class="token builtin">Promise</span><span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>data <span class="token operator">||</span> res<span class="token punctuation">)</span> <span class="token keyword">as</span> resData<span class="token operator">&lt;</span>Res<span class="token operator">&gt;</span><span class="token punctuation">)</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">)</span>\n<span class="token punctuation">}</span>\n</code></pre></div><p>顺便看下导出的 request 方法，传入了返回和请求值的类型，然后在 app.ts 中，使用 request 发送请求时，我们只要传入后端的返回类型，这样在接口请求完成后，使用数据的时候就会方便很多，这就是 TS 的好处 🐮。</p><div class="language-ts"><pre><code><span class="token keyword">import</span> <span class="token punctuation">{</span> GithubType <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;../interface&#39;</span>\n<span class="token keyword">import</span> request <span class="token keyword">from</span> <span class="token string">&#39;../request&#39;</span>\n\n<span class="token comment">/* 用户列表 */</span>\n<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">getUserList</span> <span class="token operator">=</span> <span class="token punctuation">(</span>searchName<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>\n  <span class="token generic-function"><span class="token function">request</span><span class="token generic class-name"><span class="token operator">&lt;</span>GithubType<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n    url<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">/api/search/users?q=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>searchName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>\n    method<span class="token operator">:</span> <span class="token string">&#39;get&#39;</span><span class="token punctuation">,</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span>\n</code></pre></div><p><img src="/blog/_assets/axios-ts-resdata.36e6d00b.gif" alt="axios-ts-resdata"></p><p>query.client.ts 用于初始化 react query，导出 client 会在 QueryClientProvider 中进行透传。</p><div class="language-ts"><pre><code><span class="token keyword">import</span> <span class="token punctuation">{</span> QueryClient <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;react-query&#39;</span>\n<span class="token keyword">const</span> client <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">QueryClient</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>\n\n<span class="token comment">// client.setQueryDefaults(QUERY_CHAT_TRANSLATE_INPUT, {</span>\n<span class="token comment">//   select: (res) =&gt; res.data,</span>\n<span class="token comment">//   enabled: false,</span>\n<span class="token comment">// });</span>\n\n<span class="token keyword">export</span> <span class="token keyword">default</span> client\n</code></pre></div><p>query.constant.ts 用于统一管理 react query 所有的 key，<strong>key 有什么用呢</strong>？这个只要你把 react query 用起来就可以知道 key 的作用了。</p><div class="language-ts"><pre><code><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token constant">QUERY_USER_LIST</span> <span class="token operator">=</span> <span class="token string">&#39;user/list&#39;</span>\n</code></pre></div></li><li><p>在 main.tsx 中配置</p><div class="language-tsx"><pre><code><span class="token keyword">import</span> <span class="token punctuation">{</span> QueryClientProvider <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;react-query&#39;</span>\n<span class="token keyword">import</span> client <span class="token keyword">from</span> <span class="token string">&#39;./api/query/query.client&#39;</span>\n<span class="token operator">...</span>\n\nReactDOM<span class="token punctuation">.</span><span class="token function">createRoot</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&#39;root&#39;</span><span class="token punctuation">)</span> <span class="token keyword">as</span> HTMLElement<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>\n  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">QueryClientProvider</span></span> <span class="token attr-name">client</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>client<span class="token punctuation">}</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">\n    </span><span class="token punctuation">{</span><span class="token comment">/* 添加devtools */</span><span class="token punctuation">}</span><span class="token plain-text">\n    </span><span class="token punctuation">{</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">===</span> <span class="token string">&#39;development&#39;</span> <span class="token operator">?</span> <span class="token punctuation">(</span>\n      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">ReactQueryDevtools</span></span>\n         <span class="token attr-name">initialIsOpen</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token boolean">false</span><span class="token punctuation">}</span></span>\n         <span class="token attr-name">position</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>bottom-right<span class="token punctuation">&quot;</span></span>\n       <span class="token punctuation">/&gt;</span></span>\n    <span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token punctuation">(</span>\n      <span class="token string">&#39;&#39;</span>\n    <span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token plain-text">\n    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">App</span></span> <span class="token punctuation">/&gt;</span></span><span class="token plain-text">\n  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">QueryClientProvider</span></span><span class="token punctuation">&gt;</span></span>\n  <span class="token operator">...</span>\n<span class="token punctuation">)</span>\n</code></pre></div></li><li><p>在组件中使用</p><p>通过下面这个例子可以看出来，不使用 react query 的情况下，我要既要通过 useState 管理 loading 和数据状态，还得通过 useEffect 来发送请求；而使用 react-query 的情况下，各种<strong>数据状态直接可以使用 useQuery 来代替</strong>，简化我们的代码。</p><div class="language-tsx"><pre><code><span class="token keyword">import</span> <span class="token punctuation">{</span> getUserList <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;@/api/feature/app&#39;</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> UserType <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;@/api/interface&#39;</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> <span class="token constant">QUERY_USER_LIST</span> <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;@/api/query/query.constant&#39;</span>\n<span class="token comment">// import React, { useEffect, useState } from &#39;react&#39;;</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> useQuery <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;react-query&#39;</span>\n\n<span class="token keyword">const</span> <span class="token function-variable function">QueryDemo</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 不使用react-query时的请求</span>\n  <span class="token comment">// const [loading, setLoading] = useState(false);</span>\n  <span class="token comment">// const [users, setUsers] = useState&lt;UserType[]&gt;([]);</span>\n  <span class="token comment">// const getList = () =&gt; {</span>\n  <span class="token comment">//   setLoading(true);</span>\n  <span class="token comment">//   getUserList(&#39;wang&#39;)</span>\n  <span class="token comment">//     .then((res) =&gt; setUsers(res.items))</span>\n  <span class="token comment">//     .finally(() =&gt; setLoading(false));</span>\n  <span class="token comment">// };</span>\n  <span class="token comment">// useEffect(() =&gt; getList(), []);</span>\n  <span class="token comment">// 使用react-query</span>\n  <span class="token keyword">const</span> <span class="token punctuation">{</span> data<span class="token operator">:</span> users<span class="token punctuation">,</span> isLoading<span class="token operator">:</span> loading <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">useQuery</span><span class="token punctuation">(</span>\n    <span class="token constant">QUERY_USER_LIST</span><span class="token punctuation">,</span>\n    <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">getUserList</span><span class="token punctuation">(</span><span class="token string">&#39;wang&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    <span class="token punctuation">{</span>\n      <span class="token function-variable function">select</span><span class="token operator">:</span> <span class="token punctuation">(</span>res<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> res<span class="token punctuation">.</span>items<span class="token punctuation">,</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">)</span>\n  <span class="token keyword">return</span> <span class="token punctuation">(</span>\n    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">\n      </span><span class="token punctuation">{</span>loading <span class="token operator">&amp;&amp;</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">loading...</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">}</span><span class="token plain-text">\n      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">\n        </span><span class="token punctuation">{</span>users<span class="token operator">?.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span>user<span class="token operator">:</span> UserType<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span>\n          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">key</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>user<span class="token punctuation">.</span>id <span class="token keyword">as</span> <span class="token builtin">string</span><span class="token punctuation">}</span></span><span class="token punctuation">&gt;</span></span><span class="token punctuation">{</span>user<span class="token punctuation">.</span>login<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>\n        <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token plain-text">\n      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">\n    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span></span><span class="token punctuation">&gt;</span></span>\n  <span class="token punctuation">)</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">export</span> <span class="token keyword">default</span> QueryDemo\n</code></pre></div></li></ol><p>基于以上步骤，我们实现的代码如下：</p><p>首先询问是否需要安装 react-query，并返回 isQuery 是否为 true，如果为 true 时，将 react-query 的模板文件添加到输出目录中，同时修改 main.tsx 的代码：</p><div class="language-ts"><pre><code><span class="token keyword">if</span> <span class="token punctuation">(</span>isQuery<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token function">copyTemplateFile</span><span class="token punctuation">(</span><span class="token string">&#39;query&#39;</span><span class="token punctuation">)</span>\n  <span class="token comment">// 获取模板下的文件 将除了package.json的文件全部复制到输出目录中</span>\n  <span class="token keyword">const</span> MainComponent <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>targetPath<span class="token punctuation">,</span> <span class="token string">&#39;./src/Main.tsx&#39;</span><span class="token punctuation">)</span>\n  <span class="token comment">// @ts-ignore</span>\n  <span class="token keyword">const</span> <span class="token punctuation">{</span> packages<span class="token punctuation">,</span> Main <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">&#39;../query-templates/index.js&#39;</span><span class="token punctuation">)</span>\n  fs<span class="token punctuation">.</span><span class="token function">writeFileSync</span><span class="token punctuation">(</span>MainComponent<span class="token punctuation">,</span> Main<span class="token punctuation">)</span>\n\n  pkg<span class="token punctuation">.</span>dependencies <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token operator">...</span>pkg<span class="token punctuation">.</span>dependencies<span class="token punctuation">,</span> <span class="token operator">...</span>packages <span class="token punctuation">}</span>\n  <span class="token function">write</span><span class="token punctuation">(</span><span class="token string">&#39;package.json&#39;</span><span class="token punctuation">,</span> templateDir<span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>pkg<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&#39;\\n&#39;</span><span class="token punctuation">)</span>\n<span class="token punctuation">}</span>\n</code></pre></div><p>🎉🎉🎉 到这里，我们需要做的事情都已经完成了！接下来就是发布 npm 包。</p><h2 id="发布-npm"><a class="header-anchor" href="#发布-npm" aria-hidden="true">#</a> 发布 npm</h2><div class="language-json"><pre><code><span class="token property">&quot;bin&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n  <span class="token property">&quot;create-vct&quot;</span><span class="token operator">:</span> <span class="token string">&quot;index.js&quot;</span><span class="token punctuation">,</span>\n  <span class="token property">&quot;cvt&quot;</span><span class="token operator">:</span> <span class="token string">&quot;index.js&quot;</span>\n<span class="token punctuation">}</span><span class="token punctuation">,</span>\n<span class="token property">&quot;files&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>\n  <span class="token string">&quot;index.js&quot;</span><span class="token punctuation">,</span>\n  <span class="token string">&quot;template-*&quot;</span><span class="token punctuation">,</span>\n  <span class="token string">&quot;*-templates&quot;</span><span class="token punctuation">,</span>\n  <span class="token string">&quot;dist&quot;</span>\n<span class="token punctuation">]</span><span class="token punctuation">,</span>\n</code></pre></div><p>发布 npm 包时，我们需要将所有模板文件都发布，修改 package.json 的<code>files</code>如上所示，files 就是发布到 npm 仓库的文件。</p><p>bin 字段修改为<code>create-vct</code>，这样在执行<code>create-vct</code>命令时最终执行的文件就是 index.js。</p><p><img src="/blog/_assets/package-bin.b08f13f1.png" alt="package-bin.png"></p><blockquote><p>bin 里的命令对应的是一个可执行的文件，通过软链接或者符号链接到指定资源的映射，这些可执行文件必须以 #!/usr/bin/env node 开头，否则脚本将在没有 node 可执行文件的情况下启动。</p></blockquote><p>修改完成后，执行</p><div class="language-bash"><pre><code><span class="token function">pnpm</span> build\nnrm use <span class="token function">npm</span>\n<span class="token function">npm</span> publish\n</code></pre></div><h2 id="如何使用"><a class="header-anchor" href="#如何使用" aria-hidden="true">#</a> 如何使用</h2><ul><li><p>全局安装</p><div class="language-bash"><pre><code><span class="token function">npm</span> i create-vct -g\ncreate-vct\n</code></pre></div><p>全局安装后，直接在控制台输入<code>create-vct</code>即可。</p></li><li><p>使用 npx</p><p>npm 从 5.25.2 版开始，增加了 npx 命令，可以让我们在当前路径使用全局包。npx 运行时，会到当前 node_modules/.bin 路径和环境变量$PATH 里面，检查命令是否存在。如果找不到时会从 npm 上下载最新版本使用。</p><div class="language-bash"><pre><code>npx create-vct\n</code></pre></div></li></ul><h2 id="总结"><a class="header-anchor" href="#总结" aria-hidden="true">#</a> 总结</h2><p>整个流程走下来，真的是收获很多，学到了 node 操作文件的很多 api。对 react-router、redux-toolkit 和 react-query 又重新回顾了一遍。之前做的白板要派上用场了，我用它来做每个模块的图（虽然略丑 😅），同时还学着做了一下 svg 的图标，可谓是收获满满。</p><p>以上就是本文的全部内容，希望这篇文章对你有所帮助，欢迎点赞和收藏 🙏，如果发现有什么错误或者更好的解决方案及建议，欢迎随时联系。</p><p>本文项目地址，<a href="https://github.com/wang1xiang/create-vct" target="_blank" rel="noopener noreferrer">https://github.com/wang1xiang/create-vct</a> 欢迎 star。</p>',108)];p.render=function(a,t,p,e,c,l){return n(),s("div",null,o)};export{t as __pageData,p as default};
