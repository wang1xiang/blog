<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>
      å†é‡ååŒç¼–è¾‘ï¼šYjs + Quillï¼Œæ–‡æ¡£ååŒç¼–è¾‘ç«Ÿå¦‚æ­¤ç®€å• ğŸ¸ | å­¦ä¹ ç¬”è®°
    </title>
    <meta name="description" content="A VitePress site">
    <link rel="stylesheet" href="/blog/_assets/style.85766dd9.css">
    <link rel="modulepreload" href="/blog/_assets/common-03e46d7f.js">
    <link rel="modulepreload" href="/blog/_assets/docs_tiptap_tiptap-tutorial6.md.22b6833e.lean.js">
    <link rel="modulepreload" href="/blog/_assets/app.6e2a9892.js">
    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no">
    <meta name="keywords" content="ç¿”å­Blog">
    <link rel="icon" href="/blog/favicon.ico">
    <link rel="stylesheet" href="https://lib.baomitu.com/gitalk/1.7.0/gitalk.min.css">
    <script src="https://lib.baomitu.com/gitalk/1.7.0/gitalk.min.js"></script>
    <script src="https://lib.baomitu.com/axios/0.21.1/axios.js"></script>
    
  </head>
  <body>
    <div id="app"><!--[--><div id="containerColor" class="no-sidebar theme" data-v-afcf09d4><header class="navbar" data-v-afcf09d4><!--[--><a class="title" aria-label="å­¦ä¹ ç¬”è®°, back to home" href="/blog/"><img class="logo" src="/blog/favicon.ico" alt="logo"><span>å­¦ä¹ ç¬”è®°</span></a><div class="flex-grow"></div><nav class="nav-links hide-mobile"><!--[--><!--[--><div class="nav-item"><a class="nav-link" href="/blog/index.html" target="" rel="">ğŸ  é¦–é¡µ <!----></a></div><!--]--><!--[--><div class="nav-item"><a class="nav-link" href="/blog/more/docs.html" target="" rel="">ğŸ“… å½’æ¡£ <!----></a></div><!--]--><!--[--><div class="nav-item"><a class="nav-link" href="/blog/more/tags.html" target="" rel="">ğŸ“‚ åˆ†ç±» <!----></a></div><!--]--><!--]--><div id="docsearch"></div><!----><!----></nav><!--[--><!--]--><!--]--><div class="sidebar-button" data-v-afcf09d4><svg class="icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z" class></path></svg></div></header><aside class="" data-v-afcf09d4><!--[--><nav class="nav-links show-mobile"><!--[--><!--[--><div class="nav-item"><a class="nav-link" href="/blog/index.html" target="" rel="">ğŸ  é¦–é¡µ <!----></a></div><!--]--><!--[--><div class="nav-item"><a class="nav-link" href="/blog/more/docs.html" target="" rel="">ğŸ“… å½’æ¡£ <!----></a></div><!--]--><!--[--><div class="nav-item"><a class="nav-link" href="/blog/more/tags.html" target="" rel="">ğŸ“‚ åˆ†ç±» <!----></a></div><!--]--><!--]--><div id="docsearch"></div><!----><!----></nav><!--[--><!--]--><ul class="sidebar"><!--[--><!--]--></ul><!--[--><!--]--><!--]--></aside><!----><!-- TODO: make this button accessible --><div class="sidebar-mask" data-v-afcf09d4></div><main data-v-afcf09d4><!--[--><div class="content"><!--[--><!--]--><div class="md-header"><div class="md-title">å†é‡ååŒç¼–è¾‘ï¼šYjs + Quillï¼Œæ–‡æ¡£ååŒç¼–è¾‘ç«Ÿå¦‚æ­¤ç®€å• ğŸ¸</div><span id="jinrishici-sentence">æ­£åœ¨åŠ è½½ä»Šæ—¥è¯—è¯....</span><div class="md-date">2024-02-21</div></div><ul class="catalog"><!--[--><li class="catalog-item"><a class="level level-2" href="#yjs-ä»‹ç»">Yjs ä»‹ç»</a><!----></li><li class="catalog-item"><!----><a class="level level-3" href="#å¯¹æ¯”">å¯¹æ¯”</a></li><li class="catalog-item"><!----><a class="level level-3" href="#åŸºç¡€ä»£ç ">åŸºç¡€ä»£ç </a></li><li class="catalog-item"><a class="level level-2" href="#yjs-quill-æ‰“é€ ååŒç¼–è¾‘æ–‡æ¡£">Yjs + Quill æ‰“é€ ååŒç¼–è¾‘æ–‡æ¡£</a><!----></li><li class="catalog-item"><!----><a class="level level-3" href="#åˆå§‹åŒ–é¡¹ç›®">åˆå§‹åŒ–é¡¹ç›®</a></li><li class="catalog-item"><!----><a class="level level-3" href="#åˆå§‹åŒ–-quill-å¯Œæ–‡æœ¬ç¼–è¾‘å™¨">åˆå§‹åŒ– Quill å¯Œæ–‡æœ¬ç¼–è¾‘å™¨</a></li><li class="catalog-item"><!----><a class="level level-3" href="#å¼•å…¥-yjs-ä¸-quill-å®ç°ç»‘å®š">å¼•å…¥ Yjs ä¸ Quill å®ç°ç»‘å®š</a></li><li class="catalog-item"><!----><a class="level level-3" href="#ä½¿ç”¨-y-websocket-è¿›è¡Œæ•°æ®ä¼ è¾“">ä½¿ç”¨ y-websocket è¿›è¡Œæ•°æ®ä¼ è¾“</a></li><li class="catalog-item"><!----><a class="level level-3" href="#ä½¿ç”¨æœ¬åœ°-socket-æœåŠ¡">ä½¿ç”¨æœ¬åœ° socket æœåŠ¡</a></li><li class="catalog-item"><!----><a class="level level-3" href="#å°ç»“">å°ç»“</a></li><li class="catalog-item"><a class="level level-2" href="#yjs-çš„æ ¸å¿ƒæ¦‚å¿µ">Yjs çš„æ ¸å¿ƒæ¦‚å¿µ</a><!----></li><li class="catalog-item"><!----><a class="level level-3" href="#documents">Documents</a></li><li class="catalog-item"><!----><a class="level level-3" href="#shared-types">Shared Types</a></li><li class="catalog-item"><!----><a class="level level-3" href="#providers">Providers</a></li><li class="catalog-item"><!----><a class="level level-3" href="#awareness-presence">Awareness &amp; Presence</a></li><li class="catalog-item"><!----><a class="level level-3" href="#undomanager">UndoManager</a></li><li class="catalog-item"><a class="level level-2" href="#offline-support-ç¦»çº¿æ”¯æŒ">Offline Support ç¦»çº¿æ”¯æŒ</a><!----></li><li class="catalog-item"><a class="level level-2" href="#yjs-ä¸ä¸åŒç¼–è¾‘å™¨çš„ç»‘å®š">Yjs ä¸ä¸åŒç¼–è¾‘å™¨çš„ç»‘å®š</a><!----></li><li class="catalog-item"><a class="level level-2" href="#æ€»ç»“">æ€»ç»“</a><!----></li><!--]--></ul><div><p>é€šè¿‡ä¸Šä¸€ç¯‡æ–‡ç« <a href="https://juejin.cn/post/7336761948066332723" target="_blank" rel="noopener noreferrer">åˆè¯†ååŒç¼–è¾‘ï¼šOT å’Œ CRDT ç®—æ³•ï¼Œæ–‡æ¡£åä½œçš„â€œé­”æ³•çŸ³â€</a>ï¼Œç›¸ä¿¡å„ä½å°ä¼™ä¼´å¯¹ OT å’Œ CRDT ååŒç®—æ³•æœ‰äº†ä¸€å®šçš„äº†è§£ï¼Œå¹¶ä¸”å¯¹ Yjs æœ‰äº†åˆæ­¥çš„è®¤è¯†ï¼Œæœ¬æ–‡ä¸»è¦æ•™ä¼šå¤§å®¶å¦‚ä½•ä½¿ç”¨ Yjs æ¥å®ç° Quill çš„ååŒç¼–è¾‘ï¼Œä»¥åŠé’ˆå¯¹ Yjs çš„ä¸€äº›é‡è¦æ¦‚å¿µè¿›è¡Œè®²è§£ã€‚</p><blockquote><p>å› ä¸ºåä½œéœ€è¦æœåŠ¡ç«¯çš„æ”¯æŒï¼Œæ‰€æœ‰æ²¡æœ‰ demoï¼Œå…·ä½“å®ç°è¯·<a href="https://github.com/wang1xiang/tiptap-editor/tree/master/02-quill-collab" target="_blank" rel="noopener noreferrer">ğŸ‘‰ğŸ» æŸ¥çœ‹æºç </a>ã€‚</p></blockquote><h2 id="yjs-ä»‹ç»"><a class="header-anchor" href="#yjs-ä»‹ç»" aria-hidden="true">#</a> Yjs ä»‹ç»</h2><p>å®˜æ–¹ä»‹ç»ï¼š<strong>ç”¨äºæ„å»º Google Docs å’Œ Figma ç­‰åä½œåº”ç”¨ç¨‹åºçš„æ¨¡å—åŒ–æ„å»ºå—</strong>ã€‚</p><p><a href="https://docs.yjs.dev/" target="_blank" rel="noopener noreferrer">Yjs</a> åŸºäº CRDT ï¼Œå¸®åŠ©å®ç°é«˜æ€§èƒ½çš„åä½œåº”ç”¨ç¨‹åºã€‚</p><p><a href="https://demos.yjs.dev/" target="_blank" rel="noopener noreferrer">å®˜æ–¹ demo</a></p><p>å¦‚æœç›®å‰ä½¿ç”¨çš„ç¼–è¾‘å™¨æ˜¯ä¸Šè¿°å…¶ä¸­ä¹‹ä¸€æ—¶ï¼Œæ ¹æ®ä¸Šè¿° demo ä¾¿å¯ä»¥è½»æ¾å®ŒæˆååŒç¼–è¾‘ã€‚ä½†å½“æˆ‘ä»¬å­¦ä¹ å®Œæˆåï¼Œèƒ½å¤Ÿå®ç°çš„ååŒç¼–è¾‘å°±ä¸å†ä»…ä»…å±€é™äºä¸Šè¿°ç¼–è¾‘å™¨äº†ã€‚</p><h3 id="å¯¹æ¯”"><a class="header-anchor" href="#å¯¹æ¯”" aria-hidden="true">#</a> å¯¹æ¯”</h3><p><a href="https://automerge.org/" target="_blank" rel="noopener noreferrer">automerge</a>æ˜¯ä¸€ä¸ªç”¨äºæ„å»ºåä½œåº”ç”¨ç¨‹åºçš„æ•°æ®ç»“æ„åº“ï¼Œä¹Ÿæ˜¯åŸºäº CRDT ç®—æ³•å®ç°çš„ï¼Œé€šè¿‡å®ƒä¸ Yjs çš„<a href="https://github.com/dmonad/crdt-benchmarks?tab=readme-ov-file#results" target="_blank" rel="noopener noreferrer">å¯¹æ¯”</a>å¯çŸ¥ Yjs æ˜¯è¿„ä»Šä¸ºæ­¢æœ€å¿«çš„ CRDT å®ç°ã€‚</p><h3 id="åŸºç¡€ä»£ç "><a class="header-anchor" href="#åŸºç¡€ä»£ç " aria-hidden="true">#</a> åŸºç¡€ä»£ç </h3><p>ä¸‹é¢ä¾¿æ˜¯æœ€åŸºç¡€çš„ Yjs ä»£ç ï¼Œä¸€è„¸æ‡µé€¼å§ ğŸ¤·â€â™‚ï¸ï¼æ²¡äº‹ï¼Œç°åœ¨çœ‹ä¸æ‡‚æ²¡å…³ç³»ï¼Œç­‰å­¦å®Œæœ¬æ–‡å†å›æ¥çœ‹ï¼Œä½ ä¼šå‘ç°â€œsogaï¼ŒåŸæ¥é‚£ä¹ˆç®€å•ï¼â€œã€‚</p><div class="language-js"><pre><code><span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> <span class="token constant">Y</span> <span class="token keyword">from</span> <span class="token string">&#39;yjs&#39;</span>

<span class="token comment">// Yjs documents are collections of</span>
<span class="token comment">// shared objects that sync automatically.</span>
<span class="token keyword">const</span> ydoc <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Y<span class="token punctuation">.</span>Doc</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">// Define a shared Y.Map instance</span>
<span class="token keyword">const</span> ymap <span class="token operator">=</span> ydoc<span class="token punctuation">.</span><span class="token function">getMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
ymap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&#39;keyA&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;valueA&#39;</span><span class="token punctuation">)</span>

<span class="token comment">// Create another Yjs document (simulating a remote user)</span>
<span class="token comment">// and create some conflicting changes</span>
<span class="token keyword">const</span> ydocRemote <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Y<span class="token punctuation">.</span>Doc</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> ymapRemote <span class="token operator">=</span> ydocRemote<span class="token punctuation">.</span><span class="token function">getMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
ymapRemote<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&#39;keyB&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;valueB&#39;</span><span class="token punctuation">)</span>

<span class="token comment">// Merge changes from remote</span>
<span class="token keyword">const</span> update <span class="token operator">=</span> <span class="token constant">Y</span><span class="token punctuation">.</span><span class="token function">encodeStateAsUpdate</span><span class="token punctuation">(</span>ydocRemote<span class="token punctuation">)</span>
<span class="token constant">Y</span><span class="token punctuation">.</span><span class="token function">applyUpdate</span><span class="token punctuation">(</span>ydoc<span class="token punctuation">,</span> update<span class="token punctuation">)</span>

<span class="token comment">// Observe that the changes have merged</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ymap<span class="token punctuation">.</span><span class="token function">toJSON</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// =&gt; { keyA: &#39;valueA&#39;, keyB: &#39;valueB&#39; }</span>
</code></pre></div><h2 id="yjs-quill-æ‰“é€ ååŒç¼–è¾‘æ–‡æ¡£"><a class="header-anchor" href="#yjs-quill-æ‰“é€ ååŒç¼–è¾‘æ–‡æ¡£" aria-hidden="true">#</a> Yjs + Quill æ‰“é€ ååŒç¼–è¾‘æ–‡æ¡£</h2><p>âœ… æ­¥å…¥æ­£æ–‡å•¦ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬ç”¨çŸ­çŸ­å‡ åè¡Œä»£ç ï¼Œä¾¿å¯æ‰“é€ ä¸€ä¸ª Quill å¯Œæ–‡æœ¬ç¼–è¾‘å™¨çš„ååŒç¼–è¾‘ã€‚å¾ˆç®€å•ï¼Œåˆ«å…‰çœ‹ï¼ŒåŠ¨æ‰‹æ’¸èµ·æ¥ã€‚</p><h3 id="åˆå§‹åŒ–é¡¹ç›®"><a class="header-anchor" href="#åˆå§‹åŒ–é¡¹ç›®" aria-hidden="true">#</a> åˆå§‹åŒ–é¡¹ç›®</h3><p>é€šè¿‡<code>npx create-vite quill-collab</code>åˆ›å»ºä¸€ä¸ª vue é¡¹ç›®</p><h3 id="åˆå§‹åŒ–-quill-å¯Œæ–‡æœ¬ç¼–è¾‘å™¨"><a class="header-anchor" href="#åˆå§‹åŒ–-quill-å¯Œæ–‡æœ¬ç¼–è¾‘å™¨" aria-hidden="true">#</a> åˆå§‹åŒ– Quill å¯Œæ–‡æœ¬ç¼–è¾‘å™¨</h3><ol><li><p>å®‰è£… quill åŠæ’ä»¶ quill-cursor</p><div class="language-bash"><pre><code><span class="token function">yarn</span> <span class="token function">add</span> quill quill-cursors
</code></pre></div></li><li><p>ä¿®æ”¹ main.ts ä»£ç ï¼Œä½¿ç”¨ä»¥ä¸‹ä»£ç è¦†ç›– main.ts</p><div class="language-js"><pre><code><span class="token keyword">import</span> Quill <span class="token keyword">from</span> <span class="token string">&#39;quill&#39;</span>
<span class="token keyword">import</span> QuillCursors <span class="token keyword">from</span> <span class="token string">&#39;quill-cursors&#39;</span>
<span class="token keyword">import</span> <span class="token string">&#39;quill/dist/quill.snow.css&#39;</span>

Quill<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token string">&#39;modules/cursors&#39;</span><span class="token punctuation">,</span> QuillCursors<span class="token punctuation">)</span>

<span class="token keyword">const</span> quill <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Quill</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&#39;#app&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">modules</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">cursors</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token literal-property property">toolbar</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token comment">// adding some basic Quill content features</span>
      <span class="token punctuation">[</span><span class="token punctuation">{</span> <span class="token literal-property property">header</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token punctuation">[</span><span class="token string">&#39;bold&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;italic&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;underline&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token punctuation">[</span><span class="token string">&#39;image&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;code-block&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token literal-property property">history</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token comment">// Local undo shouldn&#39;t undo changes</span>
      <span class="token comment">// from remote users</span>
      <span class="token literal-property property">userOnly</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">placeholder</span><span class="token operator">:</span> <span class="token string">&#39;Start collaborating...&#39;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">theme</span><span class="token operator">:</span> <span class="token string">&#39;snow&#39;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div></li></ol><p>å¯åŠ¨æœåŠ¡ï¼ŒQuill ç¼–è¾‘å™¨åˆå§‹åŒ–å®Œæˆã€‚</p><h3 id="å¼•å…¥-yjs-ä¸-quill-å®ç°ç»‘å®š"><a class="header-anchor" href="#å¼•å…¥-yjs-ä¸-quill-å®ç°ç»‘å®š" aria-hidden="true">#</a> å¼•å…¥ Yjs ä¸ Quill å®ç°ç»‘å®š</h3><p>è¿™ä¸€æ­¥æ˜¯ä¸ºäº†å°† Yjs çš„æ•°æ®æ¨¡å‹ä¸ Quill çš„æ•°æ®æ¨¡å‹è¿›è¡Œç»‘å®šï¼Œç»‘å®šå Yjs å°±ä¼šè‡ªåŠ¨å¤„ç†æ•°æ®çš„å¹¶å‘æ›´æ”¹ï¼ˆ<strong>è‡ªåŠ¨è§£å†³å†²çª</strong>ï¼‰ã€‚</p><ol><li><p>å®‰è£…ä¾èµ–</p><div class="language-bash"><pre><code><span class="token function">yarn</span> <span class="token function">add</span> yjs y-quill
</code></pre></div><p><code>y-quill</code> æ˜¯ Yjs å®˜æ–¹æä¾›çš„ï¼Œé€šè¿‡å®ƒæä¾›çš„ <code>QuillBinding</code> æ–¹æ³•å¯ä»¥å°† Quill æ•°æ®æ¨¡å‹å’Œ Yjs æ•°æ®æ¨¡å‹è¿›è¡Œç»‘å®šã€‚</p></li><li><p>ä¿®æ”¹ main.tsï¼Œæ·»åŠ å¦‚ä¸‹ä»£ç ï¼š</p><div class="language-js"><pre><code><span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> <span class="token constant">Y</span> <span class="token keyword">from</span> <span class="token string">&#39;yjs&#39;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> QuillBinding <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;y-quill&#39;</span>
<span class="token comment">// Yjsæ–‡æ¡£ï¼Œä¿å­˜å…±äº«æ•°æ®shared data</span>
<span class="token keyword">const</span> ydoc <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Y<span class="token punctuation">.</span>Doc</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">// åœ¨æ–‡æ¡£ä¸Šå®šä¹‰å…±äº«æ–‡æœ¬ç±»å‹</span>
<span class="token keyword">const</span> ytext <span class="token operator">=</span> ydoc<span class="token punctuation">.</span><span class="token function">getText</span><span class="token punctuation">(</span><span class="token string">&#39;quill&#39;</span><span class="token punctuation">)</span>

<span class="token comment">// åˆ›å»ºä¸€ä¸ªç¼–è¾‘å™¨ç»‘å®š å°†quillç¼–è¾‘å™¨â€œç»‘å®šâ€åˆ° Y.Text ç±»å‹ã€‚</span>
<span class="token keyword">const</span> binding <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">QuillBinding</span><span class="token punctuation">(</span>ytext<span class="token punctuation">,</span> quill<span class="token punctuation">)</span>
</code></pre></div><ul><li>é¦–å…ˆé€šè¿‡<code>new Y.Doc()</code>åˆ›å»º Yjs æ–‡æ¡£ï¼Œç”¨äºä¿å­˜ Shared Types å…±äº«æ•°æ®ï¼›</li><li>æ¥ç€åˆ›å»ºåä¸º <code>quill</code> çš„ ytext å¯¹è±¡ï¼Œç”¨äºè¡¨ç¤ºæ–‡æœ¬çš„å…±äº«æ•°æ®ç»“æ„ï¼›</li><li>æœ€åé€šè¿‡ <code>QuillBinding</code> å°† ytext ä¸ Quill ç¼–è¾‘å™¨è¿›è¡Œç»‘å®šï¼ŒåŠ<strong>æ•°æ®ä¿æŒåŒæ­¥</strong>ï¼ˆYjs æ•°æ®æ”¹å˜æ—¶ Quill ç¼–è¾‘å™¨æ•°æ®è‡ªåŠ¨æ›´æ–°ï¼ŒQuill ç¼–è¾‘å™¨æ•°æ®æ”¹å˜æ—¶ Yjs æ•°æ®ä¹Ÿè‡ªåŠ¨æ›´æ–°ï¼‰ã€‚</li></ul><p><strong>å‡ ä¹æ‰€æœ‰ç¼–è¾‘å™¨ä¸ Yjs è¿›è¡Œç»‘å®šæ—¶éƒ½æ˜¯ä»¥ä¸Šä¸‰ä¸ªæ­¥éª¤</strong>ã€‚</p></li></ol><h3 id="ä½¿ç”¨-y-websocket-è¿›è¡Œæ•°æ®ä¼ è¾“"><a class="header-anchor" href="#ä½¿ç”¨-y-websocket-è¿›è¡Œæ•°æ®ä¼ è¾“" aria-hidden="true">#</a> ä½¿ç”¨ y-websocket è¿›è¡Œæ•°æ®ä¼ è¾“</h3><p>å‰ä¸‰æ­¥å®¢æˆ·ç«¯çš„æ“ä½œå·²ç»å®Œæˆï¼Œæ¥ä¸‹æ¥å°±æ˜¯è¦æ¥ä¸ŠæœåŠ¡ç«¯ï¼Œå®ç°æ•°æ®ä¼ è¾“äº†ï¼ŒYjs æä¾›äº† <a href="https://docs.yjs.dev/ecosystem/connection-provider" target="_blank" rel="noopener noreferrer">Provider</a> æ¥å®ç°ã€‚</p><p>Yjs æä¾›äº†å¤šç§ç±»å‹çš„ Provider ç”¨äºæ•°æ®ä¼ è¾“ï¼Œå¦‚ï¼šWebSocketã€WebRTCã€Datã€‚</p><ol><li><p>å®‰è£…ä¾èµ–</p><div class="language-bash"><pre><code><span class="token function">yarn</span> <span class="token function">add</span> y-websocket
</code></pre></div></li><li><p>ä¿®æ”¹ä»£ç </p><div class="language-js"><pre><code><span class="token keyword">import</span> <span class="token punctuation">{</span> WebsocketProvider <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;y-websocket&#39;</span>
<span class="token comment">// è¿æ¥åˆ° websocket æœåŠ¡ç«¯ yjsæä¾›çš„ä½“éªŒæœåŠ¡å™¨</span>
<span class="token keyword">const</span> provider <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebsocketProvider</span><span class="token punctuation">(</span>
  <span class="token string">&#39;wss://demos.yjs.dev&#39;</span><span class="token punctuation">,</span>
  <span class="token string">&#39;quill-demo-room&#39;</span><span class="token punctuation">,</span>
  ydoc
<span class="token punctuation">)</span>
<span class="token comment">// ç»‘å®š</span>
<span class="token keyword">const</span> binding <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">QuillBinding</span><span class="token punctuation">(</span>ytext<span class="token punctuation">,</span> quill<span class="token punctuation">,</span> provider<span class="token punctuation">.</span>awareness<span class="token punctuation">)</span>
</code></pre></div><p>å¤§å¤šæ•° Provider çš„å…±åŒç‚¹æ˜¯ä»–ä»¬<strong>ä½¿ç”¨æˆ¿é—´åç§°çš„æ¦‚å¿µ</strong>æ¥è¿æ¥ Yjs æ–‡æ¡£ã€‚åœ¨ä¸Šé¢çš„ç¤ºä¾‹ä¸­ï¼Œæ‰€æœ‰æŒ‡å®šâ€œquill-demo-roomâ€ä½œä¸ºæˆ¿é—´åç§°çš„æ–‡æ¡£éƒ½å°†åŒæ­¥ã€‚</p></li><li><p>ååŒæ•ˆæœå¦‚ä¸‹</p><p><img src="/blog/_assets/quill-collab-error.08a78138.gif" alt="quill-collab-error"></p><p>ä¸Šé¢æ˜¯ç”¨ chrome æµè§ˆå™¨å’Œ safari æµè§ˆå™¨åŒæ—¶æµ‹è¯•çš„æ•ˆæœï¼Œå› ä¸ºå®˜æ–¹æä¾›çš„ websocket æœåŠ¡è¿æ¥å¤±è´¥ï¼Œä¸åŒæµè§ˆå™¨ä¹‹é—´çš„ååŒæ˜¯æ²¡æœ‰ç”Ÿæ•ˆçš„ã€‚</p><p><img src="/blog/_assets/yjs-demo-wss.bd7eb3ee.png" alt="yjs-demo-wss"></p><p>é‚£ä¸ºä»€ä¹ˆåŒä¸€æµè§ˆå™¨çš„ä¸¤ä¸ª tabï¼Œæ²¡è¿ä¸Š socket æœåŠ¡ä¹Ÿèƒ½åšååŒç¼–è¾‘å‘¢ï¼Ÿ</p><p>è¿™æ˜¯å› ä¸º Yjs ä¼š<strong>ä¼˜å…ˆé€šè¿‡æµè§ˆå™¨çš„åŒ host å…±äº«çŠ¶æ€çš„æ–¹å¼è¿›è¡Œé€šä¿¡</strong>ï¼Œç„¶åæ‰æ˜¯ç½‘ç»œé€šä¿¡ã€‚</p></li></ol><h3 id="ä½¿ç”¨æœ¬åœ°-socket-æœåŠ¡"><a class="header-anchor" href="#ä½¿ç”¨æœ¬åœ°-socket-æœåŠ¡" aria-hidden="true">#</a> ä½¿ç”¨æœ¬åœ° socket æœåŠ¡</h3><p>æ—¢ç„¶ Yjs æä¾›çš„ä½“éªŒæœåŠ¡æ— æ³•è¿æ¥ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥è‡ªå·±æœ¬åœ°å¯ä¸€ä¸ª y-websocket æœåŠ¡ã€‚</p><ol><li><p>åœ¨å½“å‰é¡¹ç›®ä¸‹å¯åŠ¨ y-websocket æœåŠ¡</p><p>å½“å‰é¡¹ç›®å·²ç»å®‰è£… y-websocket ä¾èµ–ï¼Œå¯ç›´æ¥ä½¿ç”¨ï¼›å¦‚æœåœ¨åˆ«å¤„å¯ç”¨æ—¶ï¼Œéœ€è¦å…ˆå®‰è£… y-websocket ä¾èµ–ã€‚</p><div class="language-bash"><pre><code><span class="token assign-left variable">PORT</span><span class="token operator">=</span><span class="token number">1234</span> npx y-websocket
</code></pre></div><p><img src="/blog/_assets/local-websocket.edfc9873.png" alt="local-websocket"></p></li><li><p>ä¿®æ”¹ ws æœåŠ¡çš„åœ°å€</p><div class="language-js"><pre><code><span class="token keyword">const</span> provider <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebsocketProvider</span><span class="token punctuation">(</span>
  <span class="token string">&#39;ws://localhost:1234&#39;</span><span class="token punctuation">,</span>
  <span class="token string">&#39;quill-demo-room&#39;</span><span class="token punctuation">,</span>
  ydoc
<span class="token punctuation">)</span>
</code></pre></div></li></ol><p>æ­¤æ—¶æ•ˆæœå°±æ­£å¸¸äº† <img src="/blog/_assets/quill-collab.bec9f695.gif" alt="quill-collab"></p><h3 id="å°ç»“"><a class="header-anchor" href="#å°ç»“" aria-hidden="true">#</a> å°ç»“</h3><p>æˆ‘ä»¬ç”¨ä¸åˆ° 70 è¡Œä»£ç ï¼ˆ<a href="https://github.com/wang1xiang/tiptap-editor/tree/master/02-quill-collab" target="_blank" rel="noopener noreferrer">ğŸ‘‰ğŸ» å®Œæ•´ä»£ç </a>ï¼‰ï¼Œå°±å®ç°äº† Quill å¯Œæ–‡æœ¬ç¼–è¾‘å™¨çš„ååŒç¼–è¾‘ã€‚ä¸»è¦æ˜¯é€šè¿‡å°† Yjs ä¸ Quill ç¼–è¾‘å™¨è¿›è¡Œç»‘å®šï¼Œå®ç°äº†æ•°æ®çš„è”åŠ¨ï¼›ç„¶åå†é€šè¿‡ç½‘ç»œæœåŠ¡å°† Yjs æ•°æ®åœ¨ä¸åŒå®¢æˆ·ç«¯ä¹‹é—´è¿›è¡Œä¼ é€’ã€‚</p><p>æœ‰äº†è¿™ä¸ªå‰æï¼Œæ¥ä¸‹æ¥æ•´ç†ä¸‹ Yjs å‡ ä¸ªæ¯”è¾ƒé‡è¦çš„æ¦‚å¿µã€‚</p><h2 id="yjs-çš„æ ¸å¿ƒæ¦‚å¿µ"><a class="header-anchor" href="#yjs-çš„æ ¸å¿ƒæ¦‚å¿µ" aria-hidden="true">#</a> Yjs çš„æ ¸å¿ƒæ¦‚å¿µ</h2><p>Yjsï¼šåŒ…å«æœ€æ ¸å¿ƒçš„æ•°æ®ç»“æ„åŠé€»è¾‘ã€‚å¦‚æ•°æ®ç±»å‹çš„å®šä¹‰ï¼Œæ•°æ®è¯»å†™ç¼–ç  encoding æ¨¡å—ï¼Œäº‹ä»¶ç›‘å¬ï¼ŒçŠ¶æ€ç®¡ç† StructStoreï¼ŒUndo/Redo ç®¡ç†å™¨ç­‰ã€‚</p><h3 id="documents"><a class="header-anchor" href="#documents" aria-hidden="true">#</a> Documents</h3><div class="language-js"><pre><code><span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> <span class="token constant">Y</span> <span class="token keyword">from</span> <span class="token string">&#39;yjs&#39;</span>

<span class="token keyword">const</span> doc <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Y<span class="token punctuation">.</span>Doc</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p>é€šè¿‡ <code>new Y.Doc()</code> ä¼šåˆ›å»ºä¸€ä¸ª Doc å®ä¾‹ï¼ˆå³ä¸€ä¸ª Yjs æ–‡æ¡£ï¼‰ï¼Œä½œç”¨ï¼š</p><ul><li><p><strong>å®¹å™¨</strong>ï¼šæ˜¯æ‰¿è½½å…±äº«æ•°æ® Shared Types çš„å®¹å™¨</p><div class="language-js"><pre><code><span class="token keyword">const</span> ytext <span class="token operator">=</span> ydoc<span class="token punctuation">.</span><span class="token function">getText</span><span class="token punctuation">(</span><span class="token string">&#39;quill&#39;</span><span class="token punctuation">)</span>
</code></pre></div></li><li><p><strong>è½½ä½“</strong>ï¼šæ˜¯ç½‘ç»œä¼ è¾“ Provider çš„è½½ä½“ï¼Œå°† ydoc ä¼ å…¥ WebSocket çš„ provider åå³å¯æ”¯æŒç½‘ç»œåŒæ­¥</p><div class="language-js"><pre><code><span class="token comment">// è¿æ¥åˆ° websocket</span>
<span class="token keyword">const</span> provider <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebsocketProvider</span><span class="token punctuation">(</span>
  <span class="token string">&#39;ws://localhost:1234&#39;</span><span class="token punctuation">,</span>
  <span class="token string">&#39;quill-demo-room&#39;</span><span class="token punctuation">,</span>
  ydoc
<span class="token punctuation">)</span>
</code></pre></div></li></ul><p>Y.doc ä¸Šæœ‰å¾ˆå¤šæœ‰ç”¨çš„å±æ€§ï¼Œå¦‚ï¼š</p><h4 id="doc-clientid-number"><a class="header-anchor" href="#doc-clientid-number" aria-hidden="true">#</a> doc.clientID: number</h4><p><strong>åªè¯»å±æ€§</strong>ï¼Œæ ‡è¯†ä¼šè¯çš„<code>å®¢æˆ·ç«¯çš„å”¯ä¸€ ID</code>, Yjs ä¼šä¸ºæ¯ä¸ªä¼šè¯åˆ›å»ºä¸€ä¸ªæ–°çš„ clientIDï¼Œä»¥é¿å…åŒæ­¥å†²çªã€‚åŒä¸€ç”¨æˆ·æ‰“å¼€å¤šä¸ª tab é¡µæ—¶ clientID ä¹Ÿæ˜¯å”¯ä¸€çš„ï¼Œä¸å…è®¸è·¨ä¼šè¯é‡å¤ä½¿ç”¨ï¼Œå¯è§<a href="https://docs.yjs.dev/api/faq#i-get-a-new-clientid-for-every-session-is-there-a-way-to-make-it-static-for-a-peer-accessing-the-doc" target="_blank" rel="noopener noreferrer">FAQ</a>ã€‚</p><h4 id="doc-gc-boolean"><a class="header-anchor" href="#doc-gc-boolean" aria-hidden="true">#</a> doc.gc: boolean</h4><p>æ˜¯å¦åœ¨æ­¤æ–‡æ¡£å®ä¾‹ä¸Šå¯ç”¨åƒåœ¾å›æ”¶ï¼Œé»˜è®¤ä¸º<code>true</code>ã€‚æ›´å¤šå¯é€šè¿‡<a href="https://docs.yjs.dev/api/internals" target="_blank" rel="noopener noreferrer">Internals</a>äº†è§£ Yjs çš„å†…éƒ¨å·¥ä½œåŸç†ã€‚</p><h4 id="doc-transact-function-transaction-void-origin-any"><a class="header-anchor" href="#doc-transact-function-transaction-void-origin-any" aria-hidden="true">#</a> doc.transact(function(Transaction): void [, origin:any])</h4><p>Yjs ä¸­ Documents/Shared Types çš„æ‰€æœ‰æ›´æ”¹éƒ½å‘ç”Ÿåœ¨äº‹åŠ¡ä¸­ï¼Œæ¯æ¬¡å‘ç”Ÿäº‹åŠ¡åéƒ½ä¼šè§¦å‘ <code>observer</code> è°ƒç”¨å’Œ <code>update</code> äº‹ä»¶ï¼Œè§¦å‘<strong>ç›‘å¬å’Œæ›´æ–°</strong>æ“ä½œã€‚</p><h4 id="doc-get-string-y-typeclass-type"><a class="header-anchor" href="#doc-get-string-y-typeclass-type" aria-hidden="true">#</a> doc.get(string, Y.[TypeClass]): [Type]</h4><p>è·å–å…±äº«ç±»å‹çš„é¡¶çº§å®ä¾‹ï¼Œå¯ä»¥çœ‹åˆ° <code>gc</code> é»˜è®¤ä¸º <code>true</code>ï¼Œ<code>clientID</code> ä¸ºä¸€ä¸ªéšæœºæ•°</p><p><img src="/blog/_assets/y-doc-property.9724e5c8.png" alt="y-doc-property"></p><h4 id="doc-gettext-getarray-getmap"><a class="header-anchor" href="#doc-gettext-getarray-getmap" aria-hidden="true">#</a> doc.getText/getArray/getMap</h4><p>ç”¨äºå®šä¹‰ Shared Types ç±»å‹ï¼ˆtextã€arrayã€map ç­‰ï¼‰</p><h4 id="doc-on-once-off"><a class="header-anchor" href="#doc-on-once-off" aria-hidden="true">#</a> doc.on/once/off</h4><p>äº‹ä»¶ç›‘å¬</p><h4 id="doc-on-beforetransaction-function-tr-transaction-doc-y-doc"><a class="header-anchor" href="#doc-on-beforetransaction-function-tr-transaction-doc-y-doc" aria-hidden="true">#</a> doc.on(&#39;beforeTransaction&#39;, function(tr: Transaction, doc: Y.Doc))</h4><p>äº‹ä»¶å¤„ç†ç¨‹åºåœ¨æ¯æ¬¡<strong>äº‹åŠ¡ä¹‹å‰</strong>éƒ½ä¼šè¢«è°ƒç”¨</p><h4 id="doc-on-beforeobservercalls-function-tr-transaction-doc-y-doc"><a class="header-anchor" href="#doc-on-beforeobservercalls-function-tr-transaction-doc-y-doc" aria-hidden="true">#</a> doc.on(&#39;beforeObserverCalls&#39;, function(tr: Transaction, doc: Y.Doc))</h4><p>äº‹ä»¶å¤„ç†ç¨‹åºåœ¨è°ƒç”¨å…±äº«ç±»å‹çš„è§‚å¯Ÿç¨‹åºä¹‹å‰ç«‹å³è°ƒç”¨</p><h4 id="doc-on-aftertransaction-function-tr-transaction-doc-y-doc"><a class="header-anchor" href="#doc-on-aftertransaction-function-tr-transaction-doc-y-doc" aria-hidden="true">#</a> doc.on(&#39;afterTransaction&#39;, function(tr: Transaction, doc: Y.Doc))</h4><p>äº‹ä»¶å¤„ç†ç¨‹åºåœ¨æ¯æ¬¡<strong>äº‹åŠ¡ä¹‹å</strong>ç«‹å³è°ƒç”¨</p><h4 id="doc-on-update-function-update-uint8array-origin-any-doc-y-doc-tr-transaction"><a class="header-anchor" href="#doc-on-update-function-update-uint8array-origin-any-doc-y-doc-tr-transaction" aria-hidden="true">#</a> doc.on(&#39;update&#39;, function(update: Uint8Array, origin: any, doc: Y.Doc, tr: Transaction))</h4><p>ç›‘å¬ Shared Types ä¸Šçš„æœ€æ–°æ¶ˆæ¯ï¼Œæ‰€æœ‰æ›´æ–°æ¶ˆæ¯éƒ½ä¼ æ’­ç»™æ‰€æœ‰ç”¨æˆ·ï¼Œæ¯ä¸ªäººæœ€ç»ˆéƒ½ä¼šç»Ÿä¸€ç›¸åŒçš„çŠ¶æ€ã€‚</p><h4 id="äº‹ä»¶è°ƒç”¨é¡ºåº"><a class="header-anchor" href="#äº‹ä»¶è°ƒç”¨é¡ºåº" aria-hidden="true">#</a> äº‹ä»¶è°ƒç”¨é¡ºåº</h4><p>å‰é¢è¯´äº†â€œYjs ä¸­ Documents/Shared Types çš„æ‰€æœ‰æ›´æ”¹éƒ½å‘ç”Ÿåœ¨äº‹åŠ¡ä¸­â€ï¼Œå½“å‘ç”Ÿå˜æ›´æ—¶ï¼Œäº‹ä»¶æŒ‰ä»¥ä¸‹é¡ºåºè°ƒç”¨ï¼š</p><p><img src="/blog/_assets/yjs-event-order.d99bd63d.png" alt="yjs-event-order"></p><p>å¯ä¿®æ”¹ä»£ç æµ‹è¯•</p><div class="language-js"><pre><code><span class="token keyword">const</span> ydoc <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Y<span class="token punctuation">.</span>Doc</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
ydoc<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;beforeTransaction&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;beforeTransaction&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
ydoc<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;beforeObserverCalls&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;beforeObserverCalls&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
ydoc<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;afterTransaction&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;afterTransaction&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
ydoc<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;update&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">update</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;update&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment">// åˆ›å»ºä¸€ä¸ªé¡¶å±‚åä¸º kun çš„ YMap</span>
<span class="token keyword">const</span> ymap <span class="token operator">=</span> ydoc<span class="token punctuation">.</span><span class="token function">getMap</span><span class="token punctuation">(</span><span class="token string">&#39;kun&#39;</span><span class="token punctuation">)</span>
ymap<span class="token punctuation">.</span><span class="token function">observe</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;observe&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
ymap<span class="token punctuation">.</span><span class="token function">observeDeep</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;observeDeep&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>æµ‹è¯•ç»“æœå¦‚ä¸‹ï¼š</p><p><img src="/blog/_assets/yjs-event-order-test.3930d3a9.png" alt="yjs-event-order-test"></p><p>Documents çš„å®Œæ•´å±æ€§å¯è§<a href="https://docs.yjs.dev/api/y.doc" target="_blank" rel="noopener noreferrer">è¿™é‡Œã€‚</a></p><h3 id="shared-types"><a class="header-anchor" href="#shared-types" aria-hidden="true">#</a> Shared Types</h3><p><strong>The most unique feature of Yjs yet: Shared Types.</strong></p><p>Shared Types æ˜¯ Yjs æœ€æ ¸å¿ƒçš„å†…å®¹ï¼Œç”¨äºè¡¨ç¤º<code>å¯ååŒç¼–è¾‘çš„æ•°æ®ç»“æ„</code>ã€‚é€šè¿‡å®ƒå¯ä»¥å®ç°ä»»ä½•åº”ç”¨çš„åä½œï¼Œæ¯”å¦‚ï¼šæ–‡æ¡£ã€è¡¨æ ¼ã€ç»˜å›¾ç­‰ç­‰ã€‚</p><p>Yjs æä¾›äº†å¤šç§ç±»å‹çš„ Shared Typesï¼šåŒ…æ‹¬å¸¸è§çš„æ•°æ®ç»“æ„ <a href="https://docs.yjs.dev/api/shared-types/y.map" target="_blank" rel="noopener noreferrer">Y.Map</a>ã€<a href="https://docs.yjs.dev/api/shared-types/y.array" target="_blank" rel="noopener noreferrer">Y.Array</a>ã€<a href="https://docs.yjs.dev/api/shared-types/y.text" target="_blank" rel="noopener noreferrer">Y.Text</a>ï¼Œä½¿ç”¨èµ·æ¥å°±å’Œ js çš„ mapã€array å¯¹è±¡åŸºæœ¬æ˜¯ä¸€æ ·çš„ï¼Œå…·ä½“ä½¿ç”¨å“ªç§éœ€è¦æ ¹æ®å®é™…çš„æ•°æ®ç»“æ„æ¥å†³å®šã€‚æ¯”å¦‚ä¸Šä¸€èŠ‚ä¸­å°† Y.Text é€šè¿‡ <code>y-quill</code> â€œç»‘å®šâ€åˆ° Quill çš„ç¼–è¾‘å™¨å®ä¾‹åè‡ªåŠ¨åŒæ­¥ç¼–è¾‘å™¨å†…å®¹ã€‚</p><p>å¦‚ä½•å®ç°ååŒç¼–è¾‘ï¼Ÿæˆ‘ä»¬åªéœ€è¦<strong>æ„é€ å¥½ä¸€ä¸ª Shared Types æ•°æ®ç»“æ„ï¼Œç›‘å¬å®ƒçš„å˜åŒ–ï¼Œå°†å˜åŒ–é€šè¿‡ç½‘ç»œå‘é€åˆ°å…¶ä»–ç«¯</strong>å³å¯ã€‚çœ‹ä¸‹åœ¨ Yjs ä¸­æ˜¯æ€ä¹ˆå®ç°çš„ï¼Ÿ</p><h4 id="æ„é€ -shared-types"><a class="header-anchor" href="#æ„é€ -shared-types" aria-hidden="true">#</a> æ„é€  Shared Types</h4><p>æ¯”å¦‚æˆ‘ä»¬æœ‰å¦‚ä¸‹æ•°æ®ï¼š</p><div class="language-js"><pre><code><span class="token punctuation">{</span>
  <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&#39;kunkun&#39;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">age</span><span class="token operator">:</span> <span class="token string">&#39;2.5&#39;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">address</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">country</span><span class="token operator">:</span> <span class="token string">&#39;China&#39;</span><span class="token punctuation">,</span>
    <span class="token literal-property property">city</span><span class="token operator">:</span> <span class="token string">&#39;shanghai&#39;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">likes</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&#39;Sing&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;dance&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;rap&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;basketball&#39;</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><p><img src="/blog/_assets/yjs-kunkun.33c626d1.png" alt="yjs-kunkun"></p><p>å°è¯•å°†ä¸Šé¢æ•°æ®è½¬ä¸º Y.Map æ ¼å¼å¦‚ä¸‹ï¼š</p><div class="language-js"><pre><code><span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> <span class="token constant">Y</span> <span class="token keyword">from</span> <span class="token string">&#39;yjs&#39;</span>

<span class="token keyword">const</span> ydoc <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Y<span class="token punctuation">.</span>Doc</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// åˆ›å»ºä¸€ä¸ªé¡¶å±‚åä¸º kun çš„ YMap</span>
<span class="token keyword">const</span> ymap <span class="token operator">=</span> ydoc<span class="token punctuation">.</span><span class="token function">getMap</span><span class="token punctuation">(</span><span class="token string">&#39;kun&#39;</span><span class="token punctuation">)</span>

<span class="token comment">// æ„é€ åµŒå¥—çš„ ymap</span>
<span class="token keyword">const</span> ymapAddress <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Y<span class="token punctuation">.</span>Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
ymapAddress<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&#39;country&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;China&#39;</span><span class="token punctuation">)</span>
ymapAddress<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&#39;city&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;shanghai&#39;</span><span class="token punctuation">)</span>
ymap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&#39;address&#39;</span><span class="token punctuation">,</span> ymapAddress<span class="token punctuation">)</span>

<span class="token comment">// æ„é€ åµŒå¥—çš„ yarray</span>
<span class="token keyword">const</span> yarrayLikes <span class="token operator">=</span> <span class="token constant">Y</span><span class="token punctuation">.</span>Array<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&#39;Sing&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;dance&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;rap&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;basketball&#39;</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token comment">// const yarrayLikes = new Y.Array()</span>
<span class="token comment">// yarrayLikes.push([&#39;Sing&#39;])</span>
<span class="token comment">// yarrayLikes.push([&#39;dance&#39;])</span>
<span class="token comment">// yarrayLikes.push([&#39;rap&#39;])</span>
<span class="token comment">// yarrayLikes.insert(3, [&#39;basketball&#39;])</span>
ymap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&#39;likes&#39;</span><span class="token punctuation">,</span> yarrayLikes<span class="token punctuation">)</span>
ymap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&#39;name&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;kunkun&#39;</span><span class="token punctuation">)</span>
ymap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&#39;age&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;2.5&#39;</span><span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ymap<span class="token punctuation">.</span><span class="token function">toJSON</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p><img src="/blog/_assets/y-map-kun.09eae68e.png" alt="y-map-kun"></p><p>ä¸Šé¢çš„ API å¯å‚è€ƒ<a href="https://docs.yjs.dev/api/shared-types/y.map" target="_blank" rel="noopener noreferrer">yMap</a></p><h4 id="ç›‘å¬-ymap-å˜åŒ–"><a class="header-anchor" href="#ç›‘å¬-ymap-å˜åŒ–" aria-hidden="true">#</a> ç›‘å¬ Ymap å˜åŒ–</h4><p>yMap å·²ç»æ„é€ å®Œæˆï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥ä¾¿æ˜¯ç›‘å¬å®ƒçš„å˜åŒ–ä½œç›¸åº”çš„å¤„ç†ã€‚</p><p>Shared Types ä¸­é€šè¿‡ observe å’Œ observeDeep æ¥ç›‘å¬æ•°æ®çš„å˜åŒ–ï¼Œå½“æ•°æ®å˜åŒ–æ—¶ï¼Œä¼šè§¦å‘ç›‘å¬çš„å›è°ƒå‡½æ•°ï¼Œå›è°ƒå‡½æ•°ä¼šé€šè¿‡æ›´æ–°äº‹ä»¶ <a href="https://docs.yjs.dev/api/y.event" target="_blank" rel="noopener noreferrer">YEvent</a> ä¼ å…¥å½“å‰çš„æ›´æ–°å†…å®¹ï¼Œä»è€Œæ‰§è¡Œç›¸åº”çš„æ“ä½œã€‚</p><ul><li>ymap.observeï¼šæ³¨å†Œä¸€ä¸ª observeï¼Œå½“ä¿®æ”¹æ•°æ®æ—¶ä¼šè°ƒç”¨è¯¥æ–¹æ³•</li><li>ymap.unobserveï¼šå–æ¶ˆæ³¨å†Œåœ¨ ymap.observe ä¸­æ–¹æ³•</li><li>ymap.observeDeep</li><li>ymap.unobserveDeep(function)</li></ul><p>observeDeep ä¸ observe çš„ä¸åŒåœ¨äº observeDeep æ˜¯æ·±åº¦ç›‘å¬ï¼Œç±»ä¼¼äº watch çš„<code>deep:true</code>ã€‚</p><p>ä¿®æ”¹ä»£ç å¦‚ä¸‹ï¼š</p><div class="language-js"><pre><code><span class="token comment">// åˆ›å»ºä¸€ä¸ªé¡¶å±‚åä¸º kun çš„ YMap</span>
<span class="token keyword">const</span> ymap <span class="token operator">=</span> ydoc<span class="token punctuation">.</span><span class="token function">getMap</span><span class="token punctuation">(</span><span class="token string">&#39;kun&#39;</span><span class="token punctuation">)</span>

<span class="token comment">// ç›‘å¬å˜åŒ–</span>
ymap<span class="token punctuation">.</span><span class="token function">observe</span><span class="token punctuation">(</span><span class="token parameter">event</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  event<span class="token punctuation">.</span>changes<span class="token punctuation">.</span>keys<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">change<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>change<span class="token punctuation">.</span>action <span class="token operator">===</span> <span class="token string">&#39;add&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Property &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>key<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot; was added. Initial value: &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ymap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>change<span class="token punctuation">.</span>action <span class="token operator">===</span> <span class="token string">&#39;update&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Property &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>key<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot; was updated. New value: &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ymap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;. Previous value: &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>change<span class="token punctuation">.</span>oldValue<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>change<span class="token punctuation">.</span>action <span class="token operator">===</span> <span class="token string">&#39;delete&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Property &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>key<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot; was deleted. New value: undefined. Previous value: &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>change<span class="token punctuation">.</span>oldValue<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token operator">...</span>
</code></pre></div><p><img src="/blog/_assets/y-map-observe.9f01b136.png" alt="y-map-observe"></p><h4 id="æ›´æ–°åŒæ­¥"><a class="header-anchor" href="#æ›´æ–°åŒæ­¥" aria-hidden="true">#</a> æ›´æ–°åŒæ­¥</h4><p>é€šè¿‡ observe å·²ç»å¯ä»¥ç›‘å¬åˆ° Shared Types çš„å˜åŒ–ï¼Œé‚£ä¹ˆå¦‚ä½•å°†å˜åŒ–åº”ç”¨åˆ°å…¶ä»–å®¢æˆ·ç«¯å‘¢ï¼Ÿ</p><p>é¦–å…ˆï¼Œåä½œç¼–è¾‘æ—¶ä¼ è¾“æ•°æ®å¾ˆé¢‘ç¹ï¼Œå¹¶ä¸”ä¸€èˆ¬æ•°æ®é‡éƒ½æ¯”è¾ƒå¤§ï¼ŒYjs ä¸ºäº†å‡å°‘æ¯æ¬¡ä¼ è¾“æ•°æ®çš„å¤§å°ï¼Œå¯¹<strong>æ•°æ®è¿›è¡ŒäºŒè¿›åˆ¶ç¼–ç </strong>ï¼ˆé«˜åº¦å‹ç¼©ï¼‰åï¼Œé€šè¿‡ <a href="https://docs.yjs.dev/api/document-updates#update-api" target="_blank" rel="noopener noreferrer">Update API</a> ä¸å…¶ä»–æ–‡æ¡£è¿›è¡ŒåŒæ­¥ï¼Œæ‰€æœ‰å®¢æˆ·ç«¯æ”¶åˆ°æ‰€æœ‰æ–‡æ¡£æ›´æ–°åéƒ½ä¼šåŒæ­¥ï¼Œä¸»è¦ä½¿ç”¨ä¸‹é¢ä¸¤ä¸ª API è¿›è¡ŒåŒæ­¥ï¼š</p><ul><li>Y.applyUpdateï¼šå°†å½“å‰æ›´æ–°åº”ç”¨åˆ°ä¸€ä¸ªæ–°å‰¯æœ¬</li><li>Y.encodeStateAsUpdateï¼šç¼–ç æ•´ä¸ªæ–‡æ¡£ä¸ºå•ä¸ªæ›´æ–°æ¶ˆæ¯</li></ul><p>ä¹‹å‰æˆ‘ä»¬æåˆ°äº†å‘ç”Ÿå˜æ›´æ—¶çš„äº‹ä»¶æ‰§è¡Œé¡ºåºï¼ŒShared Types å˜æ›´æ—¶é€šè¿‡ <code>ydoc.on(&#39;update&#39;, )</code> æ¥æ”¶ <code>ytype.observe</code> æ‰€å‘å‡ºçš„å¢é‡æ›´æ–°ï¼Œå°†è®¡ç®—å‡ºçš„å¢é‡æ›´æ–°å‘é€åˆ°æ‰€æœ‰è¿æ¥çš„å®¢æˆ·ç«¯ã€‚</p><p>æˆ‘ä»¬å¯ä»¥åœ¨æœ¬åœ°åŒæ—¶åˆ›å»ºä¸¤ä¸ª YDoc å®ä¾‹æ¥æ¨¡æ‹Ÿ 2 ä¸ªå®¢æˆ·ç«¯ï¼ŒéªŒè¯ä¸€ä¸‹ï¼š</p><div class="language-js"><pre><code><span class="token keyword">const</span> ydoc1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Y<span class="token punctuation">.</span>Doc</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> ydoc2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Y<span class="token punctuation">.</span>Doc</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// åœ¨å…¶ä¸­ä¸€ä»½ YDoc æ›´æ–°æ—¶ï¼Œé€šè¿‡applyUpdateå°†äºŒè¿›åˆ¶æ•°æ®åº”ç”¨åˆ°å…¶ä»– YDoc ä¸Š</span>
ydoc1<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;update&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">update</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token constant">Y</span><span class="token punctuation">.</span><span class="token function">applyUpdate</span><span class="token punctuation">(</span>ydoc2<span class="token punctuation">,</span> update<span class="token punctuation">)</span><span class="token punctuation">)</span>
ydoc2<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;update&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">update</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token constant">Y</span><span class="token punctuation">.</span><span class="token function">applyUpdate</span><span class="token punctuation">(</span>ydoc1<span class="token punctuation">,</span> update<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment">// åˆ›å»ºä¸€ä¸ªé¡¶å±‚åä¸º kun çš„ YMap</span>
<span class="token keyword">const</span> ymap1 <span class="token operator">=</span> ydoc1<span class="token punctuation">.</span><span class="token function">getMap</span><span class="token punctuation">(</span><span class="token string">&#39;kun&#39;</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> ymap2 <span class="token operator">=</span> ydoc2<span class="token punctuation">.</span><span class="token function">getMap</span><span class="token punctuation">(</span><span class="token string">&#39;kun&#39;</span><span class="token punctuation">)</span>
<span class="token comment">// ç›‘å¬å˜åŒ–</span>
ymap1<span class="token punctuation">.</span><span class="token function">observe</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  event<span class="token punctuation">.</span>changes<span class="token punctuation">.</span>keys<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">change<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>change<span class="token punctuation">.</span>action <span class="token operator">===</span> <span class="token string">&#39;add&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">ymap1: Property &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>key<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot; was added. Initial value: &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ymap1<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>
          key
        <span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;.</span><span class="token template-punctuation string">`</span></span>
      <span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>change<span class="token punctuation">.</span>action <span class="token operator">===</span> <span class="token string">&#39;update&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">ymap1: Property &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>key<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot; was updated. New value: &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ymap1<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>
          key
        <span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;. Previous value: &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>change<span class="token punctuation">.</span>oldValue<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;.</span><span class="token template-punctuation string">`</span></span>
      <span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>change<span class="token punctuation">.</span>action <span class="token operator">===</span> <span class="token string">&#39;delete&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">ymap1: Property &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>key<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot; was deleted. New value: undefined. Previous value: &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>change<span class="token punctuation">.</span>oldValue<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;.</span><span class="token template-punctuation string">`</span></span>
      <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
ymap2<span class="token punctuation">.</span><span class="token function">observe</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  event<span class="token punctuation">.</span>changes<span class="token punctuation">.</span>keys<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">change<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>change<span class="token punctuation">.</span>action <span class="token operator">===</span> <span class="token string">&#39;add&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">ymap2: Property &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>key<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot; was added. Initial value: &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ymap2<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>
          key
        <span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;.</span><span class="token template-punctuation string">`</span></span>
      <span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>change<span class="token punctuation">.</span>action <span class="token operator">===</span> <span class="token string">&#39;update&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">ymap2: Property &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>key<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot; was updated. New value: &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ymap2<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>
          key
        <span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;. Previous value: &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>change<span class="token punctuation">.</span>oldValue<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;.</span><span class="token template-punctuation string">`</span></span>
      <span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>change<span class="token punctuation">.</span>action <span class="token operator">===</span> <span class="token string">&#39;delete&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">ymap2: Property &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>key<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot; was deleted. New value: undefined. Previous value: &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>change<span class="token punctuation">.</span>oldValue<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;.</span><span class="token template-punctuation string">`</span></span>
      <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// æ„é€ åµŒå¥—çš„ ymap</span>
<span class="token keyword">const</span> ymapAddress <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Y<span class="token punctuation">.</span>Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
ymapAddress<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&#39;country&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;China&#39;</span><span class="token punctuation">)</span>
ymapAddress<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&#39;city&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;shanghai&#39;</span><span class="token punctuation">)</span>
ymap1<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&#39;address&#39;</span><span class="token punctuation">,</span> ymapAddress<span class="token punctuation">)</span>

<span class="token comment">// æ„é€ åµŒå¥—çš„ yarray</span>
<span class="token keyword">const</span> yarrayLikes <span class="token operator">=</span> <span class="token constant">Y</span><span class="token punctuation">.</span>Array<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&#39;Sing&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;dance&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;rap&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;basketball&#39;</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

ymap1<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&#39;likes&#39;</span><span class="token punctuation">,</span> yarrayLikes<span class="token punctuation">)</span>
ymap1<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&#39;name&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;kunkun&#39;</span><span class="token punctuation">)</span>
ymap1<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&#39;age&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;2.5&#39;</span><span class="token punctuation">)</span>
ymap1<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&#39;age&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;3&#39;</span><span class="token punctuation">)</span>
ymap2<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&#39;age&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;4&#39;</span><span class="token punctuation">)</span>
ymap1<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token string">&#39;age&#39;</span><span class="token punctuation">)</span>
ymap2<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&#39;sex&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;male&#39;</span><span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ymap1<span class="token punctuation">.</span><span class="token function">toJSON</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ymap2<span class="token punctuation">.</span><span class="token function">toJSON</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>è¾“å‡ºç»“æœå¦‚ä¸‹æ‰€ç¤ºï¼Œå¯ä»¥çœ‹åˆ°æœ€ç»ˆæ‰“å°å‡ºçš„ä¸¤ä¸ª yMap çš„ç»“æœä¸€è‡´ï¼š</p><p><img src="/blog/_assets/yjs-event-update.e5fcc570.png" alt="yjs-event-update"></p><p>ä¹Ÿå¯ä»¥é€šè¿‡äº¤æ¢å®Œæ•´æ–‡æ¡£ç»“æ„æ¥åŒæ­¥ä¸¤ä¸ªå®¢æˆ·ç«¯</p><div class="language-js"><pre><code><span class="token operator">...</span>
<span class="token comment">// é€šè¿‡äº¤æ¢å®Œæ•´æ–‡æ¡£ç»“æ„æ¥åŒæ­¥ä¸¤ä¸ªå®¢æˆ·ç«¯</span>
<span class="token keyword">const</span> state1 <span class="token operator">=</span> <span class="token constant">Y</span><span class="token punctuation">.</span><span class="token function">encodeStateAsUpdate</span><span class="token punctuation">(</span>ydoc1<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> state2 <span class="token operator">=</span> <span class="token constant">Y</span><span class="token punctuation">.</span><span class="token function">encodeStateAsUpdate</span><span class="token punctuation">(</span>ydoc2<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token constant">Y</span><span class="token punctuation">.</span><span class="token function">applyUpdate</span><span class="token punctuation">(</span>ydoc1<span class="token punctuation">,</span> state2<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token constant">Y</span><span class="token punctuation">.</span><span class="token function">applyUpdate</span><span class="token punctuation">(</span>ydoc2<span class="token punctuation">,</span> state1<span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ymap1<span class="token punctuation">.</span><span class="token function">toJSON</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ymap2<span class="token punctuation">.</span><span class="token function">toJSON</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><h4 id="å®ç°-quill-ååŒç¼–è¾‘"><a class="header-anchor" href="#å®ç°-quill-ååŒç¼–è¾‘" aria-hidden="true">#</a> å®ç° Quill ååŒç¼–è¾‘</h4><p>é€šè¿‡ä»¥ä¸Šçš„å†…å®¹ï¼Œæˆ‘ä»¬å¯ä»¥ä¸éœ€è¦ y-quillï¼Œè‡ªå·±å®ç°ç»‘å®šå±‚ï¼š</p><ol><li>åˆ›å»º ydocã€ytextã€quill å®ä¾‹</li><li>ç›‘å¬ Quill çš„<code>text-change</code> äº‹ä»¶ï¼Œæ‹¿åˆ° Delta æ•°æ®<code>delta.ops</code></li><li>åœ¨ <code>transact</code> äº‹ç‰©ä¸­ï¼Œä½¿ç”¨ <code>ytext.applyDelta</code> å°† Delta æ•°æ®åº”ç”¨äº ytext å®ä¾‹</li><li>é€šè¿‡ <code>observe</code> ç›‘å¬å˜åŒ–ï¼Œæ­¤å¤„éœ€è¦è¿‡æ»¤å½“å‰äº‹åŠ¡</li><li>ä½¿ç”¨ <code>updateContents</code> æ›´æ–° Quill æ•°æ®</li></ol><p>å®Œæ•´ä»£ç å¦‚ä¸‹ï¼š</p><div class="language-js"><pre><code><span class="token comment">// æ¨¡æ‹Ÿç¼–è¾‘å™¨ç»‘å®š</span>
quill<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;text-change&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">delta<span class="token punctuation">,</span> content<span class="token punctuation">,</span> source</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// è¿‡æ»¤éç”¨æˆ·è¾“å…¥çš„äº‹ä»¶</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>source <span class="token operator">===</span> <span class="token string">&#39;api&#39;</span><span class="token punctuation">)</span> <span class="token keyword">return</span>
  ydoc<span class="token punctuation">.</span><span class="token function">transact</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> ytext<span class="token punctuation">.</span><span class="token function">applyDelta</span><span class="token punctuation">(</span>delta<span class="token punctuation">.</span>ops<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
ytext<span class="token punctuation">.</span><span class="token function">observe</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">event<span class="token punctuation">,</span> origin</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// æœ¬åœ°çš„å˜åŒ–ä¸ä¼šå¼•èµ·quillæ›´æ–°</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>origin<span class="token punctuation">.</span>local<span class="token punctuation">)</span> <span class="token keyword">return</span>
  quill<span class="token punctuation">.</span><span class="token function">updateContents</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>delta<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>åŒæ ·ä¹Ÿèƒ½å®ç°ååŒç¼–è¾‘æ•ˆæœã€‚</p><h4 id="å°ç»“-2"><a class="header-anchor" href="#å°ç»“-2" aria-hidden="true">#</a> å°ç»“</h4><p>è¿™ä¸€å¥—ç»„åˆ API çœ‹ä¼¼å’Œæˆ‘ä»¬å¸¸ç”¨çš„ mapã€array ç­‰ç›¸ä¼¼ï¼Œä½†å®ƒçœŸæ­£çš„å¼ºå¤§ä¹‹å¤„åœ¨äº <code>Conflict-free</code>ï¼Œåœ¨å®ƒçš„å†…éƒ¨å°±å·²ç»åŒ…å«äº†<strong>å†²çªè§£å†³</strong>çš„æœºåˆ¶ã€‚å¯¹ä½¿ç”¨è€…æ¥è¯´ï¼Œæˆ‘ä»¬åªæ˜¯ç®€å•çš„ä½¿ç”¨ Shared Types æ‰€æä¾›çš„ APIï¼ŒååŒç¼–è¾‘æ—¶æ‰€å­˜åœ¨çš„çŠ¶æ€å†²çªä¼šè¢« Yjs è‡ªåŠ¨è§£å†³ã€‚</p><p>é€šå¸¸åœ¨ä»£ç ä¸­ä½¿ç”¨æ•°ç»„æˆ–å¯¹è±¡è¡¨ç¤ºåº”ç”¨çš„çŠ¶æ€ï¼Œç°åœ¨åªéœ€å¢åŠ ä¸€ä¸ªç®€å•çš„ Binding å±‚ï¼Œå°†å…¶è½¬åŒ–ä¸º Yjs çš„ Shared Typesï¼Œç±»ä¼¼äº Quill çš„ y-quillï¼Œåº”ç”¨å°±èƒ½å¤Ÿè‡ªç„¶åœ°è·å¾—å¤šäººç¼–è¾‘çš„èƒ½åŠ›ã€‚</p><h3 id="providers"><a class="header-anchor" href="#providers" aria-hidden="true">#</a> Providers</h3><h4 id="connection-providers"><a class="header-anchor" href="#connection-providers" aria-hidden="true">#</a> Connection Providers</h4><p>é€šè¿‡ä¸Šä¸€èŠ‚ï¼Œæˆ‘ä»¬å°† JSON æ•°æ®è½¬æ¢æˆäº† Shared Types çš„ yMapï¼Œä½¿å®ƒæœ‰äº†è‡ªåŠ¨è§£å†³å†²çªçš„èƒ½åŠ›ï¼Œå¹¶ä¸”åœ¨æœ¬åœ°æ¨¡æ‹Ÿäº†ä¸åŒå®¢æˆ·ç«¯çš„æ•°æ®åŒæ­¥ï¼Œè€Œä¸ºäº†èƒ½å¤Ÿåœ¨ä¸åŒçš„å®¢æˆ·ç«¯ä¹‹é—´åŒæ­¥å…±äº«æ•°æ®ï¼Œå°±éœ€è¦é€šè¿‡ç½‘ç»œé€šä¿¡æ¥å®Œæˆã€‚</p><p><strong>CRDT æœ¬èº«å’Œç½‘ç»œæ˜¯è§£è€¦</strong>çš„ï¼Œæˆ‘ä»¬å¯ä»¥é€‰æ‹©ä»»æ„çš„é€šä¿¡æ–¹æ¡ˆï¼Œåªè¦èƒ½ä¿è¯æ›´æ–°æ•°æ®æˆåŠŸçš„åŒæ­¥åˆ°è¿œç«¯å³å¯ã€‚</p><p>Yjs è‡ªèº«æä¾›äº† <a href="https://docs.yjs.dev/ecosystem/connection-provider" target="_blank" rel="noopener noreferrer">Connection Provider</a> æ¥å®ç°ä¸åŒå®¢æˆ·ç«¯ä¹‹é—´çš„é€šä¿¡ï¼Œå¦‚ï¼šy-websocketã€y-webrtcã€y-dat ç­‰ã€‚</p><p>websocket å’Œ webrtc ï¼ˆè¯·é˜…è¯» <a href="https://juejin.cn/post/7266417942182608955" target="_blank" rel="noopener noreferrer">WebRTC è¿™ä¹ˆç« ğŸ”¥ï¼Œå‰ç«¯é“ä»”ï¼Œè¯·æ”¶ä¸‹è¿™ç¯‡å…¥é—¨æ•™ç¨‹</a>ï¼‰å¤§å®¶åº”è¯¥éƒ½æœ‰æ‰€äº†è§£ï¼Œ<a href="https://docs.dat.foundation/docs/intro" target="_blank" rel="noopener noreferrer">Dat</a> æ˜¯ä¸€ä¸ª P2P åè®®ï¼Œæ˜¯ä¸€ä¸ªå»ä¸­å¿ƒåŒ–ã€å®‰å…¨ã€å¿«é€Ÿçš„æ–‡ä»¶ä¼ è¾“åè®®ï¼Œé€‚ç”¨äºå„ç§éœ€è¦ä¼ è¾“æ–‡ä»¶çš„æƒ…å†µã€‚</p><p>è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ y-websocket æ¥å®ç°æœåŠ¡ç«¯ä¸å„å®¢æˆ·ç«¯ä¹‹é—´çš„æ–‡æ¡£åŒæ­¥ã€‚</p><p>y-websocket æ”¯æŒ <code>cross-tab communication</code>ï¼šå³å½“åœ¨åŒä¸€æµè§ˆå™¨çš„ä¸åŒé¡µç­¾æ‰“å¼€åŒä¸€æ–‡æ¡£æ—¶ï¼Œæ–‡æ¡£ä¸Šçš„æ›´æ”¹å°†é€šè¿‡<strong>è·¨é€‰é¡¹å¡é€šä¿¡</strong>è¿›è¡Œäº¤æ¢ï¼ˆ<a href="https://developer.mozilla.org/en-US/docs/Web/API/Broadcast_Channel_API" target="_blank" rel="noopener noreferrer">Broadcast Channel</a>å’Œ localStorageï¼‰ã€‚</p><p>æˆ‘ä»¬ä»¥ ytext ä¸ºä¾‹æ¥çœ‹ä¸‹ï¼š</p><div class="language-js"><pre><code><span class="token keyword">const</span> ydoc <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Y<span class="token punctuation">.</span>Doc</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> wsProvider <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebsocketProvider</span><span class="token punctuation">(</span>
  <span class="token string">&#39;ws://localhost:1234&#39;</span><span class="token punctuation">,</span>
  <span class="token string">&#39;my-room-name&#39;</span><span class="token punctuation">,</span>
  ydoc
<span class="token punctuation">)</span>

wsProvider<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;status&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>status<span class="token punctuation">)</span> <span class="token comment">// logs &quot;connected&quot; or &quot;disconnected&quot;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> yText <span class="token operator">=</span> ydoc<span class="token punctuation">.</span><span class="token function">getText</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// åœ¨æŸä»½ YDoc æ›´æ–°æ—¶ï¼Œåº”ç”¨äºŒè¿›åˆ¶çš„ update æ•°æ®åˆ°å¦ä¸€ä»½ YDoc ä¸Š</span>
ydoc<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;update&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">update<span class="token punctuation">,</span> origin</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token constant">Y</span><span class="token punctuation">.</span><span class="token function">applyUpdate</span><span class="token punctuation">(</span>ydoc<span class="token punctuation">,</span> update<span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>yText<span class="token punctuation">.</span><span class="token function">toJSON</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  div<span class="token punctuation">.</span>innerText <span class="token operator">=</span> yText<span class="token punctuation">.</span><span class="token function">toJSON</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> button <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&#39;button&#39;</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> div <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&#39;div&#39;</span><span class="token punctuation">)</span>
button<span class="token punctuation">.</span>innerText <span class="token operator">=</span> <span class="token string">&#39;click&#39;</span>
document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&#39;#app&#39;</span><span class="token punctuation">)</span><span class="token operator">?.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>button<span class="token punctuation">)</span>
document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&#39;#app&#39;</span><span class="token punctuation">)</span><span class="token operator">?.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>div<span class="token punctuation">)</span>

button<span class="token punctuation">.</span><span class="token function-variable function">onclick</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> yText<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">)</span>
</code></pre></div><p>é¦–å…ˆæŒ‰ç…§æˆ‘ä»¬ä¹‹å‰è¯´çš„ <code>PORT=1234 npx y-websocket</code> å¯åŠ¨ websocket æœåŠ¡</p><p>å½“ç‚¹å‡» click æ—¶ï¼Œåœ¨æœ€å‰é¢æ’å…¥ä¸€ä¸ªæ•°å­—ï¼Œæ•ˆæœå¦‚ä¸‹ï¼š</p><p><img src="/blog/_assets/yjs-ytext-socket.cca944c4.gif" alt="yjs-ytext-socket"></p><p>å…¶å®å¯ä»¥çœ‹ä¸‹<a href="https://github1s.com/yjs/y-websocket/blob/HEAD/bin/server.js" target="_blank" rel="noopener noreferrer">y-websocket</a>çš„æºç ï¼Œä¸»è¦æœ‰ä»¥ä¸‹å‡ ä¸ªè¿‡ç¨‹ï¼š</p><ol><li><p>åˆ›å»º Websocket è¿æ¥</p><p>åœ¨ <code>/bin/server.js</code> ä¸­ï¼Œé€šè¿‡ <code>ws</code> å¯åŠ¨ä¸€ä¸ª socket æœåŠ¡ï¼ŒæœåŠ¡ç«¯åªéœ€è¦æä¾›åŸºç¡€çš„æ¶ˆæ¯è½¬å‘èƒ½åŠ›å³å¯</p><div class="language-js"><pre><code><span class="token keyword">const</span> WebSocket <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;ws&#39;</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;http&#39;</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> wss <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebSocket<span class="token punctuation">.</span>Server</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">noServer</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div></li><li><p>åˆå§‹åŒ– Yjs å®ä¾‹</p><p>åœ¨ <code>/bin/utils.js</code> ä¸­ï¼Œé€šè¿‡ <code>WSSharedDoc</code> åˆ›å»ºä¸€ä¸ª Yjs å®ä¾‹</p><div class="language-js"><pre><code>
 <span class="token keyword">class</span> <span class="token class-name">WSSharedDoc</span> <span class="token keyword">extends</span> <span class="token class-name">Y<span class="token punctuation">.</span>Doc</span> <span class="token punctuation">{</span>
   <span class="token operator">...</span>
   <span class="token keyword">this</span><span class="token punctuation">.</span>conns <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
   <span class="token operator">...</span>
   <span class="token keyword">this</span><span class="token punctuation">.</span>awareness<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;update&#39;</span><span class="token punctuation">,</span> awarenessChangeHandler<span class="token punctuation">)</span>
   <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;update&#39;</span><span class="token punctuation">,</span> updateHandler<span class="token punctuation">)</span>
   <span class="token operator">...</span>
 <span class="token punctuation">}</span>
</code></pre></div><p><code>this.conns</code> ç¼“å­˜æ‰€æœ‰çš„è¿æ¥å®¢æˆ·ç«¯ <code>this.on(&#39;update&#39;, updateHandler)</code> ç”¨æ¥ç›‘å¬ ydoc æ–‡æ¡£çš„æ›´æ–°</p><div class="language-js"><pre><code><span class="token keyword">const</span> <span class="token function-variable function">updateHandler</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">update<span class="token punctuation">,</span> origin<span class="token punctuation">,</span> doc</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
<span class="token operator">...</span>
doc<span class="token punctuation">.</span>conns<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">_<span class="token punctuation">,</span> conn</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">send</span><span class="token punctuation">(</span>doc<span class="token punctuation">,</span> conn<span class="token punctuation">,</span> message<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>åœ¨ <code>updateHandler</code> ä¸­å°†æ–‡æ¡£çš„æ›´æ–°å‘é€åˆ°æ¯ä¸€ä¸ªå®¢æˆ·ç«¯ã€‚</p></li><li><p>å®¢æˆ·ç«¯ä½¿ç”¨ <code>WebsocketProvider</code> è¿æ¥æœåŠ¡ç«¯</p><p>é¦–å…ˆéœ€è¦äº†è§£ä¸‹ <a href="https://docs.yjs.dev/api/document-updates#example-building-a-custom-provider" target="_blank" rel="noopener noreferrer">è‡ªå®šä¹‰ Provider</a></p><p>åœ¨ <code>/src/y-websocket.js</code> ä¸­ï¼Œ<code>WebsocketProvider</code> ç»§æ‰¿ <code>lib0/observable</code> çš„ <code>Observable</code>æ¥è‡ªå®šä¹‰ Providerï¼Œä¸æœåŠ¡ç«¯å»ºç«‹è¿æ¥</p></li><li><p>å¤„ç†æ–‡æ¡£æ›´æ–°</p><p>ä¸€æ—¦å»ºç«‹äº† WebSocket è¿æ¥ï¼ŒY-Websocket å¼€å§‹åŒæ­¥æ–‡æ¡£çŠ¶æ€ã€‚è¿™æ¶‰åŠå°†å®¢æˆ·ç«¯çš„æœ¬åœ°æ–‡æ¡£çŠ¶æ€å‘é€åˆ°æœåŠ¡å™¨ï¼Œç„¶åæœåŠ¡å™¨å†å°†å…¶ä»–å®¢æˆ·ç«¯çš„ç¼–è¾‘æ“ä½œä¼ é€’ç»™å½“å‰å®¢æˆ·ç«¯ã€‚</p><div class="language-js"><pre><code><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function-variable function">_updateHandler</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">update<span class="token punctuation">,</span> origin</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>origin <span class="token operator">!==</span> <span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> encoder <span class="token operator">=</span> encoding<span class="token punctuation">.</span><span class="token function">createEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    encoding<span class="token punctuation">.</span><span class="token function">writeVarUint</span><span class="token punctuation">(</span>encoder<span class="token punctuation">,</span> messageSync<span class="token punctuation">)</span>
    syncProtocol<span class="token punctuation">.</span><span class="token function">writeUpdate</span><span class="token punctuation">(</span>encoder<span class="token punctuation">,</span> update<span class="token punctuation">)</span>
    <span class="token function">broadcastMessage</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> encoding<span class="token punctuation">.</span><span class="token function">toUint8Array</span><span class="token punctuation">(</span>encoder<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>doc<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;update&#39;</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_updateHandler<span class="token punctuation">)</span>
</code></pre></div><p>åœ¨ <code>WebsocketProvider</code> çš„æ„é€ å‡½æ•°ä¸­ä½¿ç”¨<code>this.doc.on(&#39;update&#39;)</code>ç›‘å¬ ydoc æ–‡æ¡£çš„æ›´æ–°ï¼Œç„¶åé€šè¿‡ <code>broadcastMessage</code> å¹¿æ’­äº‹ä»¶ï¼Œè¿™é‡Œåˆ¤æ–­ <code>origin !== this</code> æ„æ€åªæœ‰å…¶ä»–å®¢æˆ·ç«¯çš„æ›´æ–°æ‰ä¼šè§¦å‘ <code>syncProtocol.writeUpdate</code> æ–¹æ³•ï¼ˆé¿å…æ— é™å¾ªç¯æ›´æ–°ï¼‰ã€‚</p><p>è¿™ä¸ªæ–¹æ³•æ¥è‡ªäº <a href="https://github1s.com/yjs/y-protocols/blob/HEAD/sync.js#L114" target="_blank" rel="noopener noreferrer">y-protocols</a>ï¼Œæœ€ç»ˆä¼šè°ƒç”¨ <code>readSyncStep2</code> é€šè¿‡ <code>applyUpdate</code> æ¥æ›´æ–°æ–‡æ¡£ã€‚</p><div class="language-js"><pre><code><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">readSyncStep2</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">decoder<span class="token punctuation">,</span> doc<span class="token punctuation">,</span> transactionOrigin</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token constant">Y</span><span class="token punctuation">.</span><span class="token function">applyUpdate</span><span class="token punctuation">(</span>
      doc<span class="token punctuation">,</span>
      decoding<span class="token punctuation">.</span><span class="token function">readVarUint8Array</span><span class="token punctuation">(</span>decoder<span class="token punctuation">)</span><span class="token punctuation">,</span>
      transactionOrigin
    <span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// This catches errors that are thrown by event handlers</span>
    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&#39;Caught error while handling a Yjs update&#39;</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>broadcastMessage</code> ä¹Ÿå¾ˆæœ‰ç‰¹ç‚¹ï¼Œå½“ websocket è¿æ¥å¤±è´¥æ—¶ï¼Œä¼šé€šè¿‡ <code>broadcastchannel</code> æ¥å®ç°åŒä¸€æµè§ˆå™¨ä¸åŒé¡µç­¾ä¹‹é—´çš„ååŒã€‚</p><div class="language-js"><pre><code><span class="token keyword">const</span> <span class="token function-variable function">broadcastMessage</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">provider<span class="token punctuation">,</span> buf</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> ws <span class="token operator">=</span> provider<span class="token punctuation">.</span>ws
  <span class="token keyword">if</span> <span class="token punctuation">(</span>provider<span class="token punctuation">.</span>wsconnected <span class="token operator">&amp;&amp;</span> ws <span class="token operator">&amp;&amp;</span> ws<span class="token punctuation">.</span>readyState <span class="token operator">===</span> ws<span class="token punctuation">.</span><span class="token constant">OPEN</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ws<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>provider<span class="token punctuation">.</span>bcconnected<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    bc<span class="token punctuation">.</span><span class="token function">publish</span><span class="token punctuation">(</span>provider<span class="token punctuation">.</span>bcChannel<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> provider<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ol><p>ä»¥ä¸Šå°±æ˜¯ y-websocket çš„å¤§è‡´æµç¨‹ï¼Œå…¶å®ä¹Ÿä¸æ˜¯å¾ˆå¤æ‚ï¼Œæˆ‘ä»¬å¯ä»¥ä¿®æ”¹å®ƒæ¥åšä¸€äº›å®šåˆ¶åŒ–çš„å¼€å‘ï¼Œè¦æƒ³æ›´åŠ è¯¦ç»†çš„äº†è§£ Yjs çš„åŒæ­¥è¿‡ç¨‹ï¼Œå¯ä»¥æŸ¥çœ‹<a href="https://medium.com/dovetail-engineering/yjs-fundamentals-part-2-sync-awareness-73b8fabc2233" target="_blank" rel="noopener noreferrer">Yjs Fundamentals â€” Part 2: Sync &amp; Awareness</a>è¿™ç¯‡æ–‡ç« ã€‚</p><h4 id="database-provider"><a class="header-anchor" href="#database-provider" aria-hidden="true">#</a> Database Provider</h4><p>YJs ä¸ä»…æä¾›äº† Connection Provider æ¥å®ç°å®¢æˆ·ç«¯çš„åä½œï¼Œå¹¶ä¸”æä¾›äº† Database Provider å°†æ–‡æ¡£æ•°æ®åŒæ­¥åˆ°æŒä¹…åŒ–å±‚æˆ–ç¦»çº¿å­˜å‚¨å±‚ï¼šå¦‚ y-indexeddbã€y-redis ç­‰ã€‚</p><div class="language-bash"><pre><code><span class="token function">yarn</span> <span class="token function">add</span> y-redis
</code></pre></div><div class="language-js"><pre><code><span class="token keyword">const</span> <span class="token punctuation">{</span> RedisPersistence <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;y-redis&#39;</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> redisConfig <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">host</span><span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">REDIS_HOST</span><span class="token punctuation">,</span>
  <span class="token literal-property property">port</span><span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">REDIS_PORT</span><span class="token punctuation">,</span>
  <span class="token literal-property property">password</span><span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">REDIS_PASSWORD</span><span class="token punctuation">,</span>
  <span class="token literal-property property">db</span><span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">REDIS_DB</span><span class="token punctuation">,</span>
  <span class="token literal-property property">keyPrefix</span><span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">REDIS_KEY_PREFIIX</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> rp <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RedisPersistence</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">redisOpts</span><span class="token operator">:</span> redisConfig <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> persistence <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">provider</span><span class="token operator">:</span> rp<span class="token punctuation">,</span>
  <span class="token function-variable function">bindState</span><span class="token operator">:</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">docName<span class="token punctuation">,</span> ydoc</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    rp<span class="token punctuation">.</span><span class="token function">closeDoc</span><span class="token punctuation">(</span>docName<span class="token punctuation">)</span>
    <span class="token keyword">return</span> rp<span class="token punctuation">.</span><span class="token function">bindState</span><span class="token punctuation">(</span>docName<span class="token punctuation">,</span> ydoc<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function-variable function">writeState</span><span class="token operator">:</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">docName<span class="token punctuation">,</span> ydoc</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="awareness-presence"><a class="header-anchor" href="#awareness-presence" aria-hidden="true">#</a> Awareness &amp; Presence</h3><p>ä¸Šä¸€èŠ‚æˆ‘ä»¬é€šè¿‡ Connect Provider å®ç°äº†ä¸åŒå®¢æˆ·ç«¯ä¹‹é—´çš„åä½œï¼Œä½†ååŒç¼–è¾‘ä¸ä»…ä»…æ˜¯æ•°æ®çš„åŒæ­¥ï¼Œè¿˜éœ€è¦ä¸€äº›äº¤äº’ä¸Šçš„ä¼˜åŒ–ï¼Œè¯¸å¦‚ï¼š<strong>å½“å‰åœ¨çº¿ç”¨æˆ·åˆ—è¡¨ã€ç”¨æˆ·ç¼–è¾‘ä½ç½®ä»¥åŠå…‰æ ‡ä½ç½®</strong>ï¼Œè¿™äº›ä¿¡æ¯è¢«ç§°ä¸º <code>Awareness</code>ã€‚</p><p>é€šå¸¸è¿™äº›ä¿¡æ¯æ•°æ®é‡è¾ƒå°‘ï¼Œå› æ­¤ Yjs å†…éƒ¨é‡‡ç”¨äº† <code>state-based Awareness CRDT</code> å°†ä¿¡æ¯è½¬ä¸º JSON å¯¹è±¡ä¼ æ’­ç»™æ‰€æœ‰ç”¨æˆ·ã€‚ä½†å®ƒå¹¶ä¸æ˜¯ Yjs æ¨¡å—ï¼Œå®ƒæ˜¯åœ¨ <a href="https://github.com/yjs/y-protocols" target="_blank" rel="noopener noreferrer">y-protocols</a> å†…éƒ¨å®šä¹‰çš„ï¼Œæ‰€æœ‰çš„ Providers éƒ½é»˜è®¤å®ç°äº†ï¼Œå¹¶ä¸”æä¾›äº†<a href="https://docs.yjs.dev/api/about-awareness#awareness-crdt" target="_blank" rel="noopener noreferrer">Awareness CRDT API</a> å¸®åŠ©æˆ‘ä»¬è·å– Awareness çš„å˜åŒ–å’Œæ›´æ–°ç­‰çŠ¶æ€ã€‚</p><h4 id="awareness-new-awarenessprotocol-awareness-ydoc-y-doc"><a class="header-anchor" href="#awareness-new-awarenessprotocol-awareness-ydoc-y-doc" aria-hidden="true">#</a> awareness = new awarenessProtocol.Awareness(ydoc: Y.Doc)</h4><p>åˆ›å»º awareness å®ä¾‹ï¼Œåœ¨ Provider ä¸­æˆ‘ä»¬å¯ä»¥é€šè¿‡ä»¥ä¸‹ä»£ç è·å–åˆ° awareness</p><div class="language-js"><pre><code>awareness <span class="token operator">=</span> provider<span class="token punctuation">.</span>awareness
</code></pre></div><p>å®ƒæ˜¯åœ¨ Provider å†…éƒ¨åˆ›å»ºå’Œç»´æŠ¤</p><h4 id="awareness-setlocalstatefield-string-any"><a class="header-anchor" href="#awareness-setlocalstatefield-string-any" aria-hidden="true">#</a> awareness.setLocalStateField(string, any)</h4><p>ä¸ºæœ¬åœ° awareness è®¾ç½®æˆ–æ›´æ–°é”®å€¼å¯¹ã€‚</p><h4 id="awareness-getstates-map-string-object-string-any"><a class="header-anchor" href="#awareness-getstates-map-string-object-string-any" aria-hidden="true">#</a> awareness.getStates(): Map&lt;string, Object&lt;string, any&gt;&gt;</h4><p>è·å–æ‰€æœ‰ awarenessï¼ˆè¿œç¨‹å’Œæœ¬åœ°ï¼‰</p><h4 id="awareness-on-update-added-array-updated-array-removed-array-transactionorigin-any"><a class="header-anchor" href="#awareness-on-update-added-array-updated-array-removed-array-transactionorigin-any" aria-hidden="true">#</a> awareness.on(&#39;update&#39;, ({ added: Array, updated: Array, removed: Array }, [transactionOrigin:any]) =&gt; ..)</h4><p>ç›‘å¬è¿œç¨‹å’Œæœ¬åœ°æ„è¯†å˜åŒ–ã€‚å³ä½¿æ„ŸçŸ¥çŠ¶æ€æœªæ›´æ”¹ï¼Œä½†ä»…æ›´æ–°ä»¥é€šçŸ¥å…¶ä»–ç”¨æˆ·è¯¥å®¢æˆ·ç«¯ä»å¤„äºåœ¨çº¿çŠ¶æ€ï¼Œä¹Ÿä¼šè°ƒç”¨æ­¤äº‹ä»¶ã€‚å¦‚æœæ‚¨æƒ³è¦å°†æ„ŸçŸ¥çŠ¶æ€ä¼ æ’­ç»™å…¶ä»–ç”¨æˆ·ï¼Œè¯·ä½¿ç”¨æ­¤äº‹ä»¶ã€‚</p><h4 id="awareness-on-change-added-array-updated-array-removed-array-transactionorigin-any"><a class="header-anchor" href="#awareness-on-change-added-array-updated-array-removed-array-transactionorigin-any" aria-hidden="true">#</a> awareness.on(&#39;change&#39;, ({ added: Array, updated: Array, removed: Array }, [transactionOrigin:any]) =&gt; ..)</h4><p>ç›‘å¬è¿œç¨‹å’Œæœ¬åœ°çŠ¶æ€å˜åŒ– â€‹â€‹ã€‚å½“æ·»åŠ ã€æ›´æ–°æˆ–åˆ é™¤çŠ¶æ€æ—¶æ”¶åˆ°é€šçŸ¥ã€‚</p><p>æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼Œåœ¨ä¹‹å‰çš„ Quill ååŒç¼–è¾‘æ–‡æ¡£ä¸­å±•ç¤ºå½“å‰ç¼–è¾‘çš„äººåï¼š</p><div class="language-js"><pre><code><span class="token comment">// ä»wsProviderè·å–awareness</span>
<span class="token keyword">const</span> awareness <span class="token operator">=</span> wsProvider<span class="token punctuation">.</span>awareness

<span class="token comment">// ç›‘å¬awarenesså˜åŒ–</span>
awareness<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;change&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">changes</span><span class="token operator">:</span> <span class="token constant">Y</span><span class="token punctuation">.</span>Transaction</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// è·å–æ‰€æœ‰ååŒä¿¡æ¯ æ˜¾ç¤ºå…‰æ ‡ä½ç½®å’Œç”¨æˆ·åˆ—è¡¨</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>awareness<span class="token punctuation">.</span><span class="token function">getStates</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// è®¾ç½®userå­—æ®µä¼ é€’ç”¨æˆ·ä¿¡æ¯ { name: &#39;&#39;, color: &#39;&#39; }</span>
<span class="token comment">// å¦‚æœæœªæŒ‡å®šuserå­—æ®µï¼ŒProviderä¼šä½¿ç”¨éšæœºç”¨æˆ·åä»¥é»˜è®¤é¢œè‰²å‘ˆç°å…‰æ ‡ã€‚</span>
awareness<span class="token punctuation">.</span><span class="token function">setLocalStateField</span><span class="token punctuation">(</span><span class="token string">&#39;user&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&#39;Emmanuelle Charpentier&#39;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">color</span><span class="token operator">:</span> <span class="token string">&#39;#ffb61e&#39;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p><img src="/blog/_assets/yjs-awareness-demo.7988182a.png" alt="yjs-awareness-demo"></p><h4 id="awareness-protocol"><a class="header-anchor" href="#awareness-protocol" aria-hidden="true">#</a> Awareness Protocol</h4><p>å¦‚æœè‡ªå®šä¹‰ Provider æ—¶ï¼Œåˆ™éœ€è¦äº†è§£ <a href="https://docs.yjs.dev/api/about-awareness#awareness-protocol-api" target="_blank" rel="noopener noreferrer">Awareness Protocol API</a> ä¸º Provider æ·»åŠ  Awarenessã€‚</p><h5 id="awarenessprotocol-encodeawarenessupdate-uint8array"><a class="header-anchor" href="#awarenessprotocol-encodeawarenessupdate-uint8array" aria-hidden="true">#</a> awarenessProtocol.encodeAwarenessUpdate: Uint8Array</h5><p>å°†æŒ‡å®šå®¢æˆ·ç«¯çš„æ„ŸçŸ¥çŠ¶æ€ç¼–ç ä¸º Uint8Array ç¼–ç çš„æ›´æ–°ã€‚</p><h5 id="awarenessprotocol-applyawarenessupdate-awareness-awareness-update-uint8array-origin-any"><a class="header-anchor" href="#awarenessprotocol-applyawarenessupdate-awareness-awareness-update-uint8array-origin-any" aria-hidden="true">#</a> awarenessProtocol.applyAwarenessUpdate(awareness: Awareness, update: Uint8array, origin: any)</h5><p>å°†ä½¿ç”¨ encodeAwarenessUpdate åˆ›å»ºçš„æ„ŸçŸ¥æ›´æ–°åº”ç”¨åˆ°æ„ŸçŸ¥ CRDT çš„å®ä¾‹ã€‚</p><h5 id="awarenessprotocol-removeawarenessstates-origin-any"><a class="header-anchor" href="#awarenessprotocol-removeawarenessstates-origin-any" aria-hidden="true">#</a> awarenessProtocol.removeAwarenessStates, origin: any)</h5><p>åˆ é™¤æŒ‡å®šå®¢æˆ·ç«¯çš„æ„ŸçŸ¥çŠ¶æ€ã€‚è¿™å°†è°ƒç”¨ Awareness CRDT çš„æ›´æ–°å’Œæ›´æ”¹äº‹ä»¶å¤„ç†ç¨‹åºã€‚</p><p>Awareness CRDT æ›´æ–°çš„å·¥ä½œæ–¹å¼ä¸ Yjs æ›´æ–°ç±»ä¼¼ï¼Œä¹‹å‰æˆ‘ä»¬å†è®² y-websocket çš„æµç¨‹æ—¶æ¼æ‰äº† Awarenessï¼Œç°åœ¨æˆ‘ä»¬å¯ä»¥å†è¿‡ä¸€é y-websocket æºç ï¼š</p><ol><li><p>åˆ›å»º Websocket è¿æ¥</p></li><li><p>åˆå§‹åŒ– Yjs å®ä¾‹</p><p>è¿™ä¸€æ­¥åŒæ—¶åˆ›å»º <code>awareness</code> å®ä¾‹</p><div class="language-js"><pre><code><span class="token keyword">this</span><span class="token punctuation">.</span>awareness <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">awarenessProtocol<span class="token punctuation">.</span>Awareness</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>awareness<span class="token punctuation">.</span><span class="token function">setLocalState</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>
</code></pre></div><p>é€šè¿‡ <code>awareness.on(&#39;update&#39;</code> ç›‘å¬æœ¬åœ°çŠ¶æ€å˜åŒ–ï¼Œé€šè¿‡ <code>awarenessProtocol.encodeAwarenessUpdate</code> ç¼–ç ä¸º Uint8Array æ•°æ®åŒ…ï¼Œå‘é€åˆ°æ¯ä¸€ä¸ªå®¢æˆ·ç«¯</p><div class="language-js"><pre><code><span class="token keyword">const</span> <span class="token function-variable function">awarenessChangeHandler</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> added<span class="token punctuation">,</span> updated<span class="token punctuation">,</span> removed <span class="token punctuation">}</span><span class="token punctuation">,</span> conn</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
 <span class="token operator">...</span>
 encoding<span class="token punctuation">.</span><span class="token function">writeVarUint8Array</span><span class="token punctuation">(</span>encoder<span class="token punctuation">,</span> awarenessProtocol<span class="token punctuation">.</span><span class="token function">encodeAwarenessUpdate</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>awareness<span class="token punctuation">,</span> changedClients<span class="token punctuation">)</span><span class="token punctuation">)</span>
 <span class="token keyword">const</span> buff <span class="token operator">=</span> encoding<span class="token punctuation">.</span><span class="token function">toUint8Array</span><span class="token punctuation">(</span>encoder<span class="token punctuation">)</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>conns<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">_<span class="token punctuation">,</span> c</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">send</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> c<span class="token punctuation">,</span> buff<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>awareness<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;update&#39;</span><span class="token punctuation">,</span> awarenessChangeHandler<span class="token punctuation">)</span>
</code></pre></div></li><li><p>å®¢æˆ·ç«¯ä½¿ç”¨ <code>WebsocketProvider</code> è¿æ¥æœåŠ¡ç«¯</p></li><li><p>å¤„ç†æ–‡æ¡£æ›´æ–°</p><p>åœ¨å¤„ç†æ–‡æ¡£æ›´æ–°çš„åŒæ—¶ï¼Œå¤„ç†æ„ŸçŸ¥æ•°æ®çš„æ›´æ–°ï¼Œå‘é€æ¶ˆæ¯æ–¹å¼ä¸æ–‡æ¡£æ›´æ–°çš„ä¸€è‡´ï¼Œè¿™é‡Œä¸å†èµ˜è¿°</p><div class="language-js"><pre><code><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function-variable function">_awarenessUpdateHandler</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> added<span class="token punctuation">,</span> updated<span class="token punctuation">,</span> removed <span class="token punctuation">}</span><span class="token punctuation">,</span> _origin</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
 <span class="token operator">...</span>
 <span class="token function">broadcastMessage</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> encoding<span class="token punctuation">.</span><span class="token function">toUint8Array</span><span class="token punctuation">(</span>encoder<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
awareness<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;update&#39;</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_awarenessUpdateHandler<span class="token punctuation">)</span>
</code></pre></div></li><li><p>æ–­å¼€è¿æ¥</p><p>å½“æŸä¸ªå®¢æˆ·ç«¯æ–­å¼€è¿æ¥æ—¶ï¼Œé€šè¿‡ <code>awarenessProtocol.removeAwarenessStates</code> åˆ é™¤å®ƒçš„æ„ŸçŸ¥çŠ¶æ€ï¼Œ</p><div class="language-js"><pre><code><span class="token keyword">const</span> <span class="token function-variable function">closeConn</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">doc<span class="token punctuation">,</span> conn</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
 <span class="token operator">...</span>
 awarenessProtocol<span class="token punctuation">.</span><span class="token function">removeAwarenessStates</span><span class="token punctuation">(</span>doc<span class="token punctuation">.</span>awareness<span class="token punctuation">,</span> Array<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>controlledIds<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
 <span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre></div><p>åœ¨ y-websocketï¼Œæ¯ä¸ªå®¢æˆ·ç«¯æ¯ 30 ç§’å‘æœåŠ¡å™¨å‘é€ä¸€æ¬¡å¿ƒè·³ï¼Œå¦‚æœåœ¨è¿‡å» 30 ç§’å†…æœªä»å®¢æˆ·ç«¯æ”¶åˆ°æ¶ˆæ¯ï¼Œå…¶ä»–å®¢æˆ·ç«¯ä¼šå°†å…¶æ ‡è®°ä¸ºç¦»çº¿ã€‚</p><div class="language-js"><pre><code><span class="token keyword">const</span> pingTimeout <span class="token operator">=</span> <span class="token number">30000</span>
<span class="token keyword">const</span> pingInterval <span class="token operator">=</span> <span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pongReceived<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>doc<span class="token punctuation">.</span>conns<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>conn<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">closeConn</span><span class="token punctuation">(</span>doc<span class="token punctuation">,</span> conn<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token function">clearInterval</span><span class="token punctuation">(</span>pingInterval<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>doc<span class="token punctuation">.</span>conns<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>conn<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    pongReceived <span class="token operator">=</span> <span class="token boolean">false</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      conn<span class="token punctuation">.</span><span class="token function">ping</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">closeConn</span><span class="token punctuation">(</span>doc<span class="token punctuation">,</span> conn<span class="token punctuation">)</span>
      <span class="token function">clearInterval</span><span class="token punctuation">(</span>pingInterval<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> pingTimeout<span class="token punctuation">)</span>
</code></pre></div></li></ol><h3 id="undomanager"><a class="header-anchor" href="#undomanager" aria-hidden="true">#</a> UndoManager</h3><p>Yjs æä¾›äº† UndoManagerï¼Œç”¨æ¥è¿½è¸ªæœ¬åœ°æ›´æ”¹ï¼Œæä¾› uodo/redo åŠŸèƒ½ã€‚</p><div class="language-js"><pre><code><span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> <span class="token constant">Y</span> <span class="token keyword">from</span> <span class="token string">&#39;yjs&#39;</span>

<span class="token keyword">const</span> ytext <span class="token operator">=</span> doc<span class="token punctuation">.</span><span class="token function">getText</span><span class="token punctuation">(</span><span class="token string">&#39;text&#39;</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> undoManager <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Y<span class="token punctuation">.</span>UndoManager</span><span class="token punctuation">(</span>ytext<span class="token punctuation">)</span>

ytext<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">&#39;abc&#39;</span><span class="token punctuation">)</span>
undoManager<span class="token punctuation">.</span><span class="token function">stopCapturing</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
undoManager<span class="token punctuation">.</span><span class="token function">undo</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
ytext<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// =&gt; &#39;&#39;</span>
undoManager<span class="token punctuation">.</span><span class="token function">redo</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
ytext<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// =&gt; &#39;abc&#39;</span>
</code></pre></div><p>ç»“åˆä»¥ä¸Šä»£ç ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸‹å®ƒçš„ API</p><h4 id="const-undomanager-new-y-undomanager-scope-y-abstracttype-array-y-abstracttype-capturetimeout-number-trackedorigins-deletefilter-function-item-boolean"><a class="header-anchor" href="#const-undomanager-new-y-undomanager-scope-y-abstracttype-array-y-abstracttype-capturetimeout-number-trackedorigins-deletefilter-function-item-boolean" aria-hidden="true">#</a> const undoManager = new Y.UndoManager(scope: Y.AbstractType | Array&lt;Y.AbstractType&gt; [, {captureTimeout: number, trackedOrigins deleteFilter: function(item):boolean}])</h4><p>åœ¨ Shared Types ä¸Šåˆ›å»º Y.UndoManagerï¼Œå¦‚æœä»»ä½•æŒ‡å®šç±»å‹æˆ–å…¶ä»»ä½•å­ç±»å‹è¢«ä¿®æ”¹ï¼ŒUndoManager å°†åœ¨å…¶å †æ ˆä¸Šæ·»åŠ åå‘æ“ä½œã€‚</p><p>é»˜è®¤æƒ…å†µä¸‹è¿½è¸ªæ‰€æœ‰æœ¬åœ°æ›´æ”¹ï¼ŒShared Types æ¯æ¬¡æ›´æ”¹éƒ½ä¼šæœ‰æ¥æºï¼Œæ‰€ä»¥å¯ä»¥é€šè¿‡æŒ‡å®š <code>trackedOrigins</code> æ¥è¿‡æ»¤ç‰¹å®šæ¥æºçš„æ›´æ”¹ï¼Œé»˜è®¤ä¸º nullï¼Œå³ä¸è¿‡æ»¤ã€‚</p><div class="language-js"><pre><code><span class="token keyword">const</span> undoManager <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Y<span class="token punctuation">.</span>UndoManager</span><span class="token punctuation">(</span>ytext<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">trackedOrigins</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">42</span><span class="token punctuation">,</span> CustomBinding<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>UndoManager åˆå¹¶åœ¨ç‰¹å®š <code>captureTimeout</code>ï¼ˆé»˜è®¤ä¸º 500msï¼‰å†…åˆ›å»ºçš„ç¼–è¾‘ï¼Œå°†å…¶è®¾ç½®ä¸º 0 ä»¥å•ç‹¬æ•è·æ¯ä¸ªæ›´æ”¹ã€‚</p><div class="language-js"><pre><code><span class="token keyword">const</span> undoManager <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Y<span class="token punctuation">.</span>UndoManager</span><span class="token punctuation">(</span>ytext<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">captureTimeout</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h4 id="undomanager-undo-undomanager-redo-undomanager-clear"><a class="header-anchor" href="#undomanager-undo-undomanager-redo-undomanager-clear" aria-hidden="true">#</a> undoManager.undo()/undoManager.redo()/undoManager.clear()</h4><p>åœ¨ undoManager å®ä¾‹ä¸Šæœ‰ä¸¤ä¸ªå †æ ˆ undoStack å’Œ redoStack ç”¨äºè®°å½• undo/redo æ“ä½œï¼š</p><p>undo æ–¹æ³•ä¼šæ’¤æ¶ˆ undoStack å †æ ˆä¸Šçš„æœ€åä¸€ä¸ªæ“ä½œï¼Œå°†æ ˆé¡¶æ·»åŠ åˆ° redoStack ä¸Šã€‚</p><p>redo æ–¹æ³•é‡åš redoStack å †æ ˆä¸Šçš„æœ€åä¸€ä¸ªæ“ä½œï¼Œå°†æ ˆé¡¶æ·»åŠ åˆ° undoStack ä¸Šã€‚</p><p>clear æ–¹æ³•ä¼šæ¸…ç©ºè¿™ä¸¤ä¸ªå †æ ˆã€‚</p><h4 id="undomanager-stopcapturing"><a class="header-anchor" href="#undomanager-stopcapturing" aria-hidden="true">#</a> undoManager.stopCapturing()</h4><p>å‰é¢æåˆ° UndoManager ä¼šé»˜è®¤åˆå¹¶ <code>captureTimeout</code> è®¾ç½®çš„æ—¶é—´é—´éš”å†…çš„æ“ä½œï¼Œå¦‚æœæ¯æ­¥éƒ½æƒ³å•ç‹¬æˆä¸ºå†å²è®°å½•çš„è¯ï¼Œå¯ä»¥è®¾ç½® <code>captureTimeout</code> ä¸º 0 å³å¯ï¼›</p><p>è€Œå¦‚æœåªæ˜¯æƒ³è®¾ç½®å•æ­¥çš„è®°å½•æ—¶ï¼Œå¯ä»¥é€šè¿‡è°ƒç”¨ stopCapturing() æ–¹æ³•ç¡®ä¿ UndoManager çš„ä¸‹ä¸€ä¸ªæ“ä½œä¸ä¼šä¸ä¸Šä¸€ä¸ªæ“ä½œåˆå¹¶ã€‚</p><div class="language-js"><pre><code><span class="token keyword">const</span> undoManager <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Y<span class="token punctuation">.</span>UndoManager</span><span class="token punctuation">(</span>yText<span class="token punctuation">)</span>

yText<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">&#39;abc&#39;</span><span class="token punctuation">)</span>
undoManager<span class="token punctuation">.</span><span class="token function">stopCapturing</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
yText<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">&#39;def&#39;</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>undoManager<span class="token punctuation">)</span>
</code></pre></div><p>æœªè°ƒç”¨ stopCapturing æ–¹æ³•ï¼š <img src="/blog/_assets/yjs-no-captureTimeout.f7734899.png" alt="yjs-no-captureTimeout"></p><p>è°ƒç”¨ stopCapturing æ–¹æ³•ï¼š <img src="/blog/_assets/yjs-captureTimeout.62dd7639.png" alt="yjs-captureTimeout"></p><p>å¯ä»¥çœ‹åˆ°æœªè°ƒç”¨ stopCapturing æ–¹æ³•åï¼Œåœ¨<code>undoStack</code> å †æ ˆåªä¼šå½¢æˆä¸€æ¡æ•°æ®ï¼Œè€Œè°ƒç”¨ä¹‹åï¼Œä¼šç”Ÿæˆä¸¤æ¡å †æ ˆä¿¡æ¯ã€‚</p><h4 id="on-stack-item-added-on-stack-item-popped"><a class="header-anchor" href="#on-stack-item-added-on-stack-item-popped" aria-hidden="true">#</a> on(&#39;stack-item-added&#39;,...) / on(&#39;stack-item-popped&#39;, ...)</h4><p>ç›‘å¬ undo/redo äº‹ä»¶ï¼Œå¦‚å¯åœ¨äº‹ä»¶å‘ç”Ÿæ—¶å‘ StackItems æ·»åŠ é™„åŠ ä¿¡æ¯ï¼Œç”¨æ¥æ¢å¤å…‰æ ‡ä½ç½®æˆ–æ–‡æ¡£è§†å›¾ç­‰</p><div class="language-js"><pre><code>undoManager<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;stack-item-added&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// å°†å½“å‰å…‰æ ‡ä½ç½®ä¿å­˜åœ¨å †æ ˆé¡¹ä¸Š</span>
  <span class="token comment">// getRelativeCursorLocation()</span>
  event<span class="token punctuation">.</span>stackItem<span class="token punctuation">.</span>meta<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&#39;cursor-location&#39;</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

undoManager<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;stack-item-popped&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// æ¢å¤å †æ ˆé¡¹ä¸Šçš„å½“å‰å…‰æ ‡ä½ç½®</span>
  <span class="token keyword">const</span> cursorLocation <span class="token operator">=</span> event<span class="token punctuation">.</span>stackItem<span class="token punctuation">.</span>meta<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&#39;cursor-location&#39;</span><span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>cursorLocation<span class="token punctuation">)</span>
  <span class="token comment">// restoreCursorLocation()</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="offline-support-ç¦»çº¿æ”¯æŒ"><a class="header-anchor" href="#offline-support-ç¦»çº¿æ”¯æŒ" aria-hidden="true">#</a> Offline Support ç¦»çº¿æ”¯æŒ</h2><p>æˆ‘ä»¬å‰é¢ä»‹ç»äº† Yjs é€šè¿‡ Network Provider å¯ä»¥åœ¨ä¸åŒç½‘ç»œé—´ä¼ è¾“ï¼ŒDataBase Provider å¯ä»¥å°†æ–‡æ¡£æ›´æ–°åŒæ­¥åˆ°æ•°æ®åº“ã€‚</p><p>y-indexeddb æ˜¯ DataBase Provider çš„å…¶ä¸­ä¸€ç§ ï¼Œå¯ä»¥å°†æ–‡æ¡£æ›´æ–°åŒæ­¥åˆ° <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/IndexedDB_API" target="_blank" rel="noopener noreferrer">IndexDB</a> æ•°æ®åº“ï¼Œå®ç°ç¦»çº¿ç¼–è¾‘åŠŸèƒ½ã€‚</p><p>å•ä¸ª Provider éƒ½å¯ä»¥ä¸å…¶ä»– Provider è¿›è¡Œåˆä½œï¼Œæ¯”å¦‚æˆ‘ä»¬å¯ä»¥é€šè¿‡ y-websocket è¿›è¡Œç½‘ç»œä¹‹é—´çš„åŒæ­¥ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ y-redisã€y-indexeddb ç­‰å°†æ–‡æ¡£æŒä¹…åŒ–åˆ° redis æˆ– IndexedDB ä¸­ã€‚</p><p>è¿™æ ·åœ¨å¼±ç½‘æˆ–æ— ç½‘ç»œçŠ¶æ€æ—¶æ–‡æ¡£çš„ä¿®æ”¹ä¹Ÿä¼šè®°å½•åœ¨ indexedDB ä¸­ï¼Œç½‘ç»œæ­£å¸¸åå†åŒæ­¥åˆ°æœåŠ¡ç«¯ï¼Œä¸ä¼šé€ æˆæ–‡æ¡£å†…å®¹çš„ä¸¢å¤±ï¼› åŒæ—¶ä½¿ç”¨ y-indexeddb å’Œ y-websocket ä¼šå°†ä¼šåœ¨æ¯ä¸ªå®¢æˆ·ç«¯çš„ IndexedDB æ•°æ®åº“ä¸­å­˜å‚¨ä¸‹æ¥ï¼Œå¦‚æœæŸä¸ªå®¢æˆ·ç«¯æˆ–è€…æœåŠ¡å™¨ä¸¢å¤±ä¸€äº›æ•°æ®æ—¶ï¼Œå…¶ä»–å®¢æˆ·ç«¯ä¹Ÿä¼šå°†æœ€æ–°çš„æ–‡æ¡£åŒæ­¥å›æœåŠ¡å™¨ã€‚</p><div class="language-bash"><pre><code><span class="token function">yarn</span> <span class="token function">add</span> y-indexeddb
</code></pre></div><div class="language-js"><pre><code><span class="token keyword">import</span> <span class="token punctuation">{</span> IndexeddbPersistence <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;y-indexeddb&#39;</span>

<span class="token keyword">const</span> ydoc <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Y<span class="token punctuation">.</span>Doc</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> roomName <span class="token operator">=</span> <span class="token string">&#39;quill-room-name&#39;</span>

<span class="token keyword">const</span> indexDBProvider <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IndexeddbPersistence</span><span class="token punctuation">(</span>roomName<span class="token punctuation">,</span> ydoc<span class="token punctuation">)</span>
indexDBProvider<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&#39;version&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;1&#39;</span><span class="token punctuation">)</span>
indexDBProvider<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;synced&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;ä»IndexDBåŠ è½½æ–‡æ¡£&#39;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>y-indexeddb ä¸ä¹‹å‰ y-websocket çš„å·¥ä½œæ–¹å¼ç±»ä¼¼ï¼Œä¹Ÿæ˜¯ä¼ å…¥æˆ¿é—´åç§°å’Œ Yjs æ–‡æ¡£ï¼Œé€šè¿‡æˆ¿é—´åç§°æ¥è¿æ¥ Yjs æ–‡æ¡£ï¼Œæ‰€æœ‰ç›¸åŒæˆ¿é—´åç§°çš„æ–‡æ¡£éƒ½å°†åŒæ­¥ã€‚</p><p>æ­¤æ—¶ï¼Œæ–‡æ¡£çš„æ›´æ”¹éƒ½ä¼šä¿å­˜åˆ° IndexedDB æ•°æ®åº“ä¸­ï¼Œé‡æ–°è®¿é—®ç«™ç‚¹æ—¶ï¼Œå°†é¦–å…ˆä» IndexedDB æ•°æ®åº“åŠ è½½æ–‡æ¡£ã€‚</p><p><img src="/blog/_assets/y-indexedDB.1a9978e4.png" alt="y-indexedDB"></p><p>å¯ä»¥çœ‹åˆ° <code>quill-room-name</code> å‘½åçš„ IndexedDB ä¸­åŒ…å« <code>custom</code> å’Œ <code>updates</code> ä¸¤ä¸ªå¯¹è±¡å­˜å‚¨åŒºï¼Œ <code>custom</code>ä¸»è¦ç”¨æ¥å­˜å‚¨è‡ªå®šä¹‰å±æ€§ï¼Œ<code>updates</code> ä¸»è¦æ˜¯è®°å½•æ–‡æ¡£çš„æ›´æ–°ä¿¡æ¯ã€‚</p><h4 id="provider-new-indexeddbpersistence-docname-string-ydoc-y-doc"><a class="header-anchor" href="#provider-new-indexeddbpersistence-docname-string-ydoc-y-doc" aria-hidden="true">#</a> provider = new IndexeddbPersistence(docName: string, ydoc: Y.Doc)</h4><p>åˆ›å»º indexedDB çš„ provider</p><h4 id="provider-on-synced-function-idbpersistence-indexeddbpersistence"><a class="header-anchor" href="#provider-on-synced-function-idbpersistence-indexeddbpersistence" aria-hidden="true">#</a> provider.on(&#39;synced&#39;, function(idbPersistence: IndexeddbPersistence))</h4><p>å½“ä¸ IndexedDB æ•°æ®åº“çš„è¿æ¥å»ºç«‹å¹¶ä¸”æ‰€æœ‰å¯ç”¨å†…å®¹éƒ½å·²åŠ è½½æ—¶ï¼Œå°†è§¦å‘ <code>synced</code> äº‹ä»¶ã€‚<strong>å½“å°šæ— å†…å®¹å¯ç”¨æ—¶ï¼Œä¹Ÿä¼šè§¦å‘è¯¥äº‹ä»¶</strong>ã€‚</p><h4 id="provider-set-key-any-value-any-get-del"><a class="header-anchor" href="#provider-set-key-any-value-any-get-del" aria-hidden="true">#</a> provider.set(key: any, value: any)/get/del</h4><p>é€šè¿‡ provider.set å¯ä»¥åœ¨ provider å®ä¾‹ä¸Šè®¾ç½®è‡ªå®šä¹‰å±æ€§ï¼Œå­˜å‚¨æ–‡æ¡£çš„ç›¸å…³å…ƒä¿¡æ¯ï¼Œé€šè¿‡ get/del è·å–æˆ–åˆ é™¤å•ä¸ªå±æ€§ã€‚</p><h4 id="provider-destroy-promise"><a class="header-anchor" href="#provider-destroy-promise" aria-hidden="true">#</a> provider.destroy(): Promise</h4><p>å…³é—­ä¸ IndexedDB æ•°æ®åº“çš„è¿æ¥å¹¶åœæ­¢åŒæ­¥æ–‡æ¡£ã€‚å½“ Yjs æ–‡æ¡£è¢«é”€æ¯æ—¶ï¼Œä¼šè‡ªåŠ¨è°ƒç”¨æ­¤æ–¹æ³•ã€‚</p><h4 id="provider-cleardata-promise"><a class="header-anchor" href="#provider-cleardata-promise" aria-hidden="true">#</a> provider.clearData(): Promise</h4><p>é”€æ¯ IndexedDB æ•°æ®åº“å¹¶åˆ é™¤å­˜å‚¨çš„æ–‡æ¡£å’Œæ‰€æœ‰ç›¸å…³å…ƒä¿¡æ¯ã€‚</p><h2 id="yjs-ä¸ä¸åŒç¼–è¾‘å™¨çš„ç»‘å®š"><a class="header-anchor" href="#yjs-ä¸ä¸åŒç¼–è¾‘å™¨çš„ç»‘å®š" aria-hidden="true">#</a> Yjs ä¸ä¸åŒç¼–è¾‘å™¨çš„ç»‘å®š</h2><p>åœ¨æ–‡ç« å‰é¢æˆ‘ä»¬ä»‹ç» Quill çš„ååŒç¼–è¾‘æ—¶ï¼Œä½¿ç”¨ y-quill å°† Yjs ä¸ Quill è¿›è¡Œç»‘å®šï¼Œå®ç°äº† Quill çš„ååŒç¼–è¾‘ã€‚åŒæ—¶ä¹Ÿåœ¨ä¸ä½¿ç”¨ y-quill çš„æƒ…å†µä¸‹ï¼Œä½¿ç”¨ Yjs è‡ªå¸¦çš„ API å®ç°äº† Quill çš„ååŒç¼–è¾‘ã€‚</p><p>å›å¿†ä¸‹æ•´ä¸ªè¿‡ç¨‹ï¼š</p><ol><li>é¦–å…ˆç›‘å¬ Quill æ–‡æœ¬çš„å˜åŒ–ï¼›</li><li>æ¥ç€å°† Quill çš„ Delta æ•°æ®ç»“æ„è½¬æ¢ä¸º yText ç»“æ„ï¼›</li><li>yText æ”¹å˜æ—¶é€šè¿‡ y-websocket å‘é€åˆ°å…¶ä»–å®¢æˆ·ç«¯ï¼›</li><li>å…¶ä»–å®¢æˆ·ç«¯ç›‘å¬ yText çš„å˜åŒ–ï¼Œè§£æå‡º Quill çš„ Delta æ•°æ®ï¼Œå›å¡«åˆ°ç¼–è¾‘å™¨ä¸­ã€‚</li></ol><p>Yjs å·²ç»æä¾›äº†å¸¸ç”¨çš„ç¼–è¾‘å™¨çš„æ•°æ®ç»‘å®šï¼Œåƒ<a href="https://docs.yjs.dev/ecosystem/editor-bindings/prosemirror" target="_blank" rel="noopener noreferrer">Prosemirror</a>ã€<a href="https://docs.yjs.dev/ecosystem/editor-bindings/tiptap2" target="_blank" rel="noopener noreferrer">Tiptap</a>ã€<a href="https://docs.yjs.dev/ecosystem/editor-bindings/monaco" target="_blank" rel="noopener noreferrer">Monaco</a>ã€<a href="https://docs.yjs.dev/ecosystem/editor-bindings/quill" target="_blank" rel="noopener noreferrer">Quill</a> ç­‰ç­‰ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹ä¸‹<a href="https://github.com/yjs/y-quill/blob/master/src/y-quill.js" target="_blank" rel="noopener noreferrer">y-quill</a>å’Œ<a href="https://github.com/yjs/y-monaco/blob/HEAD/src/y-monaco.js" target="_blank" rel="noopener noreferrer">y-monaco</a>çš„æºç ï¼ŒYjs åº”ç”¨åˆ°ä¸åŒçš„ç¼–è¾‘å™¨ï¼ŒåŸºæœ¬éƒ½æ˜¯è¿™ä¸€å¥—é€»è¾‘ï¼š</p><p>é¦–å…ˆç›‘å¬ç¼–è¾‘å™¨çš„æ•°æ®å˜åŒ–ï¼Œå½“å‘ç”Ÿå˜åŒ–æ—¶ï¼Œå°†ç¼–è¾‘å™¨æ•°æ®è½¬ä¸º Yjs çš„ Shared Types æ•°æ®ç»“æ„ï¼Œå½“æœ¬åœ° Yjs æ•°æ®å‘ç”Ÿå˜åŒ–æ—¶ä¼šé€šè¿‡ Network Provider å°†æ•°æ®ç»“æ„åŒæ­¥ç»™æ‰€æœ‰ååŒè€…ï¼Œå…¶ä»–ååŒè€…å†é€šè¿‡ç›‘å¬ Yjs æ•°æ®çš„å˜åŠ¨ï¼Œå°† Yjs æ•°æ®è½¬ä¸ºç¼–è¾‘å™¨æ•°æ®ï¼Œåˆ©ç”¨è‡ªèº«çš„ API å°†å˜åŒ–å¡«å……åˆ°ç¼–è¾‘å™¨ä¸­ï¼Œä»è€Œå®ç°ååŒç¼–è¾‘ã€‚</p><p><img src="/blog/_assets/yjs-flow.34c7b153.png" alt="yjs-flow"></p><p>ä»æµç¨‹å›¾å¯ä»¥çœ‹å‡ºæ¯ä¸€ä¸ªå®¢æˆ·ç«¯éƒ½ç»´æŠ¤äº†ä¸€ä¸ª Yjs æ•°æ®ç»“æ„çš„å‰¯æœ¬ï¼Œè¿™ä¸ªæ•°æ®ç»“æ„å‰¯æœ¬æ‰€è¡¨è¾¾çš„å†…å®¹ä¸ Slate ç¼–è¾‘å™¨æ•°æ®æ‰€è¡¨è¾¾çš„å†…å®¹å®Œå…¨ä¸€æ ·ï¼Œåªæ˜¯å®ƒä»¬æ‰¿æ‹…èŒè´£ä¸åŒï¼ŒSlate æ•°æ®ä¾›ç¼–è¾‘å™¨åŠå…¶æ’ä»¶æ¸²æŸ“ä½¿ç”¨ï¼Œç„¶å Yjs æ•°æ®ç»“æ„ç”¨äºå¤„ç†å†²çªã€ä¿è¯æ•°æ®ä¸€è‡´æ€§ï¼Œæ•°æ®çš„ä¿®æ”¹æœ€ç»ˆæ˜¯é€šè¿‡ Yjs çš„æ•°æ®ç»“æ„æ¥è¿›è¡ŒåŒæ­¥çš„ã€‚</p><h2 id="æ€»ç»“"><a class="header-anchor" href="#æ€»ç»“" aria-hidden="true">#</a> æ€»ç»“</h2><p>æœ¬æ–‡é€šè¿‡å®ç° Yjs + Quill çš„ååŒç¼–è¾‘ï¼Œå­¦ä¹  Yjs åŸºæœ¬ä½¿ç”¨æ–¹æ³•ï¼Œä»¥åŠä¸€äº› Yjs çš„æ ¸å¿ƒæ¦‚å¿µï¼šDocumentsã€Shared Typesã€Providerã€ Awareness ç­‰ã€‚æœ€åä»‹ç»äº† Yjs ä¸ä¸åŒç¼–è¾‘å™¨çš„ç»‘å®šï¼Œå¯ä»¥ä½¿ç”¨ y-quillã€y-monacoã€y-prosemirrorã€y-tiptap ç­‰ç¼–è¾‘å™¨ç»‘å®šï¼Œå®ç°ä¸åŒç¼–è¾‘å™¨çš„ååŒç¼–è¾‘ï¼Œå¦‚éœ€å®ç°å…¶ä»–åº”ç”¨çš„ååŒç¼–è¾‘æ—¶ï¼Œæœ€é‡è¦çš„ä¹Ÿæ˜¯å®ç° Yjs æ•°æ®æ¨¡å‹å’Œåº”ç”¨æ•°æ®æ¨¡å‹çš„ç»‘å®šï¼Œå¯ä»¥é€šè¿‡é˜…è¯»ä»¥ä¸Šå‡ ä¸ªç¼–è¾‘å™¨çš„ç»‘å®šæºç æ¥å®ç°ã€‚</p></div><div class="links-wrapper"><div class="prev-link"><!----></div><div class="next-link"><!----></div></div><div><footer class="page-edit"><!-- <a v-for="(item,index) in data.platform" :key="index" :href="item.href">
        <img class="imgIcon" :src="item.icon" />
      </a> --></footer><!-- <p class="platform">
      ä»¥ä¸Šçš†ä¸º
      <a href="javascript:;">çºªå¹´</a> æ–‡ç« å‘å¸ƒå¹³å°
    </p> --><p class="platform"><a href="https://beian.miit.gov.cn/" target="_blank">äº¬ICPå¤‡2022027737å·</a><br> Copyright Â© 2022 - present <a href="https://github.com/wang1xiang">@wangxiang</a></p></div><!--[--><!--]--></div><!-- åªæƒ³ç‚¹å‡»èƒŒæ™¯æ‰å…³é—­ è¯·ä½¿ç”¨ .self ä¿®é¥°ç¬¦ --><div style="display:none;" class="imgBox"><img src=""></div><!--]--></main><div class="theme-select" data-v-afcf09d4><ul data-v-afcf09d4><li class="active" data-v-afcf09d4>â˜€ï¸</li><li class="" data-v-afcf09d4>ğŸŒ‘</li></ul></div></div><!----><!--]--></div>
    <script>__VP_HASH_MAP__ = JSON.parse("{\"README.md\":\"586a6f14\",\"index.md\":\"4f989c38\",\"more_docs.md\":\"8a628146\",\"more_index.md\":\"1ef28a80\",\"more_tags.md\":\"2ad29310\",\"docs_css_grid.md\":\"089f6eb0\",\"docs_css_placeholder.md\":\"04c49e9c\",\"docs_css_tailWindcss-start.md\":\"14ff19b5\",\"docs_docker_docker-start.md\":\"d4b0d88e\",\"docs_electron_electron-bug.md\":\"b1027b72\",\"docs_electron_electron-check-update.md\":\"d2659dd5\",\"docs_electron_electron-diaoyan.md\":\"c318ef56\",\"docs_electron_electron-object-destroyed.md\":\"9f182f68\",\"docs_electron_electron-og.md\":\"c872375d\",\"docs_electron_electron-open-other.md\":\"af388e74\",\"docs_electron_electron-protocol.md\":\"87c521fd\",\"docs_electron_electron-sentry.md\":\"2adecf0b\",\"docs_electron_electron-sign-windows.md\":\"55d93d75\",\"docs_electron_electron-sign.md\":\"3bfc74a7\",\"docs_electron_electron-sqlite3-bug.md\":\"dae0bdb2\",\"docs_electron_electron-sqlite3-start.md\":\"399ff87b\",\"docs_electron_electron-sqlite3.md\":\"ef3e2345\",\"docs_electron_electron-start.md\":\"0c66674a\",\"docs_electron_electron-update.md\":\"6a2972c7\",\"docs_electron_electron-webview-zoom.md\":\"c427b894\",\"docs_electron_hybrid-electron.md\":\"f732109b\",\"docs_electron_sentry-electron.md\":\"5a63f85a\",\"docs_flutter_flutter-dart.md\":\"a34d8438\",\"docs_flutter_flutter-other.md\":\"9703c8ab\",\"docs_flutter_flutter-route-manage.md\":\"4cbbfbdc\",\"docs_flutter_flutter-start.md\":\"4b9638cb\",\"docs_flutter_flutter-state-manage.md\":\"c3ac7a2e\",\"docs_flutter_flutter-wechat-pay.md\":\"c3a2980e\",\"docs_git_git-autocrlf.md\":\"ed4e7f77\",\"docs_git_git-ignorecase.md\":\"c0ea6470\",\"docs_git_git-notes.md\":\"6da214bc\",\"docs_git_git-rebase.md\":\"976b7f44\",\"docs_git_git-username.md\":\"10bfa3f2\",\"docs_git_gitflow.md\":\"9b8cdec1\",\"docs_git_gitlab-ci-start.md\":\"02b1f4c1\",\"docs_http_http.md\":\"3cf03cd3\",\"docs_javascript_async-await.md\":\"5321a06d\",\"docs_javascript_createEvent.md\":\"0a8719c2\",\"docs_javascript_html2docs.md\":\"52680083\",\"docs_javascript_http-cache.md\":\"75e49310\",\"docs_javascript_image-load.md\":\"6e3be031\",\"docs_javascript_indexDB-dexie.md\":\"5155b445\",\"docs_javascript_javascript-utils.md\":\"21b7e46f\",\"docs_javascript_memory-leak.md\":\"21d128c5\",\"docs_javascript_office-preview-type.md\":\"464dda41\",\"docs_javascript_page-alive.md\":\"2800481b\",\"docs_javascript_performance-optimization.md\":\"b7b6d885\",\"docs_javascript_preload-prefetch.md\":\"b13cafdb\",\"docs_javascript_scrollend.md\":\"6f5acb8a\",\"docs_javascript_storage-change.md\":\"1397d666\",\"docs_javascript_turborepo-start.md\":\"93703a64\",\"docs_javascript_webworker.md\":\"ea0f81c8\",\"docs_javascript_zero-width-space.md\":\"5b6ba8cc\",\"docs_leetcode_array-code.md\":\"309c15b5\",\"docs_leetcode_array-code1.md\":\"5488e802\",\"docs_leetcode_back-tracking-code.md\":\"51c0e57b\",\"docs_leetcode_back-tracking-code1.md\":\"64d7b54d\",\"docs_leetcode_back-tracking-code2.md\":\"ca219913\",\"docs_leetcode_back-tracking-code3.md\":\"e5e2cf62\",\"docs_leetcode_binary-tree-code.md\":\"63cad71d\",\"docs_leetcode_binary-tree-code1.md\":\"1c0bf555\",\"docs_leetcode_binary-tree-code2.md\":\"f9ee807e\",\"docs_leetcode_binary-tree-code3.md\":\"283832ae\",\"docs_leetcode_binary-tree-code4.md\":\"6f1f99a4\",\"docs_leetcode_binary-tree-code5.md\":\"565df205\",\"docs_leetcode_binary-tree-code6.md\":\"3c835e03\",\"docs_leetcode_binary-tree-code7.md\":\"62a536db\",\"docs_leetcode_dynamic-programming-code.md\":\"bcf8a332\",\"docs_leetcode_dynamic-programming-code10.md\":\"2af493ec\",\"docs_leetcode_dynamic-programming-code11.md\":\"485749a8\",\"docs_leetcode_dynamic-programming-code12.md\":\"2c22130b\",\"docs_leetcode_dynamic-programming-code13.md\":\"aebdb190\",\"docs_leetcode_dynamic-programming-code2.md\":\"b9eacf92\",\"docs_leetcode_dynamic-programming-code3.md\":\"bc90733e\",\"docs_leetcode_dynamic-programming-code4.md\":\"9e2662b9\",\"docs_leetcode_dynamic-programming-code5.md\":\"d3cbdd33\",\"docs_leetcode_dynamic-programming-code6.md\":\"00b48e8e\",\"docs_leetcode_dynamic-programming-code7.md\":\"02114355\",\"docs_leetcode_dynamic-programming-code8.md\":\"a95b8831\",\"docs_leetcode_dynamic-programming-code9.md\":\"53ad4a83\",\"docs_leetcode_graph-theory.md\":\"0357332d\",\"docs_leetcode_graph-theory2.md\":\"8da2eee2\",\"docs_leetcode_greedy-algorithmc-code.md\":\"a70f62ad\",\"docs_leetcode_greedy-algorithmc-code2.md\":\"93e631e9\",\"docs_leetcode_greedy-algorithmc-code3.md\":\"40487f10\",\"docs_leetcode_greedy-algorithmc-code4.md\":\"dd7243db\",\"docs_leetcode_greedy-algorithmc-code5.md\":\"aadf5218\",\"docs_leetcode_hash-code.md\":\"357e13a7\",\"docs_leetcode_hash-code1.md\":\"c096c1b8\",\"docs_leetcode_linked-list-code.md\":\"aac4b370\",\"docs_leetcode_linked-list-code1.md\":\"9078e6f5\",\"docs_leetcode_monotone-stack.md\":\"3287e8c0\",\"docs_leetcode_monotone-stack1.md\":\"7d82b0de\",\"docs_leetcode_stack-code.md\":\"853c9ce4\",\"docs_leetcode_stack-code1.md\":\"dd95e893\",\"docs_leetcode_string-code.md\":\"4d0b2e2b\",\"docs_leetcode_string-code1.md\":\"bb1ea655\",\"docs_linux_centos-docker.md\":\"71f1449b\",\"docs_linux_linux-no-possword.md\":\"4a5e0c88\",\"docs_mobile_mobileDebugging.md\":\"292323dc\",\"docs_nest_mysql-satart.md\":\"a7869eb8\",\"docs_nest_nest-bff.md\":\"87ad936c\",\"docs_nest_nest-start.md\":\"d395e064\",\"docs_node_bff-express-esm.md\":\"64f6d25a\",\"docs_node_bff-express.md\":\"63519536\",\"docs_node_bff.md\":\"ec74f23c\",\"docs_node_deploy-server.md\":\"a0b79804\",\"docs_node_express-mysql2.md\":\"b7ed816b\",\"docs_node_express-swigger.md\":\"8c9f10af\",\"docs_node_socketIO-start.md\":\"dca38366\",\"docs_photography_nd.md\":\"4ce42003\",\"docs_pnpm_pnpm-monorepo.md\":\"dcffcb8d\",\"docs_prosemirror_html2docs-pdf.md\":\"548142d8\",\"docs_react_create-react-app.md\":\"9a2ca4b4\",\"docs_react_dompurify.md\":\"bedaf247\",\"docs_react_eslint-react.md\":\"d9cf8ee3\",\"docs_react_react-classnames.md\":\"912ec5e4\",\"docs_react_react-grid-layout.md\":\"ef160721\",\"docs_react_react-intl.md\":\"cd95b816\",\"docs_react_react-philosophies.md\":\"dd4292a8\",\"docs_react_react-query.md\":\"85fe0203\",\"docs_react_react-router-change.md\":\"dc8f790e\",\"docs_react_react-vs-vue3.md\":\"b6a61396\",\"docs_react_redux-audition.md\":\"485d3dc2\",\"docs_react_tomcat-404.md\":\"bffb053e\",\"docs_reactNative_react-native-errors.md\":\"9cbe1334\",\"docs_taro_taro-get-started.md\":\"995e794f\",\"docs_taro_taro-start.md\":\"9f05ab92\",\"docs_tiptap_tiptap-tutorial.md\":\"cbae009d\",\"docs_tiptap_tiptap-tutorial10.md\":\"9c257ddd\",\"docs_tiptap_tiptap-tutorial2.md\":\"1a9e2c33\",\"docs_tiptap_tiptap-tutorial3.md\":\"63ba7f63\",\"docs_tiptap_tiptap-tutorial4.md\":\"2493f6d3\",\"docs_tiptap_tiptap-tutorial5.md\":\"e21259bf\",\"docs_tiptap_tiptap-tutorial6.md\":\"22b6833e\",\"docs_tiptap_tiptap-tutorial7.md\":\"2fdc46e1\",\"docs_tiptap_tiptap-tutorial8.md\":\"a8da1273\",\"docs_tiptap_tiptap-tutorial9.md\":\"89d2d2ce\",\"docs_tool_2023-summary.md\":\"0b78dff1\",\"docs_tool_2024-summary.md\":\"f5e8e8a2\",\"docs_tool_blog.md\":\"2ea13e82\",\"docs_tool_chatgpt.md\":\"d58c76d5\",\"docs_tool_chrome-extension.md\":\"70536d0a\",\"docs_tool_chrome-override.md\":\"fb4fb2ea\",\"docs_tool_debugging.md\":\"9233f836\",\"docs_tool_mac.md\":\"43cb4aee\",\"docs_tool_mock.md\":\"38a152c7\",\"docs_tool_moment-api.md\":\"b21e6ab2\",\"docs_tool_mvp.md\":\"b7297dc2\",\"docs_tool_np.md\":\"d58118a7\",\"docs_tool_prosemirror-tables.md\":\"d3c343e5\",\"docs_tool_vitepress-error.md\":\"fcd85cf2\",\"docs_tool_vscode-web-error.md\":\"9ffb72e4\",\"docs_tool_whistle.md\":\"94a570d8\",\"docs_tool_yarn-certificate.md\":\"d12490d3\",\"docs_vite_componentLibrary.md\":\"2fe282e4\",\"docs_vite_create-vite.md\":\"428c7642\",\"docs_vite_vite-env.md\":\"4f2b164e\",\"docs_vite_vite-mulit-import.md\":\"ec22e7ea\",\"docs_vite_vite-react-cli.md\":\"136b49ca\",\"docs_vite_vite-react.md\":\"77113efb\",\"docs_vite_vite.md\":\"35184670\",\"docs_vite_vite3.0.md\":\"862f7416\",\"docs_vscode_vscode-markdown.md\":\"bd32ed74\",\"docs_vscode_vscode-todo.md\":\"dfb35ce2\",\"docs_vue_antd-form.md\":\"6320ad45\",\"docs_vue_antd-vue.md\":\"20ae7ec9\",\"docs_vue_axios-token.md\":\"67520fb6\",\"docs_vue_history-mode.md\":\"42125aa3\",\"docs_vue_keepAlive.md\":\"857110e6\",\"docs_vue_tjTodo.md\":\"9205159e\",\"docs_vue_unplugin-auto-import.md\":\"2d07a5ff\",\"docs_vue_vue-scoped-issue.md\":\"cb444fde\",\"docs_vue_vue3-jsx.md\":\"df0b91fd\",\"docs_vue_vue3-lint-staged.md\":\"f9fe4f97\",\"docs_vue_vue3-unexpected-token.md\":\"dc58531b\",\"docs_webrtc_getstarted-webrtc.md\":\"3c6a8fda\",\"docs_webrtc_livekit-start.md\":\"0352dfa6\",\"docs_webrtc_webrtc-one.md\":\"771ddadb\",\"docs_wechat_uniapp-start.md\":\"07c38563\",\"docs_wechat_wechat-app.md\":\"c1cf8d52\",\"docs_work_360-develop.md\":\"0b9b90bd\",\"docs_work_babel.md\":\"adb1f7bf\",\"docs_work_click-event.md\":\"445dc1b9\",\"docs_work_contentEdit-div-insert.md\":\"4ea43fd1\",\"docs_work_developer.md\":\"bf6ec366\",\"docs_work_echarts.md\":\"65cb8d1b\",\"docs_work_email-font.md\":\"6a551aee\",\"docs_work_excalidraw-use.md\":\"5e45249b\",\"docs_work_excalidraw.md\":\"656ae4b8\",\"docs_work_font-loading-speed.md\":\"ef063a78\",\"docs_work_g2-vs-echarts.md\":\"f47905d1\",\"docs_work_h5-app.md\":\"d8f4b8f7\",\"docs_work_html2canvas-bug.md\":\"1ca28cf1\",\"docs_work_i18n.md\":\"992f8a11\",\"docs_work_image-type.md\":\"9a42d87a\",\"docs_work_jenkins-start.md\":\"403612f1\",\"docs_work_js-long.md\":\"4c726d83\",\"docs_work_malformed.md\":\"a0c81ba5\",\"docs_work_mutationObserver.md\":\"e6a962bd\",\"docs_work_node16-docker.md\":\"43142b37\",\"docs_work_one-react-screenshots.md\":\"438a48f3\",\"docs_work_plop-express.md\":\"1f22d30a\",\"docs_work_puppeteer.md\":\"9592e1cf\",\"docs_work_react-ref.md\":\"18f5bf14\",\"docs_work_report-2023.md\":\"05731d4d\",\"docs_work_report-regular.md\":\"9b31eae0\",\"docs_work_richeditor.md\":\"10bf6668\",\"docs_work_sentry-cli-error.md\":\"a428c0b5\",\"docs_work_sentry-error.md\":\"a01a8333\",\"docs_work_sentry.md\":\"8c73bdf8\",\"docs_work_server-deploy.md\":\"24f3add7\",\"docs_work_sse.md\":\"daa4e38b\",\"docs_work_text-decoration.md\":\"39bfe9a9\",\"docs_work_unocss.md\":\"920a76d9\",\"docs_work_white-board.md\":\"20b18db8\",\"docs_work_word-cpu.md\":\"10327ef0\",\"docs_work_zero-width-spaces.md\":\"4caf32ef\"}")</script>
    <script type="module" async src="/blog/_assets/app.6e2a9892.js"></script>
  </body>
</html>