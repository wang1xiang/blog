import{f as n,g as s,J as a}from"./common-03e46d7f.js";const t='{"title":"玩遍Web中的“选区”和“范围”，下次不要再百度了","frontmatter":{"date":"2023-09-05","title":"玩遍Web中的“选区”和“范围”，下次不要再百度了","tags":["work"],"describe":"平时没少遇到Selection和Range对象吧？所以你搞清楚他们分别是什么了吗？没有就来好好学习。"},"headers":[{"level":2,"title":"前言","slug":"前言"},{"level":2,"title":"document.execCommand","slug":"document-execcommand"},{"level":2,"title":"选区 & 范围","slug":"选区-范围"},{"level":3,"title":"是什么","slug":"是什么"},{"level":3,"title":"如何获取","slug":"如何获取"},{"level":3,"title":"常用操作","slug":"常用操作"},{"level":3,"title":"实现最初的需求：记录选区并恢复","slug":"实现最初的需求：记录选区并恢复"},{"level":2,"title":"总结","slug":"总结"}],"relativePath":"docs/work/contentEdit-div-insert.md","lastUpdated":1742378303222.6125}';var e={};const o=[a('<h2 id="前言"><a class="header-anchor" href="#前言" aria-hidden="true">#</a> 前言</h2><p>最近有个需求，一个纯文本的评论功能，但是评论中需要实现 <code>@ 功能</code>，类似于 antd 的 <a href="https://www.antdv.com/components/mentions-cn" target="_blank" rel="noopener noreferrer">Mentions</a>组件，不过在样式上有特定的要求。实质就是在一段纯文本中，添加一些 html 片段。</p><p>首先想到的是引入一个富文本编辑器，类似 wangEditor、quill 等，但是一个这么小的功能好像并没有必要，一是麻烦二是增加包的体积。于是就用 <code>contenteditable=&#39;true&#39;</code> 生成一个可编辑 div 来完成。</p><p>为此学习了 <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Document/execCommand" target="_blank" rel="noopener noreferrer">document.execCommand</a> 以及用于操作选区的 <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Selection" target="_blank" rel="noopener noreferrer">Selection</a> 和 <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Range" target="_blank" rel="noopener noreferrer">Range</a> API。</p><h2 id="document-execcommand"><a class="header-anchor" href="#document-execcommand" aria-hidden="true">#</a> document.execCommand</h2><p>document.execCommand 可以说是富文本编辑器的核心 API，尽管 document.execCommand 已经被 MDN 给废弃了。</p><p>通过 document.execCommand 可以实现对可编辑文档执行预定义的命令，例如：</p><div class="language-javascript"><pre><code><span class="token comment">// 加粗</span>\ndocument<span class="token punctuation">.</span><span class="token function">execCommand</span><span class="token punctuation">(</span><span class="token string">&#39;bold&#39;</span><span class="token punctuation">)</span>\n<span class="token comment">// 斜体</span>\ndocument<span class="token punctuation">.</span><span class="token function">execCommand</span><span class="token punctuation">(</span><span class="token string">&#39;italic&#39;</span><span class="token punctuation">)</span>\n<span class="token comment">// 字体</span>\ndocument<span class="token punctuation">.</span><span class="token function">execCommand</span><span class="token punctuation">(</span><span class="token string">&#39;fontSize&#39;</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span>\n</code></pre></div><p>关于 document.execCommand 的更多功能可查看<a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Document/execCommand" target="_blank" rel="noopener noreferrer">MDN</a>。</p><p>下面我们可以来一个实际的案例看看：</p><div class="language-js"><pre><code><span class="token operator">&lt;</span><span class="token operator">!</span><span class="token constant">DOCTYPE</span> html<span class="token operator">&gt;</span>\n<span class="token operator">&lt;</span>html lang<span class="token operator">=</span><span class="token string">&quot;en&quot;</span><span class="token operator">&gt;</span>\n  <span class="token operator">&lt;</span>head<span class="token operator">&gt;</span>\n    <span class="token operator">&lt;</span>meta charset<span class="token operator">=</span><span class="token string">&quot;UTF-8&quot;</span> <span class="token operator">/</span><span class="token operator">&gt;</span>\n    <span class="token operator">&lt;</span>meta name<span class="token operator">=</span><span class="token string">&quot;viewport&quot;</span> content<span class="token operator">=</span><span class="token string">&quot;width=device-width, initial-scale=1.0&quot;</span> <span class="token operator">/</span><span class="token operator">&gt;</span>\n    <span class="token operator">&lt;</span>title<span class="token operator">&gt;</span>Document<span class="token operator">&lt;</span><span class="token operator">/</span>title<span class="token operator">&gt;</span>\n    <span class="token operator">&lt;</span>style type<span class="token operator">=</span><span class="token string">&quot;text/css&quot;</span><span class="token operator">&gt;</span>\n      <span class="token punctuation">.</span>btn<span class="token operator">-</span>group <span class="token punctuation">{</span>\n        <span class="token literal-property property">margin</span><span class="token operator">:</span> 15px <span class="token number">0</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n\n      <span class="token punctuation">.</span>btn <span class="token punctuation">{</span>\n        <span class="token literal-property property">color</span><span class="token operator">:</span> #<span class="token number">494949</span><span class="token punctuation">;</span>\n        background<span class="token operator">-</span>color<span class="token operator">:</span> #fff<span class="token punctuation">;</span>\n        <span class="token literal-property property">border</span><span class="token operator">:</span> 1px solid #<span class="token number">494949</span><span class="token punctuation">;</span>\n        border<span class="token operator">-</span>radius<span class="token operator">:</span> 5px<span class="token punctuation">;</span>\n        <span class="token literal-property property">cursor</span><span class="token operator">:</span> pointer<span class="token punctuation">;</span>\n        margin<span class="token operator">-</span>top<span class="token operator">:</span> 10px<span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n\n      <span class="token punctuation">.</span>editor <span class="token punctuation">{</span>\n        <span class="token literal-property property">border</span><span class="token operator">:</span> 1px solid #<span class="token number">424242</span><span class="token punctuation">;</span>\n        <span class="token literal-property property">width</span><span class="token operator">:</span> 800px<span class="token punctuation">;</span>\n        <span class="token literal-property property">height</span><span class="token operator">:</span> 500px<span class="token punctuation">;</span>\n        <span class="token literal-property property">padding</span><span class="token operator">:</span> 8px 12px<span class="token punctuation">;</span>\n        border<span class="token operator">-</span>radius<span class="token operator">:</span> 6px<span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n      a <span class="token punctuation">{</span>\n        <span class="token literal-property property">cursor</span><span class="token operator">:</span> pointer<span class="token punctuation">;</span>\n        text<span class="token operator">-</span>decoration<span class="token operator">:</span> none<span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n    <span class="token operator">&lt;</span><span class="token operator">/</span>style<span class="token operator">&gt;</span>\n  <span class="token operator">&lt;</span><span class="token operator">/</span>head<span class="token operator">&gt;</span>\n  <span class="token operator">&lt;</span>body<span class="token operator">&gt;</span>\n    <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;btn-group&quot;</span><span class="token operator">&gt;</span>\n      <span class="token operator">&lt;</span>input <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;btn&quot;</span> type<span class="token operator">=</span><span class="token string">&quot;button&quot;</span> value<span class="token operator">=</span><span class="token string">&quot;撤销&quot;</span> data<span class="token operator">-</span>commandid<span class="token operator">=</span><span class="token string">&quot;undo&quot;</span> <span class="token operator">/</span><span class="token operator">&gt;</span>\n      <span class="token operator">&lt;</span>input <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;btn&quot;</span> type<span class="token operator">=</span><span class="token string">&quot;button&quot;</span> value<span class="token operator">=</span><span class="token string">&quot;恢复&quot;</span> data<span class="token operator">-</span>commandid<span class="token operator">=</span><span class="token string">&quot;redo&quot;</span> <span class="token operator">/</span><span class="token operator">&gt;</span>\n      <span class="token operator">&lt;</span>input <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;btn&quot;</span> type<span class="token operator">=</span><span class="token string">&quot;button&quot;</span> value<span class="token operator">=</span><span class="token string">&quot;加粗&quot;</span> data<span class="token operator">-</span>commandid<span class="token operator">=</span><span class="token string">&quot;bold&quot;</span> <span class="token operator">/</span><span class="token operator">&gt;</span>\n      <span class="token operator">&lt;</span>input <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;btn&quot;</span> type<span class="token operator">=</span><span class="token string">&quot;button&quot;</span> value<span class="token operator">=</span><span class="token string">&quot;倾斜&quot;</span> data<span class="token operator">-</span>commandid<span class="token operator">=</span><span class="token string">&quot;italic&quot;</span> <span class="token operator">/</span><span class="token operator">&gt;</span>\n      <span class="token operator">&lt;</span>input <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;btn&quot;</span> type<span class="token operator">=</span><span class="token string">&quot;button&quot;</span> value<span class="token operator">=</span><span class="token string">&quot;下划线&quot;</span> data<span class="token operator">-</span>commandid<span class="token operator">=</span><span class="token string">&quot;underline&quot;</span> <span class="token operator">/</span><span class="token operator">&gt;</span>\n      <span class="token operator">&lt;</span>input <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;btn&quot;</span> type<span class="token operator">=</span><span class="token string">&quot;button&quot;</span> value<span class="token operator">=</span><span class="token string">&quot;删除线&quot;</span> data<span class="token operator">-</span>commandid<span class="token operator">=</span><span class="token string">&quot;strikeThrough&quot;</span> <span class="token operator">/</span><span class="token operator">&gt;</span>\n\n      <span class="token operator">&lt;</span>input <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;btn&quot;</span> type<span class="token operator">=</span><span class="token string">&quot;button&quot;</span> value<span class="token operator">=</span><span class="token string">&quot;设置字体大小&quot;</span> data<span class="token operator">-</span>commandid<span class="token operator">=</span><span class="token string">&quot;fontSize&quot;</span> data<span class="token operator">-</span>value<span class="token operator">=</span><span class="token string">&quot;22&quot;</span> <span class="token operator">/</span><span class="token operator">&gt;</span>\n      <span class="token operator">&lt;</span>input <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;btn&quot;</span> type<span class="token operator">=</span><span class="token string">&quot;button&quot;</span> value<span class="token operator">=</span><span class="token string">&quot;字体背景色&quot;</span> data<span class="token operator">-</span>commandid<span class="token operator">=</span><span class="token string">&quot;backColor&quot;</span> data<span class="token operator">-</span>value<span class="token operator">=</span><span class="token string">&quot;#FFFF02&quot;</span> <span class="token operator">/</span><span class="token operator">&gt;</span>\n      <span class="token operator">&lt;</span>input <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;btn&quot;</span> type<span class="token operator">=</span><span class="token string">&quot;button&quot;</span> value<span class="token operator">=</span><span class="token string">&quot;字体颜色&quot;</span> data<span class="token operator">-</span>commandid<span class="token operator">=</span><span class="token string">&quot;foreColor&quot;</span> data<span class="token operator">-</span>value<span class="token operator">=</span><span class="token string">&quot;#FF0000&quot;</span>  <span class="token operator">/</span><span class="token operator">&gt;</span>\n\n      <span class="token operator">&lt;</span>input <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;btn&quot;</span> type<span class="token operator">=</span><span class="token string">&quot;button&quot;</span> value<span class="token operator">=</span><span class="token string">&quot;链接&quot;</span> data<span class="token operator">-</span>commandid<span class="token operator">=</span><span class="token string">&quot;createLink&quot;</span> data<span class="token operator">-</span>value<span class="token operator">=</span><span class="token string">&quot;https://www.baidu.com/&quot;</span><span class="token operator">/</span><span class="token operator">&gt;</span>\n      <span class="token operator">&lt;</span>input <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;btn&quot;</span> type<span class="token operator">=</span><span class="token string">&quot;button&quot;</span> value<span class="token operator">=</span><span class="token string">&quot;有序列表&quot;</span> data<span class="token operator">-</span>commandid<span class="token operator">=</span><span class="token string">&quot;insertOrderedList&quot;</span> <span class="token operator">/</span><span class="token operator">&gt;</span>\n      <span class="token operator">&lt;</span>input <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;btn&quot;</span> type<span class="token operator">=</span><span class="token string">&quot;button&quot;</span> value<span class="token operator">=</span><span class="token string">&quot;无序列表&quot;</span> data<span class="token operator">-</span>commandid<span class="token operator">=</span><span class="token string">&quot;insertUnorderedList&quot;</span> <span class="token operator">/</span><span class="token operator">&gt;</span>\n\n      <span class="token operator">&lt;</span>input <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;btn&quot;</span> type<span class="token operator">=</span><span class="token string">&quot;button&quot;</span> value<span class="token operator">=</span><span class="token string">&quot;剪切选中文字&quot;</span> data<span class="token operator">-</span>commandid<span class="token operator">=</span><span class="token string">&quot;cut&quot;</span> <span class="token operator">/</span><span class="token operator">&gt;</span>\n      <span class="token operator">&lt;</span>input <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;btn&quot;</span> type<span class="token operator">=</span><span class="token string">&quot;button&quot;</span> value<span class="token operator">=</span><span class="token string">&quot;复制选中文字&quot;</span> data<span class="token operator">-</span>commandid<span class="token operator">=</span><span class="token string">&quot;copy&quot;</span> <span class="token operator">/</span><span class="token operator">&gt;</span>\n      <span class="token operator">&lt;</span>input <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;btn&quot;</span> type<span class="token operator">=</span><span class="token string">&quot;button&quot;</span> value<span class="token operator">=</span><span class="token string">&quot;删除选中文字&quot;</span> data<span class="token operator">-</span>commandid<span class="token operator">=</span><span class="token string">&quot;delete&quot;</span> <span class="token operator">/</span><span class="token operator">&gt;</span>\n\n      <span class="token operator">&lt;</span>input <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;btn&quot;</span> type<span class="token operator">=</span><span class="token string">&quot;button&quot;</span> value<span class="token operator">=</span><span class="token string">&quot;清除格式&quot;</span> data<span class="token operator">-</span>commandid<span class="token operator">=</span><span class="token string">&quot;removeFormat&quot;</span> <span class="token operator">/</span><span class="token operator">&gt;</span>\n    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>\n    <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;editor&quot;</span> contenteditable<span class="token operator">=</span><span class="token string">&quot;true&quot;</span> width<span class="token operator">=</span><span class="token string">&quot;800px&quot;</span> height<span class="token operator">=</span><span class="token string">&quot;500px&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>\n    <span class="token operator">&lt;</span>script type<span class="token operator">=</span><span class="token string">&quot;text/javascript&quot;</span><span class="token operator">&gt;</span>\n      window<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>\n        <span class="token keyword">const</span> <span class="token function-variable function">handleClick</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>\n          <span class="token keyword">const</span> target <span class="token operator">=</span> event<span class="token punctuation">.</span>target\n          <span class="token keyword">const</span> <span class="token punctuation">{</span> commandid<span class="token punctuation">,</span> value <span class="token punctuation">}</span> <span class="token operator">=</span> target<span class="token punctuation">.</span>dataset\n          document<span class="token punctuation">.</span><span class="token function">execCommand</span><span class="token punctuation">(</span>commandid<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span>\n        <span class="token punctuation">}</span>\n        <span class="token keyword">const</span> btnGroup <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&#39;.btn-group&#39;</span><span class="token punctuation">)</span>\n        <span class="token comment">// 事件代理，给按钮父级绑定点击事件</span>\n        btnGroup<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&#39;click&#39;</span><span class="token punctuation">,</span> handleClick<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>\n      <span class="token punctuation">}</span>\n    <span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>\n  <span class="token operator">&lt;</span><span class="token operator">/</span>body<span class="token operator">&gt;</span>\n<span class="token operator">&lt;</span><span class="token operator">/</span>html<span class="token operator">&gt;</span>\n</code></pre></div><p><a href="https://codepen.io/wang1xiang/pen/qBLpRVJ" target="_blank" rel="noopener noreferrer">👉🏻 预览地址</a></p><p>通过体验上面的 Demo 之后，或许你会发现一个问题？那就是<strong>每次点完功能按钮后文本框失焦，需要再次点击使其聚焦</strong>。</p><p>这点就比较恶心了，难不成要我每次点击文本框才行 😔。</p><p>那么使用什么方法能够在点击编辑器外部功能按钮时继续让编辑器获取焦点呢？</p><p>好办，只需要在点击按钮执行 execCommand 命令的同时调用 <a href="https://developer.mozilla.org/en-US/docs/Web/API/HTMLElement/focus" target="_blank" rel="noopener noreferrer">focus</a> 方法即可。</p><div class="language-js"><pre><code><span class="token keyword">const</span> <span class="token function-variable function">handleClick</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">item</span><span class="token operator">:</span> ToolType</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> <span class="token punctuation">{</span> commandId<span class="token punctuation">,</span> value <span class="token punctuation">}</span> <span class="token operator">=</span> item\n  editorRef<span class="token punctuation">.</span>value<span class="token operator">?.</span><span class="token function">focus</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n  document<span class="token punctuation">.</span><span class="token function">execCommand</span><span class="token punctuation">(</span>commandId<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span>\n<span class="token punctuation">}</span>\n</code></pre></div><p>那么除了 focus 之外，还有其他的方法吗？带着问题，我们来学习一下 <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Selection" target="_blank" rel="noopener noreferrer">Selection</a>（选区）和<a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Range" target="_blank" rel="noopener noreferrer">Range</a>（范围）这两个家伙。</p><h2 id="选区-范围"><a class="header-anchor" href="#选区-范围" aria-hidden="true">#</a> 选区 &amp; 范围</h2><h3 id="是什么"><a class="header-anchor" href="#是什么" aria-hidden="true">#</a> 是什么</h3><p><img src="/blog/_assets/selection-range.21292089.png" alt="selection-range"></p><p>上面是我在 Firefox 浏览器中的 demo，<strong>范围指的就是页面上的每一个选中节点或节点部分文字</strong>，即上图中的每个红框内的内容（只有 Firefox 可以选择多个范围，其他浏览器只能选择单个范围），每个都有起始位置和终止位置，<strong>选区指的就是所有范围的集合</strong>。</p><p>我们再来看下 MDN 中的介绍：</p><h4 id="range-范围"><a class="header-anchor" href="#range-范围" aria-hidden="true">#</a> Range 范围</h4><ul><li>范围指的是文档中连续的一部分。一个范围包括整个节点，也可以包含节点的一部分，例如文本节点的一部分；</li><li>通常只能选择一个范围，但在 Firefox 浏览器中可以选择多个范围；</li><li>Range 对象也能通过 DOM 创建、增加、删减。</li></ul><h4 id="selection-选区"><a class="header-anchor" href="#selection-选区" aria-hidden="true">#</a> Selection 选区</h4><ul><li>表示用户选择的文本范围或光标的当前位置，<strong>光标也是一种特殊的选区</strong>；</li><li>代表页面中的文本选区，可能横跨多个元素；</li><li><strong>选择的起点 anchorNode 被称为锚点（anchor），终点 focusNode 被称为焦点（focus）</strong></li></ul><h3 id="如何获取"><a class="header-anchor" href="#如何获取" aria-hidden="true">#</a> 如何获取</h3><h4 id="获取选区"><a class="header-anchor" href="#获取选区" aria-hidden="true">#</a> 获取选区</h4><p>通过<code>window.getSelection()</code>即可获取到 Selection 对象，如下（第一张为 Chrome 浏览器，第二张为 Firefox 浏览器）：</p><p><strong>Chrome</strong></p><p><img src="/blog/_assets/window-getSelection.22c006b6.png" alt="window-getSelection"></p><p><strong>Firefox</strong></p><p><img src="/blog/_assets/window-getSelection-firefox.c6f2313b.png" alt="window-getSelection-firefox"></p><p>可以看到 Chrome 浏览器和 Firefox 返回的结构略有差异，baseNode 和 extentNode 仅在 Chrome 浏览器中有，并且相关的定义在 MDN 中并不能查到。</p><p>通过<a href="https://stackoverflow.com/questions/27241281/what-is-anchornode-basenode-extentnode-and-focusnode-in-the-object-returned" target="_blank" rel="noopener noreferrer">这个回答</a>了解到：<strong>baseNode 和 extentNode 分别是 anchorNode 和 focusNode 的别名</strong>。</p><p>Selection 数据格式如下：</p><ul><li><a href="https://developer.mozilla.org/docs/Web/API/Selection/anchorNode" target="_blank" rel="noopener noreferrer">anchorNode</a>: 选区开始位置所属的节点元素；</li><li><a href="https://developer.mozilla.org/docs/Web/API/Selection/anchorOffset" target="_blank" rel="noopener noreferrer">anchorOffset</a>: 代表选区起点在 anchorNode 中的偏移量，例如选区从 anchorNode 的第一个字符开始，则返回 0；</li><li><a href="https://developer.mozilla.org/docs/Web/API/Selection/focusNode" target="_blank" rel="noopener noreferrer">focusNode</a>: 选区结束位置所属的节点元素；</li><li><a href="https://developer.mozilla.org/docs/Web/API/Selection/focusOffset" target="_blank" rel="noopener noreferrer">focusOffset</a>: 代表选区终点在 focusNode 中的偏移量，例如选区在 focusNode 的第一个字符前结束，则返回 0；</li><li><a href="https://developer.mozilla.org/docs/Web/API/Selection/isCollapsed" target="_blank" rel="noopener noreferrer">isCollapsed</a>: 未选择任何内容（空范围）或不存在的选取为 true，例如光标的 isCollapsed 为 true；</li><li><a href="https://developer.mozilla.org/docs/Web/API/Selection/rangeCount" target="_blank" rel="noopener noreferrer">rangeCount</a>: 返回选取中范围的数量，默认是 1，Firefox 浏览器返回可能大于 1；</li><li><a href="https://developer.mozilla.org/docs/Web/API/Selection/type" target="_blank" rel="noopener noreferrer">type</a>: 当前选择类型： <ul><li>None: 当前没有选择</li><li>Caret: 选区已折叠（即 光标在字符之间，并未处于选中状态）</li><li>Range: 选择的是一个范围。</li></ul></li></ul><h4 id="获取范围"><a class="header-anchor" href="#获取范围" aria-hidden="true">#</a> 获取范围</h4><p>我们在上面说了选区是所有范围的集合，那么选区 Selection 一定是提供了获取 Range 的相关方法，<a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Selection#%E6%96%B9%E6%B3%95" target="_blank" rel="noopener noreferrer">🫵 来查我呀</a>。</p><p><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Selection/getRangeAt" target="_blank" rel="noopener noreferrer">selection.getRangeAt</a> ：用于获取当前选区内的 Range 对象，传入一个索引，表示需要获取选区中的第几个范围，一般传 0 即可，只有在 Firefox 浏览器中才会有多个范围。</p><div class="language-js"><pre><code><span class="token keyword">const</span> range <span class="token operator">=</span> selection<span class="token operator">?.</span><span class="token function">getRangeAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>\n</code></pre></div><p><img src="/blog/_assets/window-getSelection-getRangeAt.3c7c38cd.png" alt="window-getSelection-getRangeAt"> Range 对象在 Chrome 浏览器和 Firefox 浏览器的输出结果一致，都包含一下对象：</p><ul><li><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Range/collapsed" target="_blank" rel="noopener noreferrer">collapsed</a>：表示 Range 的起始位置和终止位置是否相同，如光标为 true；</li><li><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Range/commonAncestorContainer" target="_blank" rel="noopener noreferrer">commonAncestorContainer</a>：表示范围内的所有节点它们最近的共同祖先节点；</li><li><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Range/endContainer" target="_blank" rel="noopener noreferrer">endContainer</a>：表示包含 Range 终点的节点；</li><li><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Range/endOffset" target="_blank" rel="noopener noreferrer">endOffset</a>：表示 Range 终点在 endContainer 中的位置的偏移;</li><li><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Range/startContainer" target="_blank" rel="noopener noreferrer">startContainer</a>：表示包含 Range 开始的节点；</li><li><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Range/startOffset" target="_blank" rel="noopener noreferrer">startOffset</a>：表示 Range 在 startContainer 中的位置的偏移。</li></ul><h3 id="常用操作"><a class="header-anchor" href="#常用操作" aria-hidden="true">#</a> 常用操作</h3><p>因为 Range 和 Seleciton 相关的 API 很多，这里我们只需要记住一些常用的即可，其他的等用到的时候再去查文档即可。</p><p><a href="https://github.com/wang1xiang/simple-editor" target="_blank" rel="noopener noreferrer">👉🏻 本文代码地址</a></p><p>在继续往下学习之前，请先打开<a href="https://wang1xiang.github.io/simple-editor/" target="_blank" rel="noopener noreferrer">👉🏻 在线体验地址</a>，搭配使用，效果更佳哦 😯</p><h4 id="获取当前选区内容"><a class="header-anchor" href="#获取当前选区内容" aria-hidden="true">#</a> 获取当前选区内容</h4><p><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Selection/toString" target="_blank" rel="noopener noreferrer">selection.toString</a> 返回当前选区的纯文本内容，<a href="https://developer.mozilla.org/en-US/docs/Web/API/Range/toString" target="_blank" rel="noopener noreferrer">range.toString</a> 返回某个范围的纯文本内容。</p><div class="language-js"><pre><code>selection<span class="token operator">?.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token comment">// 或者</span>\nselection<span class="token operator">?.</span><span class="token function">getRangeAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n</code></pre></div><h4 id="删除当前选区"><a class="header-anchor" href="#删除当前选区" aria-hidden="true">#</a> 删除当前选区</h4><p><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Selection/removeRange" target="_blank" rel="noopener noreferrer">selection.removeRange</a> 和 <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Selection/removeAllRanges" target="_blank" rel="noopener noreferrer">selection.removeAllRanges</a> 都可以用于删除选区，不同的是 removeRange 删除时需要指定第几个范围，下面两种方法实现的效果一致。</p><div class="language-js"><pre><code><span class="token keyword">const</span> count <span class="token operator">=</span> selection<span class="token operator">?.</span>rangeCount <span class="token operator">||</span> <span class="token number">0</span>\n<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span> count<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> range <span class="token operator">=</span> selection<span class="token operator">?.</span><span class="token function">getRangeAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">as</span> Range\n  selection<span class="token operator">?.</span><span class="token function">removeRange</span><span class="token punctuation">(</span>range<span class="token punctuation">)</span>\n<span class="token punctuation">}</span>\n<span class="token comment">// or</span>\nselection<span class="token operator">?.</span><span class="token function">removeAllRanges</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n</code></pre></div><p><strong>在一些操作前都需要先删除选区</strong>，直接使用 removeAllRanges 即可。</p><h4 id="添加选区"><a class="header-anchor" href="#添加选区" aria-hidden="true">#</a> 添加选区</h4><p><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Selection/addRange" target="_blank" rel="noopener noreferrer">selection.addRange</a> 方法可以将一个新的 range 添加到选区中。步骤如下：</p><ol><li><p>使用 document.createRange 方法创建一个 Range 对象，也可以使用 new Range 创建；</p></li><li><p>将指定范围添加到选区中；</p><p>指定范围：<strong>即选区的起始范围和终止范围</strong>，有多种方法可以实现：</p><ul><li>使用 <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Range/selectNode" target="_blank" rel="noopener noreferrer">range.selectNode</a> 或 <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Range/selectNodeContents" target="_blank" rel="noopener noreferrer">range.selectNodeContents</a> 方法将 DOM 节点添加到 Range 中，这样选中的就是传入的 DOM 元素；</li><li>使用 <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Range/setStart" target="_blank" rel="noopener noreferrer">range.setStart</a> 和 <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Range/setEnd" target="_blank" rel="noopener noreferrer">range.setEnd</a> 添加范围的边界；</li><li>使用 <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Range/setStartBefore" target="_blank" rel="noopener noreferrer">range.setStartBefore</a>/<a href="https://developer.mozilla.org/en-US/docs/Web/API/Range/setEndBefore" target="_blank" rel="noopener noreferrer">srange.etEndBefore</a> 或 <a href="https://developer.mozilla.org/en-US/docs/Web/API/Range/setStartAfter" target="_blank" rel="noopener noreferrer">range.setStartAfter</a>/<a href="https://developer.mozilla.org/en-US/docs/Web/API/Range/setEndAfter" target="_blank" rel="noopener noreferrer">range.setEndAfter</a> 来添加范围的边界。</li></ul></li><li><p>移除已有选区，通过尝试，<strong>如果不移除当前选区的话，除 Firefox 外的所有浏览器都将忽略新范围</strong>；</p></li><li><p>最后将 range 范围添加到选区中。</p></li></ol><p>下面这个 Demo 分别用 selectNode、setStart 和 setStartBefore 这几种方法实现。</p><div class="language-js"><pre><code><span class="token keyword">const</span> editor <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&#39;.editor&#39;</span><span class="token punctuation">)</span><span class="token operator">!</span>\n<span class="token keyword">const</span> range <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createRange</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token comment">// 1. selectNode 选中第n个子节点</span>\n<span class="token comment">// const sizeStr = window.prompt(&#39;选择第几个子节点&#39;, &#39;1&#39;) || &#39;1&#39;</span>\n<span class="token comment">// const size = parseInt(sizeStr)</span>\n<span class="token comment">// if (isNaN(size)) return</span>\n<span class="token comment">// range.selectNode(editor.childNodes[size])</span>\n\n<span class="token comment">// 2. setStart/setEnd 选中第n个子节点到第m个子节点</span>\n<span class="token comment">// const startOffsetStr = window.prompt(&#39;从第几个子节点开始&#39;, &#39;1&#39;) || &#39;1&#39;</span>\n<span class="token comment">// const endOffsetStr = window.prompt(&#39;到第几个子节点结束&#39;, &#39;5&#39;) || &#39;1&#39;</span>\n<span class="token comment">// const startOffset = parseInt(startOffsetStr)</span>\n<span class="token comment">// const endOffset = parseInt(endOffsetStr)</span>\n<span class="token comment">// if (isNaN(startOffset) || isNaN(endOffset)) return</span>\n<span class="token comment">// range.setStart(editor, startOffset)</span>\n<span class="token comment">// range.setEnd(editor, endOffset)</span>\n\n<span class="token comment">// 3. setStart/setEnd 选中第n个子节点的开始到结束范围</span>\n<span class="token comment">// const n = 1</span>\n<span class="token comment">// const startOffsetStr = window.prompt(&#39;从第一个子节点的第几个位置开始&#39;, &#39;1&#39;) || &#39;1&#39;</span>\n<span class="token comment">// const endOffsetStr = window.prompt(&#39;到第一个子节点的第几个位置结束&#39;, &#39;5&#39;) || &#39;1&#39;</span>\n<span class="token comment">// const startOffset = parseInt(startOffsetStr)</span>\n<span class="token comment">// const endOffset = parseInt(endOffsetStr)</span>\n<span class="token comment">// if (isNaN(startOffset) || isNaN(endOffset)) return</span>\n<span class="token comment">// range.setStart(editor.childNodes[n], startOffset)</span>\n<span class="token comment">// range.setEnd(editor.childNodes[n], endOffset)</span>\n\n<span class="token comment">// 4. setStartBefore/setEndBefore 选中第n个子节点到第m个子节点</span>\n<span class="token keyword">const</span> startOffsetStr <span class="token operator">=</span> window<span class="token punctuation">.</span><span class="token function">prompt</span><span class="token punctuation">(</span><span class="token string">&#39;从第几个子节点前开始&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;1&#39;</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token string">&#39;1&#39;</span>\n<span class="token keyword">const</span> endOffsetStr <span class="token operator">=</span> window<span class="token punctuation">.</span><span class="token function">prompt</span><span class="token punctuation">(</span><span class="token string">&#39;到第几个子节点末尾结束&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;5&#39;</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token string">&#39;1&#39;</span>\n<span class="token keyword">const</span> startOffset <span class="token operator">=</span> <span class="token function">parseInt</span><span class="token punctuation">(</span>startOffsetStr<span class="token punctuation">)</span>\n<span class="token keyword">const</span> endOffset <span class="token operator">=</span> <span class="token function">parseInt</span><span class="token punctuation">(</span>endOffsetStr<span class="token punctuation">)</span>\n<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isNaN</span><span class="token punctuation">(</span>startOffset<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">isNaN</span><span class="token punctuation">(</span>endOffset<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span>\nrange<span class="token punctuation">.</span><span class="token function">setStartBefore</span><span class="token punctuation">(</span>editor<span class="token punctuation">.</span>childNodes<span class="token punctuation">[</span>startOffset<span class="token punctuation">]</span><span class="token punctuation">)</span>\nrange<span class="token punctuation">.</span><span class="token function">setEndBefore</span><span class="token punctuation">(</span>editor<span class="token punctuation">.</span>childNodes<span class="token punctuation">[</span>endOffset<span class="token punctuation">]</span><span class="token punctuation">)</span>\n\nselection<span class="token operator">?.</span><span class="token function">removeAllRanges</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\nselection<span class="token operator">?.</span><span class="token function">addRange</span><span class="token punctuation">(</span>range<span class="token punctuation">)</span>\n</code></pre></div><p>在上面代码中，setStart/setEnd 有两种不同的效果:</p><ol><li><p><strong>作用于元素节点时</strong>（上述 2. setStart/setEnd 选中第 n 个子节点到第 m 个子节点）</p><p>此时 node 设置为 editor，即整个富文本，那么此时设定的 offset 就是就是子元素的位置。</p></li><li><p><strong>作用于文本节点时</strong>（上述 3. setStart/setEnd 选中第 n 个子节点的开始到结束范围）</p><p>此时 node 设置为 <code>editor.childNodes[1]</code>, 即第一段话，那么此时设定的 offset 是其文本中的位置。</p></li></ol><p>MDN 上是这样解释的：</p><blockquote><p>如果起始节点类型是 Text、Comment 或 CDATASection 之一，那么 startOffset 指的是从起始节点算起字符的偏移量。对于其他 Node 类型节点，startOffset 是指从起始结点开始算起子节点的偏移量。</p></blockquote><p><img src="/blog/_assets/window-getselection-selection.0de5ed27.gif" alt="window-getSelection-selection"></p><h4 id="修改选区"><a class="header-anchor" href="#修改选区" aria-hidden="true">#</a> 修改选区</h4><p><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Selection/modify" target="_blank" rel="noopener noreferrer">selection.modify</a>：可以用来修改选区，通过指定 <code>left</code> 或 <code>rigth</code> 来向左或向右修改选区，范围可以指定为一个字符、单词、段落、行等等。</p><div class="language-js"><pre><code><span class="token comment">// 向左添加一个字符到选区</span>\nselection<span class="token operator">?.</span><span class="token function">modify</span><span class="token punctuation">(</span><span class="token string">&#39;extend&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;left&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;character&#39;</span><span class="token punctuation">)</span>\n<span class="token comment">// 向右添加一个单词到选区</span>\nselection<span class="token operator">?.</span><span class="token function">modify</span><span class="token punctuation">(</span><span class="token string">&#39;extend&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;right&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;word&#39;</span><span class="token punctuation">)</span>\n</code></pre></div><p><img src="/blog/_assets/window-getselection-move.9c152b6a.gif" alt="window-getSelection-move"></p><h4 id="设置光标位置"><a class="header-anchor" href="#设置光标位置" aria-hidden="true">#</a> 设置光标位置</h4><p>光标位置的设置可以有以下几种方法实现：</p><ol><li>单纯使用 range.setStart，即给定起始范围，不给结束范围，那么此时光标就会聚焦在 range.setStart 设置的范围前；</li><li>使用 <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Selection/collapse" target="_blank" rel="noopener noreferrer">selection.collapse</a>，传入光标需要落在的目标节点，以及落在节点的偏移量。</li></ol><div class="language-js"><pre><code><span class="token comment">// 1. 使用setStart/setStart实现</span>\n<span class="token keyword">const</span> editor <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&#39;.editor&#39;</span><span class="token punctuation">)</span><span class="token operator">!</span>\n<span class="token keyword">const</span> range <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createRange</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token comment">// range.setStart(editor.childNodes[1], 1)</span>\n<span class="token comment">// selection?.removeAllRanges()</span>\n<span class="token comment">// selection?.addRange(range)</span>\n<span class="token comment">// 2. 使用selection.collapse实现</span>\nselection<span class="token operator">?.</span><span class="token function">collapse</span><span class="token punctuation">(</span>editor<span class="token punctuation">.</span>childNodes<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">)</span>\n</code></pre></div><h5 id="移动光标位置"><a class="header-anchor" href="#移动光标位置" aria-hidden="true">#</a> 移动光标位置</h5><p>如果只是移动当前已有光标的位置，那么也可以使用上面提到的 selection.modify ，只需将第一个参数 <code>extend</code> 改为 <code>move</code> 即可。</p><div class="language-js"><pre><code><span class="token comment">//向左移动光标</span>\nselection<span class="token operator">?.</span><span class="token function">modify</span><span class="token punctuation">(</span><span class="token string">&#39;move&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;left&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;character&#39;</span><span class="token punctuation">)</span>\n<span class="token comment">// 向右移动光标</span>\nselection<span class="token operator">?.</span><span class="token function">modify</span><span class="token punctuation">(</span><span class="token string">&#39;move&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;right&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;word&#39;</span><span class="token punctuation">)</span>\n</code></pre></div><h5 id="将光标聚焦到选区前后"><a class="header-anchor" href="#将光标聚焦到选区前后" aria-hidden="true">#</a> 将光标聚焦到选区前后</h5><p>如果已有选区的情况下，还有可以针对已有选区进行光标位置设置的方法：</p><p><a href="https://developer.mozilla.org/en-US/docs/Web/API/Range/collapse" target="_blank" rel="noopener noreferrer">range.collapse</a> —— 此方法会将选中范围向边界点（前/后）进行折叠，传入 true 折叠到 Range 开始的节点，false 折叠到 Range 终点的节点； <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Selection/collapseToStart" target="_blank" rel="noopener noreferrer">selection.collapseToStart</a> —— 折叠到选区起点 <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Selection/collapseToEnd" target="_blank" rel="noopener noreferrer">selection.collapseToEnd</a> —— 折叠到选区终点</p><div class="language-js"><pre><code><span class="token comment">// range?.collapse(false);</span>\n<span class="token comment">// 1. 使用collapseToStart</span>\n<span class="token comment">// selection?.collapseToStart()</span>\n<span class="token comment">// 2. 使用collapseToEnd</span>\nselection<span class="token operator">?.</span><span class="token function">collapseToEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n</code></pre></div><p><img src="/blog/_assets/window-getselection-extend.f23903b6.gif" alt="window-getSelection-extend"></p><h4 id="添加-替换选区内容"><a class="header-anchor" href="#添加-替换选区内容" aria-hidden="true">#</a> 添加/替换选区内容</h4><p>往富文本中插入/替换内容，在我们日常开发中应该应该会有所接触，那么你是怎么做的呢？</p><p>一种是使用 document.insertHTML 来实现，比如前面提到的 @ 功能，我一开始也是使用 document.insertHTML 来实现，但是遇到了问题，类似<a href="https://stackoverflow.com/questions/25941559/is-there-a-way-to-keep-execcommandinserthtml-from-removing-attributes-in-chr" target="_blank" rel="noopener noreferrer">这个问题</a>；看评论说可以使用 <a href="https://developer.mozilla.org/en-US/docs/Web/API/Range/insertNode" target="_blank" rel="noopener noreferrer">range.insertNode</a> 来实现。</p><p>具体的实现步骤如下：</p><ol><li>获取当前选区，没有选区没法添加；</li><li>创建需要添加到选区中的元素 node；</li><li>如果需要替换选区内容，则需要执行 <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Range/deleteContents" target="_blank" rel="noopener noreferrer">range.deleteContents</a>；</li><li>通过 range.insertNode 将 node 添加到选区；</li><li>需要执行 range.setStartAfter 将光标移动到插入的元素之后（默认是选中插入元素）；</li><li>恢复选区位置。</li></ol><div class="language-js"><pre><code><span class="token keyword">const</span> editor <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&#39;.editor&#39;</span><span class="token punctuation">)</span> <span class="token keyword">as</span> HTMLElement\n<span class="token keyword">const</span> range <span class="token operator">=</span> selection<span class="token operator">?.</span><span class="token function">getRangeAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>\n<span class="token keyword">const</span> mark <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&#39;mark&#39;</span><span class="token punctuation">)</span>\nmark<span class="token punctuation">.</span>innerText <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">@xxx</span><span class="token template-punctuation string">`</span></span>\nmark<span class="token punctuation">.</span>contentEditable <span class="token operator">=</span> <span class="token string">&#39;false&#39;</span>\nmark<span class="token punctuation">.</span>className <span class="token operator">=</span> <span class="token string">&#39;comment-mentions-label&#39;</span>\nrange<span class="token operator">?.</span><span class="token function">deleteContents</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\nrange<span class="token operator">?.</span><span class="token function">insertNode</span><span class="token punctuation">(</span>mark<span class="token punctuation">)</span>\nrange<span class="token operator">?.</span><span class="token function">setStartAfter</span><span class="token punctuation">(</span>mark<span class="token punctuation">)</span>\neditor<span class="token punctuation">.</span><span class="token function">focus</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n</code></pre></div><p>像我们还可能会遇到加粗、斜体等等，可以使用 <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Range/surroundContents" target="_blank" rel="noopener noreferrer">range.surroundContents</a> 来实现，surroundContents 方法将 Range 对象的内容移动到一个新的节点，并将新节点放到这个范围的起始处，简单来说：就是使用传入的节点包裹当前选取，例如实现加粗功能：</p><div class="language-js"><pre><code><span class="token keyword">const</span> strong <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&#39;strong&#39;</span><span class="token punctuation">)</span>\nrange<span class="token operator">?.</span><span class="token function">surroundContents</span><span class="token punctuation">(</span>strong<span class="token punctuation">)</span>\n</code></pre></div><p><strong>注意：通过 range 添加/替换选区内容后，无法使用 Ctrl+Z 撤消</strong></p><h3 id="实现最初的需求：记录选区并恢复"><a class="header-anchor" href="#实现最初的需求：记录选区并恢复" aria-hidden="true">#</a> 实现最初的需求：记录选区并恢复</h3><p>如果了解了以上知识，那此时我们要实现恢复选区的方法，只需要<strong>在编辑器失焦前记录选区，在点击功能按钮完成后恢复选区</strong>即可，如下（为了方便，封装成一个 hooks）：</p><div class="language-js"><pre><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Ref<span class="token punctuation">,</span> onBeforeMount<span class="token punctuation">,</span> onMounted <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;vue&#39;</span>\n\n<span class="token keyword">const</span> <span class="token function-variable function">useRestoreSelection</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">inputRef</span><span class="token operator">:</span> Ref<span class="token operator">&lt;</span>HTMLDivElement <span class="token operator">|</span> <span class="token keyword">undefined</span><span class="token operator">&gt;</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>\n  <span class="token keyword">let</span> <span class="token literal-property property">saveRange</span><span class="token operator">:</span> Range <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token operator">=</span> <span class="token keyword">null</span>\n  <span class="token keyword">const</span> <span class="token function-variable function">saveSelection</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> sel <span class="token operator">=</span> window<span class="token punctuation">.</span><span class="token function">getSelection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">!</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>sel<span class="token punctuation">.</span>getRangeAt <span class="token operator">&amp;&amp;</span> sel<span class="token punctuation">.</span>rangeCount<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      saveRange <span class="token operator">=</span> sel<span class="token punctuation">.</span><span class="token function">getRangeAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token keyword">const</span> <span class="token function-variable function">restoreSelection</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>saveRange<span class="token punctuation">)</span> <span class="token keyword">return</span>\n    <span class="token keyword">const</span> sel <span class="token operator">=</span> window<span class="token punctuation">.</span><span class="token function">getSelection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">!</span>\n    sel<span class="token punctuation">.</span><span class="token function">removeAllRanges</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n    sel<span class="token punctuation">.</span><span class="token function">addRange</span><span class="token punctuation">(</span>saveRange<span class="token punctuation">)</span>\n  <span class="token punctuation">}</span>\n  <span class="token function">onMounted</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> editorDOM <span class="token operator">=</span> inputRef<span class="token punctuation">.</span>value\n    editorDOM<span class="token operator">?.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&#39;blur&#39;</span><span class="token punctuation">,</span> saveSelection<span class="token punctuation">)</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span>\n  <span class="token function">onBeforeMount</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> editorDOM <span class="token operator">=</span> inputRef<span class="token punctuation">.</span>value\n    editorDOM<span class="token operator">?.</span><span class="token function">removeEventListener</span><span class="token punctuation">(</span><span class="token string">&#39;blur&#39;</span><span class="token punctuation">,</span> saveSelection<span class="token punctuation">)</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span>\n  <span class="token keyword">return</span> <span class="token punctuation">{</span>\n    restoreSelection<span class="token punctuation">,</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">export</span> <span class="token keyword">default</span> useRestoreSelection\n</code></pre></div><p>可以将上面的 <code>editorRef.value?.focus()</code> 替换为 <code>saveSelection</code> 方法。</p><div class="language-js"><pre><code><span class="token keyword">const</span> <span class="token function-variable function">handleClick</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">item</span><span class="token operator">:</span> ToolType</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> <span class="token punctuation">{</span> commandId<span class="token punctuation">,</span> value <span class="token punctuation">}</span> <span class="token operator">=</span> item\n  <span class="token function">restoreSelection</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n  document<span class="token punctuation">.</span><span class="token function">execCommand</span><span class="token punctuation">(</span>commandId<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span>\n<span class="token punctuation">}</span>\n</code></pre></div><h2 id="总结"><a class="header-anchor" href="#总结" aria-hidden="true">#</a> 总结</h2><p>其实很早之前就有用到这两个 API，但一直认为用处不大，所有没有深入研究，每次有需要的时候就百度查一查，现在终于肯花时间来搞清楚，以后遇到这种问题也就不会感到棘手了。</p><p>希望大家遇到不会的东西时，静下心来花时间去研究透它，这样就不至于每次遇到都去百度一遍。</p>',98)];e.render=function(a,t,e,p,r,c){return n(),s("div",null,o)};export{t as __pageData,e as default};
