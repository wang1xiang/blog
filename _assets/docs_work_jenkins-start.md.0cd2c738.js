import{f as n,g as s,J as a}from"./common-03e46d7f.js";import{_ as e}from"./common-af9dd5a8.js";const p='{"title":"队友升职加薪来不及羡慕，被迫解锁 Jenkins 技能（小小玩意，拿捏 🫴）","frontmatter":{"date":"2024-03-11","title":"队友升职加薪来不及羡慕，被迫解锁 Jenkins 技能（小小玩意，拿捏 🫴）","tags":["work"],"describe":null},"headers":[{"level":2,"title":"入坑 Jenkins","slug":"入坑-jenkins"},{"level":2,"title":"说说我经历过的前端部署流程","slug":"说说我经历过的前端部署流程"},{"level":3,"title":"原始时代","slug":"原始时代"},{"level":3,"title":"脚本化时代","slug":"脚本化时代"},{"level":3,"title":"CI/CD 时代","slug":"ci-cd-时代"},{"level":2,"title":"Jenkins 解决了什么问题","slug":"jenkins-解决了什么问题"},{"level":2,"title":"Jenkins 部署","slug":"jenkins-部署"},{"level":3,"title":"安装过程","slug":"安装过程"},{"level":3,"title":"Jenkins 配置","slug":"jenkins-配置"},{"level":3,"title":"安装过程遇到的问题","slug":"安装过程遇到的问题"},{"level":3,"title":"如何卸载 Jenkins","slug":"如何卸载-jenkins"},{"level":3,"title":"Jenkins 版本更新","slug":"jenkins-版本更新"},{"level":2,"title":"项目创建","slug":"项目创建"},{"level":3,"title":"Freestyle project","slug":"freestyle-project"},{"level":3,"title":"Build Steps","slug":"build-steps"},{"level":3,"title":"构建后操作","slug":"构建后操作"},{"level":2,"title":"构建","slug":"构建"},{"level":3,"title":"Pipeline","slug":"pipeline"},{"level":3,"title":"生成方式","slug":"生成方式"},{"level":3,"title":"重要概念","slug":"重要概念"},{"level":3,"title":"语法","slug":"语法"},{"level":3,"title":"构建看看效果","slug":"构建看看效果"},{"level":3,"title":"通过项目中的 Jenkinsfile 构建","slug":"通过项目中的-jenkinsfile-构建"},{"level":3,"title":"片段生成器","slug":"片段生成器"},{"level":3,"title":"配置构建过程遇到的问题","slug":"配置构建过程遇到的问题"},{"level":2,"title":"总结","slug":"总结"}],"relativePath":"docs/work/jenkins-start.md","lastUpdated":1742205571990.0427}';var t={};const o=[a('<p><img src="/blog/_assets/jenkins-learn.6cc4796a.png" alt="jenkins-learn"></p><h2 id="入坑-jenkins"><a class="header-anchor" href="#入坑-jenkins" aria-hidden="true">#</a> 入坑 Jenkins</h2><p>作为一个前端，想必大家都会有这个想法：“<strong>Jenkins 会用就行了，有啥好学的</strong>”。</p><p>我一直都是这么想的，不就会点个<code>开始构建</code>就行了嘛！</p><p>可是碰巧我们之前负责 Jenkins 的前端同事升了职，碰巧这个项目组就剩了两个人，碰巧我比较闲，于是这个“活”就落在我的头上了。</p><p><img src="/blog/_assets/yali.d5778777.jpeg" alt="yali"></p><p>压力一下就上来了，一点不懂 Jenkins 可咋整？</p><p>然而现实是没有一点儿压力。</p><p>刚开始的时候挺轻松，也就是要发版的流程到我这了，我直接在对应项目上点击<code>开始构建</code>，so easy！可是某一天，突然遇到一个 bug：我们每次 web 端项目发完后，桌面端的 hybrid 包需要我手动改 OSS 上配置文件的版本号，正巧那天忘记更新版本号了，导致桌面端应用本地的 hybrid 没有更新。。。</p><p>领导：你要不就别手动更新了，弄成自动化的 我：😨 啊！什么，我我我不会，是不可能的</p><p>小弟我之前没有接触过 Jenkins，看着那一堆配置着实有点费脑，于是就只能边百度学习边输出，从 Jenkins 安装开始到配置不同类型的构建流程，踩过不少坑，最后形成这篇万字长文。如果有能帮到大家的点，我就很开心了，毕竟我也是刚接触的！</p><h2 id="说说我经历过的前端部署流程"><a class="header-anchor" href="#说说我经历过的前端部署流程" aria-hidden="true">#</a> 说说我经历过的前端部署流程</h2><p>按照我的经历，我把前端部署流程分为了以下几个阶段：即原始时代 -&gt; 脚本化时代 -&gt; CI/CD 时代。</p><p><img src="/blog/_assets/jenkins-history.6bf79e01.png" alt="jenkins-history"></p><h3 id="原始时代"><a class="header-anchor" href="#原始时代" aria-hidden="true">#</a> 原始时代</h3><p>最开始的公司运维是一个小老头，他只负责管理服务器资源，不管各种项目打包之类的。我们就只能自己打包，再手动把构建的文件丢到服务器上。</p><p>整体流程就是：本地合并代码 --&gt; 本地打包 --&gt; 上传服务器；</p><p>上传服务器可以分为这几个小步骤：打开 xshell --&gt; 连接服务器 --&gt; 进入 tomcat 目录 --&gt; 通过 ftp 上传本地文件。</p><p>可能全套下来需要 5 分钟左右。</p><h3 id="脚本化时代"><a class="header-anchor" href="#脚本化时代" aria-hidden="true">#</a> 脚本化时代</h3><p>为了简化，我写了一个 node 脚本，通过<code>ssh2-sftp-client</code>将<code>上传服务器</code>这一步骤脚本化：</p><div class="language-js"><pre><code><span class="token keyword">const</span> chalk <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;chalk&#39;</span><span class="token punctuation">)</span>\n<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;path&#39;</span><span class="token punctuation">)</span>\n<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;fs&#39;</span><span class="token punctuation">)</span>\n<span class="token keyword">const</span> Client <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;ssh2-sftp-client&#39;</span><span class="token punctuation">)</span>\n<span class="token keyword">const</span> sftp <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Client</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token keyword">const</span> envConfig <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;./env.config&#39;</span><span class="token punctuation">)</span>\n\n<span class="token keyword">const</span> defalutConfig <span class="token operator">=</span> <span class="token punctuation">{</span>\n  <span class="token literal-property property">port</span><span class="token operator">:</span> <span class="token string">&#39;22&#39;</span><span class="token punctuation">,</span>\n  <span class="token literal-property property">username</span><span class="token operator">:</span> <span class="token string">&#39;root&#39;</span><span class="token punctuation">,</span>\n  <span class="token literal-property property">password</span><span class="token operator">:</span> <span class="token string">&#39;123&#39;</span><span class="token punctuation">,</span>\n  <span class="token literal-property property">localStatic</span><span class="token operator">:</span> <span class="token string">&#39;./dist.tar.gz&#39;</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token punctuation">{</span>\n  <span class="token operator">...</span>defalutConfig<span class="token punctuation">,</span>\n  <span class="token literal-property property">host</span><span class="token operator">:</span> envConfig<span class="token punctuation">.</span>host<span class="token punctuation">,</span>\n  <span class="token literal-property property">remoteStatic</span><span class="token operator">:</span> envConfig<span class="token punctuation">.</span>remoteStatic<span class="token punctuation">,</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">const</span> error <span class="token operator">=</span> chalk<span class="token punctuation">.</span>bold<span class="token punctuation">.</span>red\n<span class="token keyword">const</span> success <span class="token operator">=</span> chalk<span class="token punctuation">.</span>bold<span class="token punctuation">.</span>green\n<span class="token keyword">function</span> <span class="token function">upload</span><span class="token punctuation">(</span><span class="token parameter">config<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fs<span class="token punctuation">.</span><span class="token function">existsSync</span><span class="token punctuation">(</span><span class="token string">&#39;./dist&#39;</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>fs<span class="token punctuation">.</span><span class="token function">existsSync</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>localStatic<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span>\n  <span class="token punctuation">}</span>\n  <span class="token comment">// 标志上传dist目录</span>\n  <span class="token keyword">let</span> isDist <span class="token operator">=</span> <span class="token boolean">false</span>\n  sftp\n    <span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>\n    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>\n      <span class="token comment">// 判断gz文件存在时 上传gz 不存在时上传dist</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>fs<span class="token punctuation">.</span><span class="token function">existsSync</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>localStatic<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">return</span> sftp<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>localStatic<span class="token punctuation">,</span> options<span class="token punctuation">.</span>remoteStatic<span class="token punctuation">)</span>\n      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>fs<span class="token punctuation">.</span><span class="token function">existsSync</span><span class="token punctuation">(</span><span class="token string">&#39;./dist&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        isDist <span class="token operator">=</span> <span class="token boolean">true</span>\n        <span class="token keyword">return</span> sftp<span class="token punctuation">.</span><span class="token function">uploadDir</span><span class="token punctuation">(</span><span class="token string">&#39;./dist&#39;</span><span class="token punctuation">,</span> options<span class="token punctuation">.</span>remoteStatic<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span>\n    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>\n      sftp<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isDist<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">const</span> <span class="token punctuation">{</span> Client <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;ssh2&#39;</span><span class="token punctuation">)</span>\n        <span class="token keyword">const</span> conn <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Client</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n        conn\n          <span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;ready&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>\n            <span class="token comment">// 远程解压</span>\n            <span class="token keyword">const</span> remoteModule <span class="token operator">=</span> options<span class="token punctuation">.</span>remoteStatic<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">&#39;dist.tar.gz&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">)</span>\n            conn<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span>\n              <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">cd </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>remoteModule<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">;tar xvf dist.tar.gz</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>\n              <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> stream</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>\n                <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">throw</span> err\n                stream\n                  <span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;close&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">code</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>\n                    code <span class="token operator">===</span> <span class="token number">0</span>\n                    conn<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n                    <span class="token comment">// 解压完成 删除本地文件</span>\n                    fs<span class="token punctuation">.</span><span class="token function">unlink</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>localStatic<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>\n                      <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">throw</span> err\n                    <span class="token punctuation">}</span><span class="token punctuation">)</span>\n                  <span class="token punctuation">}</span><span class="token punctuation">)</span>\n                  <span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;data&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>\n              <span class="token punctuation">}</span>\n            <span class="token punctuation">)</span>\n          <span class="token punctuation">}</span><span class="token punctuation">)</span>\n          <span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span>\n    <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>\n      sftp<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span>\n<span class="token punctuation">}</span>\n\n<span class="token comment">// 上传文件</span>\n<span class="token function">upload</span><span class="token punctuation">(</span>config<span class="token punctuation">,</span> <span class="token punctuation">{</span>\n  <span class="token literal-property property">localStatic</span><span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> config<span class="token punctuation">.</span>localStatic<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 本地文件夹路径</span>\n  <span class="token literal-property property">remoteStatic</span><span class="token operator">:</span> config<span class="token punctuation">.</span>remoteStatic<span class="token punctuation">,</span> <span class="token comment">// 服务器文件夹路径器</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span>\n</code></pre></div><p><img src="/blog/_assets/upload-dist.a021593f.png" alt="upload-dist"></p><p>最后只要通过执行<code>yarn deploy</code>即可实现打包并上传，用了一段时间，队友也都觉得挺好用的，毕竟少了很多手动操作，效率大大提升。</p><h3 id="ci-cd-时代"><a class="header-anchor" href="#ci-cd-时代" aria-hidden="true">#</a> CI/CD 时代</h3><p>不过用了没多久后，来了个新的运维小年轻，一上来就整了个 Jenkins ，取代了我们手动打包的过程，只要我们点击部署就可以了，当时就感觉 Jenkins 挺方便的，但又觉得和前端没多大关系，也就没学习。</p><p>不过也挺<code>烦</code> Jenkins 的，为啥呢？</p><blockquote><p>当时和测试说的最多的就是“我在我这试试.....我这没问题啊，你刷新一下”，趁这个时候，赶紧打包重新部署下。有了 Jenkins 后，打包都有记录了，测试一看就知道我在哄她了 🙄</p></blockquote><h2 id="jenkins-解决了什么问题"><a class="header-anchor" href="#jenkins-解决了什么问题" aria-hidden="true">#</a> Jenkins 解决了什么问题</h2><p>我觉得在了解一个新事物前，应该先了解下它的出现解决了什么问题。</p><p>以我的亲身经历来看，Jenkins 的出现使得 <code>拉取代码 -&gt; 打包 -&gt; 部署 -&gt; 完成后工作（通知、归档、上传CDN等）</code>这一繁琐的流程不需要人为再去干预，一键触发 🛫。</p><p><img src="/blog/_assets/jenkins-vs-old.7fc3d2be.png" alt="jenkins-vs-old"></p><p>只需要点击开始构建即可，如何你觉得还得每次打开 jenkins 页面去点击构建，可以通过设置代码提交到 master 或合并代码时触发构建，这样就不用每次手动去点击构建了，省时更省力 🚴🏻‍♂️。</p><h2 id="jenkins-部署"><a class="header-anchor" href="#jenkins-部署" aria-hidden="true">#</a> Jenkins 部署</h2><p><a href="https://www.jenkins.io/zh/doc/" target="_blank" rel="noopener noreferrer">Jenkins 中文帮助文档</a></p><p>Jenkins 提供了多种<a href="https://www.jenkins.io/zh/download/" target="_blank" rel="noopener noreferrer">安装</a>方式，我的服务器是 Centos，按照<a href="https://mirrors.jenkins-ci.org/redhat/" target="_blank" rel="noopener noreferrer">官方教程</a>进行部署即可。</p><p>官方提供两种方式进行安装：</p><p>方式一：</p><div class="language-bash"><pre><code><span class="token function">sudo</span> <span class="token function">wget</span> -O /etc/yum.repos.d/jenkins.repo https://pkg.jenkins.io/redhat-stable/jenkins.repo\n<span class="token function">sudo</span> <span class="token function">rpm</span> --import https://pkg.jenkins.io/redhat-stable/jenkins.io.key\n\nyum <span class="token function">install</span> jenkins\n</code></pre></div><p>方式二：</p><p>直接下载 rpm 包进行安装，地址：<a href="https://mirrors.jenkins-ci.org/redhat/" target="_blank" rel="noopener noreferrer">https://mirrors.jenkins-ci.org/redhat/</a></p><div class="language-bash"><pre><code><span class="token function">wget</span> https://pkg.jenkins.io/redhat/jenkins-2.449-1.1.noarch.rpm\n<span class="token function">rpm</span> -ivh jenkins-2.449-1.1.noarch.rpm\n</code></pre></div><h3 id="安装过程"><a class="header-anchor" href="#安装过程" aria-hidden="true">#</a> 安装过程</h3><p>我是使用方式二进行安装的，来看下具体过程。</p><p>首先需要<strong>安装 jdk17 以上的版本</strong></p><ol><li><p>下载对应的 jdk</p><div class="language-bash"><pre><code><span class="token function">wget</span> https://download.oracle.com/java/17/latest/jdk-17_linux-x64_bin.tar.gz\n</code></pre></div></li><li><p>解压并放到合适位置</p><div class="language-bash"><pre><code><span class="token function">tar</span> xf jdk-17_linux-x64_bin.tar.gz\n<span class="token function">mv</span> jdk-17.0.8/ /usr/lib/jvm\n</code></pre></div></li><li><p>配置 Java 环境变量</p><div class="language-bash"><pre><code><span class="token function">vim</span> /etc/profile\n<span class="token builtin class-name">export</span> <span class="token assign-left variable">JAVA_HOME</span><span class="token operator">=</span>/usr/lib/jvm/jdk-17.0.8\n<span class="token builtin class-name">export</span> <span class="token assign-left variable">CLASSPATH</span><span class="token operator">=</span><span class="token variable">$JAVA_HOME</span>/lib:<span class="token variable">$JRE_HOME</span>/lib:<span class="token variable">$CLASSPATH</span>\n<span class="token builtin class-name">export</span> <span class="token assign-left variable"><span class="token environment constant">PATH</span></span><span class="token operator">=</span><span class="token variable">$JAVA_HOME</span>/bin:<span class="token variable">$JRE_HOME</span>/bin:<span class="token environment constant">$PATH</span>\n</code></pre></div></li><li><p>验证</p><div class="language-bash"><pre><code>java -version\n</code></pre></div><p><img src="/blog/_assets/jenkins-java-version.0e96ee21.png" alt="jenkins-java-version"></p></li></ol><p>接着安装 Jenkins，需要注意：<strong>Jenkins 一定要安装最新版本，因为插件要求最新版本</strong>，最新的 2.449。</p><ol><li><p>下载 rpm 包</p><div class="language-bash"><pre><code><span class="token builtin class-name">cd</span> /usr/local/jenkins\n<span class="token function">wget</span> https://mirrors.jenkins-ci.org/redhat/jenkins-2.449-1.1.noarch.rpm\n</code></pre></div></li><li><p>安装 Jenkins</p><div class="language-bash"><pre><code><span class="token function">rpm</span> -ivh jenkins-2.449-1.1.noarch.rpm\n</code></pre></div><p><img src="/blog/_assets/jenkins-install-2.449.88b5b58c.png" alt="jenkins-install-2.449"></p></li><li><p>启动 Jenkins</p><div class="language-bash"><pre><code>systemctl start jenkins\n</code></pre></div><p><img src="/blog/_assets/jenkins-install-error.6ef0890b.png" alt="jenkins-install-error"></p></li></ol><p>你以为就这么简单？肯定会报错的，通过百度报错信息，报错原因是：<strong>Java 环境不对</strong>，百度到的解决方法：</p><p>修改<code>/etc/init.d/jenkins</code>文件，添加 JDK，但是目录下并没有这个文件，继续百度得知：</p><p><strong>使用 <code>systemctl</code> 启动 jenkins 时，不会使用 <code>etc/init.d/jenkins</code> 配置文件，而是使用 <code>/usr/lib/systemd/system/jenkins.service</code>文件</strong>。</p><p>于是修改：</p><div class="language-bash"><pre><code><span class="token function">vim</span> /usr/lib/systemd/system/jenkins.service\n</code></pre></div><p><img src="/blog/_assets/jenkins-service-java.2c14c3ee.png" alt="jenkins-service-java"> 搜索 Java，找到上面这一行，打开注释，修改为对应的 JDK 位置：</p><div class="language-bash"><pre><code><span class="token assign-left variable">Environment</span><span class="token operator">=</span><span class="token string">&quot;JAVA_HOME=/usr/lib/jvm/jdk-17.0.10&quot;</span>\n</code></pre></div><p>重新启动 Jenkins：</p><div class="language-bash"><pre><code>systemctl restart jenkins\n</code></pre></div><p>查看启动状态，出现如下则说明 Jenkins 启动完成：</p><p><img src="/blog/_assets/jenkins-install-success.ef6059ec.png" alt="jenkins-install-success"></p><p>接着在浏览器通过 <code>ip:8090</code> 访问，出现如下页面，说明安装成功。</p><p><img src="/blog/_assets/jenkins-install-success-ip.8627075a.png" alt="jenkins-install-success-ip"></p><p>此时需要填写管理员密码，通过 <code>cat /var/lib/jenkins/secrets/initialAdminPassword</code> 即可获取。</p><h3 id="jenkins-配置"><a class="header-anchor" href="#jenkins-配置" aria-hidden="true">#</a> Jenkins 配置</h3><p>出现上述界面，填写密码成功后等待数秒，即可出现如下界面：</p><p><img src="/blog/_assets/jenkins-install-plugins.44936023.png" alt="jenkins-install-plugins"></p><p>选择 <code>安装推荐的插件</code></p><p><img src="/blog/_assets/jenkins-install-plugins-wait.72e54108.png" alt="jenkins-install-plugins-wait"></p><p>这个过程稍微有点慢，可以整理整理文档，等待安装完成。</p><p>安装完成后，会出现此页面，需要创建一个管理员用户。</p><p><img src="/blog/_assets/jenkins-install-ok.b4698e0e.png" alt="jenkins-install-ok"></p><p>点击开始使用 Jenkins，即可进入 Jenkins 首页。</p><p><img src="/blog/_assets/jenkins-home.adce1a29.png" alt="jenkins-home"></p><p>至此，Jenkins 安装完成 🎉🎉🎉。</p><h3 id="安装过程遇到的问题"><a class="header-anchor" href="#安装过程遇到的问题" aria-hidden="true">#</a> 安装过程遇到的问题</h3><ol><li><p>没有经验第一次安装，参考网上文档推荐的是 JDK8，结果安装的 Jenkins 至少需要 JDK 11，导致安装失败；</p></li><li><p>第二次安装，按照网上的文档安装，不是最新版本，导致部分插件安装失败；</p><p><a href="https://github.com/jenkinsci/jenkins/releases" target="_blank" rel="noopener noreferrer">release</a><a href="https://mirrors.jenkins-ci.org/redhat/" target="_blank" rel="noopener noreferrer">版本</a></p></li><li><p>配置修改问题</p><ul><li>Jenkins 默认的配置文件位于 <code>/usr/lib/systemd/system/jenkins.service</code></li><li>默认目录安装在 <code>/var/lib/jenkins/</code></li><li>默认工作空间在 <code>/var/lib/jenkins/workspace</code></li></ul></li><li><p>修改端口号为 <code>8090</code></p><div class="language-bash"><pre><code><span class="token function">vim</span> /usr/lib/systemd/system/jenkins.service\n</code></pre></div><p>修改 <code>Environment=&quot;JENKINS_PORT=8090&quot;</code>，修改完后执行：</p><div class="language-bash"><pre><code>systemctl daemon-reload\nsystemctl restart jenkins\n</code></pre></div></li></ol><h3 id="如何卸载-jenkins"><a class="header-anchor" href="#如何卸载-jenkins" aria-hidden="true">#</a> 如何卸载 Jenkins</h3><p>安装过程遇到了不少坑，基本都是卸载了重新安装，于是就总结了以下卸载的命令。</p><div class="language-bash"><pre><code><span class="token comment"># 查找是否存在 Jenkins 安装包</span>\n<span class="token function">rpm</span> -ql jenkins\n<span class="token comment"># 卸载 Jenkins</span>\n<span class="token function">rpm</span> -e jenkins\n<span class="token comment"># 再次查看 此时会提示：未安装软件包 jenkins</span>\n<span class="token function">rpm</span> -ql jenkins\n<span class="token comment"># 删除所有 Jenkins 相关目录</span>\n<span class="token function">find</span> / -iname jenkins <span class="token operator">|</span> <span class="token function">xargs</span> -n <span class="token number">1000</span> <span class="token function">rm</span> -rf\n</code></pre></div><h3 id="jenkins-版本更新"><a class="header-anchor" href="#jenkins-版本更新" aria-hidden="true">#</a> Jenkins 版本更新</h3><p>Jenkins 发布版本很频繁，基本为一周一次，参考 <a href="https://segmentfault.com/a/1190000022109648#item-2" target="_blank" rel="noopener noreferrer">Jenkins 更新</a></p><h2 id="项目创建"><a class="header-anchor" href="#项目创建" aria-hidden="true">#</a> 项目创建</h2><p>点击 <code>+ 新建Item</code>，输入名称，选择类型：</p><p><img src="/blog/_assets/jenkins-create-project.6323a31a.png" alt="jenkins-create-project"></p><p>有多种类型可供选择，这里我们主要讲这两种：Freestyle project 和 Pipeline。</p><h3 id="freestyle-project"><a class="header-anchor" href="#freestyle-project" aria-hidden="true">#</a> Freestyle project</h3><p><img src="/blog/_assets/jenkins-create-freestyle.6c52e3d9.jpeg" alt="jenkins-create-freestyle"></p><p>选择这种类型后，就可以通过各种 web 表单（基础信息、源码、构建步骤等），配置完整的构建步骤，对于新手来说，易上手且容易理解，如果第一次接触，创建项目就选择 Freestyle project 即可。</p><p>总共有以下几个环节需要配置：</p><ul><li>General</li><li>源码管理</li><li>构建触发器</li><li>构建环境</li><li>Build Steps</li><li>构建后操作</li></ul><p>此时我们点击 OK，创建完如下所示都是空白的，也可以通过创建时的<code>复制</code>选项，复制之前项目的配置：</p><p><img src="/blog/_assets/jenkins-create-configure.f757836b.png" alt="jenkins-create-configure"></p><p>接着就如同填写表单信息，一步步完成构建工作。</p><h4 id="general"><a class="header-anchor" href="#general" aria-hidden="true">#</a> General</h4><p>项目基本信息也就是对所打包项目的描述信息：</p><p><img src="/blog/_assets/jenkins-configure-general.6dd56687.png" alt="jenkins-configure-general"></p><p>比如描述这里，可以写项目名称、描述、输出环境等等。</p><h5 id="discard-old-builds-丢弃旧的构建"><a class="header-anchor" href="#discard-old-builds-丢弃旧的构建" aria-hidden="true">#</a> Discard old builds 丢弃旧的构建</h5><p>可以理解为<strong>清初构建历史</strong>，Jenkins 每打包一次就会产生一个构建历史记录，在<code>构建历史</code>中可以看到从第一次到最新的构建信息，这会导致磁盘空间消耗。</p><p>点击配置名称或勾选，会自动展开配置项。这里我们可以设置<code>保持构建的最大个数</code>为<code>5</code>，则当前项目的构建历史记录只会保留最新的 5 个，并自动删除掉最老的构建。</p><p><img src="/blog/_assets/jenkins-configure-discard.f3cd708d.png" alt="jenkins-configure-discard"></p><p>这个可以按照自己的需求来设置，比如保留 7 天的构建记录或保留最多 100 个构建记录。</p><p>Jenkins 的大多数配置都有 <code>高级</code> 选项，在高级选项中可以做更详细的配置。</p><h5 id="this-project-is-parameterized"><a class="header-anchor" href="#this-project-is-parameterized" aria-hidden="true">#</a> This project is parameterized</h5><p>可以理解为<strong>此构建后续过程可能用到的参数</strong>，可以是手动输入或选项等，如：git 分支、构建环境、特定的配置等等。通过这种方式，项目可以更加灵活和可配置，以适应不同的构建需求和环境。</p><p>默认有 8 种参数类型：</p><ol><li>Boolean Parameter: checkbox 选择，如果需要设置 true/false 值时，可以添加此参数类型</li><li>Choice Parameter：选择，多个选项</li><li>Credentials Parameter：账号证书等参数</li><li>File Parameter：文件上传</li><li>Multi-line String parameters：多行文本参数</li><li>Password Parameter：密码参数</li><li>Run Parameter：用于选择执行的 job</li><li>String Parameter：单行文本参数</li></ol><p><code>Git Parameter</code> 需要在 <code>系统管理 -&gt; 插件管理</code> 搜索 <code>Git Parameter</code> 插件进行安装，安装完成后重启才会有这个参数。</p><p>通过 <code>添加参数</code> 来设置后续会用到的参数，比如设置名称为 <code>delopyTag</code> 的 <code>Git Parameter</code> 参数来指定要构建的分支，设置名称为 <code>DEPLOYPATH</code> 的 <code>Choice Parameter</code> 参数来指定部署环境等等。</p><p><img src="/blog/_assets/jenkins-configure-parameter.22985ad1.png" alt="jenkins-configure-parameter"></p><h4 id="源码管理"><a class="header-anchor" href="#源码管理" aria-hidden="true">#</a> 源码管理</h4><h5 id="repositories"><a class="header-anchor" href="#repositories" aria-hidden="true">#</a> Repositories</h5><p>一般公司项目都是从 gitlab 上拉代码，首先设置 <code>Repository URL</code>，填写 git 仓库地址，比如：<code>https://gitlab.com/xxx/xxx.git</code></p><p>填写完后会报错如下：</p><p><img src="/blog/_assets/jenkins-configure-git-error.694ed24a.png" alt="jenkins-configure-git-error"></p><p>可以通过添加 Credentials 凭证解决，在 Jenkins 中，Git 的 Credentials 是用于访问 Git 仓库的认证信息，这些凭据可以是用户名和密码、SSH 密钥或其他认证机制，以确保 Jenkins 能够安全的与 Git 仓库进行交互，即构建过程中<strong>自动拉取代码、执行构建任务等</strong>。</p><h6 id="方式一：在当前页面填写帐号、密码"><a class="header-anchor" href="#方式一：在当前页面填写帐号、密码" aria-hidden="true">#</a> 方式一：在当前页面填写帐号、密码</h6><p>选择<code>添加 -&gt; Jenkins -&gt; 填写 git 用户名、密码</code>等信息生成一个新的 Credentials，然后重新选择我们刚刚添加的 Credentials，报错信息自动消失</p><p><img src="/blog/_assets/jenkins-configure-git.015381c4.png" alt="jenkins-configure-git"></p><p>这样添加会有一个问题，就是如果有多个项目时，每次都需要手动填写 Git 账户和密码信息。</p><h6 id="方式二：jenkins-全局凭证设置"><a class="header-anchor" href="#方式二：jenkins-全局凭证设置" aria-hidden="true">#</a> 方式二：Jenkins 全局凭证设置</h6><p>在 <a href="https://jk.qmpoa.com/manage/credentials/store/system/domain/_/" target="_blank" rel="noopener noreferrer">Global Credentials</a> 中设置全局的凭证。</p><p><img src="/blog/_assets/jenkins-configure-git-credentials.2e3d5b1a.png" alt="jenkins-configure-git-credentials"></p><p>然后在项目中配置时可以直接选择我们刚刚添加的 Credentials，报错信息自动消失。</p><h5 id="branches-to-build"><a class="header-anchor" href="#branches-to-build" aria-hidden="true">#</a> Branches to build</h5><p>这里构建的分支，可以设置为我们上面设置的 <code>delopyTag</code> 参数，即用户自己选择的分支进行构建。</p><h4 id="构建触发器"><a class="header-anchor" href="#构建触发器" aria-hidden="true">#</a> 构建触发器</h4><p>特定情况下出发构建，如<strong>定时触发、代码提交或合并时触发、其他任务完成时触发</strong>等。</p><p>如果没有特殊的要求时，这一步完全可以不用设置，在需要构建时我们只需要手动点击开始构建即可。</p><h4 id="构建环境"><a class="header-anchor" href="#构建环境" aria-hidden="true">#</a> 构建环境</h4><p>构建环境是在构建开始之前的准备工作，如<strong>清除上次构建、指定构建工具、设置 JDK 、Node 版本、生成版本号</strong>等。</p><h5 id="provide-node-npm-bin-folder-to-path"><a class="header-anchor" href="#provide-node-npm-bin-folder-to-path" aria-hidden="true">#</a> Provide Node &amp; npm bin/folder to PATH</h5><p>默认是没有这一项的，但前端部署需要 Node 环境支持，所以需要在 <code>系统管理 -&gt; 插件管理</code> 搜索 <code>nodejs</code> 插件进行安装，安装完成后重启才会展示这项配置。</p><p>但此时还是不能选择的，需要在 <code>系统管理 -&gt; 全局工具配置</code> 中先安装 NodeJs，根据不同环境配置，<strong>可同时安装多个 NodeJs 版本</strong>。</p><p><img src="/blog/_assets/jenkins-configure-nodeJs.578c2be1.png" alt="jenkins-configure-nodeJs"></p><p>之后在 <code>Provide Node</code> 处才有可供选择的 Node 环境。</p><p><img src="/blog/_assets/jenkins-configure-provide-node.fce9818f.png" alt="jenkins-configure-provide-node"></p><h5 id="create-a-formatted-version-number"><a class="header-anchor" href="#create-a-formatted-version-number" aria-hidden="true">#</a> Create a formatted version number</h5><p>这个就是我用来解决了一开始问题的配置项，也就是把每次打包的结果上传到 OSS 服务器上时生成一个新的版本号，在 Electron 项目中通过对比版本号，自动更新对应的 hybrid 包，领导都爱上我了 😜。</p><p>首先需要安装插件 <code>Version Number Plugin</code>，在 <code>系统管理 -&gt; 插件管理</code> 中搜索安装，然后重启 Jenkins 即可</p><p><img src="/blog/_assets/jenkins-configure-version.e4e73e7b.png" alt="jenkins-configure-version"></p><ol><li><p>Environment Variable Name</p><p>类似于第一步的构建参数，可以在其他地方使用。</p></li><li><p>Version Number Format String</p><p>用于设置版本号的格式，如<code>1.x.x</code>，Jenkins 提供了许多内置的环境变量：</p><ul><li><p>BUILD_DAY：生成的日期</p></li><li><p>BUILD_WEEK：生成年份中的一周</p></li><li><p>BUILD_MONTH：生成的月份</p></li><li><p>BUILD_YEAR：生成的年份</p></li><li><p>BUILDS_TAY：在此日历日期完成的生成数</p></li><li><p>BUILDS_THIS_WEEK：此日历周内完成的生成数</p></li><li><p>BUILDS_THIS_MONTH：此日历月内完成的生成数</p></li><li><p>BUILDS_THIS_YEAR：此日历年中完成的生成数</p></li><li><p>BUILDS_ALL_TIME：自项目开始以来完成的生成数</p></li></ul></li><li><p>勾选 Build Display Name Use the formatted version number for build display name 后</p><p>此时每次构建后就会生成一个个版本号：</p><p><img src="/blog/_assets/jenkins-configure-version-result.0d2c8af5.png" alt="jenkins-configure-version-result"></p></li><li><p>把这个参数传递到后续的 OSS 上传的 Shell 脚本中即可。</p></li></ol><p>如果想要重置版本号，只要设置<code>Number of builds since the start of the project</code>为 0 即可，此时就会从 <code>1.7.0</code> 重新开始。</p><h3 id="build-steps"><a class="header-anchor" href="#build-steps" aria-hidden="true">#</a> Build Steps</h3><p>这是最为重要的环节，主要用于定义整个构建过程的具体任务和操作，包括<strong>执行脚本、编译代码、打包应用</strong>等。</p><p>我们可以通过 Shell 脚本来完成前端项目常见的操作：安装依赖、打包、压缩、上传到 OSS 等。</p><p>点击 <code>增加构建步骤 -&gt; Execute shell</code>，在上方输入 shell 脚本，常见的如下：</p><div class="language-bash"><pre><code><span class="token comment">#环境变量</span>\n<span class="token builtin class-name">echo</span> <span class="token environment constant">$PATH</span>\n<span class="token comment">#node版本号</span>\n<span class="token function">node</span> -v\n<span class="token comment">#npm版本号</span>\n<span class="token function">npm</span> -v\n\n\n<span class="token comment">#进入jenkins workspace的项目目录</span>\n<span class="token builtin class-name">echo</span> <span class="token variable">${WORKSPACE}</span>\n<span class="token builtin class-name">cd</span> <span class="token variable">${WORKSPACE}</span>\n\n<span class="token comment">#下载依赖包</span>\n<span class="token function">yarn</span>\n<span class="token comment">#开始打包</span>\n<span class="token function">yarn</span> run build\n\n<span class="token comment">#进入到打包目录</span>\n<span class="token builtin class-name">cd</span> dist\n<span class="token comment">#删除上次打包生成的压缩文件</span>\n<span class="token function">rm</span> -rf *.tar.gz\n\n<span class="token comment">#上传oss，如果没有需要可删除此段代码</span>\n<span class="token assign-left variable">ossurl</span><span class="token operator">=</span><span class="token string">&quot;xxx&quot;</span>\n<span class="token function">curl</span> <span class="token string">&quot;xxx&quot;</span> <span class="token operator">&gt;</span> RELEASES.json\n<span class="token function">node</span> deploy-oss.cjs -- <span class="token assign-left variable">accessKeyId</span><span class="token operator">=</span><span class="token variable">$OSS_KEY</span> <span class="token assign-left variable">accessKeySecret</span><span class="token operator">=</span><span class="token variable">$OSS_SECRET</span> <span class="token assign-left variable">zipDir</span><span class="token operator">=</span>tmp.zip <span class="token assign-left variable">ossUrl</span><span class="token operator">=</span>xxx/v<span class="token variable">${BUILD_VERSION}</span>.zip\n<span class="token function">node</span> deploy-oss.cjs -- <span class="token assign-left variable">accessKeyId</span><span class="token operator">=</span><span class="token variable">$OSS_KEY</span> <span class="token assign-left variable">accessKeySecret</span><span class="token operator">=</span><span class="token variable">$OSS_SECRET</span> <span class="token assign-left variable">zipDir</span><span class="token operator">=</span>RELEASES.json <span class="token assign-left variable">ossUrl</span><span class="token operator">=</span>xxx/RELEASES.json\n\n<span class="token comment">#把生成的项目打包成压缩包方便传输到远程服务器</span>\n<span class="token function">tar</span> -zcvf <span class="token variable"><span class="token variable">`</span><span class="token function">date</span> +%Y%m%d%H%M%S<span class="token variable">`</span></span>.tar.gz *\n<span class="token comment">#回到上层工作目录</span>\n<span class="token builtin class-name">cd</span> <span class="token punctuation">..</span>/\n</code></pre></div><h3 id="构建后操作"><a class="header-anchor" href="#构建后操作" aria-hidden="true">#</a> 构建后操作</h3><p>通过上面的构建步骤，我们已经完成了项目的打包，此时我们需要执行一些后续操作，如<strong>部署应用、发送通知、触发其他 Job</strong>等操作。</p><h4 id="send-build-artifacts-over-ssh"><a class="header-anchor" href="#send-build-artifacts-over-ssh" aria-hidden="true">#</a> Send build artifacts over SSH</h4><p>通过 Send build artifacts over SSH，我们可以将构建好的产物（<strong>一般是压缩后的文件</strong>）通过 ssh 发送到指定的服务器上用于部署，比如 Jenkins 服务器是 10.10，需要将压缩文件发送到 10.11 服务器进行部署，需要以下步骤：</p><ol><li><p>安装插件</p><p>在 <code>系统管理 -&gt; 插件管理</code> 中搜索插件 <code>Publish over SSH</code> 安装，用于处理文件上传工作；</p></li><li><p>配置服务器信息</p><p>在 <code>系统管理 -&gt; System</code> 中搜索 <code>Publish over SSH</code> 进行配置。</p><p><img src="/blog/_assets/jenkins-publish-over-SSH.54300329.png" alt="jenkins-publish-over-SSH"></p><p>需要填写用户名、密码、服务器地址等信息，完成后点击 <code>Test Configuration</code>，如果配置正确，会显示 <code>Success</code>，否则会出现报错信息。</p><p>这里有两种方式连接远程服务器，第一种是<strong>密码方式</strong>，输入服务器账户密码等信息即可；</p><p>第二种是<strong>秘钥方式</strong>，在服务器生成密钥文件，并且将私钥<strong>全部拷贝</strong>，记住是全部，要携带<strong>起止标志-----BEGIN RSA PRIVATE KEY-----或-----END RSA PRIVATE KEY----</strong>，粘贴在 <code>高级 -&gt; key</code> 即可。</p><p>此处的 <code>Remote Directory</code> 是远程服务器接收 Jenkins 打包产物的目录，<strong>必须在对应的服务器手动创建目录</strong>，如 <code>/home/jenkins</code>。</p></li><li><p>项目配置</p><p>选择需要上传的服务器，接着设置需要传输的文件，执行脚本，移动文件到对应的目录。</p><p><img src="/blog/_assets/jenkins-configure-ssh.ec4aa3ed.png" alt="jenkins-configure-ssh"></p></li></ol><h5 id="transfer-set-参数配置"><a class="header-anchor" href="#transfer-set-参数配置" aria-hidden="true">#</a> Transfer Set 参数配置</h5><ul><li><p><code>Source files</code>：需要传输的文件，也就是通过上一步 Build Steps 后生成的压缩文件，这个路径是相对于“工作空间”的路径，即只需要输入 <code>dist/*.tar.gz</code> 即可</p></li><li><p><code>Remove prefix</code>：删除传输文件指定的前缀，如 <code>Source files</code> 设置为<code>dist/*.tar.gz</code> ，此时设置 <code>Remove prefix</code> 为<code>/dist</code>，移除前缀，只传输 <code>*.tar.gz</code> 文件；如果不设置酒会传输 <code>dist/*.tar.gz</code> 包含了 dist 整个目录，并且会自动在上传后的服务器中创建 <code>/dist</code> 这个路径。如果只需要传输压缩包，则移除前缀即可</p></li><li><p><code>Remote directory</code>：文件传输到远程服务器上的具体目录，会与 Publish over SSH 插件系统配置中的 <code>Remote directory</code> 进行拼接，如我们之前设置的目录是 <code>/home/jenkins</code>，此处在写入 <code>qmp_pc_ddm</code>，那么最终上传的路径为 <code>/home/jenkins/qmp_pc_ddm</code>，与之前不同的是，如果此路径不存在时会自动创建，这样设置后，Jenkins 服务器构建后的产物会通过 ssh 上传到此目录，供下一步使用。</p></li><li><p><code>Exec command</code></p><p>文件传输完成后执行自定义 Shell 脚本，比如移动文件到指定目录、解压文件、启动服务等。</p><div class="language-bash"><pre><code><span class="token shebang important">#!/bin/bash</span>\n\n<span class="token comment">#进入远程服务器的目录</span>\n<span class="token assign-left variable">project_dir</span><span class="token operator">=</span>/usr/local/nginx/qmp_pc_ddm/<span class="token variable">${DEPLOYPATH}</span>\n<span class="token builtin class-name">cd</span> <span class="token variable">$project_dir</span>\n\n<span class="token comment">#移动压缩包</span>\n<span class="token function">sudo</span> <span class="token function">mv</span> /home/jenkins/qmp_pc_ddm/*.tar.gz  <span class="token builtin class-name">.</span>\n\n<span class="token comment">#找到新的压缩包</span>\n<span class="token assign-left variable">new_dist</span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span><span class="token function">ls</span> -ltr *.tar.gz <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">&#39;{print $NF}&#39;</span> <span class="token operator">|</span><span class="token function">tail</span> -1<span class="token variable">`</span></span>\n<span class="token builtin class-name">echo</span> <span class="token variable">$new_dist</span>\n\n<span class="token comment">#解压缩</span>\n<span class="token function">sudo</span> <span class="token function">tar</span> -zxvf <span class="token variable">$new_dist</span>\n\n<span class="token comment">#删除压缩包</span>\n<span class="token function">sudo</span> <span class="token function">rm</span> *.tar.gz\n</code></pre></div><p>这一步可以使用之前定义的参数，如 <code>${DEPLOYPATH}</code>，以及 Jenkins 提供的变量：如 <code>${WORKSPACE}</code> 来引用 Jenkins 的工作空间路径等。</p></li></ul><h4 id="build-other-projects"><a class="header-anchor" href="#build-other-projects" aria-hidden="true">#</a> Build other projects</h4><p>添加 Build other projects，在项目构建成功后，触发相关联的应用开始打包。</p><p><img src="/blog/_assets/jenkins-configure-other.a2614ac8.png" alt="jenkins-configure-other"></p><p>另外还可以配置企业微信通知、生成构建报告等工作。</p><p>此时，所有的配置都设置完成，我们点击<code>保存</code>配置，返回到构建页。</p><h2 id="构建"><a class="header-anchor" href="#构建" aria-hidden="true">#</a> 构建</h2><p><img src="/blog/_assets/jenkins-start-build.ee9694e5.png" alt="jenkins-start-build"></p><p>点击 <code>Build with parameters</code> 选择对应的分支和部署环境，点击<code>开始构建</code></p><p>在控制台输出中，可以看到打包的详细过程，</p><p>可以看到我们在<code>Build Steps</code>中执行的 Shell 脚本的输出如下：</p><p><img src="/blog/_assets/jenkins-result-build.bc3fdcc5.png" alt="jenkins-result-build"></p><p>以及我们通过 Publish Over SSH 插件将构建产物传输的指定服务器的输出：</p><p><img src="/blog/_assets/jenkins-result-ssh.363bb7b1.png" alt="jenkins-result-ssh"></p><p>最终需要部署的服务器就有了以下文件：</p><p><img src="/blog/_assets/jenkins-remote-directory.4f2b93d9.png" alt="jenkins-remote-directory"></p><h3 id="pipeline"><a class="header-anchor" href="#pipeline" aria-hidden="true">#</a> Pipeline</h3><p>对于简单的构建需求或新手用户来说，我们可以直接选择 FreeStyle project。而对于复杂的构建流程或需要更高灵活性和扩展性的场景来说，Pipeline 则更具优势。</p><p>通过 <code>新建任务 -&gt; 流水线</code> 创建一个流水线项目。</p><p><img src="/blog/_assets/jenkins-pipeline-white.5f8d32b8.png" alt="jenkins-pipeline-white"></p><p>开始配置前请先阅读下<a href="https://www.jenkins.io/zh/doc/book/pipeline/" target="_blank" rel="noopener noreferrer">流水线</a>章节。</p><h3 id="生成方式"><a class="header-anchor" href="#生成方式" aria-hidden="true">#</a> 生成方式</h3><p>首先，Jenkins 流水线是一套插件，在最开始的插件推荐安装时会自动安装，如果选择自定义安装时，需要手动安装这一套插件。</p><p>Jenkins 流水线的定义有两种方式：<code>Pipeline script</code> 和 <code>Pipeline script from SCM</code>。 <img src="/blog/_assets/jenkins-pipeline-type.12077a7d.png" alt="jenkins-pipeline-type"></p><h4 id="pipeline-script"><a class="header-anchor" href="#pipeline-script" aria-hidden="true">#</a> Pipeline script</h4><p>Pipeline script 是直接在 Jenkins 页面的配置中写脚本，<strong>可直接定义和执行</strong>，比较直观。</p><p><img src="/blog/_assets/jenkins-pipeline-page.0f4696d2.png" alt="jenkins-pipeline-page"></p><h4 id="pipeline-script-from-scm"><a class="header-anchor" href="#pipeline-script-from-scm" aria-hidden="true">#</a> Pipeline script from SCM</h4><p>Pipeline script from SCM 是将脚本文件和项目代码放在一起，即 <code>Jenkinsfile</code>，也可自定义名称。</p><p><img src="/blog/_assets/jenkins-pipeline-code.6ec3c322.png" alt="jenkins-pipeline-code"></p><p>当 Jenkins 执行构建任务时，会从 git 中拉取该仓库到本地，然后读取 <code>Jenkinsfile</code> 的内容执行相应步骤，通常<strong>认为在 <code>Jenkinsfile</code> 中定义并检查源代码控制是最佳实践</strong>。</p><p>当选择 <code>Pipeline script from SCM</code> 后，需要设置 SCM 为 <code>git</code>，告诉 Jenkins 从指定的 Git 仓库中拉取包含 Pipeline 脚本的文件。</p><p><img src="/blog/_assets/jenkins-pipeline-code-scm.2a18d75a.png" alt="jenkins-pipeline-code-scm"></p><p>如果没有对应的文件时，任务会失败并发出报错信息。</p><p><img src="/blog/_assets/jenkins-pipeline-code-error.4832540a.png" alt="jenkins-pipeline-code-error"></p><h3 id="重要概念"><a class="header-anchor" href="#重要概念" aria-hidden="true">#</a> 重要概念</h3><p>了解完上面的基础配置，我们先找一段示例代码，粘贴在项目的配置中：</p><div class="language-bash"><pre><code>pipeline <span class="token punctuation">{</span>\n  agent any\n    stages <span class="token punctuation">{</span>\n      stage<span class="token punctuation">(</span><span class="token string">&#39;Build&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        steps <span class="token punctuation">{</span>\n          <span class="token builtin class-name">echo</span> <span class="token string">&#39;Build&#39;</span>\n        <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span>\n      stage<span class="token punctuation">(</span><span class="token string">&#39;Test&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        steps <span class="token punctuation">{</span>\n          <span class="token builtin class-name">echo</span> <span class="token string">&#39;Test&#39;</span>\n        <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span>\n      stage<span class="token punctuation">(</span><span class="token string">&#39;Deploy&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        steps <span class="token punctuation">{</span>\n          <span class="token builtin class-name">echo</span> <span class="token string">&#39;Deploy&#39;</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n</code></pre></div><p>看下它的输出结果：</p><p><img src="/blog/_assets/jenkins-pipeline-result.937afc3d.png" alt="jenkins-pipeline-result"></p><p>接着看一下上面语法中几个重要的概念。</p><h4 id="流水线-pipline"><a class="header-anchor" href="#流水线-pipline" aria-hidden="true">#</a> 流水线 pipline</h4><p>定义了整个项目的构建过程, 包括：构建、测试和交付应用程序的阶段。</p><p><strong>流水线顶层必须是一个 block，pipeline{}</strong>，作为整个流水线的根节点，如下：</p><div class="language-js"><pre><code>pipeline <span class="token punctuation">{</span>\n  <span class="token comment">/* insert Declarative Pipeline here */</span>\n<span class="token punctuation">}</span>\n</code></pre></div><h4 id="节点-agent"><a class="header-anchor" href="#节点-agent" aria-hidden="true">#</a> 节点 agent</h4><p>agent 用来指定在哪个代理节点上执行构建，即执行流水线，可以设置为 <code>any</code>，表示 Jenkins 可以在任何可用的代理节点上执行构建任务。</p><p>但一般在实际项目中，为了满足更复杂的构建需求，提高构建效率和资源利用率，以及确保构建环境的一致性，会根据项目的具体需求和资源情况，设置不同的代理节点来执行流水线。</p><p>如：</p><div class="language-js"><pre><code>pipeline <span class="token punctuation">{</span>\n  agent <span class="token punctuation">{</span>\n        node <span class="token punctuation">{</span>\n            label <span class="token string">&#39;slave_2_34&#39;</span>\n        <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n    <span class="token operator">...</span>\n<span class="token punctuation">}</span>\n</code></pre></div><p>可以通过 <code>系统管理 -&gt; 节点列表</code> 增加节点，可以看到默认有一个 master 节点，主要负责协调和管理整个 Jenkins 系统的运行，包括任务的调度、代理节点的管理、插件的安装和配置等。</p><p><img src="'+e+'" alt="jenkins-agent-master"></p><h4 id="阶段-stage"><a class="header-anchor" href="#阶段-stage" aria-hidden="true">#</a> 阶段 stage</h4><p>定义流水线的执行过程，如：Build、Test 和 Deploy，可以在可视化的查看目前的状态/进展。</p><p>注意：<strong>参数可以传入任何内容</strong>。不一定非得 <code>Build</code>、<code>Test</code>，也可以传入 <code>打包</code>、<code>测试</code>，与红框内的几个阶段名对应。</p><p><img src="/blog/_assets/jenkins-pipeline-console.f56b208d.png" alt="jenkins-pipeline-console"></p><h4 id="步骤-steps"><a class="header-anchor" href="#步骤-steps" aria-hidden="true">#</a> 步骤 steps</h4><p>执行某阶段具体的步骤。</p><h3 id="语法"><a class="header-anchor" href="#语法" aria-hidden="true">#</a> 语法</h3><p>了解上述概念后，我们仅仅只能看懂一个 Pipeline script 脚本，但距离真正的动手写还有点距离，此时就需要来了解下<a href="https://www.jenkins.io/zh/doc/book/pipeline/syntax/" target="_blank" rel="noopener noreferrer">流水线语法</a>。</p><p>我将上面通过 Freestyle project 的脚本翻译成 Pipeline script 的语法：</p><div class="language-groovy"><pre><code>pipeline <span class="token punctuation">{</span>\n    agent any\n    triggers <span class="token punctuation">{</span>\n        <span class="token function">gitlab</span><span class="token punctuation">(</span>triggerOnPush<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> triggerOnMergeRequest<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> branchFilterType<span class="token punctuation">:</span> <span class="token string">&#39;All&#39;</span><span class="token punctuation">)</span>\n    <span class="token punctuation">}</span>\n    parameters <span class="token punctuation">{</span>\n     gitParameter branchFilter<span class="token punctuation">:</span> <span class="token string">&#39;origin/(.*)&#39;</span><span class="token punctuation">,</span> defaultValue<span class="token punctuation">:</span> <span class="token string">&#39;master&#39;</span><span class="token punctuation">,</span> name<span class="token punctuation">:</span> <span class="token string">&#39;delopyTag&#39;</span><span class="token punctuation">,</span> type<span class="token punctuation">:</span> <span class="token string">&#39;PT_BRANCH&#39;</span>\n    <span class="token punctuation">}</span>\n    stages <span class="token punctuation">{</span>\n        <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">&#39;拉取代码&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n          steps <span class="token punctuation">{</span>\n            git branch<span class="token punctuation">:</span> <span class="token interpolation-string"><span class="token string">&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token expression">params<span class="token punctuation">.</span>delopyTag</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">,</span> credentialsId<span class="token punctuation">:</span> <span class="token string">&#39;xxx&#39;</span><span class="token punctuation">,</span> url<span class="token punctuation">:</span> <span class="token string">&#39;https://xxx/fe/qmp_doc_hy.git&#39;</span>\n          <span class="token punctuation">}</span>\n        <span class="token punctuation">}</span>\n        <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">&#39;安装依赖&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n          steps <span class="token punctuation">{</span>\n            <span class="token function">nodejs</span><span class="token punctuation">(</span><span class="token string">&#39;node-v16.20.2&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n              sh <span class="token string">&#39;&#39;&#39;\n                #!/bin/bash\n                source /etc/profile\n                echo &quot;下载安装包&quot;\n                yarn config set registry https://registry.npmmirror.com\n                yarn\n              &#39;&#39;&#39;</span>\n            <span class="token punctuation">}</span>\n            sleep <span class="token number">5</span>\n          <span class="token punctuation">}</span>\n        <span class="token punctuation">}</span>\n        <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">&#39;编译&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n          steps <span class="token punctuation">{</span>\n            sh <span class="token string">&#39;&#39;&#39;\n              #!/bin/bash\n              source /etc/profile\n              yarn run build\n              sleep 5\n              if [ -d dist ];then\n                cd dist\n                rm -rf *.tar.gz\n\n                tar -zcvf `date +%Y%m%d%H%M%S`.tar.gz *\n              fi\n            &#39;&#39;&#39;</span>\n            sleep <span class="token number">5</span>\n          <span class="token punctuation">}</span>\n        <span class="token punctuation">}</span>\n        <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">&#39;解压&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n          steps <span class="token punctuation">{</span>\n            echo <span class="token string">&#39;解压&#39;</span>\n            <span class="token function">sshPublisher</span><span class="token punctuation">(</span>\n                publishers<span class="token punctuation">:</span> <span class="token punctuation">[</span>\n                    <span class="token function">sshPublisherDesc</span><span class="token punctuation">(</span>\n                        configName<span class="token punctuation">:</span> <span class="token string">&#39;server(101.201.181.27)&#39;</span><span class="token punctuation">,</span><span class="token punctuation">,</span>\n                        transfers<span class="token punctuation">:</span> <span class="token punctuation">[</span>\n                            <span class="token function">sshTransfer</span><span class="token punctuation">(</span>\n                                cleanRemote<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>\n                                excludes<span class="token punctuation">:</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">,</span>\n                                execCommand<span class="token punctuation">:</span> <span class="token string">&#39;&#39;&#39;#!/bin/bash\n                                  #进入远程服务器的目录\n                                  project_dir=/usr/local/nginx/qmp_pc_ddm_${DEPLOYPATH}/${DEPLOYPATH}\n                                  if [ ${DEPLOYPATH} == &quot;ddm&quot;  ]; then\n                                     project_dir=/usr/local/nginx/qmp_pc_ddm/dist\n                                  fi\n                                  cd $project_dir\n\n                                  sudo mv /home/jenkins/qmp_pc_ddm/*.tar.gz  .\n\n                                  #找到新的压缩包\n                                  new_dist=`ls -ltr *.tar.gz | awk \\&#39;{print $NF}\\&#39; |tail -1`\n\n                                  #解压缩\n                                  sudo tar -zxvf $new_dist\n\n                                  #删除压缩包\n                                  sudo rm *.tar.gz\n\n                                  #发布完成\n                                  echo &quot;环境发布完成&quot;\n                                &#39;&#39;&#39;</span><span class="token punctuation">,</span>\n                                execTimeout<span class="token punctuation">:</span> <span class="token number">120000</span><span class="token punctuation">,</span>\n                                flatten<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>\n                                makeEmptyDirs<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>\n                                noDefaultExcludes<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>\n                                patternSeparator<span class="token punctuation">:</span> <span class="token string">&#39;[, ]+&#39;</span><span class="token punctuation">,</span>\n                                remoteDirectory<span class="token punctuation">:</span> <span class="token string">&#39;qmp_pc_ddm&#39;</span><span class="token punctuation">,</span>\n                                remoteDirectorySDF<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>\n                                removePrefix<span class="token punctuation">:</span> <span class="token string">&#39;dist/&#39;</span><span class="token punctuation">,</span>\n                                sourceFiles<span class="token punctuation">:</span> <span class="token string">&#39;dist/*.tar.gz&#39;</span>\n                            <span class="token punctuation">)</span>\n                        <span class="token punctuation">]</span><span class="token punctuation">,</span>\n                        usePromotionTimestamp<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>\n                        useWorkspaceInPromotion<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>\n                        verbose<span class="token punctuation">:</span> <span class="token boolean">false</span>\n                    <span class="token punctuation">)</span>\n                <span class="token punctuation">]</span>\n            <span class="token punctuation">)</span>\n          <span class="token punctuation">}</span>\n        <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n    post <span class="token punctuation">{</span>\n        success  <span class="token punctuation">{</span>\n          echo <span class="token string">&#39;success.&#39;</span>\n          <span class="token function">deleteDir</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n        <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n</code></pre></div><p>接下来，我们一起来解读下这个文件。</p><p>首先，所有的指令都是包裹在 <code>pipeline{}</code> 块中，</p><h4 id="agent"><a class="header-anchor" href="#agent" aria-hidden="true">#</a> agent</h4><p>enkins 可以在任何可用的代理节点上执行构建任务。</p><h4 id="environment"><a class="header-anchor" href="#environment" aria-hidden="true">#</a> <a href="https://www.jenkins.io/zh/doc/book/pipeline/syntax/#environment" target="_blank" rel="noopener noreferrer">environment</a></h4><p>用于定义环境变量，它们会保存为 Groovy 变量和 Shell 环境变量：定义流水线中的所有步骤可用的环境变量 <code>temPath</code>，在后续可通过 <code>$tmpPath</code> 来使用；</p><p>环境变量可以在全局定义，也可在 stage 里单独定义，全局定义的在整个生命周期里可以使用，在 stage 里定义的环境变量只能在当前步骤使用。</p><p>Jenkins 有一些内置变量也可以通过 env 获取（env 也可以读取用户自己定义的环境变量）。</p><div class="language-js"><pre><code>steps <span class="token punctuation">{</span>\n    echo <span class="token string">&quot;Running ${env.BUILD_ID} on ${env.JENKINS_URL}&quot;</span>\n<span class="token punctuation">}</span>\n</code></pre></div><p>这些变量都是 String 类型，常见的内置变量有：</p><ul><li>BUILD_NUMBER：Jenkins 构建序号；</li><li>BUILD_TAG：比如 jenkins-${JOB_NAME}-${BUILD_NUMBER}；</li><li>BUILD_URL：Jenkins 某次构建的链接；</li><li>NODE_NAME：当前构建使用的机器</li></ul><h4 id="parameters"><a class="header-anchor" href="#parameters" aria-hidden="true">#</a> <a href="https://www.jenkins.io/zh/doc/book/pipeline/syntax/#%E5%8F%82%E6%95%B0" target="_blank" rel="noopener noreferrer">parameters</a></h4><p>定义流水线中可以接收的参数，如上面脚本中的 gitParameter，只有安装了 Git Parameters 插件后才能使用，name 设置为<code>delopyTag</code>，在后续可通过 <code>${params.delopyTag}</code> 来使用；</p><p>还有以下参数类型可供添加：</p><div class="language-js"><pre><code>parameters <span class="token punctuation">{</span>\n  <span class="token function">booleanParam</span><span class="token punctuation">(</span>name<span class="token operator">:</span> <span class="token string">&#39;isOSS&#39;</span><span class="token punctuation">,</span> <span class="token literal-property property">defaultValue</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token literal-property property">description</span><span class="token operator">:</span> <span class="token string">&#39;是否上传OSS&#39;</span><span class="token punctuation">)</span>\n  <span class="token function">choice</span><span class="token punctuation">(</span>name<span class="token operator">:</span> <span class="token string">&#39;select&#39;</span><span class="token punctuation">,</span> <span class="token literal-property property">choices</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&#39;A&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;B&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;C&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token literal-property property">description</span><span class="token operator">:</span> <span class="token string">&#39;选择&#39;</span><span class="token punctuation">)</span>\n  <span class="token function">string</span><span class="token punctuation">(</span>name<span class="token operator">:</span> <span class="token string">&#39;temp&#39;</span><span class="token punctuation">,</span> <span class="token literal-property property">defaultValue</span><span class="token operator">:</span> <span class="token string">&#39;/temp&#39;</span><span class="token punctuation">,</span> <span class="token literal-property property">description</span><span class="token operator">:</span> <span class="token string">&#39;默认路径&#39;</span><span class="token punctuation">)</span>\n  <span class="token function">text</span><span class="token punctuation">(</span>name<span class="token operator">:</span> <span class="token string">&#39;showText&#39;</span><span class="token punctuation">,</span> <span class="token literal-property property">defaultValue</span><span class="token operator">:</span> <span class="token string">&#39;Hello\\nWorld&#39;</span><span class="token punctuation">,</span> <span class="token literal-property property">description</span><span class="token operator">:</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">)</span>\n  <span class="token function">password</span><span class="token punctuation">(</span>name<span class="token operator">:</span> <span class="token string">&#39;Password&#39;</span><span class="token punctuation">,</span> <span class="token literal-property property">defaultValue</span><span class="token operator">:</span> <span class="token string">&#39;123&#39;</span><span class="token punctuation">,</span> <span class="token literal-property property">description</span><span class="token operator">:</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">)</span>\n<span class="token punctuation">}</span>\n</code></pre></div><h4 id="triggers"><a class="header-anchor" href="#triggers" aria-hidden="true">#</a> <a href="https://www.jenkins.io/zh/doc/book/pipeline/syntax/#%E8%A7%A6%E5%8F%91%E5%99%A8" target="_blank" rel="noopener noreferrer">triggers</a></h4><p>定义了流水线被重新触发的自动化方法，上面的配置是：当 Git 仓库有新的 push 操作时触发构建</p><h4 id="stages-阶段"><a class="header-anchor" href="#stages-阶段" aria-hidden="true">#</a> stages 阶段</h4><ul><li><p>阶段一：拉取代码</p><p>git：拉取代码，参数 <code>branch</code> 为分支名，我们使用上面定义的 <code>${params.delopyTag}</code>，<code>credentialsId</code> 以及 <code>url</code>，如果不知道怎么填，可以在 <code>流水线语法 -&gt; 片段生成器</code> 中填写对应信息后，自动生成，如下：</p><p><img src="/blog/_assets/jenkins-stage-git.86a6be47.png" alt="jenkins-stage-git"></p><p>再复制到此处即可。</p></li><li><p>阶段二：安装依赖</p><p>在 <code>steps</code> 中，<code>sh</code> 是 Jenkins pipeline 的语法，通过它来执行 shell 脚本。</p><p><code>#!/bin/bash</code>表示使用 bash 脚本； <code>source /etc/profile</code> 用于将指定文件中的环境变量和函数导入当前 shell。</p><p>执行 <code>yarn</code> 安装依赖。</p></li><li><p>阶段三：编译</p><p>执行 <code>yarn build</code> 打包，</p><p><code>if [ -d dist ];</code> 是 shell 脚本中的语法，用于测试 <code>dist</code> 目录是否存在，通过脚本将打包产物打成一个压缩包。</p></li><li><p>阶段四：解压</p><p>将上步骤生成的压缩包，通过 <code>Publish over SSH</code> 发送到指定服务器的指定位置，执行 Shell 命令解压。</p><p>不会写 <code>Publish over SSH</code> 怎么办？同样，可以在 <code>流水线语法 -&gt; 片段生成器</code> 中填写对应信息后，自动生成，如下：</p><p><img src="/blog/_assets/jenkins-generate-publish.872a08c3.png" alt="jenkins-generate-publish"></p></li></ul><h4 id="post"><a class="header-anchor" href="#post" aria-hidden="true">#</a> <a href="https://www.jenkins.io/zh/doc/book/pipeline/syntax/#post" target="_blank" rel="noopener noreferrer">post</a></h4><p>当流水线的完成状态为 <code>success</code>，输出 success。</p><p>deleteDir() 函数用于删除当前工作目录中的所有文件和子目录。这通常用于清理工作区，确保在下一次构建之前工作区是干净的，以避免由于残留文件或目录引起的潜在问题。</p><h3 id="构建看看效果"><a class="header-anchor" href="#构建看看效果" aria-hidden="true">#</a> 构建看看效果</h3><p>可以直接通过 <code>Console Output</code> 查看控制台输出，当然在流水线项目中自然要通过流水线去查看了。</p><p><img src="/blog/_assets/jenkins-pipeline-result-in.de7b7c1f.png" alt="jenkins-pipeline-result-in"></p><ol><li><p>效果一</p><p><img src="/blog/_assets/jenkins-pipeline-result1.2d48ed21.png" alt="jenkins-pipeline-result1"></p><p>Pipeline Overview 中记录了每个步骤的执行情况、开始时间和耗时等信息，但是没有详细信息，详细信息就要在 Pipeline Console 中进行查看。</p></li><li><p>效果二</p><p>安装插件 <code>Blue Ocean</code>，相当于同时结合了 Pipeline Overview 和 Pipeline Console，可以同时看到每个步骤的执行情况等基本信息，以及构建过程中的详细信息。</p><p><img src="/blog/_assets/jenkins-pipeline-result2.6e3a631a.png" alt="jenkins-pipeline-result2"></p><p>通过 Blue Ocean 也可以直接创建流水线，选择代码仓库，然后填写对应的字段，即可快速创建流水线项目，如创建 gitlab 仓库：</p><p><img src="/blog/_assets/jenkins-blue-create.de5965d6.png" alt="jenkins-blue-create"></p><p>或者直接连接 github 仓库，需要 token，直接点击红框去创建即可：</p><p><img src="/blog/_assets/jenkins-blue-create1.1d625fb6.png" alt="jenkins-blue-create1"></p></li></ol><h3 id="通过项目中的-jenkinsfile-构建"><a class="header-anchor" href="#通过项目中的-jenkinsfile-构建" aria-hidden="true">#</a> 通过项目中的 Jenkinsfile 构建</h3><p>再把对应的 Pipeline script 代码复制到对应代码仓库的 <code>Jenkinsfile</code> 文件，设置为 Pipeline script from SCM，填写 git 信息。</p><p><img src="/blog/_assets/jenkins-pipeline-config-scm.0838cb45.png" alt="jenkins-pipeline-config-scm"></p><p>正常情况下，Jenkins 会自动检测代码仓库的 <code>Jenkinsfile</code> 文件，如果选择的文件没有 Jenkinsfile 文件时就会报错，如下：</p><p><img src="/blog/_assets/jenkins-pipeline-scm-error.914a8959.png" alt="jenkins-pipeline-scm-error"></p><p>正常按照流水线的执行流程，打开 Blue Ocean，查看构建结果，如下：</p><p><img src="/blog/_assets/jenkins-pipeline-scm-result.e0f72ce2.png" alt="jenkins-pipeline-scm-result"></p><h3 id="片段生成器"><a class="header-anchor" href="#片段生成器" aria-hidden="true">#</a> 片段生成器</h3><p>如果你觉得上述代码手写麻烦，刚开始时又不会写，那么就可以使用片段代码生成器来帮助我们生成流水线语法。</p><p>进入任务构建页面，点击 <code>流水线语法</code> 进入：</p><h3 id="配置构建过程遇到的问题"><a class="header-anchor" href="#配置构建过程遇到的问题" aria-hidden="true">#</a> 配置构建过程遇到的问题</h3><ol><li><p>Jenkins 工作空间权限问题</p><p><img src="/blog/_assets/jenkins-pipeline-error.229cec12.png" alt="jenkins-pipeline-error"></p><p>修复：</p><div class="language-bash"><pre><code><span class="token function">chown</span> -R jenkins:jenkins /var/lib/jenkins/workspace\n</code></pre></div></li><li><p>Git Parameters 不显示问题</p><p>当配置完 Git Parameters 第一次点击构建时，会报如下错误，找了很久也没有找到解决方法，于是就先使用 master 分支构建了一次，构建完成之后再次点击构建这里就正常显示了，猜测是没构建前没有 git 仓库的信息，构建完一次后就有了构建信息，于是就正常显示了。</p><p><img src="/blog/_assets/jenkins-pipeline-error1.50e8bd4b.png" alt="jenkins-pipeline-error1"></p></li></ol><h2 id="总结"><a class="header-anchor" href="#总结" aria-hidden="true">#</a> 总结</h2><p>本文对 Jenkins 的基本教程就到此为止了，主要讲了 Jenkins 的安装部署，FreeStyle project 和 Pipeline 的使用，以及插件安装、配置等。如果想要学，跟着我这个教程实操一遍，Jenkins 就基本掌握了，基本工作中遇到的问题都能解决，剩下的就只能在实际工作中慢慢摸索了。</p><p>再说回最初的话题，前端需不需要学习 Jenkins。我认为接触新的东西，然后学习并掌握，拓宽了技术面，虽然是一种压力，也是得到了成长的机会，在这个前端技术日新月异的时代，前端们不仅要熟练掌握前端技术，还需要具备一定的后端知识和自动化构建能力，才能不那么容易被大环境淘汰。</p>',256)];t.render=function(a,e,p,t,c,i){return n(),s("div",null,o)};export{p as __pageData,t as default};
