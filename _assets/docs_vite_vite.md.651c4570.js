import{f as n,g as s,J as a}from"./common-03e46d7f.js";const t='{"title":"vite学习记录","frontmatter":{"date":"2022-07-30","title":"vite学习记录","tags":["vite"],"describe":"vite基本概念及常用配置"},"headers":[{"level":3,"title":"概念","slug":"概念"},{"level":3,"title":"vite如何解决这两个问题？","slug":"vite如何解决这两个问题？"},{"level":3,"title":"配置","slug":"配置"}],"relativePath":"docs/vite/vite.md","lastUpdated":1672815835215.9387}';var p={};const o=[a('<h3 id="概念"><a class="header-anchor" href="#概念" aria-hidden="true">#</a> 概念</h3><p>vite开发阶段是esbuild，构建阶段是rollup</p><p>以前浏览器不支持ES Modules，所以es6代码都是通过打包工具转成浏览器识别的语言才能正常工作</p><p>带来的问题是：</p><ol><li>当项目越来越大时，启动项目需要很长时间（经历一条很长的编译打包链条，从入口开始需要逐步经历语法解析、依赖收集、代码转译、打包合并、代码优化，最终将高版本的、离散的源码编译打包成低版本、高兼容性的产物代码）</li><li>代码更新也需要时间（HMR 时需要把改动模块及相关依赖全部编译）</li></ol><h3 id="vite如何解决这两个问题？"><a class="header-anchor" href="#vite如何解决这两个问题？" aria-hidden="true">#</a> vite如何解决这两个问题？</h3><ul><li><p>针对项目启动慢的问题，vite 在开发环境冷启动无需打包，无需分析模块之间的依赖，同时也无需在启动开发服务器前进行编译，vite启动时将代码分为依赖和源码</p><p><code>依赖</code>：指的是一些不变的东西。例如第三方库，这部分使用esbuild构建（go语言开发，比js编写的打包器预构建依赖快10-100倍）</p><p><code>源码</code>：项目代码，按需加载，并且以es moduel的方式直接交给浏览器</p></li><li><p>针对项目更新的问题，vite只需要更新改动的源码位置，依赖不需要重新加载</p><p>源码部分根据协商缓存，依赖模块直接强缓存</p></li></ul><h3 id="配置"><a class="header-anchor" href="#配置" aria-hidden="true">#</a> 配置</h3><p>以下配置是我在项目中使用的配置</p><ol><li><p>vite创建项目</p><div class="language-bash"><pre><code><span class="token function">npm</span> init vite@latest my-vue-app\n\n<span class="token comment"># 使用pnpm</span>\n<span class="token function">pnpm</span> create vite my-vue-app --template vue-ts\n</code></pre></div></li><li><p>配置vite.config.ts</p><p>path等node变量不生效时，安装ts-node 缺少node类型定义</p><div class="language-bash"><pre><code><span class="token function">yarn</span> <span class="token function">add</span> ts-node --dev\n<span class="token function">yarn</span> <span class="token function">add</span> @types/node --dev\n</code></pre></div></li><li><p>组件编写，想在当前组件中创建example文件夹测试当前组件</p><p>vite.config.ts配置</p><div class="language-tsx"><pre><code><span class="token keyword">import</span> <span class="token punctuation">{</span> defineConfig <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;vite&#39;</span>\n<span class="token keyword">import</span> react <span class="token keyword">from</span> <span class="token string">&#39;@vitejs/plugin-react&#39;</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> path <span class="token keyword">from</span> <span class="token string">&#39;path&#39;</span><span class="token punctuation">;</span>\n\n<span class="token comment">// https://vitejs.dev/config/</span>\n<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">defineConfig</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n  resolve<span class="token operator">:</span> <span class="token punctuation">{</span>\n    alias<span class="token operator">:</span> <span class="token punctuation">{</span>\n      <span class="token string-property property">&#39;@example&#39;</span><span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">&#39;example&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n      <span class="token string-property property">&#39;@&#39;</span><span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">&#39;./src&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n      <span class="token comment">// 确保example可以成功找到quick-email-editor</span>\n      <span class="token string-property property">&#39;quick-email-editor&#39;</span><span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">&#39;./src/main.tsx&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  plugins<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token function">react</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n  build<span class="token operator">:</span> <span class="token punctuation">{</span>\n    minify<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n    manifest<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n    sourcemap<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n    target<span class="token operator">:</span> <span class="token string">&#39;es2015&#39;</span><span class="token punctuation">,</span>\n    rollupOptions<span class="token operator">:</span> <span class="token punctuation">{</span>\n      output<span class="token operator">:</span> <span class="token punctuation">{</span>\n        <span class="token function">manualChunks</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^\\/src\\/.*</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token keyword">return</span> <span class="token string">&#39;quick-email-editor&#39;</span><span class="token punctuation">;</span>\n          <span class="token punctuation">}</span>\n          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^\\/example\\/.*</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token keyword">return</span> <span class="token string">&#39;demo&#39;</span><span class="token punctuation">;</span>\n          <span class="token punctuation">}</span>\n        <span class="token punctuation">}</span><span class="token punctuation">,</span>\n      <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span>\n\n</code></pre></div><p>index.html配置</p><div class="language-html"><pre><code><span class="token comment">&lt;!-- 找到最外层HTML文件 --&gt;</span>\n<span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">&gt;</span></span>\n<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>en<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>\n  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>\n    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>UTF-8<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>\n    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>icon<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>image/svg+xml<span class="token punctuation">&quot;</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>/src/favicon.svg<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>\n    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>viewport<span class="token punctuation">&quot;</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>width=device-width, initial-scale=1.0<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>\n    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>Vite App<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>\n  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>\n  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>\n    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>root<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>\n    <span class="token comment">&lt;!-- 将此行隐藏 使用下面的文件  --&gt;</span>\n    <span class="token comment">&lt;!--&lt;script type=&quot;module&quot; src=&quot;/src/main.tsx&quot;&gt;&lt;/script&gt;--&gt;</span>\n    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>module<span class="token punctuation">&quot;</span></span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>/example/index.tsx<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>\n  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>\n<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>\n\n</code></pre></div></li><li><p>打包分析 rollup-plugin-visualize</p><div class="language-sh"><pre><code>yarn add rollup-plugin-visualizer --dev\n</code></pre></div><p>vite.config.js配置</p><div class="language-sh"><pre><code>process.env.ANALYZE === &quot;true&quot; &amp;&amp;\n      visualizer({\n        open: true,\n        gzipSize: true,\n        brotliSize: true,\n      }),\n</code></pre></div><p>package.json配置</p><div class="language-sh"><pre><code>\n&quot;analyze&quot;: &quot;cross-env ANALYZE=true yarn lib&quot;,\n&quot;analyze:build&quot;: &quot;cross-env ANALYZE=true yarn build&quot;,\n</code></pre></div></li><li><p>预览preview</p><p>package.json配置</p><div class="language-sh"><pre><code>&quot;preview&quot;: &quot;npm run lib &amp;&amp; vite --config vite.preview.config.ts --force&quot;,\n</code></pre></div><p>vite.lib.config.js配置</p><div class="language-sh"><pre><code>plugins: [\n    {\n      ...typescript2({\n        check: false,\n        tsconfig: &#39;tsconfig.lib.json&#39;,\n      }),\n      apply: &#39;build&#39;,\n    },\n    process.env.ANALYZE === &#39;true&#39; &amp;&amp;\n    visualizer({\n      open: true,\n      gzipSize: true,\n      brotliSize: true,\n    }),\n  ],\n</code></pre></div></li><li><p>编译生成.d.ts文件</p><p>要确保tsconfig.json存在declaration</p><div class="language-sh"><pre><code>{\n  &quot;compilerOptions&quot;: {\n    &quot;target&quot;: &quot;ESNext&quot;,\n    &quot;useDefineForClassFields&quot;: true,\n    &quot;lib&quot;: [&quot;DOM&quot;, &quot;DOM.Iterable&quot;, &quot;ESNext&quot;],\n    &quot;allowJs&quot;: false,\n    &quot;skipLibCheck&quot;: true,\n    &quot;esModuleInterop&quot;: false,\n    &quot;allowSyntheticDefaultImports&quot;: true,\n    &quot;strict&quot;: true,\n    &quot;forceConsistentCasingInFileNames&quot;: true,\n    &quot;module&quot;: &quot;ESNext&quot;,\n    &quot;moduleResolution&quot;: &quot;Node&quot;,\n    &quot;resolveJsonModule&quot;: true,\n    &quot;isolatedModules&quot;: true,\n    &quot;noEmit&quot;: true,\n    # 是否生成声明文件\n    &quot;declaration&quot;: true,\n    &quot;jsx&quot;: &quot;react-jsx&quot;\n  },\n  &quot;include&quot;: [&quot;src&quot;],\n  &quot;references&quot;: [{ &quot;path&quot;: &quot;./tsconfig.node.json&quot; }]\n}\n\n</code></pre></div><p>安装typescript2</p><div class="language-sh"><pre><code>yarn add rollup-plugin-typescript2 typescript tslib --dev\n</code></pre></div><p>配置</p><div class="language-sh"><pre><code>plugins: [\n    {\n      ...typescript2({\n        check: false,\n        # 默认加载tsconfig.json\n        tsconfig: &#39;tsconfig.lib.json&#39;,\n      }),\n      apply: &#39;build&#39;,\n    },\n    process.env.ANALYZE === &#39;true&#39; &amp;&amp;\n    visualizer({\n      open: true,\n      gzipSize: true,\n      brotliSize: true,\n    }),\n  ],\n</code></pre></div></li><li><p>静态文件还在public下，打包的时候会直接copy</p></li><li><p>vite进度条插件</p><div class="language-bash"><pre><code><span class="token function">yarn</span> <span class="token function">add</span> progress vite-plugin-progress -D\n</code></pre></div><div class="language-javascript"><pre><code><span class="token comment">// vite.config.js</span>\n<span class="token keyword">import</span> progress <span class="token keyword">from</span> <span class="token string">&#39;vite-plugin-progress&#39;</span>\n<span class="token keyword">import</span> colors <span class="token keyword">from</span> <span class="token string">&#39;picocolors&#39;</span>\n<span class="token operator">...</span>\n\n<span class="token literal-property property">plugins</span><span class="token operator">:</span> <span class="token punctuation">[</span>\n    <span class="token punctuation">{</span>\n      <span class="token operator">...</span><span class="token function">typescript2</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n        <span class="token literal-property property">check</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>\n        <span class="token literal-property property">tsconfig</span><span class="token operator">:</span> <span class="token string">&#39;tsconfig.lib.json&#39;</span><span class="token punctuation">,</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n      <span class="token literal-property property">apply</span><span class="token operator">:</span> <span class="token string">&#39;build&#39;</span><span class="token punctuation">,</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">ANALYZE</span> <span class="token operator">===</span> <span class="token string">&#39;true&#39;</span> <span class="token operator">&amp;&amp;</span>\n    <span class="token function">visualizer</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n      <span class="token literal-property property">open</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n      <span class="token literal-property property">gzipSize</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n      <span class="token literal-property property">brotliSize</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    <span class="token function">progress</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n      <span class="token literal-property property">format</span><span class="token operator">:</span>  <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>colors<span class="token punctuation">.</span><span class="token function">green</span><span class="token punctuation">(</span>colors<span class="token punctuation">.</span><span class="token function">bold</span><span class="token punctuation">(</span><span class="token string">&#39;Bouilding&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>colors<span class="token punctuation">.</span><span class="token function">cyan</span><span class="token punctuation">(</span><span class="token string">&#39;[:bar]&#39;</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> :percent</span><span class="token template-punctuation string">`</span></span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span>\n  <span class="token punctuation">]</span><span class="token punctuation">,</span>\n  <span class="token operator">...</span>\n</code></pre></div><p>实现思路：</p><p>webpack有对应的插件webpackBar，实现思路：webpack.progressPlugin事件钩子，可轻松获取进度 vite基于rollup打包，不知道进度</p><p>第一次打包时，模拟并记录所有模块总数并缓存起来</p></li><li><p>静态资源处理</p><ul><li>默认在public下的文件不打包</li><li>引用：<code>public/icon.png</code>应该在代码中引用为<code>/icon.png</code></li></ul></li><li><p>new URL(url, import.meta.url)</p><p>import.meta可以获取模块上的元数据属性</p><div class="language-javascript"><pre><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">import</span><span class="token punctuation">.</span>meta<span class="token punctuation">.</span>env<span class="token punctuation">)</span><span class="token punctuation">;</span>\nconsole<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">import</span><span class="token punctuation">.</span>meta<span class="token punctuation">.</span>hot<span class="token punctuation">)</span><span class="token punctuation">;</span>\nconsole<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">import</span><span class="token punctuation">.</span>meta<span class="token punctuation">.</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>\n</code></pre></div><p><img src="/blog/_assets/importmeta.6042770e.png" alt="截图"></p><p>与URL构造器组合使用可以通过相对路径得到一个被完整解析的静态资源URL</p><div class="language-javascript"><pre><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span><span class="token string">&#39;./sample.json&#39;</span><span class="token punctuation">,</span> <span class="token keyword">import</span><span class="token punctuation">.</span>meta<span class="token punctuation">.</span>url<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n</code></pre></div><p><img src="/blog/_assets/importurl.70b70234.png" alt="截图"></p></li><li><p>vite配置<a href="https://emotion.sh/docs/introduction" target="_blank" rel="noopener noreferrer">Emotion</a></p><div class="language-bash"><pre><code><span class="token function">npm</span> <span class="token function">install</span> @emotion/react\n<span class="token function">npm</span> <span class="token function">install</span> -D @emotion/babel-plugin\n</code></pre></div><p>修改vite.config.js文件</p><div class="language-js"><pre><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">defineConfig</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n  <span class="token literal-property property">plugins</span><span class="token operator">:</span> <span class="token punctuation">[</span>\n    <span class="token function">react</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n      <span class="token literal-property property">jsxImportSource</span><span class="token operator">:</span> <span class="token string">&#39;@emotion/react&#39;</span><span class="token punctuation">,</span>\n      <span class="token literal-property property">babel</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n        <span class="token comment">// 利用emotion的babel插件为JSX加入css属性，这样不用每个jsx文件开头添加JSX Pragma了</span>\n        <span class="token literal-property property">plugins</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&#39;@emotion/babel-plugin&#39;</span><span class="token punctuation">]</span>\n      <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n  <span class="token punctuation">]</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n</code></pre></div></li><li></li></ol><p>持续更新中。。。</p>',11)];p.render=function(a,t,p,e,c,l){return n(),s("div",null,o)};export{t as __pageData,p as default};
