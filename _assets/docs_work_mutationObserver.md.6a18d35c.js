import{f as n,g as s,J as a}from"./common-03e46d7f.js";const t='{"title":"使用mutationObserver检测DOM变化","frontmatter":{"date":"2022-07-26","title":"使用mutationObserver检测DOM变化","tags":["work","react"],"describe":"通过mutationObserver检测DOM变化，生成事件"},"headers":[{"level":2,"title":"生成快照","slug":"生成快照"},{"level":3,"title":"优化","slug":"优化"}],"relativePath":"docs/work/mutationObserver.md","lastUpdated":1743134641514.3196}';var p={};const o=[a('<blockquote><p>最近在写项目时，有一个需求是保存的同时截取当前页面内容并生成缩略图，下面是我的实现过程。</p></blockquote><h2 id="生成快照"><a class="header-anchor" href="#生成快照" aria-hidden="true">#</a> 生成快照</h2><ul><li><p>将DOM转成图片的三种方式 <a href="https://github.com/tsayen/dom-to-image" target="_blank" rel="noopener noreferrer">dom-to-image</a>、<a href="https://github.com/niklasvh/html2canvas" target="_blank" rel="noopener noreferrer">html2canvas</a>、<a href="./[html-to-image](https://github.com/bubkoo/html-to-image).html"> html-to-image</a> 对比之后选择html2canvas</p></li><li><p>使用</p><div class="language-js"><pre><code><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">eleToImage</span><span class="token punctuation">(</span><span class="token parameter">content</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> container <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&#39;div&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  container<span class="token punctuation">.</span>style<span class="token punctuation">.</span>position <span class="token operator">=</span> <span class="token string">&#39;absolute&#39;</span><span class="token punctuation">;</span>\n  container<span class="token punctuation">.</span>style<span class="token punctuation">.</span>left <span class="token operator">=</span> <span class="token string">&#39;-9999px&#39;</span><span class="token punctuation">;</span>\n  container<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token keyword">typeof</span> content <span class="token operator">===</span> <span class="token string">&#39;string&#39;</span> <span class="token operator">?</span> content <span class="token operator">:</span> content<span class="token operator">?.</span>outerHTML<span class="token punctuation">;</span>\n  document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>container<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token comment">/* 删除transform布局，改为position */</span>\n  <span class="token keyword">var</span> transformLay <span class="token operator">=</span> container<span class="token punctuation">.</span><span class="token function">querySelectorAll</span><span class="token punctuation">(</span><span class="token string">&#39;.react-grid-item&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">let</span> list <span class="token operator">=</span> <span class="token class-name">Array</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>transformLay <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n  list<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>\n    <span class="token keyword">let</span> positon <span class="token operator">=</span> item<span class="token punctuation">.</span>style<span class="token punctuation">.</span>transform<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&#39;,&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    item<span class="token punctuation">.</span>style<span class="token punctuation">.</span>left <span class="token operator">=</span> positon<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>\n    item<span class="token punctuation">.</span>style<span class="token punctuation">.</span>top <span class="token operator">=</span> positon<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>\n    item<span class="token punctuation">.</span>style<span class="token punctuation">.</span>transform <span class="token operator">=</span> <span class="token string">&#39;&#39;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span>\n  <span class="token keyword">var</span> textDom <span class="token operator">=</span> container<span class="token punctuation">.</span><span class="token function">querySelectorAll</span><span class="token punctuation">(</span><span class="token string">&#39;.text&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">let</span> textList <span class="token operator">=</span> <span class="token class-name">Array</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>textDom <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n  textList<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 截图时文字会突出</span>\n    item<span class="token punctuation">.</span>style<span class="token punctuation">.</span>fontSize <span class="token operator">=</span> <span class="token function">parseInt</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>style<span class="token punctuation">.</span>fontSize<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">0.92</span> <span class="token operator">+</span> <span class="token string">&#39;px&#39;</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span>\n  console<span class="token punctuation">.</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token string">&#39;canvas&#39;</span><span class="token punctuation">)</span>\n  <span class="token keyword">const</span> blob <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token operator">&lt;</span>any<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>\n    <span class="token function">html2canvas</span><span class="token punctuation">(</span>container<span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">useCORS</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">canvas</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>\n      canvas<span class="token punctuation">.</span><span class="token function">toBlob</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> <span class="token string">&#39;png&#39;</span><span class="token punctuation">,</span> <span class="token number">0.1</span><span class="token punctuation">)</span>\n    <span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>container<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  console<span class="token punctuation">.</span><span class="token function">timeEnd</span><span class="token punctuation">(</span><span class="token string">&#39;canvas&#39;</span><span class="token punctuation">)</span>\n  <span class="token keyword">return</span> blob<span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n</code></pre></div></li><li><p>使用html2canvas时遇到的坑</p><ol><li>transform兼容性问题，html2canvas不支持transform，需要修改成position</li><li>字体限制宽度时，可能会遮挡，需要缩小一定比例</li><li>图片跨域问题，需要配置useCORS</li></ol></li></ul><p>通过html2canvas将DOM转成图片并保存，原则上已经解决了问题，但每次保存时不管页面有没有发生变化，都会生成快照，尝试通过<a href="https://developer.mozilla.org/zh-CN/docs/Web/API/MutationObserver" target="_blank" rel="noopener noreferrer">MutationObserver</a>解决一下。</p><h3 id="优化"><a class="header-anchor" href="#优化" aria-hidden="true">#</a> 优化</h3><p>为了通用，写了一个自定义hooks，通过传入func函数来监听DOM变化时的回调</p><div class="language-js"><pre><code><span class="token keyword">import</span> <span class="token punctuation">{</span> useEffect <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;react&#39;</span><span class="token punctuation">;</span>\n\n<span class="token comment">/**\n * MutationObserver主要用于监视对DOM树所做的修改\n * https://developer.mozilla.org/zh-CN/docs/Web/API/MutationObserver\n */</span>\n<span class="token keyword">const</span> <span class="token function-variable function">useMutationObserver</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">dom<span class="token punctuation">,</span> depends<span class="token punctuation">,</span> func</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>\n  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>\n    <span class="token keyword">let</span> <span class="token literal-property property">mutation</span><span class="token operator">:</span> MutationObserver<span class="token punctuation">;</span>\n    <span class="token keyword">if</span><span class="token punctuation">(</span>dom<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// 当观察到变动时执行的回调函数</span>\n      <span class="token keyword">const</span> <span class="token function-variable function">callback</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">mutations</span><span class="token operator">:</span> MutationRecord<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token literal-property property">observer</span><span class="token operator">:</span> MutationObserver</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>\n        <span class="token function">func</span><span class="token punctuation">(</span>mutations<span class="token punctuation">,</span> observer<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n\n      <span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token punctuation">{</span>\n        <span class="token literal-property property">attributes</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 观察属性变动</span>\n        <span class="token comment">// attributeFilter: [&#39;style&#39;, &#39;childList&#39;],</span>\n        <span class="token literal-property property">attributeOldValue</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n        <span class="token literal-property property">characterData</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>   <span class="token comment">// 监听元素内的数据变动</span>\n        <span class="token literal-property property">characterDataOldValue</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n        <span class="token literal-property property">childList</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 监听子元素数量变动（子元素的属性变化不会触发事件）（只针对一级子元素，孙子元素的数量变化不会触发事件）</span>\n        <span class="token literal-property property">subtree</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>  <span class="token comment">// 将observer事件下发到目标元素的所有子元素，相当于对子元素也进行了observer</span>\n      <span class="token punctuation">}</span>\n\n      <span class="token comment">// 创建一个观察器实例并传入回调函数</span>\n      mutation <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MutationObserver</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n      <span class="token comment">// config 观察器的配置（需要观察什么变动）</span>\n      <span class="token comment">// 在DOM更改时 开始接收通知</span>\n      mutation<span class="token punctuation">.</span><span class="token function">observe</span><span class="token punctuation">(</span>dom<span class="token punctuation">,</span> config<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token punctuation">}</span>\n\n    <span class="token comment">// 组件销毁时 阻止MutationObaserver继续接收通知</span>\n    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>\n      <span class="token keyword">if</span><span class="token punctuation">(</span>mutation<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        mutation<span class="token punctuation">.</span><span class="token function">disconnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>depends<span class="token punctuation">]</span><span class="token punctuation">)</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">export</span> <span class="token keyword">default</span> useMutationObserver<span class="token punctuation">;</span>\n\n<span class="token comment">// 使用: 监测删除事件</span>\n<span class="token comment">// const isDelBtn = useRef&lt;boolean&gt;(false);</span>\n\n<span class="token comment">// const func = (mutations) =&gt; {</span>\n<span class="token comment">//   // 如果删除最后一个空格 则将当前的优惠券删除</span>\n<span class="token comment">//   if (</span>\n<span class="token comment">//     mutations[0]?.removedNodes[0]?.className === &quot;delete&quot; &amp;&amp;</span>\n<span class="token comment">//     !isDelBtn.current</span>\n<span class="token comment">//   ) {</span>\n<span class="token comment">//     const key = mutations[0]?.removedNodes[0].getAttribute(&quot;data-key&quot;);</span>\n<span class="token comment">//     removeNode(key);</span>\n<span class="token comment">//   }</span>\n<span class="token comment">// };</span>\n<span class="token comment">// useMutationObserver(refInput, func);</span>\n</code></pre></div>',7)];p.render=function(a,t,p,e,c,l){return n(),s("div",null,o)};export{t as __pageData,p as default};
