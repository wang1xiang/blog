<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>
      再遇协同编辑：Yjs + Quill，文档协同编辑竟如此简单 🎸 | 学习笔记
    </title>
    <meta name="description" content="A VitePress site">
    <link rel="stylesheet" href="/blog/_assets/style.85766dd9.css">
    <link rel="modulepreload" href="/blog/_assets/common-03e46d7f.js">
    <link rel="modulepreload" href="/blog/_assets/docs_tiptap_tiptap-tutorial6.md.22b6833e.lean.js">
    <link rel="modulepreload" href="/blog/_assets/app.6e2a9892.js">
    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no">
    <meta name="keywords" content="翔子Blog">
    <link rel="icon" href="/blog/favicon.ico">
    <link rel="stylesheet" href="https://lib.baomitu.com/gitalk/1.7.0/gitalk.min.css">
    <script src="https://lib.baomitu.com/gitalk/1.7.0/gitalk.min.js"></script>
    <script src="https://lib.baomitu.com/axios/0.21.1/axios.js"></script>
    
  </head>
  <body>
    <div id="app"><!--[--><div id="containerColor" class="no-sidebar theme" data-v-afcf09d4><header class="navbar" data-v-afcf09d4><!--[--><a class="title" aria-label="学习笔记, back to home" href="/blog/"><img class="logo" src="/blog/favicon.ico" alt="logo"><span>学习笔记</span></a><div class="flex-grow"></div><nav class="nav-links hide-mobile"><!--[--><!--[--><div class="nav-item"><a class="nav-link" href="/blog/index.html" target="" rel="">🏠 首页 <!----></a></div><!--]--><!--[--><div class="nav-item"><a class="nav-link" href="/blog/more/docs.html" target="" rel="">📅 归档 <!----></a></div><!--]--><!--[--><div class="nav-item"><a class="nav-link" href="/blog/more/tags.html" target="" rel="">📂 分类 <!----></a></div><!--]--><!--]--><div id="docsearch"></div><!----><!----></nav><!--[--><!--]--><!--]--><div class="sidebar-button" data-v-afcf09d4><svg class="icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z" class></path></svg></div></header><aside class="" data-v-afcf09d4><!--[--><nav class="nav-links show-mobile"><!--[--><!--[--><div class="nav-item"><a class="nav-link" href="/blog/index.html" target="" rel="">🏠 首页 <!----></a></div><!--]--><!--[--><div class="nav-item"><a class="nav-link" href="/blog/more/docs.html" target="" rel="">📅 归档 <!----></a></div><!--]--><!--[--><div class="nav-item"><a class="nav-link" href="/blog/more/tags.html" target="" rel="">📂 分类 <!----></a></div><!--]--><!--]--><div id="docsearch"></div><!----><!----></nav><!--[--><!--]--><ul class="sidebar"><!--[--><!--]--></ul><!--[--><!--]--><!--]--></aside><!----><!-- TODO: make this button accessible --><div class="sidebar-mask" data-v-afcf09d4></div><main data-v-afcf09d4><!--[--><div class="content"><!--[--><!--]--><div class="md-header"><div class="md-title">再遇协同编辑：Yjs + Quill，文档协同编辑竟如此简单 🎸</div><span id="jinrishici-sentence">正在加载今日诗词....</span><div class="md-date">2024-02-21</div></div><ul class="catalog"><!--[--><li class="catalog-item"><a class="level level-2" href="#yjs-介绍">Yjs 介绍</a><!----></li><li class="catalog-item"><!----><a class="level level-3" href="#对比">对比</a></li><li class="catalog-item"><!----><a class="level level-3" href="#基础代码">基础代码</a></li><li class="catalog-item"><a class="level level-2" href="#yjs-quill-打造协同编辑文档">Yjs + Quill 打造协同编辑文档</a><!----></li><li class="catalog-item"><!----><a class="level level-3" href="#初始化项目">初始化项目</a></li><li class="catalog-item"><!----><a class="level level-3" href="#初始化-quill-富文本编辑器">初始化 Quill 富文本编辑器</a></li><li class="catalog-item"><!----><a class="level level-3" href="#引入-yjs-与-quill-实现绑定">引入 Yjs 与 Quill 实现绑定</a></li><li class="catalog-item"><!----><a class="level level-3" href="#使用-y-websocket-进行数据传输">使用 y-websocket 进行数据传输</a></li><li class="catalog-item"><!----><a class="level level-3" href="#使用本地-socket-服务">使用本地 socket 服务</a></li><li class="catalog-item"><!----><a class="level level-3" href="#小结">小结</a></li><li class="catalog-item"><a class="level level-2" href="#yjs-的核心概念">Yjs 的核心概念</a><!----></li><li class="catalog-item"><!----><a class="level level-3" href="#documents">Documents</a></li><li class="catalog-item"><!----><a class="level level-3" href="#shared-types">Shared Types</a></li><li class="catalog-item"><!----><a class="level level-3" href="#providers">Providers</a></li><li class="catalog-item"><!----><a class="level level-3" href="#awareness-presence">Awareness &amp; Presence</a></li><li class="catalog-item"><!----><a class="level level-3" href="#undomanager">UndoManager</a></li><li class="catalog-item"><a class="level level-2" href="#offline-support-离线支持">Offline Support 离线支持</a><!----></li><li class="catalog-item"><a class="level level-2" href="#yjs-与不同编辑器的绑定">Yjs 与不同编辑器的绑定</a><!----></li><li class="catalog-item"><a class="level level-2" href="#总结">总结</a><!----></li><!--]--></ul><div><p>通过上一篇文章<a href="https://juejin.cn/post/7336761948066332723" target="_blank" rel="noopener noreferrer">初识协同编辑：OT 和 CRDT 算法，文档协作的“魔法石”</a>，相信各位小伙伴对 OT 和 CRDT 协同算法有了一定的了解，并且对 Yjs 有了初步的认识，本文主要教会大家如何使用 Yjs 来实现 Quill 的协同编辑，以及针对 Yjs 的一些重要概念进行讲解。</p><blockquote><p>因为协作需要服务端的支持，所有没有 demo，具体实现请<a href="https://github.com/wang1xiang/tiptap-editor/tree/master/02-quill-collab" target="_blank" rel="noopener noreferrer">👉🏻 查看源码</a>。</p></blockquote><h2 id="yjs-介绍"><a class="header-anchor" href="#yjs-介绍" aria-hidden="true">#</a> Yjs 介绍</h2><p>官方介绍：<strong>用于构建 Google Docs 和 Figma 等协作应用程序的模块化构建块</strong>。</p><p><a href="https://docs.yjs.dev/" target="_blank" rel="noopener noreferrer">Yjs</a> 基于 CRDT ，帮助实现高性能的协作应用程序。</p><p><a href="https://demos.yjs.dev/" target="_blank" rel="noopener noreferrer">官方 demo</a></p><p>如果目前使用的编辑器是上述其中之一时，根据上述 demo 便可以轻松完成协同编辑。但当我们学习完成后，能够实现的协同编辑就不再仅仅局限于上述编辑器了。</p><h3 id="对比"><a class="header-anchor" href="#对比" aria-hidden="true">#</a> 对比</h3><p><a href="https://automerge.org/" target="_blank" rel="noopener noreferrer">automerge</a>是一个用于构建协作应用程序的数据结构库，也是基于 CRDT 算法实现的，通过它与 Yjs 的<a href="https://github.com/dmonad/crdt-benchmarks?tab=readme-ov-file#results" target="_blank" rel="noopener noreferrer">对比</a>可知 Yjs 是迄今为止最快的 CRDT 实现。</p><h3 id="基础代码"><a class="header-anchor" href="#基础代码" aria-hidden="true">#</a> 基础代码</h3><p>下面便是最基础的 Yjs 代码，一脸懵逼吧 🤷‍♂️！没事，现在看不懂没关系，等学完本文再回来看，你会发现“soga，原来那么简单！“。</p><div class="language-js"><pre><code><span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> <span class="token constant">Y</span> <span class="token keyword">from</span> <span class="token string">&#39;yjs&#39;</span>

<span class="token comment">// Yjs documents are collections of</span>
<span class="token comment">// shared objects that sync automatically.</span>
<span class="token keyword">const</span> ydoc <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Y<span class="token punctuation">.</span>Doc</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">// Define a shared Y.Map instance</span>
<span class="token keyword">const</span> ymap <span class="token operator">=</span> ydoc<span class="token punctuation">.</span><span class="token function">getMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
ymap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&#39;keyA&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;valueA&#39;</span><span class="token punctuation">)</span>

<span class="token comment">// Create another Yjs document (simulating a remote user)</span>
<span class="token comment">// and create some conflicting changes</span>
<span class="token keyword">const</span> ydocRemote <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Y<span class="token punctuation">.</span>Doc</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> ymapRemote <span class="token operator">=</span> ydocRemote<span class="token punctuation">.</span><span class="token function">getMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
ymapRemote<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&#39;keyB&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;valueB&#39;</span><span class="token punctuation">)</span>

<span class="token comment">// Merge changes from remote</span>
<span class="token keyword">const</span> update <span class="token operator">=</span> <span class="token constant">Y</span><span class="token punctuation">.</span><span class="token function">encodeStateAsUpdate</span><span class="token punctuation">(</span>ydocRemote<span class="token punctuation">)</span>
<span class="token constant">Y</span><span class="token punctuation">.</span><span class="token function">applyUpdate</span><span class="token punctuation">(</span>ydoc<span class="token punctuation">,</span> update<span class="token punctuation">)</span>

<span class="token comment">// Observe that the changes have merged</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ymap<span class="token punctuation">.</span><span class="token function">toJSON</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// =&gt; { keyA: &#39;valueA&#39;, keyB: &#39;valueB&#39; }</span>
</code></pre></div><h2 id="yjs-quill-打造协同编辑文档"><a class="header-anchor" href="#yjs-quill-打造协同编辑文档" aria-hidden="true">#</a> Yjs + Quill 打造协同编辑文档</h2><p>✅ 步入正文啦。接下来我们用短短几十行代码，便可打造一个 Quill 富文本编辑器的协同编辑。很简单，别光看，动手撸起来。</p><h3 id="初始化项目"><a class="header-anchor" href="#初始化项目" aria-hidden="true">#</a> 初始化项目</h3><p>通过<code>npx create-vite quill-collab</code>创建一个 vue 项目</p><h3 id="初始化-quill-富文本编辑器"><a class="header-anchor" href="#初始化-quill-富文本编辑器" aria-hidden="true">#</a> 初始化 Quill 富文本编辑器</h3><ol><li><p>安装 quill 及插件 quill-cursor</p><div class="language-bash"><pre><code><span class="token function">yarn</span> <span class="token function">add</span> quill quill-cursors
</code></pre></div></li><li><p>修改 main.ts 代码，使用以下代码覆盖 main.ts</p><div class="language-js"><pre><code><span class="token keyword">import</span> Quill <span class="token keyword">from</span> <span class="token string">&#39;quill&#39;</span>
<span class="token keyword">import</span> QuillCursors <span class="token keyword">from</span> <span class="token string">&#39;quill-cursors&#39;</span>
<span class="token keyword">import</span> <span class="token string">&#39;quill/dist/quill.snow.css&#39;</span>

Quill<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token string">&#39;modules/cursors&#39;</span><span class="token punctuation">,</span> QuillCursors<span class="token punctuation">)</span>

<span class="token keyword">const</span> quill <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Quill</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&#39;#app&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">modules</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">cursors</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token literal-property property">toolbar</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token comment">// adding some basic Quill content features</span>
      <span class="token punctuation">[</span><span class="token punctuation">{</span> <span class="token literal-property property">header</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token punctuation">[</span><span class="token string">&#39;bold&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;italic&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;underline&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token punctuation">[</span><span class="token string">&#39;image&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;code-block&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token literal-property property">history</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token comment">// Local undo shouldn&#39;t undo changes</span>
      <span class="token comment">// from remote users</span>
      <span class="token literal-property property">userOnly</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">placeholder</span><span class="token operator">:</span> <span class="token string">&#39;Start collaborating...&#39;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">theme</span><span class="token operator">:</span> <span class="token string">&#39;snow&#39;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div></li></ol><p>启动服务，Quill 编辑器初始化完成。</p><h3 id="引入-yjs-与-quill-实现绑定"><a class="header-anchor" href="#引入-yjs-与-quill-实现绑定" aria-hidden="true">#</a> 引入 Yjs 与 Quill 实现绑定</h3><p>这一步是为了将 Yjs 的数据模型与 Quill 的数据模型进行绑定，绑定后 Yjs 就会自动处理数据的并发更改（<strong>自动解决冲突</strong>）。</p><ol><li><p>安装依赖</p><div class="language-bash"><pre><code><span class="token function">yarn</span> <span class="token function">add</span> yjs y-quill
</code></pre></div><p><code>y-quill</code> 是 Yjs 官方提供的，通过它提供的 <code>QuillBinding</code> 方法可以将 Quill 数据模型和 Yjs 数据模型进行绑定。</p></li><li><p>修改 main.ts，添加如下代码：</p><div class="language-js"><pre><code><span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> <span class="token constant">Y</span> <span class="token keyword">from</span> <span class="token string">&#39;yjs&#39;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> QuillBinding <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;y-quill&#39;</span>
<span class="token comment">// Yjs文档，保存共享数据shared data</span>
<span class="token keyword">const</span> ydoc <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Y<span class="token punctuation">.</span>Doc</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">// 在文档上定义共享文本类型</span>
<span class="token keyword">const</span> ytext <span class="token operator">=</span> ydoc<span class="token punctuation">.</span><span class="token function">getText</span><span class="token punctuation">(</span><span class="token string">&#39;quill&#39;</span><span class="token punctuation">)</span>

<span class="token comment">// 创建一个编辑器绑定 将quill编辑器“绑定”到 Y.Text 类型。</span>
<span class="token keyword">const</span> binding <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">QuillBinding</span><span class="token punctuation">(</span>ytext<span class="token punctuation">,</span> quill<span class="token punctuation">)</span>
</code></pre></div><ul><li>首先通过<code>new Y.Doc()</code>创建 Yjs 文档，用于保存 Shared Types 共享数据；</li><li>接着创建名为 <code>quill</code> 的 ytext 对象，用于表示文本的共享数据结构；</li><li>最后通过 <code>QuillBinding</code> 将 ytext 与 Quill 编辑器进行绑定，及<strong>数据保持同步</strong>（Yjs 数据改变时 Quill 编辑器数据自动更新，Quill 编辑器数据改变时 Yjs 数据也自动更新）。</li></ul><p><strong>几乎所有编辑器与 Yjs 进行绑定时都是以上三个步骤</strong>。</p></li></ol><h3 id="使用-y-websocket-进行数据传输"><a class="header-anchor" href="#使用-y-websocket-进行数据传输" aria-hidden="true">#</a> 使用 y-websocket 进行数据传输</h3><p>前三步客户端的操作已经完成，接下来就是要接上服务端，实现数据传输了，Yjs 提供了 <a href="https://docs.yjs.dev/ecosystem/connection-provider" target="_blank" rel="noopener noreferrer">Provider</a> 来实现。</p><p>Yjs 提供了多种类型的 Provider 用于数据传输，如：WebSocket、WebRTC、Dat。</p><ol><li><p>安装依赖</p><div class="language-bash"><pre><code><span class="token function">yarn</span> <span class="token function">add</span> y-websocket
</code></pre></div></li><li><p>修改代码</p><div class="language-js"><pre><code><span class="token keyword">import</span> <span class="token punctuation">{</span> WebsocketProvider <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;y-websocket&#39;</span>
<span class="token comment">// 连接到 websocket 服务端 yjs提供的体验服务器</span>
<span class="token keyword">const</span> provider <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebsocketProvider</span><span class="token punctuation">(</span>
  <span class="token string">&#39;wss://demos.yjs.dev&#39;</span><span class="token punctuation">,</span>
  <span class="token string">&#39;quill-demo-room&#39;</span><span class="token punctuation">,</span>
  ydoc
<span class="token punctuation">)</span>
<span class="token comment">// 绑定</span>
<span class="token keyword">const</span> binding <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">QuillBinding</span><span class="token punctuation">(</span>ytext<span class="token punctuation">,</span> quill<span class="token punctuation">,</span> provider<span class="token punctuation">.</span>awareness<span class="token punctuation">)</span>
</code></pre></div><p>大多数 Provider 的共同点是他们<strong>使用房间名称的概念</strong>来连接 Yjs 文档。在上面的示例中，所有指定“quill-demo-room”作为房间名称的文档都将同步。</p></li><li><p>协同效果如下</p><p><img src="/blog/_assets/quill-collab-error.08a78138.gif" alt="quill-collab-error"></p><p>上面是用 chrome 浏览器和 safari 浏览器同时测试的效果，因为官方提供的 websocket 服务连接失败，不同浏览器之间的协同是没有生效的。</p><p><img src="/blog/_assets/yjs-demo-wss.bd7eb3ee.png" alt="yjs-demo-wss"></p><p>那为什么同一浏览器的两个 tab，没连上 socket 服务也能做协同编辑呢？</p><p>这是因为 Yjs 会<strong>优先通过浏览器的同 host 共享状态的方式进行通信</strong>，然后才是网络通信。</p></li></ol><h3 id="使用本地-socket-服务"><a class="header-anchor" href="#使用本地-socket-服务" aria-hidden="true">#</a> 使用本地 socket 服务</h3><p>既然 Yjs 提供的体验服务无法连接，那么我们可以自己本地启一个 y-websocket 服务。</p><ol><li><p>在当前项目下启动 y-websocket 服务</p><p>当前项目已经安装 y-websocket 依赖，可直接使用；如果在别处启用时，需要先安装 y-websocket 依赖。</p><div class="language-bash"><pre><code><span class="token assign-left variable">PORT</span><span class="token operator">=</span><span class="token number">1234</span> npx y-websocket
</code></pre></div><p><img src="/blog/_assets/local-websocket.edfc9873.png" alt="local-websocket"></p></li><li><p>修改 ws 服务的地址</p><div class="language-js"><pre><code><span class="token keyword">const</span> provider <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebsocketProvider</span><span class="token punctuation">(</span>
  <span class="token string">&#39;ws://localhost:1234&#39;</span><span class="token punctuation">,</span>
  <span class="token string">&#39;quill-demo-room&#39;</span><span class="token punctuation">,</span>
  ydoc
<span class="token punctuation">)</span>
</code></pre></div></li></ol><p>此时效果就正常了 <img src="/blog/_assets/quill-collab.bec9f695.gif" alt="quill-collab"></p><h3 id="小结"><a class="header-anchor" href="#小结" aria-hidden="true">#</a> 小结</h3><p>我们用不到 70 行代码（<a href="https://github.com/wang1xiang/tiptap-editor/tree/master/02-quill-collab" target="_blank" rel="noopener noreferrer">👉🏻 完整代码</a>），就实现了 Quill 富文本编辑器的协同编辑。主要是通过将 Yjs 与 Quill 编辑器进行绑定，实现了数据的联动；然后再通过网络服务将 Yjs 数据在不同客户端之间进行传递。</p><p>有了这个前提，接下来整理下 Yjs 几个比较重要的概念。</p><h2 id="yjs-的核心概念"><a class="header-anchor" href="#yjs-的核心概念" aria-hidden="true">#</a> Yjs 的核心概念</h2><p>Yjs：包含最核心的数据结构及逻辑。如数据类型的定义，数据读写编码 encoding 模块，事件监听，状态管理 StructStore，Undo/Redo 管理器等。</p><h3 id="documents"><a class="header-anchor" href="#documents" aria-hidden="true">#</a> Documents</h3><div class="language-js"><pre><code><span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> <span class="token constant">Y</span> <span class="token keyword">from</span> <span class="token string">&#39;yjs&#39;</span>

<span class="token keyword">const</span> doc <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Y<span class="token punctuation">.</span>Doc</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p>通过 <code>new Y.Doc()</code> 会创建一个 Doc 实例（即一个 Yjs 文档），作用：</p><ul><li><p><strong>容器</strong>：是承载共享数据 Shared Types 的容器</p><div class="language-js"><pre><code><span class="token keyword">const</span> ytext <span class="token operator">=</span> ydoc<span class="token punctuation">.</span><span class="token function">getText</span><span class="token punctuation">(</span><span class="token string">&#39;quill&#39;</span><span class="token punctuation">)</span>
</code></pre></div></li><li><p><strong>载体</strong>：是网络传输 Provider 的载体，将 ydoc 传入 WebSocket 的 provider 后即可支持网络同步</p><div class="language-js"><pre><code><span class="token comment">// 连接到 websocket</span>
<span class="token keyword">const</span> provider <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebsocketProvider</span><span class="token punctuation">(</span>
  <span class="token string">&#39;ws://localhost:1234&#39;</span><span class="token punctuation">,</span>
  <span class="token string">&#39;quill-demo-room&#39;</span><span class="token punctuation">,</span>
  ydoc
<span class="token punctuation">)</span>
</code></pre></div></li></ul><p>Y.doc 上有很多有用的属性，如：</p><h4 id="doc-clientid-number"><a class="header-anchor" href="#doc-clientid-number" aria-hidden="true">#</a> doc.clientID: number</h4><p><strong>只读属性</strong>，标识会话的<code>客户端的唯一 ID</code>, Yjs 会为每个会话创建一个新的 clientID，以避免同步冲突。同一用户打开多个 tab 页时 clientID 也是唯一的，不允许跨会话重复使用，可见<a href="https://docs.yjs.dev/api/faq#i-get-a-new-clientid-for-every-session-is-there-a-way-to-make-it-static-for-a-peer-accessing-the-doc" target="_blank" rel="noopener noreferrer">FAQ</a>。</p><h4 id="doc-gc-boolean"><a class="header-anchor" href="#doc-gc-boolean" aria-hidden="true">#</a> doc.gc: boolean</h4><p>是否在此文档实例上启用垃圾回收，默认为<code>true</code>。更多可通过<a href="https://docs.yjs.dev/api/internals" target="_blank" rel="noopener noreferrer">Internals</a>了解 Yjs 的内部工作原理。</p><h4 id="doc-transact-function-transaction-void-origin-any"><a class="header-anchor" href="#doc-transact-function-transaction-void-origin-any" aria-hidden="true">#</a> doc.transact(function(Transaction): void [, origin:any])</h4><p>Yjs 中 Documents/Shared Types 的所有更改都发生在事务中，每次发生事务后都会触发 <code>observer</code> 调用和 <code>update</code> 事件，触发<strong>监听和更新</strong>操作。</p><h4 id="doc-get-string-y-typeclass-type"><a class="header-anchor" href="#doc-get-string-y-typeclass-type" aria-hidden="true">#</a> doc.get(string, Y.[TypeClass]): [Type]</h4><p>获取共享类型的顶级实例，可以看到 <code>gc</code> 默认为 <code>true</code>，<code>clientID</code> 为一个随机数</p><p><img src="/blog/_assets/y-doc-property.9724e5c8.png" alt="y-doc-property"></p><h4 id="doc-gettext-getarray-getmap"><a class="header-anchor" href="#doc-gettext-getarray-getmap" aria-hidden="true">#</a> doc.getText/getArray/getMap</h4><p>用于定义 Shared Types 类型（text、array、map 等）</p><h4 id="doc-on-once-off"><a class="header-anchor" href="#doc-on-once-off" aria-hidden="true">#</a> doc.on/once/off</h4><p>事件监听</p><h4 id="doc-on-beforetransaction-function-tr-transaction-doc-y-doc"><a class="header-anchor" href="#doc-on-beforetransaction-function-tr-transaction-doc-y-doc" aria-hidden="true">#</a> doc.on(&#39;beforeTransaction&#39;, function(tr: Transaction, doc: Y.Doc))</h4><p>事件处理程序在每次<strong>事务之前</strong>都会被调用</p><h4 id="doc-on-beforeobservercalls-function-tr-transaction-doc-y-doc"><a class="header-anchor" href="#doc-on-beforeobservercalls-function-tr-transaction-doc-y-doc" aria-hidden="true">#</a> doc.on(&#39;beforeObserverCalls&#39;, function(tr: Transaction, doc: Y.Doc))</h4><p>事件处理程序在调用共享类型的观察程序之前立即调用</p><h4 id="doc-on-aftertransaction-function-tr-transaction-doc-y-doc"><a class="header-anchor" href="#doc-on-aftertransaction-function-tr-transaction-doc-y-doc" aria-hidden="true">#</a> doc.on(&#39;afterTransaction&#39;, function(tr: Transaction, doc: Y.Doc))</h4><p>事件处理程序在每次<strong>事务之后</strong>立即调用</p><h4 id="doc-on-update-function-update-uint8array-origin-any-doc-y-doc-tr-transaction"><a class="header-anchor" href="#doc-on-update-function-update-uint8array-origin-any-doc-y-doc-tr-transaction" aria-hidden="true">#</a> doc.on(&#39;update&#39;, function(update: Uint8Array, origin: any, doc: Y.Doc, tr: Transaction))</h4><p>监听 Shared Types 上的最新消息，所有更新消息都传播给所有用户，每个人最终都会统一相同的状态。</p><h4 id="事件调用顺序"><a class="header-anchor" href="#事件调用顺序" aria-hidden="true">#</a> 事件调用顺序</h4><p>前面说了“Yjs 中 Documents/Shared Types 的所有更改都发生在事务中”，当发生变更时，事件按以下顺序调用：</p><p><img src="/blog/_assets/yjs-event-order.d99bd63d.png" alt="yjs-event-order"></p><p>可修改代码测试</p><div class="language-js"><pre><code><span class="token keyword">const</span> ydoc <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Y<span class="token punctuation">.</span>Doc</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
ydoc<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;beforeTransaction&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;beforeTransaction&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
ydoc<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;beforeObserverCalls&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;beforeObserverCalls&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
ydoc<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;afterTransaction&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;afterTransaction&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
ydoc<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;update&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">update</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;update&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment">// 创建一个顶层名为 kun 的 YMap</span>
<span class="token keyword">const</span> ymap <span class="token operator">=</span> ydoc<span class="token punctuation">.</span><span class="token function">getMap</span><span class="token punctuation">(</span><span class="token string">&#39;kun&#39;</span><span class="token punctuation">)</span>
ymap<span class="token punctuation">.</span><span class="token function">observe</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;observe&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
ymap<span class="token punctuation">.</span><span class="token function">observeDeep</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;observeDeep&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>测试结果如下：</p><p><img src="/blog/_assets/yjs-event-order-test.3930d3a9.png" alt="yjs-event-order-test"></p><p>Documents 的完整属性可见<a href="https://docs.yjs.dev/api/y.doc" target="_blank" rel="noopener noreferrer">这里。</a></p><h3 id="shared-types"><a class="header-anchor" href="#shared-types" aria-hidden="true">#</a> Shared Types</h3><p><strong>The most unique feature of Yjs yet: Shared Types.</strong></p><p>Shared Types 是 Yjs 最核心的内容，用于表示<code>可协同编辑的数据结构</code>。通过它可以实现任何应用的协作，比如：文档、表格、绘图等等。</p><p>Yjs 提供了多种类型的 Shared Types：包括常见的数据结构 <a href="https://docs.yjs.dev/api/shared-types/y.map" target="_blank" rel="noopener noreferrer">Y.Map</a>、<a href="https://docs.yjs.dev/api/shared-types/y.array" target="_blank" rel="noopener noreferrer">Y.Array</a>、<a href="https://docs.yjs.dev/api/shared-types/y.text" target="_blank" rel="noopener noreferrer">Y.Text</a>，使用起来就和 js 的 map、array 对象基本是一样的，具体使用哪种需要根据实际的数据结构来决定。比如上一节中将 Y.Text 通过 <code>y-quill</code> “绑定”到 Quill 的编辑器实例后自动同步编辑器内容。</p><p>如何实现协同编辑？我们只需要<strong>构造好一个 Shared Types 数据结构，监听它的变化，将变化通过网络发送到其他端</strong>即可。看下在 Yjs 中是怎么实现的？</p><h4 id="构造-shared-types"><a class="header-anchor" href="#构造-shared-types" aria-hidden="true">#</a> 构造 Shared Types</h4><p>比如我们有如下数据：</p><div class="language-js"><pre><code><span class="token punctuation">{</span>
  <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&#39;kunkun&#39;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">age</span><span class="token operator">:</span> <span class="token string">&#39;2.5&#39;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">address</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">country</span><span class="token operator">:</span> <span class="token string">&#39;China&#39;</span><span class="token punctuation">,</span>
    <span class="token literal-property property">city</span><span class="token operator">:</span> <span class="token string">&#39;shanghai&#39;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">likes</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&#39;Sing&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;dance&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;rap&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;basketball&#39;</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><p><img src="/blog/_assets/yjs-kunkun.33c626d1.png" alt="yjs-kunkun"></p><p>尝试将上面数据转为 Y.Map 格式如下：</p><div class="language-js"><pre><code><span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> <span class="token constant">Y</span> <span class="token keyword">from</span> <span class="token string">&#39;yjs&#39;</span>

<span class="token keyword">const</span> ydoc <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Y<span class="token punctuation">.</span>Doc</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// 创建一个顶层名为 kun 的 YMap</span>
<span class="token keyword">const</span> ymap <span class="token operator">=</span> ydoc<span class="token punctuation">.</span><span class="token function">getMap</span><span class="token punctuation">(</span><span class="token string">&#39;kun&#39;</span><span class="token punctuation">)</span>

<span class="token comment">// 构造嵌套的 ymap</span>
<span class="token keyword">const</span> ymapAddress <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Y<span class="token punctuation">.</span>Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
ymapAddress<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&#39;country&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;China&#39;</span><span class="token punctuation">)</span>
ymapAddress<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&#39;city&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;shanghai&#39;</span><span class="token punctuation">)</span>
ymap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&#39;address&#39;</span><span class="token punctuation">,</span> ymapAddress<span class="token punctuation">)</span>

<span class="token comment">// 构造嵌套的 yarray</span>
<span class="token keyword">const</span> yarrayLikes <span class="token operator">=</span> <span class="token constant">Y</span><span class="token punctuation">.</span>Array<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&#39;Sing&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;dance&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;rap&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;basketball&#39;</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token comment">// const yarrayLikes = new Y.Array()</span>
<span class="token comment">// yarrayLikes.push([&#39;Sing&#39;])</span>
<span class="token comment">// yarrayLikes.push([&#39;dance&#39;])</span>
<span class="token comment">// yarrayLikes.push([&#39;rap&#39;])</span>
<span class="token comment">// yarrayLikes.insert(3, [&#39;basketball&#39;])</span>
ymap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&#39;likes&#39;</span><span class="token punctuation">,</span> yarrayLikes<span class="token punctuation">)</span>
ymap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&#39;name&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;kunkun&#39;</span><span class="token punctuation">)</span>
ymap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&#39;age&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;2.5&#39;</span><span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ymap<span class="token punctuation">.</span><span class="token function">toJSON</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p><img src="/blog/_assets/y-map-kun.09eae68e.png" alt="y-map-kun"></p><p>上面的 API 可参考<a href="https://docs.yjs.dev/api/shared-types/y.map" target="_blank" rel="noopener noreferrer">yMap</a></p><h4 id="监听-ymap-变化"><a class="header-anchor" href="#监听-ymap-变化" aria-hidden="true">#</a> 监听 Ymap 变化</h4><p>yMap 已经构造完成，那么接下来便是监听它的变化作相应的处理。</p><p>Shared Types 中通过 observe 和 observeDeep 来监听数据的变化，当数据变化时，会触发监听的回调函数，回调函数会通过更新事件 <a href="https://docs.yjs.dev/api/y.event" target="_blank" rel="noopener noreferrer">YEvent</a> 传入当前的更新内容，从而执行相应的操作。</p><ul><li>ymap.observe：注册一个 observe，当修改数据时会调用该方法</li><li>ymap.unobserve：取消注册在 ymap.observe 中方法</li><li>ymap.observeDeep</li><li>ymap.unobserveDeep(function)</li></ul><p>observeDeep 与 observe 的不同在于 observeDeep 是深度监听，类似于 watch 的<code>deep:true</code>。</p><p>修改代码如下：</p><div class="language-js"><pre><code><span class="token comment">// 创建一个顶层名为 kun 的 YMap</span>
<span class="token keyword">const</span> ymap <span class="token operator">=</span> ydoc<span class="token punctuation">.</span><span class="token function">getMap</span><span class="token punctuation">(</span><span class="token string">&#39;kun&#39;</span><span class="token punctuation">)</span>

<span class="token comment">// 监听变化</span>
ymap<span class="token punctuation">.</span><span class="token function">observe</span><span class="token punctuation">(</span><span class="token parameter">event</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  event<span class="token punctuation">.</span>changes<span class="token punctuation">.</span>keys<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">change<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>change<span class="token punctuation">.</span>action <span class="token operator">===</span> <span class="token string">&#39;add&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Property &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>key<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot; was added. Initial value: &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ymap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>change<span class="token punctuation">.</span>action <span class="token operator">===</span> <span class="token string">&#39;update&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Property &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>key<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot; was updated. New value: &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ymap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;. Previous value: &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>change<span class="token punctuation">.</span>oldValue<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>change<span class="token punctuation">.</span>action <span class="token operator">===</span> <span class="token string">&#39;delete&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Property &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>key<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot; was deleted. New value: undefined. Previous value: &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>change<span class="token punctuation">.</span>oldValue<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token operator">...</span>
</code></pre></div><p><img src="/blog/_assets/y-map-observe.9f01b136.png" alt="y-map-observe"></p><h4 id="更新同步"><a class="header-anchor" href="#更新同步" aria-hidden="true">#</a> 更新同步</h4><p>通过 observe 已经可以监听到 Shared Types 的变化，那么如何将变化应用到其他客户端呢？</p><p>首先，协作编辑时传输数据很频繁，并且一般数据量都比较大，Yjs 为了减少每次传输数据的大小，对<strong>数据进行二进制编码</strong>（高度压缩）后，通过 <a href="https://docs.yjs.dev/api/document-updates#update-api" target="_blank" rel="noopener noreferrer">Update API</a> 与其他文档进行同步，所有客户端收到所有文档更新后都会同步，主要使用下面两个 API 进行同步：</p><ul><li>Y.applyUpdate：将当前更新应用到一个新副本</li><li>Y.encodeStateAsUpdate：编码整个文档为单个更新消息</li></ul><p>之前我们提到了发生变更时的事件执行顺序，Shared Types 变更时通过 <code>ydoc.on(&#39;update&#39;, )</code> 接收 <code>ytype.observe</code> 所发出的增量更新，将计算出的增量更新发送到所有连接的客户端。</p><p>我们可以在本地同时创建两个 YDoc 实例来模拟 2 个客户端，验证一下：</p><div class="language-js"><pre><code><span class="token keyword">const</span> ydoc1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Y<span class="token punctuation">.</span>Doc</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> ydoc2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Y<span class="token punctuation">.</span>Doc</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// 在其中一份 YDoc 更新时，通过applyUpdate将二进制数据应用到其他 YDoc 上</span>
ydoc1<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;update&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">update</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token constant">Y</span><span class="token punctuation">.</span><span class="token function">applyUpdate</span><span class="token punctuation">(</span>ydoc2<span class="token punctuation">,</span> update<span class="token punctuation">)</span><span class="token punctuation">)</span>
ydoc2<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;update&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">update</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token constant">Y</span><span class="token punctuation">.</span><span class="token function">applyUpdate</span><span class="token punctuation">(</span>ydoc1<span class="token punctuation">,</span> update<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment">// 创建一个顶层名为 kun 的 YMap</span>
<span class="token keyword">const</span> ymap1 <span class="token operator">=</span> ydoc1<span class="token punctuation">.</span><span class="token function">getMap</span><span class="token punctuation">(</span><span class="token string">&#39;kun&#39;</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> ymap2 <span class="token operator">=</span> ydoc2<span class="token punctuation">.</span><span class="token function">getMap</span><span class="token punctuation">(</span><span class="token string">&#39;kun&#39;</span><span class="token punctuation">)</span>
<span class="token comment">// 监听变化</span>
ymap1<span class="token punctuation">.</span><span class="token function">observe</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  event<span class="token punctuation">.</span>changes<span class="token punctuation">.</span>keys<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">change<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>change<span class="token punctuation">.</span>action <span class="token operator">===</span> <span class="token string">&#39;add&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">ymap1: Property &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>key<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot; was added. Initial value: &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ymap1<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>
          key
        <span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;.</span><span class="token template-punctuation string">`</span></span>
      <span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>change<span class="token punctuation">.</span>action <span class="token operator">===</span> <span class="token string">&#39;update&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">ymap1: Property &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>key<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot; was updated. New value: &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ymap1<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>
          key
        <span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;. Previous value: &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>change<span class="token punctuation">.</span>oldValue<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;.</span><span class="token template-punctuation string">`</span></span>
      <span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>change<span class="token punctuation">.</span>action <span class="token operator">===</span> <span class="token string">&#39;delete&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">ymap1: Property &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>key<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot; was deleted. New value: undefined. Previous value: &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>change<span class="token punctuation">.</span>oldValue<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;.</span><span class="token template-punctuation string">`</span></span>
      <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
ymap2<span class="token punctuation">.</span><span class="token function">observe</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  event<span class="token punctuation">.</span>changes<span class="token punctuation">.</span>keys<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">change<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>change<span class="token punctuation">.</span>action <span class="token operator">===</span> <span class="token string">&#39;add&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">ymap2: Property &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>key<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot; was added. Initial value: &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ymap2<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>
          key
        <span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;.</span><span class="token template-punctuation string">`</span></span>
      <span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>change<span class="token punctuation">.</span>action <span class="token operator">===</span> <span class="token string">&#39;update&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">ymap2: Property &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>key<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot; was updated. New value: &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ymap2<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>
          key
        <span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;. Previous value: &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>change<span class="token punctuation">.</span>oldValue<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;.</span><span class="token template-punctuation string">`</span></span>
      <span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>change<span class="token punctuation">.</span>action <span class="token operator">===</span> <span class="token string">&#39;delete&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">ymap2: Property &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>key<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot; was deleted. New value: undefined. Previous value: &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>change<span class="token punctuation">.</span>oldValue<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;.</span><span class="token template-punctuation string">`</span></span>
      <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 构造嵌套的 ymap</span>
<span class="token keyword">const</span> ymapAddress <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Y<span class="token punctuation">.</span>Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
ymapAddress<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&#39;country&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;China&#39;</span><span class="token punctuation">)</span>
ymapAddress<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&#39;city&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;shanghai&#39;</span><span class="token punctuation">)</span>
ymap1<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&#39;address&#39;</span><span class="token punctuation">,</span> ymapAddress<span class="token punctuation">)</span>

<span class="token comment">// 构造嵌套的 yarray</span>
<span class="token keyword">const</span> yarrayLikes <span class="token operator">=</span> <span class="token constant">Y</span><span class="token punctuation">.</span>Array<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&#39;Sing&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;dance&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;rap&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;basketball&#39;</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

ymap1<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&#39;likes&#39;</span><span class="token punctuation">,</span> yarrayLikes<span class="token punctuation">)</span>
ymap1<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&#39;name&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;kunkun&#39;</span><span class="token punctuation">)</span>
ymap1<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&#39;age&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;2.5&#39;</span><span class="token punctuation">)</span>
ymap1<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&#39;age&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;3&#39;</span><span class="token punctuation">)</span>
ymap2<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&#39;age&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;4&#39;</span><span class="token punctuation">)</span>
ymap1<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token string">&#39;age&#39;</span><span class="token punctuation">)</span>
ymap2<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&#39;sex&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;male&#39;</span><span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ymap1<span class="token punctuation">.</span><span class="token function">toJSON</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ymap2<span class="token punctuation">.</span><span class="token function">toJSON</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>输出结果如下所示，可以看到最终打印出的两个 yMap 的结果一致：</p><p><img src="/blog/_assets/yjs-event-update.e5fcc570.png" alt="yjs-event-update"></p><p>也可以通过交换完整文档结构来同步两个客户端</p><div class="language-js"><pre><code><span class="token operator">...</span>
<span class="token comment">// 通过交换完整文档结构来同步两个客户端</span>
<span class="token keyword">const</span> state1 <span class="token operator">=</span> <span class="token constant">Y</span><span class="token punctuation">.</span><span class="token function">encodeStateAsUpdate</span><span class="token punctuation">(</span>ydoc1<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> state2 <span class="token operator">=</span> <span class="token constant">Y</span><span class="token punctuation">.</span><span class="token function">encodeStateAsUpdate</span><span class="token punctuation">(</span>ydoc2<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token constant">Y</span><span class="token punctuation">.</span><span class="token function">applyUpdate</span><span class="token punctuation">(</span>ydoc1<span class="token punctuation">,</span> state2<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token constant">Y</span><span class="token punctuation">.</span><span class="token function">applyUpdate</span><span class="token punctuation">(</span>ydoc2<span class="token punctuation">,</span> state1<span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ymap1<span class="token punctuation">.</span><span class="token function">toJSON</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ymap2<span class="token punctuation">.</span><span class="token function">toJSON</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><h4 id="实现-quill-协同编辑"><a class="header-anchor" href="#实现-quill-协同编辑" aria-hidden="true">#</a> 实现 Quill 协同编辑</h4><p>通过以上的内容，我们可以不需要 y-quill，自己实现绑定层：</p><ol><li>创建 ydoc、ytext、quill 实例</li><li>监听 Quill 的<code>text-change</code> 事件，拿到 Delta 数据<code>delta.ops</code></li><li>在 <code>transact</code> 事物中，使用 <code>ytext.applyDelta</code> 将 Delta 数据应用于 ytext 实例</li><li>通过 <code>observe</code> 监听变化，此处需要过滤当前事务</li><li>使用 <code>updateContents</code> 更新 Quill 数据</li></ol><p>完整代码如下：</p><div class="language-js"><pre><code><span class="token comment">// 模拟编辑器绑定</span>
quill<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;text-change&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">delta<span class="token punctuation">,</span> content<span class="token punctuation">,</span> source</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 过滤非用户输入的事件</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>source <span class="token operator">===</span> <span class="token string">&#39;api&#39;</span><span class="token punctuation">)</span> <span class="token keyword">return</span>
  ydoc<span class="token punctuation">.</span><span class="token function">transact</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> ytext<span class="token punctuation">.</span><span class="token function">applyDelta</span><span class="token punctuation">(</span>delta<span class="token punctuation">.</span>ops<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
ytext<span class="token punctuation">.</span><span class="token function">observe</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">event<span class="token punctuation">,</span> origin</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 本地的变化不会引起quill更新</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>origin<span class="token punctuation">.</span>local<span class="token punctuation">)</span> <span class="token keyword">return</span>
  quill<span class="token punctuation">.</span><span class="token function">updateContents</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>delta<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>同样也能实现协同编辑效果。</p><h4 id="小结-2"><a class="header-anchor" href="#小结-2" aria-hidden="true">#</a> 小结</h4><p>这一套组合 API 看似和我们常用的 map、array 等相似，但它真正的强大之处在于 <code>Conflict-free</code>，在它的内部就已经包含了<strong>冲突解决</strong>的机制。对使用者来说，我们只是简单的使用 Shared Types 所提供的 API，协同编辑时所存在的状态冲突会被 Yjs 自动解决。</p><p>通常在代码中使用数组或对象表示应用的状态，现在只需增加一个简单的 Binding 层，将其转化为 Yjs 的 Shared Types，类似于 Quill 的 y-quill，应用就能够自然地获得多人编辑的能力。</p><h3 id="providers"><a class="header-anchor" href="#providers" aria-hidden="true">#</a> Providers</h3><h4 id="connection-providers"><a class="header-anchor" href="#connection-providers" aria-hidden="true">#</a> Connection Providers</h4><p>通过上一节，我们将 JSON 数据转换成了 Shared Types 的 yMap，使它有了自动解决冲突的能力，并且在本地模拟了不同客户端的数据同步，而为了能够在不同的客户端之间同步共享数据，就需要通过网络通信来完成。</p><p><strong>CRDT 本身和网络是解耦</strong>的，我们可以选择任意的通信方案，只要能保证更新数据成功的同步到远端即可。</p><p>Yjs 自身提供了 <a href="https://docs.yjs.dev/ecosystem/connection-provider" target="_blank" rel="noopener noreferrer">Connection Provider</a> 来实现不同客户端之间的通信，如：y-websocket、y-webrtc、y-dat 等。</p><p>websocket 和 webrtc （请阅读 <a href="https://juejin.cn/post/7266417942182608955" target="_blank" rel="noopener noreferrer">WebRTC 这么火 🔥，前端靓仔，请收下这篇入门教程</a>）大家应该都有所了解，<a href="https://docs.dat.foundation/docs/intro" target="_blank" rel="noopener noreferrer">Dat</a> 是一个 P2P 协议，是一个去中心化、安全、快速的文件传输协议，适用于各种需要传输文件的情况。</p><p>这里我们使用 y-websocket 来实现服务端与各客户端之间的文档同步。</p><p>y-websocket 支持 <code>cross-tab communication</code>：即当在同一浏览器的不同页签打开同一文档时，文档上的更改将通过<strong>跨选项卡通信</strong>进行交换（<a href="https://developer.mozilla.org/en-US/docs/Web/API/Broadcast_Channel_API" target="_blank" rel="noopener noreferrer">Broadcast Channel</a>和 localStorage）。</p><p>我们以 ytext 为例来看下：</p><div class="language-js"><pre><code><span class="token keyword">const</span> ydoc <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Y<span class="token punctuation">.</span>Doc</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> wsProvider <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebsocketProvider</span><span class="token punctuation">(</span>
  <span class="token string">&#39;ws://localhost:1234&#39;</span><span class="token punctuation">,</span>
  <span class="token string">&#39;my-room-name&#39;</span><span class="token punctuation">,</span>
  ydoc
<span class="token punctuation">)</span>

wsProvider<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;status&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>status<span class="token punctuation">)</span> <span class="token comment">// logs &quot;connected&quot; or &quot;disconnected&quot;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> yText <span class="token operator">=</span> ydoc<span class="token punctuation">.</span><span class="token function">getText</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// 在某份 YDoc 更新时，应用二进制的 update 数据到另一份 YDoc 上</span>
ydoc<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;update&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">update<span class="token punctuation">,</span> origin</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token constant">Y</span><span class="token punctuation">.</span><span class="token function">applyUpdate</span><span class="token punctuation">(</span>ydoc<span class="token punctuation">,</span> update<span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>yText<span class="token punctuation">.</span><span class="token function">toJSON</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  div<span class="token punctuation">.</span>innerText <span class="token operator">=</span> yText<span class="token punctuation">.</span><span class="token function">toJSON</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> button <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&#39;button&#39;</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> div <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&#39;div&#39;</span><span class="token punctuation">)</span>
button<span class="token punctuation">.</span>innerText <span class="token operator">=</span> <span class="token string">&#39;click&#39;</span>
document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&#39;#app&#39;</span><span class="token punctuation">)</span><span class="token operator">?.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>button<span class="token punctuation">)</span>
document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&#39;#app&#39;</span><span class="token punctuation">)</span><span class="token operator">?.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>div<span class="token punctuation">)</span>

button<span class="token punctuation">.</span><span class="token function-variable function">onclick</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> yText<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">)</span>
</code></pre></div><p>首先按照我们之前说的 <code>PORT=1234 npx y-websocket</code> 启动 websocket 服务</p><p>当点击 click 时，在最前面插入一个数字，效果如下：</p><p><img src="/blog/_assets/yjs-ytext-socket.cca944c4.gif" alt="yjs-ytext-socket"></p><p>其实可以看下<a href="https://github1s.com/yjs/y-websocket/blob/HEAD/bin/server.js" target="_blank" rel="noopener noreferrer">y-websocket</a>的源码，主要有以下几个过程：</p><ol><li><p>创建 Websocket 连接</p><p>在 <code>/bin/server.js</code> 中，通过 <code>ws</code> 启动一个 socket 服务，服务端只需要提供基础的消息转发能力即可</p><div class="language-js"><pre><code><span class="token keyword">const</span> WebSocket <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;ws&#39;</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;http&#39;</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> wss <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebSocket<span class="token punctuation">.</span>Server</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">noServer</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div></li><li><p>初始化 Yjs 实例</p><p>在 <code>/bin/utils.js</code> 中，通过 <code>WSSharedDoc</code> 创建一个 Yjs 实例</p><div class="language-js"><pre><code>
 <span class="token keyword">class</span> <span class="token class-name">WSSharedDoc</span> <span class="token keyword">extends</span> <span class="token class-name">Y<span class="token punctuation">.</span>Doc</span> <span class="token punctuation">{</span>
   <span class="token operator">...</span>
   <span class="token keyword">this</span><span class="token punctuation">.</span>conns <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
   <span class="token operator">...</span>
   <span class="token keyword">this</span><span class="token punctuation">.</span>awareness<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;update&#39;</span><span class="token punctuation">,</span> awarenessChangeHandler<span class="token punctuation">)</span>
   <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;update&#39;</span><span class="token punctuation">,</span> updateHandler<span class="token punctuation">)</span>
   <span class="token operator">...</span>
 <span class="token punctuation">}</span>
</code></pre></div><p><code>this.conns</code> 缓存所有的连接客户端 <code>this.on(&#39;update&#39;, updateHandler)</code> 用来监听 ydoc 文档的更新</p><div class="language-js"><pre><code><span class="token keyword">const</span> <span class="token function-variable function">updateHandler</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">update<span class="token punctuation">,</span> origin<span class="token punctuation">,</span> doc</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
<span class="token operator">...</span>
doc<span class="token punctuation">.</span>conns<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">_<span class="token punctuation">,</span> conn</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">send</span><span class="token punctuation">(</span>doc<span class="token punctuation">,</span> conn<span class="token punctuation">,</span> message<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在 <code>updateHandler</code> 中将文档的更新发送到每一个客户端。</p></li><li><p>客户端使用 <code>WebsocketProvider</code> 连接服务端</p><p>首先需要了解下 <a href="https://docs.yjs.dev/api/document-updates#example-building-a-custom-provider" target="_blank" rel="noopener noreferrer">自定义 Provider</a></p><p>在 <code>/src/y-websocket.js</code> 中，<code>WebsocketProvider</code> 继承 <code>lib0/observable</code> 的 <code>Observable</code>来自定义 Provider，与服务端建立连接</p></li><li><p>处理文档更新</p><p>一旦建立了 WebSocket 连接，Y-Websocket 开始同步文档状态。这涉及将客户端的本地文档状态发送到服务器，然后服务器再将其他客户端的编辑操作传递给当前客户端。</p><div class="language-js"><pre><code><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function-variable function">_updateHandler</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">update<span class="token punctuation">,</span> origin</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>origin <span class="token operator">!==</span> <span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> encoder <span class="token operator">=</span> encoding<span class="token punctuation">.</span><span class="token function">createEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    encoding<span class="token punctuation">.</span><span class="token function">writeVarUint</span><span class="token punctuation">(</span>encoder<span class="token punctuation">,</span> messageSync<span class="token punctuation">)</span>
    syncProtocol<span class="token punctuation">.</span><span class="token function">writeUpdate</span><span class="token punctuation">(</span>encoder<span class="token punctuation">,</span> update<span class="token punctuation">)</span>
    <span class="token function">broadcastMessage</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> encoding<span class="token punctuation">.</span><span class="token function">toUint8Array</span><span class="token punctuation">(</span>encoder<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>doc<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;update&#39;</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_updateHandler<span class="token punctuation">)</span>
</code></pre></div><p>在 <code>WebsocketProvider</code> 的构造函数中使用<code>this.doc.on(&#39;update&#39;)</code>监听 ydoc 文档的更新，然后通过 <code>broadcastMessage</code> 广播事件，这里判断 <code>origin !== this</code> 意思只有其他客户端的更新才会触发 <code>syncProtocol.writeUpdate</code> 方法（避免无限循环更新）。</p><p>这个方法来自于 <a href="https://github1s.com/yjs/y-protocols/blob/HEAD/sync.js#L114" target="_blank" rel="noopener noreferrer">y-protocols</a>，最终会调用 <code>readSyncStep2</code> 通过 <code>applyUpdate</code> 来更新文档。</p><div class="language-js"><pre><code><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">readSyncStep2</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">decoder<span class="token punctuation">,</span> doc<span class="token punctuation">,</span> transactionOrigin</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token constant">Y</span><span class="token punctuation">.</span><span class="token function">applyUpdate</span><span class="token punctuation">(</span>
      doc<span class="token punctuation">,</span>
      decoding<span class="token punctuation">.</span><span class="token function">readVarUint8Array</span><span class="token punctuation">(</span>decoder<span class="token punctuation">)</span><span class="token punctuation">,</span>
      transactionOrigin
    <span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// This catches errors that are thrown by event handlers</span>
    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&#39;Caught error while handling a Yjs update&#39;</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>broadcastMessage</code> 也很有特点，当 websocket 连接失败时，会通过 <code>broadcastchannel</code> 来实现同一浏览器不同页签之间的协同。</p><div class="language-js"><pre><code><span class="token keyword">const</span> <span class="token function-variable function">broadcastMessage</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">provider<span class="token punctuation">,</span> buf</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> ws <span class="token operator">=</span> provider<span class="token punctuation">.</span>ws
  <span class="token keyword">if</span> <span class="token punctuation">(</span>provider<span class="token punctuation">.</span>wsconnected <span class="token operator">&amp;&amp;</span> ws <span class="token operator">&amp;&amp;</span> ws<span class="token punctuation">.</span>readyState <span class="token operator">===</span> ws<span class="token punctuation">.</span><span class="token constant">OPEN</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ws<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>provider<span class="token punctuation">.</span>bcconnected<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    bc<span class="token punctuation">.</span><span class="token function">publish</span><span class="token punctuation">(</span>provider<span class="token punctuation">.</span>bcChannel<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> provider<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ol><p>以上就是 y-websocket 的大致流程，其实也不是很复杂，我们可以修改它来做一些定制化的开发，要想更加详细的了解 Yjs 的同步过程，可以查看<a href="https://medium.com/dovetail-engineering/yjs-fundamentals-part-2-sync-awareness-73b8fabc2233" target="_blank" rel="noopener noreferrer">Yjs Fundamentals — Part 2: Sync &amp; Awareness</a>这篇文章。</p><h4 id="database-provider"><a class="header-anchor" href="#database-provider" aria-hidden="true">#</a> Database Provider</h4><p>YJs 不仅提供了 Connection Provider 来实现客户端的协作，并且提供了 Database Provider 将文档数据同步到持久化层或离线存储层：如 y-indexeddb、y-redis 等。</p><div class="language-bash"><pre><code><span class="token function">yarn</span> <span class="token function">add</span> y-redis
</code></pre></div><div class="language-js"><pre><code><span class="token keyword">const</span> <span class="token punctuation">{</span> RedisPersistence <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;y-redis&#39;</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> redisConfig <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">host</span><span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">REDIS_HOST</span><span class="token punctuation">,</span>
  <span class="token literal-property property">port</span><span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">REDIS_PORT</span><span class="token punctuation">,</span>
  <span class="token literal-property property">password</span><span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">REDIS_PASSWORD</span><span class="token punctuation">,</span>
  <span class="token literal-property property">db</span><span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">REDIS_DB</span><span class="token punctuation">,</span>
  <span class="token literal-property property">keyPrefix</span><span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">REDIS_KEY_PREFIIX</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> rp <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RedisPersistence</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">redisOpts</span><span class="token operator">:</span> redisConfig <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> persistence <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">provider</span><span class="token operator">:</span> rp<span class="token punctuation">,</span>
  <span class="token function-variable function">bindState</span><span class="token operator">:</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">docName<span class="token punctuation">,</span> ydoc</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    rp<span class="token punctuation">.</span><span class="token function">closeDoc</span><span class="token punctuation">(</span>docName<span class="token punctuation">)</span>
    <span class="token keyword">return</span> rp<span class="token punctuation">.</span><span class="token function">bindState</span><span class="token punctuation">(</span>docName<span class="token punctuation">,</span> ydoc<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function-variable function">writeState</span><span class="token operator">:</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">docName<span class="token punctuation">,</span> ydoc</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="awareness-presence"><a class="header-anchor" href="#awareness-presence" aria-hidden="true">#</a> Awareness &amp; Presence</h3><p>上一节我们通过 Connect Provider 实现了不同客户端之间的协作，但协同编辑不仅仅是数据的同步，还需要一些交互上的优化，诸如：<strong>当前在线用户列表、用户编辑位置以及光标位置</strong>，这些信息被称为 <code>Awareness</code>。</p><p>通常这些信息数据量较少，因此 Yjs 内部采用了 <code>state-based Awareness CRDT</code> 将信息转为 JSON 对象传播给所有用户。但它并不是 Yjs 模块，它是在 <a href="https://github.com/yjs/y-protocols" target="_blank" rel="noopener noreferrer">y-protocols</a> 内部定义的，所有的 Providers 都默认实现了，并且提供了<a href="https://docs.yjs.dev/api/about-awareness#awareness-crdt" target="_blank" rel="noopener noreferrer">Awareness CRDT API</a> 帮助我们获取 Awareness 的变化和更新等状态。</p><h4 id="awareness-new-awarenessprotocol-awareness-ydoc-y-doc"><a class="header-anchor" href="#awareness-new-awarenessprotocol-awareness-ydoc-y-doc" aria-hidden="true">#</a> awareness = new awarenessProtocol.Awareness(ydoc: Y.Doc)</h4><p>创建 awareness 实例，在 Provider 中我们可以通过以下代码获取到 awareness</p><div class="language-js"><pre><code>awareness <span class="token operator">=</span> provider<span class="token punctuation">.</span>awareness
</code></pre></div><p>它是在 Provider 内部创建和维护</p><h4 id="awareness-setlocalstatefield-string-any"><a class="header-anchor" href="#awareness-setlocalstatefield-string-any" aria-hidden="true">#</a> awareness.setLocalStateField(string, any)</h4><p>为本地 awareness 设置或更新键值对。</p><h4 id="awareness-getstates-map-string-object-string-any"><a class="header-anchor" href="#awareness-getstates-map-string-object-string-any" aria-hidden="true">#</a> awareness.getStates(): Map&lt;string, Object&lt;string, any&gt;&gt;</h4><p>获取所有 awareness（远程和本地）</p><h4 id="awareness-on-update-added-array-updated-array-removed-array-transactionorigin-any"><a class="header-anchor" href="#awareness-on-update-added-array-updated-array-removed-array-transactionorigin-any" aria-hidden="true">#</a> awareness.on(&#39;update&#39;, ({ added: Array, updated: Array, removed: Array }, [transactionOrigin:any]) =&gt; ..)</h4><p>监听远程和本地意识变化。即使感知状态未更改，但仅更新以通知其他用户该客户端仍处于在线状态，也会调用此事件。如果您想要将感知状态传播给其他用户，请使用此事件。</p><h4 id="awareness-on-change-added-array-updated-array-removed-array-transactionorigin-any"><a class="header-anchor" href="#awareness-on-change-added-array-updated-array-removed-array-transactionorigin-any" aria-hidden="true">#</a> awareness.on(&#39;change&#39;, ({ added: Array, updated: Array, removed: Array }, [transactionOrigin:any]) =&gt; ..)</h4><p>监听远程和本地状态变化 ​​。当添加、更新或删除状态时收到通知。</p><p>我们来看一个简单的例子，在之前的 Quill 协同编辑文档中展示当前编辑的人名：</p><div class="language-js"><pre><code><span class="token comment">// 从wsProvider获取awareness</span>
<span class="token keyword">const</span> awareness <span class="token operator">=</span> wsProvider<span class="token punctuation">.</span>awareness

<span class="token comment">// 监听awareness变化</span>
awareness<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;change&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">changes</span><span class="token operator">:</span> <span class="token constant">Y</span><span class="token punctuation">.</span>Transaction</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 获取所有协同信息 显示光标位置和用户列表</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>awareness<span class="token punctuation">.</span><span class="token function">getStates</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 设置user字段传递用户信息 { name: &#39;&#39;, color: &#39;&#39; }</span>
<span class="token comment">// 如果未指定user字段，Provider会使用随机用户名以默认颜色呈现光标。</span>
awareness<span class="token punctuation">.</span><span class="token function">setLocalStateField</span><span class="token punctuation">(</span><span class="token string">&#39;user&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&#39;Emmanuelle Charpentier&#39;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">color</span><span class="token operator">:</span> <span class="token string">&#39;#ffb61e&#39;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p><img src="/blog/_assets/yjs-awareness-demo.7988182a.png" alt="yjs-awareness-demo"></p><h4 id="awareness-protocol"><a class="header-anchor" href="#awareness-protocol" aria-hidden="true">#</a> Awareness Protocol</h4><p>如果自定义 Provider 时，则需要了解 <a href="https://docs.yjs.dev/api/about-awareness#awareness-protocol-api" target="_blank" rel="noopener noreferrer">Awareness Protocol API</a> 为 Provider 添加 Awareness。</p><h5 id="awarenessprotocol-encodeawarenessupdate-uint8array"><a class="header-anchor" href="#awarenessprotocol-encodeawarenessupdate-uint8array" aria-hidden="true">#</a> awarenessProtocol.encodeAwarenessUpdate: Uint8Array</h5><p>将指定客户端的感知状态编码为 Uint8Array 编码的更新。</p><h5 id="awarenessprotocol-applyawarenessupdate-awareness-awareness-update-uint8array-origin-any"><a class="header-anchor" href="#awarenessprotocol-applyawarenessupdate-awareness-awareness-update-uint8array-origin-any" aria-hidden="true">#</a> awarenessProtocol.applyAwarenessUpdate(awareness: Awareness, update: Uint8array, origin: any)</h5><p>将使用 encodeAwarenessUpdate 创建的感知更新应用到感知 CRDT 的实例。</p><h5 id="awarenessprotocol-removeawarenessstates-origin-any"><a class="header-anchor" href="#awarenessprotocol-removeawarenessstates-origin-any" aria-hidden="true">#</a> awarenessProtocol.removeAwarenessStates, origin: any)</h5><p>删除指定客户端的感知状态。这将调用 Awareness CRDT 的更新和更改事件处理程序。</p><p>Awareness CRDT 更新的工作方式与 Yjs 更新类似，之前我们再讲 y-websocket 的流程时漏掉了 Awareness，现在我们可以再过一遍 y-websocket 源码：</p><ol><li><p>创建 Websocket 连接</p></li><li><p>初始化 Yjs 实例</p><p>这一步同时创建 <code>awareness</code> 实例</p><div class="language-js"><pre><code><span class="token keyword">this</span><span class="token punctuation">.</span>awareness <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">awarenessProtocol<span class="token punctuation">.</span>Awareness</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>awareness<span class="token punctuation">.</span><span class="token function">setLocalState</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>
</code></pre></div><p>通过 <code>awareness.on(&#39;update&#39;</code> 监听本地状态变化，通过 <code>awarenessProtocol.encodeAwarenessUpdate</code> 编码为 Uint8Array 数据包，发送到每一个客户端</p><div class="language-js"><pre><code><span class="token keyword">const</span> <span class="token function-variable function">awarenessChangeHandler</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> added<span class="token punctuation">,</span> updated<span class="token punctuation">,</span> removed <span class="token punctuation">}</span><span class="token punctuation">,</span> conn</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
 <span class="token operator">...</span>
 encoding<span class="token punctuation">.</span><span class="token function">writeVarUint8Array</span><span class="token punctuation">(</span>encoder<span class="token punctuation">,</span> awarenessProtocol<span class="token punctuation">.</span><span class="token function">encodeAwarenessUpdate</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>awareness<span class="token punctuation">,</span> changedClients<span class="token punctuation">)</span><span class="token punctuation">)</span>
 <span class="token keyword">const</span> buff <span class="token operator">=</span> encoding<span class="token punctuation">.</span><span class="token function">toUint8Array</span><span class="token punctuation">(</span>encoder<span class="token punctuation">)</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>conns<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">_<span class="token punctuation">,</span> c</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">send</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> c<span class="token punctuation">,</span> buff<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>awareness<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;update&#39;</span><span class="token punctuation">,</span> awarenessChangeHandler<span class="token punctuation">)</span>
</code></pre></div></li><li><p>客户端使用 <code>WebsocketProvider</code> 连接服务端</p></li><li><p>处理文档更新</p><p>在处理文档更新的同时，处理感知数据的更新，发送消息方式与文档更新的一致，这里不再赘述</p><div class="language-js"><pre><code><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function-variable function">_awarenessUpdateHandler</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> added<span class="token punctuation">,</span> updated<span class="token punctuation">,</span> removed <span class="token punctuation">}</span><span class="token punctuation">,</span> _origin</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
 <span class="token operator">...</span>
 <span class="token function">broadcastMessage</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> encoding<span class="token punctuation">.</span><span class="token function">toUint8Array</span><span class="token punctuation">(</span>encoder<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
awareness<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;update&#39;</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_awarenessUpdateHandler<span class="token punctuation">)</span>
</code></pre></div></li><li><p>断开连接</p><p>当某个客户端断开连接时，通过 <code>awarenessProtocol.removeAwarenessStates</code> 删除它的感知状态，</p><div class="language-js"><pre><code><span class="token keyword">const</span> <span class="token function-variable function">closeConn</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">doc<span class="token punctuation">,</span> conn</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
 <span class="token operator">...</span>
 awarenessProtocol<span class="token punctuation">.</span><span class="token function">removeAwarenessStates</span><span class="token punctuation">(</span>doc<span class="token punctuation">.</span>awareness<span class="token punctuation">,</span> Array<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>controlledIds<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
 <span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在 y-websocket，每个客户端每 30 秒向服务器发送一次心跳，如果在过去 30 秒内未从客户端收到消息，其他客户端会将其标记为离线。</p><div class="language-js"><pre><code><span class="token keyword">const</span> pingTimeout <span class="token operator">=</span> <span class="token number">30000</span>
<span class="token keyword">const</span> pingInterval <span class="token operator">=</span> <span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pongReceived<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>doc<span class="token punctuation">.</span>conns<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>conn<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">closeConn</span><span class="token punctuation">(</span>doc<span class="token punctuation">,</span> conn<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token function">clearInterval</span><span class="token punctuation">(</span>pingInterval<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>doc<span class="token punctuation">.</span>conns<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>conn<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    pongReceived <span class="token operator">=</span> <span class="token boolean">false</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      conn<span class="token punctuation">.</span><span class="token function">ping</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">closeConn</span><span class="token punctuation">(</span>doc<span class="token punctuation">,</span> conn<span class="token punctuation">)</span>
      <span class="token function">clearInterval</span><span class="token punctuation">(</span>pingInterval<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> pingTimeout<span class="token punctuation">)</span>
</code></pre></div></li></ol><h3 id="undomanager"><a class="header-anchor" href="#undomanager" aria-hidden="true">#</a> UndoManager</h3><p>Yjs 提供了 UndoManager，用来追踪本地更改，提供 uodo/redo 功能。</p><div class="language-js"><pre><code><span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> <span class="token constant">Y</span> <span class="token keyword">from</span> <span class="token string">&#39;yjs&#39;</span>

<span class="token keyword">const</span> ytext <span class="token operator">=</span> doc<span class="token punctuation">.</span><span class="token function">getText</span><span class="token punctuation">(</span><span class="token string">&#39;text&#39;</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> undoManager <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Y<span class="token punctuation">.</span>UndoManager</span><span class="token punctuation">(</span>ytext<span class="token punctuation">)</span>

ytext<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">&#39;abc&#39;</span><span class="token punctuation">)</span>
undoManager<span class="token punctuation">.</span><span class="token function">stopCapturing</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
undoManager<span class="token punctuation">.</span><span class="token function">undo</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
ytext<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// =&gt; &#39;&#39;</span>
undoManager<span class="token punctuation">.</span><span class="token function">redo</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
ytext<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// =&gt; &#39;abc&#39;</span>
</code></pre></div><p>结合以上代码，我们来看下它的 API</p><h4 id="const-undomanager-new-y-undomanager-scope-y-abstracttype-array-y-abstracttype-capturetimeout-number-trackedorigins-deletefilter-function-item-boolean"><a class="header-anchor" href="#const-undomanager-new-y-undomanager-scope-y-abstracttype-array-y-abstracttype-capturetimeout-number-trackedorigins-deletefilter-function-item-boolean" aria-hidden="true">#</a> const undoManager = new Y.UndoManager(scope: Y.AbstractType | Array&lt;Y.AbstractType&gt; [, {captureTimeout: number, trackedOrigins deleteFilter: function(item):boolean}])</h4><p>在 Shared Types 上创建 Y.UndoManager，如果任何指定类型或其任何子类型被修改，UndoManager 将在其堆栈上添加反向操作。</p><p>默认情况下追踪所有本地更改，Shared Types 每次更改都会有来源，所以可以通过指定 <code>trackedOrigins</code> 来过滤特定来源的更改，默认为 null，即不过滤。</p><div class="language-js"><pre><code><span class="token keyword">const</span> undoManager <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Y<span class="token punctuation">.</span>UndoManager</span><span class="token punctuation">(</span>ytext<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">trackedOrigins</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">42</span><span class="token punctuation">,</span> CustomBinding<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>UndoManager 合并在特定 <code>captureTimeout</code>（默认为 500ms）内创建的编辑，将其设置为 0 以单独捕获每个更改。</p><div class="language-js"><pre><code><span class="token keyword">const</span> undoManager <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Y<span class="token punctuation">.</span>UndoManager</span><span class="token punctuation">(</span>ytext<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">captureTimeout</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h4 id="undomanager-undo-undomanager-redo-undomanager-clear"><a class="header-anchor" href="#undomanager-undo-undomanager-redo-undomanager-clear" aria-hidden="true">#</a> undoManager.undo()/undoManager.redo()/undoManager.clear()</h4><p>在 undoManager 实例上有两个堆栈 undoStack 和 redoStack 用于记录 undo/redo 操作：</p><p>undo 方法会撤消 undoStack 堆栈上的最后一个操作，将栈顶添加到 redoStack 上。</p><p>redo 方法重做 redoStack 堆栈上的最后一个操作，将栈顶添加到 undoStack 上。</p><p>clear 方法会清空这两个堆栈。</p><h4 id="undomanager-stopcapturing"><a class="header-anchor" href="#undomanager-stopcapturing" aria-hidden="true">#</a> undoManager.stopCapturing()</h4><p>前面提到 UndoManager 会默认合并 <code>captureTimeout</code> 设置的时间间隔内的操作，如果每步都想单独成为历史记录的话，可以设置 <code>captureTimeout</code> 为 0 即可；</p><p>而如果只是想设置单步的记录时，可以通过调用 stopCapturing() 方法确保 UndoManager 的下一个操作不会与上一个操作合并。</p><div class="language-js"><pre><code><span class="token keyword">const</span> undoManager <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Y<span class="token punctuation">.</span>UndoManager</span><span class="token punctuation">(</span>yText<span class="token punctuation">)</span>

yText<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">&#39;abc&#39;</span><span class="token punctuation">)</span>
undoManager<span class="token punctuation">.</span><span class="token function">stopCapturing</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
yText<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">&#39;def&#39;</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>undoManager<span class="token punctuation">)</span>
</code></pre></div><p>未调用 stopCapturing 方法： <img src="/blog/_assets/yjs-no-captureTimeout.f7734899.png" alt="yjs-no-captureTimeout"></p><p>调用 stopCapturing 方法： <img src="/blog/_assets/yjs-captureTimeout.62dd7639.png" alt="yjs-captureTimeout"></p><p>可以看到未调用 stopCapturing 方法后，在<code>undoStack</code> 堆栈只会形成一条数据，而调用之后，会生成两条堆栈信息。</p><h4 id="on-stack-item-added-on-stack-item-popped"><a class="header-anchor" href="#on-stack-item-added-on-stack-item-popped" aria-hidden="true">#</a> on(&#39;stack-item-added&#39;,...) / on(&#39;stack-item-popped&#39;, ...)</h4><p>监听 undo/redo 事件，如可在事件发生时向 StackItems 添加附加信息，用来恢复光标位置或文档视图等</p><div class="language-js"><pre><code>undoManager<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;stack-item-added&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 将当前光标位置保存在堆栈项上</span>
  <span class="token comment">// getRelativeCursorLocation()</span>
  event<span class="token punctuation">.</span>stackItem<span class="token punctuation">.</span>meta<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&#39;cursor-location&#39;</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

undoManager<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;stack-item-popped&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 恢复堆栈项上的当前光标位置</span>
  <span class="token keyword">const</span> cursorLocation <span class="token operator">=</span> event<span class="token punctuation">.</span>stackItem<span class="token punctuation">.</span>meta<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&#39;cursor-location&#39;</span><span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>cursorLocation<span class="token punctuation">)</span>
  <span class="token comment">// restoreCursorLocation()</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="offline-support-离线支持"><a class="header-anchor" href="#offline-support-离线支持" aria-hidden="true">#</a> Offline Support 离线支持</h2><p>我们前面介绍了 Yjs 通过 Network Provider 可以在不同网络间传输，DataBase Provider 可以将文档更新同步到数据库。</p><p>y-indexeddb 是 DataBase Provider 的其中一种 ，可以将文档更新同步到 <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/IndexedDB_API" target="_blank" rel="noopener noreferrer">IndexDB</a> 数据库，实现离线编辑功能。</p><p>单个 Provider 都可以与其他 Provider 进行合作，比如我们可以通过 y-websocket 进行网络之间的同步，也可以通过 y-redis、y-indexeddb 等将文档持久化到 redis 或 IndexedDB 中。</p><p>这样在弱网或无网络状态时文档的修改也会记录在 indexedDB 中，网络正常后再同步到服务端，不会造成文档内容的丢失； 同时使用 y-indexeddb 和 y-websocket 会将会在每个客户端的 IndexedDB 数据库中存储下来，如果某个客户端或者服务器丢失一些数据时，其他客户端也会将最新的文档同步回服务器。</p><div class="language-bash"><pre><code><span class="token function">yarn</span> <span class="token function">add</span> y-indexeddb
</code></pre></div><div class="language-js"><pre><code><span class="token keyword">import</span> <span class="token punctuation">{</span> IndexeddbPersistence <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;y-indexeddb&#39;</span>

<span class="token keyword">const</span> ydoc <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Y<span class="token punctuation">.</span>Doc</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> roomName <span class="token operator">=</span> <span class="token string">&#39;quill-room-name&#39;</span>

<span class="token keyword">const</span> indexDBProvider <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IndexeddbPersistence</span><span class="token punctuation">(</span>roomName<span class="token punctuation">,</span> ydoc<span class="token punctuation">)</span>
indexDBProvider<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&#39;version&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;1&#39;</span><span class="token punctuation">)</span>
indexDBProvider<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;synced&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;从IndexDB加载文档&#39;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>y-indexeddb 与之前 y-websocket 的工作方式类似，也是传入房间名称和 Yjs 文档，通过房间名称来连接 Yjs 文档，所有相同房间名称的文档都将同步。</p><p>此时，文档的更改都会保存到 IndexedDB 数据库中，重新访问站点时，将首先从 IndexedDB 数据库加载文档。</p><p><img src="/blog/_assets/y-indexedDB.1a9978e4.png" alt="y-indexedDB"></p><p>可以看到 <code>quill-room-name</code> 命名的 IndexedDB 中包含 <code>custom</code> 和 <code>updates</code> 两个对象存储区， <code>custom</code>主要用来存储自定义属性，<code>updates</code> 主要是记录文档的更新信息。</p><h4 id="provider-new-indexeddbpersistence-docname-string-ydoc-y-doc"><a class="header-anchor" href="#provider-new-indexeddbpersistence-docname-string-ydoc-y-doc" aria-hidden="true">#</a> provider = new IndexeddbPersistence(docName: string, ydoc: Y.Doc)</h4><p>创建 indexedDB 的 provider</p><h4 id="provider-on-synced-function-idbpersistence-indexeddbpersistence"><a class="header-anchor" href="#provider-on-synced-function-idbpersistence-indexeddbpersistence" aria-hidden="true">#</a> provider.on(&#39;synced&#39;, function(idbPersistence: IndexeddbPersistence))</h4><p>当与 IndexedDB 数据库的连接建立并且所有可用内容都已加载时，将触发 <code>synced</code> 事件。<strong>当尚无内容可用时，也会触发该事件</strong>。</p><h4 id="provider-set-key-any-value-any-get-del"><a class="header-anchor" href="#provider-set-key-any-value-any-get-del" aria-hidden="true">#</a> provider.set(key: any, value: any)/get/del</h4><p>通过 provider.set 可以在 provider 实例上设置自定义属性，存储文档的相关元信息，通过 get/del 获取或删除单个属性。</p><h4 id="provider-destroy-promise"><a class="header-anchor" href="#provider-destroy-promise" aria-hidden="true">#</a> provider.destroy(): Promise</h4><p>关闭与 IndexedDB 数据库的连接并停止同步文档。当 Yjs 文档被销毁时，会自动调用此方法。</p><h4 id="provider-cleardata-promise"><a class="header-anchor" href="#provider-cleardata-promise" aria-hidden="true">#</a> provider.clearData(): Promise</h4><p>销毁 IndexedDB 数据库并删除存储的文档和所有相关元信息。</p><h2 id="yjs-与不同编辑器的绑定"><a class="header-anchor" href="#yjs-与不同编辑器的绑定" aria-hidden="true">#</a> Yjs 与不同编辑器的绑定</h2><p>在文章前面我们介绍 Quill 的协同编辑时，使用 y-quill 将 Yjs 与 Quill 进行绑定，实现了 Quill 的协同编辑。同时也在不使用 y-quill 的情况下，使用 Yjs 自带的 API 实现了 Quill 的协同编辑。</p><p>回忆下整个过程：</p><ol><li>首先监听 Quill 文本的变化；</li><li>接着将 Quill 的 Delta 数据结构转换为 yText 结构；</li><li>yText 改变时通过 y-websocket 发送到其他客户端；</li><li>其他客户端监听 yText 的变化，解析出 Quill 的 Delta 数据，回填到编辑器中。</li></ol><p>Yjs 已经提供了常用的编辑器的数据绑定，像<a href="https://docs.yjs.dev/ecosystem/editor-bindings/prosemirror" target="_blank" rel="noopener noreferrer">Prosemirror</a>、<a href="https://docs.yjs.dev/ecosystem/editor-bindings/tiptap2" target="_blank" rel="noopener noreferrer">Tiptap</a>、<a href="https://docs.yjs.dev/ecosystem/editor-bindings/monaco" target="_blank" rel="noopener noreferrer">Monaco</a>、<a href="https://docs.yjs.dev/ecosystem/editor-bindings/quill" target="_blank" rel="noopener noreferrer">Quill</a> 等等，我们可以看下<a href="https://github.com/yjs/y-quill/blob/master/src/y-quill.js" target="_blank" rel="noopener noreferrer">y-quill</a>和<a href="https://github.com/yjs/y-monaco/blob/HEAD/src/y-monaco.js" target="_blank" rel="noopener noreferrer">y-monaco</a>的源码，Yjs 应用到不同的编辑器，基本都是这一套逻辑：</p><p>首先监听编辑器的数据变化，当发生变化时，将编辑器数据转为 Yjs 的 Shared Types 数据结构，当本地 Yjs 数据发生变化时会通过 Network Provider 将数据结构同步给所有协同者，其他协同者再通过监听 Yjs 数据的变动，将 Yjs 数据转为编辑器数据，利用自身的 API 将变化填充到编辑器中，从而实现协同编辑。</p><p><img src="/blog/_assets/yjs-flow.34c7b153.png" alt="yjs-flow"></p><p>从流程图可以看出每一个客户端都维护了一个 Yjs 数据结构的副本，这个数据结构副本所表达的内容与 Slate 编辑器数据所表达的内容完全一样，只是它们承担职责不同，Slate 数据供编辑器及其插件渲染使用，然后 Yjs 数据结构用于处理冲突、保证数据一致性，数据的修改最终是通过 Yjs 的数据结构来进行同步的。</p><h2 id="总结"><a class="header-anchor" href="#总结" aria-hidden="true">#</a> 总结</h2><p>本文通过实现 Yjs + Quill 的协同编辑，学习 Yjs 基本使用方法，以及一些 Yjs 的核心概念：Documents、Shared Types、Provider、 Awareness 等。最后介绍了 Yjs 与不同编辑器的绑定，可以使用 y-quill、y-monaco、y-prosemirror、y-tiptap 等编辑器绑定，实现不同编辑器的协同编辑，如需实现其他应用的协同编辑时，最重要的也是实现 Yjs 数据模型和应用数据模型的绑定，可以通过阅读以上几个编辑器的绑定源码来实现。</p></div><div class="links-wrapper"><div class="prev-link"><!----></div><div class="next-link"><!----></div></div><div><footer class="page-edit"><!-- <a v-for="(item,index) in data.platform" :key="index" :href="item.href">
        <img class="imgIcon" :src="item.icon" />
      </a> --></footer><!-- <p class="platform">
      以上皆为
      <a href="javascript:;">纪年</a> 文章发布平台
    </p> --><p class="platform"><a href="https://beian.miit.gov.cn/" target="_blank">京ICP备2022027737号</a><br> Copyright © 2022 - present <a href="https://github.com/wang1xiang">@wangxiang</a></p></div><!--[--><!--]--></div><!-- 只想点击背景才关闭 请使用 .self 修饰符 --><div style="display:none;" class="imgBox"><img src=""></div><!--]--></main><div class="theme-select" data-v-afcf09d4><ul data-v-afcf09d4><li class="active" data-v-afcf09d4>☀️</li><li class="" data-v-afcf09d4>🌑</li></ul></div></div><!----><!--]--></div>
    <script>__VP_HASH_MAP__ = JSON.parse("{\"README.md\":\"586a6f14\",\"index.md\":\"4f989c38\",\"more_docs.md\":\"8a628146\",\"more_index.md\":\"1ef28a80\",\"more_tags.md\":\"2ad29310\",\"docs_css_grid.md\":\"089f6eb0\",\"docs_css_placeholder.md\":\"04c49e9c\",\"docs_css_tailWindcss-start.md\":\"14ff19b5\",\"docs_docker_docker-start.md\":\"d4b0d88e\",\"docs_electron_electron-bug.md\":\"b1027b72\",\"docs_electron_electron-check-update.md\":\"d2659dd5\",\"docs_electron_electron-diaoyan.md\":\"c318ef56\",\"docs_electron_electron-object-destroyed.md\":\"9f182f68\",\"docs_electron_electron-og.md\":\"c872375d\",\"docs_electron_electron-open-other.md\":\"af388e74\",\"docs_electron_electron-protocol.md\":\"87c521fd\",\"docs_electron_electron-sentry.md\":\"2adecf0b\",\"docs_electron_electron-sign-windows.md\":\"55d93d75\",\"docs_electron_electron-sign.md\":\"3bfc74a7\",\"docs_electron_electron-sqlite3-bug.md\":\"dae0bdb2\",\"docs_electron_electron-sqlite3-start.md\":\"399ff87b\",\"docs_electron_electron-sqlite3.md\":\"ef3e2345\",\"docs_electron_electron-start.md\":\"0c66674a\",\"docs_electron_electron-update.md\":\"6a2972c7\",\"docs_electron_electron-webview-zoom.md\":\"c427b894\",\"docs_electron_hybrid-electron.md\":\"f732109b\",\"docs_electron_sentry-electron.md\":\"5a63f85a\",\"docs_flutter_flutter-dart.md\":\"a34d8438\",\"docs_flutter_flutter-other.md\":\"9703c8ab\",\"docs_flutter_flutter-route-manage.md\":\"4cbbfbdc\",\"docs_flutter_flutter-start.md\":\"4b9638cb\",\"docs_flutter_flutter-state-manage.md\":\"c3ac7a2e\",\"docs_flutter_flutter-wechat-pay.md\":\"c3a2980e\",\"docs_git_git-autocrlf.md\":\"ed4e7f77\",\"docs_git_git-ignorecase.md\":\"c0ea6470\",\"docs_git_git-notes.md\":\"6da214bc\",\"docs_git_git-rebase.md\":\"976b7f44\",\"docs_git_git-username.md\":\"10bfa3f2\",\"docs_git_gitflow.md\":\"9b8cdec1\",\"docs_git_gitlab-ci-start.md\":\"02b1f4c1\",\"docs_http_http.md\":\"3cf03cd3\",\"docs_javascript_async-await.md\":\"5321a06d\",\"docs_javascript_createEvent.md\":\"0a8719c2\",\"docs_javascript_html2docs.md\":\"52680083\",\"docs_javascript_http-cache.md\":\"75e49310\",\"docs_javascript_image-load.md\":\"6e3be031\",\"docs_javascript_indexDB-dexie.md\":\"5155b445\",\"docs_javascript_javascript-utils.md\":\"21b7e46f\",\"docs_javascript_memory-leak.md\":\"21d128c5\",\"docs_javascript_office-preview-type.md\":\"464dda41\",\"docs_javascript_page-alive.md\":\"2800481b\",\"docs_javascript_performance-optimization.md\":\"b7b6d885\",\"docs_javascript_preload-prefetch.md\":\"b13cafdb\",\"docs_javascript_scrollend.md\":\"6f5acb8a\",\"docs_javascript_storage-change.md\":\"1397d666\",\"docs_javascript_turborepo-start.md\":\"93703a64\",\"docs_javascript_webworker.md\":\"ea0f81c8\",\"docs_javascript_zero-width-space.md\":\"5b6ba8cc\",\"docs_leetcode_array-code.md\":\"309c15b5\",\"docs_leetcode_array-code1.md\":\"5488e802\",\"docs_leetcode_back-tracking-code.md\":\"51c0e57b\",\"docs_leetcode_back-tracking-code1.md\":\"64d7b54d\",\"docs_leetcode_back-tracking-code2.md\":\"ca219913\",\"docs_leetcode_back-tracking-code3.md\":\"e5e2cf62\",\"docs_leetcode_binary-tree-code.md\":\"63cad71d\",\"docs_leetcode_binary-tree-code1.md\":\"1c0bf555\",\"docs_leetcode_binary-tree-code2.md\":\"f9ee807e\",\"docs_leetcode_binary-tree-code3.md\":\"283832ae\",\"docs_leetcode_binary-tree-code4.md\":\"6f1f99a4\",\"docs_leetcode_binary-tree-code5.md\":\"565df205\",\"docs_leetcode_binary-tree-code6.md\":\"3c835e03\",\"docs_leetcode_binary-tree-code7.md\":\"62a536db\",\"docs_leetcode_dynamic-programming-code.md\":\"bcf8a332\",\"docs_leetcode_dynamic-programming-code10.md\":\"2af493ec\",\"docs_leetcode_dynamic-programming-code11.md\":\"485749a8\",\"docs_leetcode_dynamic-programming-code12.md\":\"2c22130b\",\"docs_leetcode_dynamic-programming-code13.md\":\"aebdb190\",\"docs_leetcode_dynamic-programming-code2.md\":\"b9eacf92\",\"docs_leetcode_dynamic-programming-code3.md\":\"bc90733e\",\"docs_leetcode_dynamic-programming-code4.md\":\"9e2662b9\",\"docs_leetcode_dynamic-programming-code5.md\":\"d3cbdd33\",\"docs_leetcode_dynamic-programming-code6.md\":\"00b48e8e\",\"docs_leetcode_dynamic-programming-code7.md\":\"02114355\",\"docs_leetcode_dynamic-programming-code8.md\":\"a95b8831\",\"docs_leetcode_dynamic-programming-code9.md\":\"53ad4a83\",\"docs_leetcode_graph-theory.md\":\"0357332d\",\"docs_leetcode_graph-theory2.md\":\"8da2eee2\",\"docs_leetcode_greedy-algorithmc-code.md\":\"a70f62ad\",\"docs_leetcode_greedy-algorithmc-code2.md\":\"93e631e9\",\"docs_leetcode_greedy-algorithmc-code3.md\":\"40487f10\",\"docs_leetcode_greedy-algorithmc-code4.md\":\"dd7243db\",\"docs_leetcode_greedy-algorithmc-code5.md\":\"aadf5218\",\"docs_leetcode_hash-code.md\":\"357e13a7\",\"docs_leetcode_hash-code1.md\":\"c096c1b8\",\"docs_leetcode_linked-list-code.md\":\"aac4b370\",\"docs_leetcode_linked-list-code1.md\":\"9078e6f5\",\"docs_leetcode_monotone-stack.md\":\"3287e8c0\",\"docs_leetcode_monotone-stack1.md\":\"7d82b0de\",\"docs_leetcode_stack-code.md\":\"853c9ce4\",\"docs_leetcode_stack-code1.md\":\"dd95e893\",\"docs_leetcode_string-code.md\":\"4d0b2e2b\",\"docs_leetcode_string-code1.md\":\"bb1ea655\",\"docs_linux_centos-docker.md\":\"71f1449b\",\"docs_linux_linux-no-possword.md\":\"4a5e0c88\",\"docs_mobile_mobileDebugging.md\":\"292323dc\",\"docs_nest_mysql-satart.md\":\"a7869eb8\",\"docs_nest_nest-bff.md\":\"87ad936c\",\"docs_nest_nest-start.md\":\"d395e064\",\"docs_node_bff-express-esm.md\":\"64f6d25a\",\"docs_node_bff-express.md\":\"63519536\",\"docs_node_bff.md\":\"ec74f23c\",\"docs_node_deploy-server.md\":\"a0b79804\",\"docs_node_express-mysql2.md\":\"b7ed816b\",\"docs_node_express-swigger.md\":\"8c9f10af\",\"docs_node_socketIO-start.md\":\"dca38366\",\"docs_photography_nd.md\":\"4ce42003\",\"docs_pnpm_pnpm-monorepo.md\":\"dcffcb8d\",\"docs_prosemirror_html2docs-pdf.md\":\"548142d8\",\"docs_react_create-react-app.md\":\"9a2ca4b4\",\"docs_react_dompurify.md\":\"bedaf247\",\"docs_react_eslint-react.md\":\"d9cf8ee3\",\"docs_react_react-classnames.md\":\"912ec5e4\",\"docs_react_react-grid-layout.md\":\"ef160721\",\"docs_react_react-intl.md\":\"cd95b816\",\"docs_react_react-philosophies.md\":\"dd4292a8\",\"docs_react_react-query.md\":\"85fe0203\",\"docs_react_react-router-change.md\":\"dc8f790e\",\"docs_react_react-vs-vue3.md\":\"b6a61396\",\"docs_react_redux-audition.md\":\"485d3dc2\",\"docs_react_tomcat-404.md\":\"bffb053e\",\"docs_reactNative_react-native-errors.md\":\"9cbe1334\",\"docs_taro_taro-get-started.md\":\"995e794f\",\"docs_taro_taro-start.md\":\"9f05ab92\",\"docs_tiptap_tiptap-tutorial.md\":\"cbae009d\",\"docs_tiptap_tiptap-tutorial10.md\":\"9c257ddd\",\"docs_tiptap_tiptap-tutorial2.md\":\"1a9e2c33\",\"docs_tiptap_tiptap-tutorial3.md\":\"63ba7f63\",\"docs_tiptap_tiptap-tutorial4.md\":\"2493f6d3\",\"docs_tiptap_tiptap-tutorial5.md\":\"e21259bf\",\"docs_tiptap_tiptap-tutorial6.md\":\"22b6833e\",\"docs_tiptap_tiptap-tutorial7.md\":\"2fdc46e1\",\"docs_tiptap_tiptap-tutorial8.md\":\"a8da1273\",\"docs_tiptap_tiptap-tutorial9.md\":\"89d2d2ce\",\"docs_tool_2023-summary.md\":\"0b78dff1\",\"docs_tool_2024-summary.md\":\"f5e8e8a2\",\"docs_tool_blog.md\":\"2ea13e82\",\"docs_tool_chatgpt.md\":\"d58c76d5\",\"docs_tool_chrome-extension.md\":\"70536d0a\",\"docs_tool_chrome-override.md\":\"fb4fb2ea\",\"docs_tool_debugging.md\":\"9233f836\",\"docs_tool_mac.md\":\"43cb4aee\",\"docs_tool_mock.md\":\"38a152c7\",\"docs_tool_moment-api.md\":\"b21e6ab2\",\"docs_tool_mvp.md\":\"b7297dc2\",\"docs_tool_np.md\":\"d58118a7\",\"docs_tool_prosemirror-tables.md\":\"d3c343e5\",\"docs_tool_vitepress-error.md\":\"fcd85cf2\",\"docs_tool_vscode-web-error.md\":\"9ffb72e4\",\"docs_tool_whistle.md\":\"94a570d8\",\"docs_tool_yarn-certificate.md\":\"d12490d3\",\"docs_vite_componentLibrary.md\":\"2fe282e4\",\"docs_vite_create-vite.md\":\"428c7642\",\"docs_vite_vite-env.md\":\"4f2b164e\",\"docs_vite_vite-mulit-import.md\":\"ec22e7ea\",\"docs_vite_vite-react-cli.md\":\"136b49ca\",\"docs_vite_vite-react.md\":\"77113efb\",\"docs_vite_vite.md\":\"35184670\",\"docs_vite_vite3.0.md\":\"862f7416\",\"docs_vscode_vscode-markdown.md\":\"bd32ed74\",\"docs_vscode_vscode-todo.md\":\"dfb35ce2\",\"docs_vue_antd-form.md\":\"6320ad45\",\"docs_vue_antd-vue.md\":\"20ae7ec9\",\"docs_vue_axios-token.md\":\"67520fb6\",\"docs_vue_history-mode.md\":\"42125aa3\",\"docs_vue_keepAlive.md\":\"857110e6\",\"docs_vue_tjTodo.md\":\"9205159e\",\"docs_vue_unplugin-auto-import.md\":\"2d07a5ff\",\"docs_vue_vue-scoped-issue.md\":\"cb444fde\",\"docs_vue_vue3-jsx.md\":\"df0b91fd\",\"docs_vue_vue3-lint-staged.md\":\"f9fe4f97\",\"docs_vue_vue3-unexpected-token.md\":\"dc58531b\",\"docs_webrtc_getstarted-webrtc.md\":\"3c6a8fda\",\"docs_webrtc_livekit-start.md\":\"0352dfa6\",\"docs_webrtc_webrtc-one.md\":\"771ddadb\",\"docs_wechat_uniapp-start.md\":\"07c38563\",\"docs_wechat_wechat-app.md\":\"c1cf8d52\",\"docs_work_360-develop.md\":\"0b9b90bd\",\"docs_work_babel.md\":\"adb1f7bf\",\"docs_work_click-event.md\":\"445dc1b9\",\"docs_work_contentEdit-div-insert.md\":\"4ea43fd1\",\"docs_work_developer.md\":\"bf6ec366\",\"docs_work_echarts.md\":\"65cb8d1b\",\"docs_work_email-font.md\":\"6a551aee\",\"docs_work_excalidraw-use.md\":\"5e45249b\",\"docs_work_excalidraw.md\":\"656ae4b8\",\"docs_work_font-loading-speed.md\":\"ef063a78\",\"docs_work_g2-vs-echarts.md\":\"f47905d1\",\"docs_work_h5-app.md\":\"d8f4b8f7\",\"docs_work_html2canvas-bug.md\":\"1ca28cf1\",\"docs_work_i18n.md\":\"992f8a11\",\"docs_work_image-type.md\":\"9a42d87a\",\"docs_work_jenkins-start.md\":\"403612f1\",\"docs_work_js-long.md\":\"4c726d83\",\"docs_work_malformed.md\":\"a0c81ba5\",\"docs_work_mutationObserver.md\":\"e6a962bd\",\"docs_work_node16-docker.md\":\"43142b37\",\"docs_work_one-react-screenshots.md\":\"438a48f3\",\"docs_work_plop-express.md\":\"1f22d30a\",\"docs_work_puppeteer.md\":\"9592e1cf\",\"docs_work_react-ref.md\":\"18f5bf14\",\"docs_work_report-2023.md\":\"05731d4d\",\"docs_work_report-regular.md\":\"9b31eae0\",\"docs_work_richeditor.md\":\"10bf6668\",\"docs_work_sentry-cli-error.md\":\"a428c0b5\",\"docs_work_sentry-error.md\":\"a01a8333\",\"docs_work_sentry.md\":\"8c73bdf8\",\"docs_work_server-deploy.md\":\"24f3add7\",\"docs_work_sse.md\":\"daa4e38b\",\"docs_work_text-decoration.md\":\"39bfe9a9\",\"docs_work_unocss.md\":\"920a76d9\",\"docs_work_white-board.md\":\"20b18db8\",\"docs_work_word-cpu.md\":\"10327ef0\",\"docs_work_zero-width-spaces.md\":\"4caf32ef\"}")</script>
    <script type="module" async src="/blog/_assets/app.6e2a9892.js"></script>
  </body>
</html>